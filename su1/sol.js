var CAAT=CAAT||{};Function.prototype.bind=Function.prototype.bind||function(){var fn=this;var args=Array.prototype.slice.call(arguments);var obj=args.shift();return function(){return fn.apply(obj,args.concat(Array.prototype.slice.call(arguments)))}};isArray=function(input){return typeof input=="object"&&input instanceof Array};isString=function(input){return typeof input=="string"};
function extend(subc,superc){var subcp=subc.prototype;var F=function(){};F.prototype=superc.prototype;subc.prototype=new F;subc.superclass=superc.prototype;subc.prototype.constructor=subc;if(superc.prototype.constructor===Object.prototype.constructor)superc.prototype.constructor=superc;for(var method in subcp)if(subcp.hasOwnProperty(method))subc.prototype[method]=subcp[method]}
function proxy(object,preMethod,postMethod,errorMethod){if(typeof object==="function"){if(object.__isProxy)return object;return function(fn){var proxyfn=function(){if(preMethod)preMethod({fn:fn,arguments:Array.prototype.slice.call(arguments)});var retValue=null;try{retValue=fn.apply(fn,Array.prototype.slice.call(arguments));if(postMethod)retValue=postMethod({fn:fn,arguments:Array.prototype.slice.call(arguments)})}catch(e){if(errorMethod)retValue=errorMethod({fn:fn,arguments:Array.prototype.slice.call(arguments),
exception:e});else throw e;}return retValue};proxyfn.__isProxy=true;for(var method in fn)if(typeof fn[method]!=="function")if(method!=="__object"&&method!=="__isProxy")(function(proxyfn,fn){proxyfn.__defineGetter__(method,function(){return fn[method]});proxyfn.__defineSetter__(method,function(vale){fn[method]=vale})})(proxyfn,fn);return proxyfn}(object)}if(!typeof object==="object"||isArray(object)||isString(object)||object.__isProxy)return object;var cproxy=function(){};var proxy=new cproxy;proxy.__object=
object;proxy.__isProxy=true;for(var method in object)if(typeof object[method]==="function")proxy[method]=function(proxy,fn,method){return function(){if(preMethod)preMethod({object:proxy.__object,method:method,arguments:Array.prototype.slice.call(arguments)});var retValue=null;try{retValue=fn.apply(proxy.__object,arguments);if(postMethod)postMethod({object:proxy.__object,method:method,arguments:Array.prototype.slice.call(arguments)})}catch(e){if(errorMethod)retValue=errorMethod({object:proxy.__object,
method:method,arguments:Array.prototype.slice.call(arguments),exception:e});else throw e;}return retValue}}(proxy,object[method],method);else if(method!=="__object"&&method!=="__isProxy")(function(proxy,method){proxy.__defineGetter__(method,function(){return proxy.__object[method]});proxy.__defineSetter__(method,function(vale){proxy.__object[method]=vale})})(proxy,method);return proxy}
function proxify(ns,preMethod,postMethod,errorMethod,getter,setter){var nns="__"+ns+"__";var obj=window;var path=ns.split(".");while(path.length>1)obj=obj[path.shift()];window[nns]=obj[path];(function(root,obj,path,nns,ns){var newC=function(){console.log("Creating object of type proxy["+ns+"]");var obj=new root[nns](Array.prototype.slice.call(arguments));obj.____name=ns;return proxyObject(obj,preMethod,postMethod,errorMethod,getter,setter)};newC.prototype=root[nns].prototype;for(var method in obj[path])if(typeof obj[path][method]!==
"function")if(method!=="__object"&&method!=="__isProxy")(function(prevConstructor,method,newC){newC.__defineGetter__(method,function(){return prevConstructor[method]});newC.__defineSetter__(method,function(vale){prevConstructor[method]=vale})})(obj[path],method,newC);obj[path]=newC})(window,obj,path,nns,ns)}
function proxyObject(object,preMethod,postMethod,errorMethod,getter,setter){if(!typeof object==="object"||isArray(object)||isString(object)||object.__isProxy)return object;object.$proxy__isProxy=true;for(var method in object){if(method==="constructor")continue;if(typeof object[method]==="function"){var fn=object[method];object["$proxy__"+method]=fn;object[method]=function(object,fn,fnname){return function(){var args=Array.prototype.slice.call(arguments);if(preMethod)preMethod({object:object,objectName:object.____name,
method:fnname,arguments:args});var retValue=null;try{retValue=fn.apply(object,args);if(postMethod)var rr=postMethod({object:object,objectName:object.____name,method:fnname,arguments:args})}catch(e){if(errorMethod)retValue=errorMethod({object:object,objectName:object.____name,method:fnname,arguments:args,exception:e});else throw e;}return retValue}}(object,fn,method)}else if(method!=="____name")(function(object,attribute,getter,setter){object["$proxy__"+attribute]=object[attribute];object.__defineGetter__(attribute,
function(){if(getter)getter(object.____name,attribute);return object["$proxy__"+attribute]});object.__defineSetter__(attribute,function(value){object["$proxy__"+attribute]=value;if(setter)setter(object.____name,attribute,value)})})(object,method,getter,setter)}return object}
(function(){CAAT.Matrix3=function(){this.matrix=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];this.fmatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return this};CAAT.Matrix3.prototype={matrix:null,fmatrix:null,transformCoord:function(point){var x=point.x;var y=point.y;var z=point.z;point.x=x*this.matrix[0][0]+y*this.matrix[0][1]+z*this.matrix[0][2]+this.matrix[0][3];point.y=x*this.matrix[1][0]+y*this.matrix[1][1]+z*this.matrix[1][2]+this.matrix[1][3];point.z=x*this.matrix[2][0]+y*this.matrix[2][1]+z*this.matrix[2][2]+
this.matrix[2][3];return point},initialize:function(x0,y0,z0,x1,y1,z1,x2,y2,z2){this.identity();this.matrix[0][0]=x0;this.matrix[0][1]=y0;this.matrix[0][2]=z0;this.matrix[1][0]=x1;this.matrix[1][1]=y1;this.matrix[1][2]=z1;this.matrix[2][0]=x2;this.matrix[2][1]=y2;this.matrix[2][2]=z2;return this},initWithMatrix:function(matrixData){this.matrix=matrixData;return this},flatten:function(){var d=this.fmatrix;var s=this.matrix;d[0]=s[0][0];d[1]=s[1][0];d[2]=s[2][0];d[3]=s[3][0];d[4]=s[0][1];d[5]=s[1][1];
d[6]=s[2][1];d[7]=s[2][1];d[8]=s[0][2];d[9]=s[1][2];d[10]=s[2][2];d[11]=s[3][2];d[12]=s[0][3];d[13]=s[1][3];d[14]=s[2][3];d[15]=s[3][3];return this.fmatrix},identity:function(){for(var i=0;i<4;i++)for(var j=0;j<4;j++)this.matrix[i][j]=i===j?1:0;return this},getMatrix:function(){return this.matrix},rotateXY:function(xy){return this.rotate(xy,0,0)},rotateXZ:function(xz){return this.rotate(0,xz,0)},rotateYZ:function(yz){return this.rotate(0,0,yz)},setRotate:function(xy,xz,yz){var m=this.rotate(xy,xz,
yz);this.copy(m);return this},rotate:function(xy,xz,yz){var res=new CAAT.Matrix3;var s,c,m;if(xy!==0){m=new CAAT.Matrix3;s=Math.sin(xy);c=Math.cos(xy);m.matrix[1][1]=c;m.matrix[1][2]=-s;m.matrix[2][1]=s;m.matrix[2][2]=c;res.multiply(m)}if(xz!==0){m=new CAAT.Matrix3;s=Math.sin(xz);c=Math.cos(xz);m.matrix[0][0]=c;m.matrix[0][2]=-s;m.matrix[2][0]=s;m.matrix[2][2]=c;res.multiply(m)}if(yz!==0){m=new CAAT.Matrix3;s=Math.sin(yz);c=Math.cos(yz);m.matrix[0][0]=c;m.matrix[0][1]=-s;m.matrix[1][0]=s;m.matrix[1][1]=
c;res.multiply(m)}return res},getClone:function(){var m=new CAAT.Matrix3;m.copy(this);return m},multiply:function(m){var n=this.getClone();var nm=n.matrix;var n00=nm[0][0];var n01=nm[0][1];var n02=nm[0][2];var n03=nm[0][3];var n10=nm[1][0];var n11=nm[1][1];var n12=nm[1][2];var n13=nm[1][3];var n20=nm[2][0];var n21=nm[2][1];var n22=nm[2][2];var n23=nm[2][3];var n30=nm[3][0];var n31=nm[3][1];var n32=nm[3][2];var n33=nm[3][3];var mm=m.matrix;var m00=mm[0][0];var m01=mm[0][1];var m02=mm[0][2];var m03=
mm[0][3];var m10=mm[1][0];var m11=mm[1][1];var m12=mm[1][2];var m13=mm[1][3];var m20=mm[2][0];var m21=mm[2][1];var m22=mm[2][2];var m23=mm[2][3];var m30=mm[3][0];var m31=mm[3][1];var m32=mm[3][2];var m33=mm[3][3];this.matrix[0][0]=n00*m00+n01*m10+n02*m20+n03*m30;this.matrix[0][1]=n00*m01+n01*m11+n02*m21+n03*m31;this.matrix[0][2]=n00*m02+n01*m12+n02*m22+n03*m32;this.matrix[0][3]=n00*m03+n01*m13+n02*m23+n03*m33;this.matrix[1][0]=n10*m00+n11*m10+n12*m20+n13*m30;this.matrix[1][1]=n10*m01+n11*m11+n12*
m21+n13*m31;this.matrix[1][2]=n10*m02+n11*m12+n12*m22+n13*m32;this.matrix[1][3]=n10*m03+n11*m13+n12*m23+n13*m33;this.matrix[2][0]=n20*m00+n21*m10+n22*m20+n23*m30;this.matrix[2][1]=n20*m01+n21*m11+n22*m21+n23*m31;this.matrix[2][2]=n20*m02+n21*m12+n22*m22+n23*m32;this.matrix[2][3]=n20*m03+n21*m13+n22*m23+n23*m33;return this},premultiply:function(m){var n=this.getClone();var nm=n.matrix;var n00=nm[0][0];var n01=nm[0][1];var n02=nm[0][2];var n03=nm[0][3];var n10=nm[1][0];var n11=nm[1][1];var n12=nm[1][2];
var n13=nm[1][3];var n20=nm[2][0];var n21=nm[2][1];var n22=nm[2][2];var n23=nm[2][3];var n30=nm[3][0];var n31=nm[3][1];var n32=nm[3][2];var n33=nm[3][3];var mm=m.matrix;var m00=mm[0][0];var m01=mm[0][1];var m02=mm[0][2];var m03=mm[0][3];var m10=mm[1][0];var m11=mm[1][1];var m12=mm[1][2];var m13=mm[1][3];var m20=mm[2][0];var m21=mm[2][1];var m22=mm[2][2];var m23=mm[2][3];var m30=mm[3][0];var m31=mm[3][1];var m32=mm[3][2];var m33=mm[3][3];this.matrix[0][0]=n00*m00+n01*m10+n02*m20;this.matrix[0][1]=
n00*m01+n01*m11+n02*m21;this.matrix[0][2]=n00*m02+n01*m12+n02*m22;this.matrix[0][3]=n00*m03+n01*m13+n02*m23+n03;this.matrix[1][0]=n10*m00+n11*m10+n12*m20;this.matrix[1][1]=n10*m01+n11*m11+n12*m21;this.matrix[1][2]=n10*m02+n11*m12+n12*m22;this.matrix[1][3]=n10*m03+n11*m13+n12*m23+n13;this.matrix[2][0]=n20*m00+n21*m10+n22*m20;this.matrix[2][1]=n20*m01+n21*m11+n22*m21;this.matrix[2][2]=n20*m02+n21*m12+n22*m22;this.matrix[2][3]=n20*m03+n21*m13+n22*m23+n23;return this},setTranslate:function(x,y,z){this.identity();
this.matrix[0][3]=x;this.matrix[1][3]=y;this.matrix[2][3]=z;return this},translate:function(x,y,z){var m=new CAAT.Matrix3;m.setTranslate(x,y,z);return m},setScale:function(sx,sy,sz){this.identity();this.matrix[0][0]=sx;this.matrix[1][1]=sy;this.matrix[2][2]=sz;return this},scale:function(sx,sy,sz){var m=new CAAT.Matrix3;m.setScale(sx,sy,sz);return m},rotateModelView:function(xy,xz,yz){var sxy=Math.sin(xy);var sxz=Math.sin(xz);var syz=Math.sin(yz);var cxy=Math.cos(xy);var cxz=Math.cos(xz);var cyz=
Math.cos(yz);this.matrix[0][0]=cxz*cxy;this.matrix[0][1]=-cxz*sxy;this.matrix[0][2]=sxz;this.matrix[0][3]=0;this.matrix[1][0]=syz*sxz*cxy+sxy*cyz;this.matrix[1][1]=cyz*cxy-syz*sxz*sxy;this.matrix[1][2]=-syz*cxz;this.matrix[1][3]=0;this.matrix[2][0]=syz*sxy-cyz*sxz*cxy;this.matrix[2][1]=cyz*sxz*sxy+syz*cxy;this.matrix[2][2]=cyz*cxz;this.matrix[2][3]=0;this.matrix[3][0]=0;this.matrix[3][1]=0;this.matrix[3][2]=0;this.matrix[3][3]=1;return this},copy:function(m){for(var i=0;i<4;i++)for(var j=0;j<4;j++)this.matrix[i][j]=
m.matrix[i][j];return this},calculateDeterminant:function(){var mm=this.matrix;var m11=mm[0][0],m12=mm[0][1],m13=mm[0][2],m14=mm[0][3],m21=mm[1][0],m22=mm[1][1],m23=mm[1][2],m24=mm[1][3],m31=mm[2][0],m32=mm[2][1],m33=mm[2][2],m34=mm[2][3],m41=mm[3][0],m42=mm[3][1],m43=mm[3][2],m44=mm[3][3];return m14*m22*m33*m41+m12*m24*m33*m41+m14*m23*m31*m42+m13*m24*m31*m42+m13*m21*m34*m42+m11*m23*m34*m42+m14*m21*m32*m43+m11*m24*m32*m43+m13*m22*m31*m44+m12*m23*m31*m44+m12*m21*m33*m44+m11*m22*m33*m44+m14*m23*m32*
m41-m13*m24*m32*m41-m13*m22*m34*m41-m12*m23*m34*m41-m14*m21*m33*m42-m11*m24*m33*m42-m14*m22*m31*m43-m12*m24*m31*m43-m12*m21*m34*m43-m11*m22*m34*m43-m13*m21*m32*m44-m11*m23*m32*m44},getInverse:function(){var mm=this.matrix;var m11=mm[0][0],m12=mm[0][1],m13=mm[0][2],m14=mm[0][3],m21=mm[1][0],m22=mm[1][1],m23=mm[1][2],m24=mm[1][3],m31=mm[2][0],m32=mm[2][1],m33=mm[2][2],m34=mm[2][3],m41=mm[3][0],m42=mm[3][1],m43=mm[3][2],m44=mm[3][3];var m2=new CAAT.Matrix3;m2.matrix[0][0]=m23*m34*m42+m24*m32*m43+m22*
m33*m44-m24*m33*m42-m22*m34*m43-m23*m32*m44;m2.matrix[0][1]=m14*m33*m42+m12*m34*m43+m13*m32*m44-m12*m33*m44-m13*m34*m42-m14*m32*m43;m2.matrix[0][2]=m13*m24*m42+m12*m23*m44+m14*m22*m43-m12*m24*m43-m13*m22*m44-m14*m23*m42;m2.matrix[0][3]=m14*m23*m32+m12*m24*m33+m13*m22*m34-m13*m24*m32-m14*m22*m33-m12*m23*m34;m2.matrix[1][0]=m24*m33*m41+m21*m34*m43+m23*m31*m44-m23*m34*m41-m24*m31*m43-m21*m33*m44;m2.matrix[1][1]=m13*m34*m41+m14*m31*m43+m11*m33*m44-m14*m33*m41-m11*m34*m43-m13*m31*m44;m2.matrix[1][2]=m14*
m23*m41+m11*m24*m43+m13*m21*m44-m13*m24*m41-m14*m21*m43-m11*m23*m44;m2.matrix[1][3]=m13*m24*m31+m14*m21*m33+m11*m23*m34-m14*m23*m31-m11*m24*m33-m13*m21*m34;m2.matrix[2][0]=m22*m34*m41+m24*m31*m42+m21*m32*m44-m24*m32*m41-m21*m34*m42-m22*m31*m44;m2.matrix[2][1]=m14*m32*m41+m11*m34*m42+m12*m31*m44-m11*m32*m44-m12*m34*m41-m14*m31*m42;m2.matrix[2][2]=m13*m24*m41+m14*m21*m42+m11*m22*m44-m14*m22*m41-m11*m24*m42-m12*m21*m44;m2.matrix[2][3]=m14*m22*m31+m11*m24*m32+m12*m21*m34-m11*m22*m34-m12*m24*m31-m14*m21*
m32;m2.matrix[3][0]=m23*m32*m41+m21*m33*m42+m22*m31*m43-m22*m33*m41-m23*m31*m42-m21*m32*m43;m2.matrix[3][1]=m12*m33*m41+m13*m31*m42+m11*m32*m43-m13*m32*m41-m11*m33*m42-m12*m31*m43;m2.matrix[3][2]=m13*m22*m41+m11*m23*m42+m12*m21*m43-m11*m22*m43-m12*m23*m41-m13*m21*m42;m2.matrix[3][3]=m12*m23*m31+m13*m21*m32+m11*m22*m33-m13*m22*m31-m11*m23*m32-m12*m21*m33;return m2.multiplyScalar(1/this.calculateDeterminant())},multiplyScalar:function(scalar){var i,j;for(i=0;i<4;i++)for(j=0;j<4;j++)this.matrix[i][j]*=
scalar;return this}}})();
(function(){CAAT.Matrix=function(){this.matrix=[1,0,0,0,1,0,0,0,1];if(typeof Float32Array!=="undefined")this.matrix=new Float32Array(this.matrix);return this};CAAT.Matrix.prototype={matrix:null,transformCoord:function(point){var x=point.x;var y=point.y;var tm=this.matrix;point.x=x*tm[0]+y*tm[1]+tm[2];point.y=x*tm[3]+y*tm[4]+tm[5];return point},rotate:function(angle){var m=new CAAT.Matrix;m.setRotation(angle);return m},setRotation:function(angle){this.identity();var tm=this.matrix;var c=Math.cos(angle);
var s=Math.sin(angle);tm[0]=c;tm[1]=-s;tm[3]=s;tm[4]=c;return this},scale:function(scalex,scaley){var m=new CAAT.Matrix;m.matrix[0]=scalex;m.matrix[4]=scaley;return m},setScale:function(scalex,scaley){this.identity();this.matrix[0]=scalex;this.matrix[4]=scaley;return this},translate:function(x,y){var m=new CAAT.Matrix;m.matrix[2]=x;m.matrix[5]=y;return m},setTranslate:function(x,y){this.identity();this.matrix[2]=x;this.matrix[5]=y;return this},copy:function(matrix){matrix=matrix.matrix;var tmatrix=
this.matrix;tmatrix[0]=matrix[0];tmatrix[1]=matrix[1];tmatrix[2]=matrix[2];tmatrix[3]=matrix[3];tmatrix[4]=matrix[4];tmatrix[5]=matrix[5];tmatrix[6]=matrix[6];tmatrix[7]=matrix[7];tmatrix[8]=matrix[8];return this},identity:function(){var m=this.matrix;m[0]=1;m[1]=0;m[2]=0;m[3]=0;m[4]=1;m[5]=0;m[6]=0;m[7]=0;m[8]=1;return this},multiply:function(m){var tm=this.matrix;var mm=m.matrix;var tm0=tm[0];var tm1=tm[1];var tm2=tm[2];var tm3=tm[3];var tm4=tm[4];var tm5=tm[5];var tm6=tm[6];var tm7=tm[7];var tm8=
tm[8];var mm0=mm[0];var mm1=mm[1];var mm2=mm[2];var mm3=mm[3];var mm4=mm[4];var mm5=mm[5];var mm6=mm[6];var mm7=mm[7];var mm8=mm[8];tm[0]=tm0*mm0+tm1*mm3+tm2*mm6;tm[1]=tm0*mm1+tm1*mm4+tm2*mm7;tm[2]=tm0*mm2+tm1*mm5+tm2*mm8;tm[3]=tm3*mm0+tm4*mm3+tm5*mm6;tm[4]=tm3*mm1+tm4*mm4+tm5*mm7;tm[5]=tm3*mm2+tm4*mm5+tm5*mm8;tm[6]=tm6*mm0+tm7*mm3+tm8*mm6;tm[7]=tm6*mm1+tm7*mm4+tm8*mm7;tm[8]=tm6*mm2+tm7*mm5+tm8*mm8;return this},premultiply:function(m){var m00=m.matrix[0]*this.matrix[0]+m.matrix[1]*this.matrix[3]+
m.matrix[2]*this.matrix[6];var m01=m.matrix[0]*this.matrix[1]+m.matrix[1]*this.matrix[4]+m.matrix[2]*this.matrix[7];var m02=m.matrix[0]*this.matrix[2]+m.matrix[1]*this.matrix[5]+m.matrix[2]*this.matrix[8];var m10=m.matrix[3]*this.matrix[0]+m.matrix[4]*this.matrix[3]+m.matrix[5]*this.matrix[6];var m11=m.matrix[3]*this.matrix[1]+m.matrix[4]*this.matrix[4]+m.matrix[5]*this.matrix[7];var m12=m.matrix[3]*this.matrix[2]+m.matrix[4]*this.matrix[5]+m.matrix[5]*this.matrix[8];var m20=m.matrix[6]*this.matrix[0]+
m.matrix[7]*this.matrix[3]+m.matrix[8]*this.matrix[6];var m21=m.matrix[6]*this.matrix[1]+m.matrix[7]*this.matrix[4]+m.matrix[8]*this.matrix[7];var m22=m.matrix[6]*this.matrix[2]+m.matrix[7]*this.matrix[5]+m.matrix[8]*this.matrix[8];this.matrix[0]=m00;this.matrix[1]=m01;this.matrix[2]=m02;this.matrix[3]=m10;this.matrix[4]=m11;this.matrix[5]=m12;this.matrix[6]=m20;this.matrix[7]=m21;this.matrix[8]=m22;return this},getInverse:function(){var tm=this.matrix;var m00=tm[0];var m01=tm[1];var m02=tm[2];var m10=
tm[3];var m11=tm[4];var m12=tm[5];var m20=tm[6];var m21=tm[7];var m22=tm[8];var newMatrix=new CAAT.Matrix;var determinant=m00*(m11*m22-m21*m12)-m10*(m01*m22-m21*m02)+m20*(m01*m12-m11*m02);if(determinant===0)return null;var m=newMatrix.matrix;m[0]=m11*m22-m12*m21;m[1]=m02*m21-m01*m22;m[2]=m01*m12-m02*m11;m[3]=m12*m20-m10*m22;m[4]=m00*m22-m02*m20;m[5]=m02*m10-m00*m12;m[6]=m10*m21-m11*m20;m[7]=m01*m20-m00*m21;m[8]=m00*m11-m01*m10;newMatrix.multiplyScalar(1/determinant);return newMatrix},multiplyScalar:function(scalar){var i;
for(i=0;i<9;i++)this.matrix[i]*=scalar;return this},transformRenderingContextSet:null,transformRenderingContext:null,transformRenderingContextSet_NoClamp:function(ctx){var m=this.matrix;ctx.setTransform(m[0],m[3],m[1],m[4],m[2],m[5]);return this},transformRenderingContext_NoClamp:function(ctx){var m=this.matrix;ctx.transform(m[0],m[3],m[1],m[4],m[2],m[5]);return this},transformRenderingContextSet_Clamp:function(ctx){var m=this.matrix;ctx.setTransform(m[0],m[3],m[1],m[4],m[2]>>0,m[5]>>0);return this},
transformRenderingContext_Clamp:function(ctx){var m=this.matrix;ctx.transform(m[0],m[3],m[1],m[4],m[2]>>0,m[5]>>0);return this}};CAAT.Matrix.prototype.transformRenderingContext=CAAT.Matrix.prototype.transformRenderingContext_Clamp;CAAT.Matrix.prototype.transformRenderingContextSet=CAAT.Matrix.prototype.transformRenderingContextSet_Clamp})();
(function(){CAAT.MatrixStack=function(){this.stack=[];this.saved=[];return this};CAAT.MatrixStack.prototype={stack:null,saved:null,pushMatrix:function(matrix){this.stack.push(matrix);return this},popMatrix:function(){return this.stack.pop()},save:function(){this.saved.push(this.stack.length);return this},restore:function(){var pos=this.saved.pop();while(this.stack.length!==pos)this.popMatrix();return this},getMatrix:function(){var matrix=new CAAT.Matrix;for(var i=0;i<this.stack.length;i++){var matrixStack=
this.stack[i];matrix.multiply(matrixStack)}return matrix}}})();
(function(){CAAT.Color=function(){return this};CAAT.Color.prototype={hsvToRgb:function(h,s,v){var r,g,b,i,f,p,q,t;h=Math.max(0,Math.min(360,h));s=Math.max(0,Math.min(100,s));v=Math.max(0,Math.min(100,v));s/=100;v/=100;if(s===0){r=g=b=v;return[Math.round(r*255),Math.round(g*255),Math.round(b*255)]}h/=60;i=Math.floor(h);f=h-i;p=v*(1-s);q=v*(1-s*f);t=v*(1-s*(1-f));switch(i){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;default:r=
v;g=p;b=q}return new CAAT.Color.RGB(Math.round(r*255),Math.round(g*255),Math.round(b*255))},RampEnumeration:{RAMP_RGBA:0,RAMP_RGB:1,RAMP_CHANNEL_RGB:2,RAMP_CHANNEL_RGBA:3,RAMP_CHANNEL_RGB_ARRAY:4,RAMP_CHANNEL_RGBA_ARRAY:5},interpolate:function(r0,g0,b0,r1,g1,b1,nsteps,step){var r,g,b;if(step<=0)return{r:r0,g:g0,b:b0};else if(step>=nsteps)return{r:r1,g:g1,b:b1};r=r0+(r1-r0)/nsteps*step>>0;g=g0+(g1-g0)/nsteps*step>>0;b=b0+(b1-b0)/nsteps*step>>0;if(r>255)r=255;else if(r<0)r=0;if(g>255)g=255;else if(g<
0)g=0;if(b>255)b=255;else if(b<0)b=0;return{r:r,g:g,b:b}},makeRGBColorRamp:function(fromColorsArray,rampSize,returnType){var ramp=[],nc=fromColorsArray.length-1,chunk=rampSize/nc,i,j,na,nr,ng,nb,c,a0,r0,g0,b0,c1,a1,r1,g1,b1,da,dr,dg,db;for(i=0;i<nc;i+=1){c=fromColorsArray[i];a0=c>>24&255;r0=(c&16711680)>>16;g0=(c&65280)>>8;b0=c&255;c1=fromColorsArray[i+1];a1=c1>>24&255;r1=(c1&16711680)>>16;g1=(c1&65280)>>8;b1=c1&255;da=(a1-a0)/chunk;dr=(r1-r0)/chunk;dg=(g1-g0)/chunk;db=(b1-b0)/chunk;for(j=0;j<chunk;j+=
1){na=a0+da*j>>0;nr=r0+dr*j>>0;ng=g0+dg*j>>0;nb=b0+db*j>>0;switch(returnType){case this.RampEnumeration.RAMP_RGBA:ramp.push("argb("+na+","+nr+","+ng+","+nb+")");break;case this.RampEnumeration.RAMP_RGB:ramp.push("rgb("+nr+","+ng+","+nb+")");break;case this.RampEnumeration.RAMP_CHANNEL_RGB:ramp.push(4278190080|nr<<16|ng<<8|nb);break;case this.RampEnumeration.RAMP_CHANNEL_RGBA:ramp.push(na<<24|nr<<16|ng<<8|nb);break;case this.RampEnumeration.RAMP_CHANNEL_RGBA_ARRAY:ramp.push([nr,ng,nb,na]);break;case this.RampEnumeration.RAMP_CHANNEL_RGB_ARRAY:ramp.push([nr,
ng,nb]);break}}}return ramp}}})();(function(){CAAT.Color.RGB=function(r,g,b){this.r=r||255;this.g=g||255;this.b=b||255;return this};CAAT.Color.RGB.random=function(){var a="0123456789abcdef";var c="#";for(var i=0;i<3;i++)c+=a[Math.random()*a.length>>0];return c};CAAT.Color.RGB.prototype={r:255,g:255,b:255,toHex:function(){return("000000"+((this.r<<16)+(this.g<<8)+this.b).toString(16)).slice(-6)}}})();
(function(){CAAT.Rectangle=function(){return this};CAAT.Rectangle.prototype={x:0,y:0,x1:0,y1:0,width:-1,height:-1,setEmpty:function(){this.width=-1;this.height=-1;this.x=0;this.y=0;this.x1=0;this.y1=0;return this},setLocation:function(x,y){this.x=x;this.y=y;this.x1=this.x+this.width;this.y1=this.y+this.height;return this},setDimension:function(w,h){this.width=w;this.height=h;this.x1=this.x+this.width;this.y1=this.y+this.height;return this},setBounds:function(x,y,w,h){this.setLocation(x,y);this.setDimension(w,
h);return this},contains:function(px,py){return px>=0&&px<this.width&&py>=0&&py<this.height},isEmpty:function(){return this.width===-1&&this.height===-1},union:function(px,py){if(this.isEmpty()){this.x=px;this.x1=px;this.y=py;this.y1=py;this.width=0;this.height=0;return}this.x1=this.x+this.width;this.y1=this.y+this.height;if(py<this.y)this.y=py;if(px<this.x)this.x=px;if(py>this.y1)this.y1=py;if(px>this.x1)this.x1=px;this.width=this.x1-this.x;this.height=this.y1-this.y},unionRectangle:function(rectangle){this.union(rectangle.x,
rectangle.y);this.union(rectangle.x1,rectangle.y);this.union(rectangle.x,rectangle.y1);this.union(rectangle.x1,rectangle.y1);return this},intersects:function(r){if(r.isEmpty()||this.isEmpty())return false;if(r.x1<=this.x)return false;if(r.x>=this.x1)return false;if(r.y1<=this.y)return false;if(r.y>=this.y1)return false;return true},intersectsRect:function(x,y,w,h){if(-1===w||-1===h)return false;var x1=x+w-1;var y1=y+h-1;if(x1<this.x)return false;if(x>this.x1)return false;if(y1<this.y)return false;
if(y>this.y1)return false;return true},intersect:function(i,r){if(typeof r==="undefined")r=new CAAT.Rectangle;r.x=Math.max(this.x,i.x);r.y=Math.max(this.y,i.y);r.x1=Math.min(this.x1,i.x1);r.y1=Math.min(this.y1,i.y1);r.width=r.x1-r.x;r.height=r.y1-r.y;return r}}})();
(function(){CAAT.Curve=function(){return this};CAAT.Curve.prototype={coordlist:null,k:0.05,length:-1,interpolator:false,HANDLE_SIZE:20,drawHandles:true,paint:function(director){if(false===this.drawHandles)return;var cl=this.coordlist;var ctx=director.ctx;ctx.save();ctx.beginPath();ctx.strokeStyle="#a0a0a0";ctx.moveTo(cl[0].x,cl[0].y);ctx.lineTo(cl[1].x,cl[1].y);ctx.stroke();if(this.cubic){ctx.moveTo(cl[2].x,cl[2].y);ctx.lineTo(cl[3].x,cl[3].y);ctx.stroke()}ctx.globalAlpha=0.5;for(var i=0;i<this.coordlist.length;i++){ctx.fillStyle=
"#7f7f00";var w=CAAT.Curve.prototype.HANDLE_SIZE/2;ctx.beginPath();ctx.arc(cl[i].x,cl[i].y,w,0,2*Math.PI,false);ctx.fill()}ctx.restore()},update:function(){this.calcLength()},solve:function(point,t){},getContour:function(numSamples){var contour=[],i;for(i=0;i<=numSamples;i++){var point=new CAAT.Point;this.solve(point,i/numSamples);contour.push(point)}return contour},getBoundingBox:function(rectangle){if(!rectangle)rectangle=new CAAT.Rectangle;rectangle.setEmpty();rectangle.union(this.coordlist[0].x,
this.coordlist[0].y);var pt=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=this.k){this.solve(pt,t);rectangle.union(pt.x,pt.y)}return rectangle},calcLength:function(){var x1,y1;x1=this.coordlist[0].x;y1=this.coordlist[0].y;var llength=0;var pt=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=this.k){this.solve(pt,t);llength+=Math.sqrt((pt.x-x1)*(pt.x-x1)+(pt.y-y1)*(pt.y-y1));x1=pt.x;y1=pt.y}this.length=llength;return llength},getLength:function(){return this.length},endCurvePosition:function(){return this.coordlist[this.coordlist.length-
1]},startCurvePosition:function(){return this.coordlist[0]},setPoints:function(points){},setPoint:function(point,index){if(index>=0&&index<this.coordlist.length)this.coordlist[index]=point},applyAsPath:function(director){}}})();
(function(){CAAT.Bezier=function(){CAAT.Bezier.superclass.constructor.call(this);return this};CAAT.Bezier.prototype={cubic:false,applyAsPath:function(director){var cc=this.coordlist;if(this.cubic)director.ctx.bezierCurveTo(cc[1].x,cc[1].y,cc[2].x,cc[2].y,cc[3].x,cc[3].y);else director.ctx.quadraticCurveTo(cc[1].x,cc[1].y,cc[2].x,cc[2].y);return this},isQuadric:function(){return!this.cubic},isCubic:function(){return this.cubic},setCubic:function(cp0x,cp0y,cp1x,cp1y,cp2x,cp2y,cp3x,cp3y){this.coordlist=
[];this.coordlist.push((new CAAT.Point).set(cp0x,cp0y));this.coordlist.push((new CAAT.Point).set(cp1x,cp1y));this.coordlist.push((new CAAT.Point).set(cp2x,cp2y));this.coordlist.push((new CAAT.Point).set(cp3x,cp3y));this.cubic=true;this.update();return this},setQuadric:function(cp0x,cp0y,cp1x,cp1y,cp2x,cp2y){this.coordlist=[];this.coordlist.push((new CAAT.Point).set(cp0x,cp0y));this.coordlist.push((new CAAT.Point).set(cp1x,cp1y));this.coordlist.push((new CAAT.Point).set(cp2x,cp2y));this.cubic=false;
this.update();return this},setPoints:function(points){if(points.length===3){this.coordlist=points;this.cubic=false;this.update()}else if(points.length===4){this.coordlist=points;this.cubic=true;this.update()}else throw"points must be an array of 3 or 4 CAAT.Point instances.";return this},paint:function(director){if(this.cubic)this.paintCubic(director);else this.paintCuadric(director);CAAT.Bezier.superclass.paint.call(this,director)},paintCuadric:function(director){var x1,y1;x1=this.coordlist[0].x;
y1=this.coordlist[0].y;var ctx=director.ctx;ctx.save();ctx.beginPath();ctx.moveTo(x1,y1);var point=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=this.k){this.solve(point,t);ctx.lineTo(point.x,point.y)}ctx.stroke();ctx.restore()},paintCubic:function(director){var x1,y1;x1=this.coordlist[0].x;y1=this.coordlist[0].y;var ctx=director.ctx;ctx.save();ctx.beginPath();ctx.moveTo(x1,y1);var point=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=this.k){this.solve(point,t);ctx.lineTo(point.x,point.y)}ctx.stroke();
ctx.restore()},solve:function(point,t){if(this.cubic)return this.solveCubic(point,t);else return this.solveQuadric(point,t)},solveCubic:function(point,t){var t2=t*t;var t3=t*t2;var cl=this.coordlist;var cl0=cl[0];var cl1=cl[1];var cl2=cl[2];var cl3=cl[3];point.x=cl0.x+t*(-cl0.x*3+t*(3*cl0.x-cl0.x*t))+t*(3*cl1.x+t*(-6*cl1.x+cl1.x*3*t))+t2*(cl2.x*3-cl2.x*3*t)+cl3.x*t3;point.y=cl0.y+t*(-cl0.y*3+t*(3*cl0.y-cl0.y*t))+t*(3*cl1.y+t*(-6*cl1.y+cl1.y*3*t))+t2*(cl2.y*3-cl2.y*3*t)+cl3.y*t3;return point},solveQuadric:function(point,
t){var cl=this.coordlist;var cl0=cl[0];var cl1=cl[1];var cl2=cl[2];var t1=1-t;point.x=t1*t1*cl0.x+2*t1*t*cl1.x+t*t*cl2.x;point.y=t1*t1*cl0.y+2*t1*t*cl1.y+t*t*cl2.y;return point}};extend(CAAT.Bezier,CAAT.Curve,null)})();
(function(){CAAT.CatmullRom=function(){CAAT.CatmullRom.superclass.constructor.call(this);return this};CAAT.CatmullRom.prototype={setCurve:function(p0,p1,p2,p3){this.coordlist=[];this.coordlist.push(p0);this.coordlist.push(p1);this.coordlist.push(p2);this.coordlist.push(p3);this.update();return this},paint:function(director){var x1,y1;x1=this.coordlist[1].x;y1=this.coordlist[1].y;var ctx=director.ctx;ctx.save();ctx.beginPath();ctx.moveTo(x1,y1);var point=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=
this.k){this.solve(point,t);ctx.lineTo(point.x,point.y)}ctx.stroke();ctx.restore();CAAT.CatmullRom.superclass.paint.call(this,director)},solve:function(point,t){var c=this.coordlist;var af=((-t+2)*t-1)*t*0.5;var bf=((3*t-5)*t*t+2)*0.5;var cf=((-3*t+4)*t+1)*t*0.5;var df=(t-1)*t*t*0.5;point.x=c[0].x*af+c[1].x*bf+c[2].x*cf+c[3].x*df;point.y=c[0].y*af+c[1].y*bf+c[2].y*cf+c[3].y*df;return point},applyAsPath:function(director){var ctx=director.ctx;var point=new CAAT.Point;for(var t=this.k;t<=1+this.k;t+=
this.k){this.solve(point,t);ctx.lineTo(point.x,point.y)}return this},endCurvePosition:function(){return this.coordlist[this.coordlist.length-2]},startCurvePosition:function(){return this.coordlist[1]}};extend(CAAT.CatmullRom,CAAT.Curve,null)})();
(function(){CAAT.Point=function(xpos,ypos,zpos){this.x=xpos;this.y=ypos;this.z=zpos||0;return this};CAAT.Point.prototype={x:0,y:0,z:0,set:function(x,y,z){this.x=x;this.y=y;this.z=z||0;return this},clone:function(){var p=new CAAT.Point(this.x,this.y,this.z);return p},translate:function(x,y,z){this.x+=x;this.y+=y;this.z+=z;return this},translatePoint:function(aPoint){this.x+=aPoint.x;this.y+=aPoint.y;this.z+=aPoint.z;return this},subtract:function(aPoint){this.x-=aPoint.x;this.y-=aPoint.y;this.z-=aPoint.z;
return this},multiply:function(factor){this.x*=factor;this.y*=factor;this.z*=factor;return this},rotate:function(angle){var x=this.x,y=this.y;this.x=x*Math.cos(angle)-Math.sin(angle)*y;this.y=x*Math.sin(angle)+Math.cos(angle)*y;this.z=0;return this},setAngle:function(angle){var len=this.getLength();this.x=Math.cos(angle)*len;this.y=Math.sin(angle)*len;this.z=0;return this},setLength:function(length){var len=this.getLength();if(len)this.multiply(length/len);else this.x=this.y=this.z=length;return this},
normalize:function(){var len=this.getLength();this.x/=len;this.y/=len;this.z/=len;return this},getAngle:function(){return Math.atan2(this.y,this.x)},limit:function(max){var aLenthSquared=this.getLengthSquared();if(aLenthSquared+0.01>max*max){var aLength=Math.sqrt(aLenthSquared);this.x=this.x/aLength*max;this.y=this.y/aLength*max;this.z=this.z/aLength*max}return this},getLength:function(){var length=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(length<0.0050&&length>-0.0050)return 1.0E-6;
return length},getLengthSquared:function(){var lengthSquared=this.x*this.x+this.y*this.y+this.z*this.z;if(lengthSquared<0.0050&&lengthSquared>-0.0050)return 0;return lengthSquared},getDistance:function(point){var deltaX=this.x-point.x;var deltaY=this.y-point.y;var deltaZ=this.z-point.z;return Math.sqrt(deltaX*deltaX+deltaY*deltaY+deltaZ*deltaZ)},getDistanceSquared:function(point){var deltaX=this.x-point.x;var deltaY=this.y-point.y;var deltaZ=this.z-point.z;return deltaX*deltaX+deltaY*deltaY+deltaZ*
deltaZ},toString:function(){return"(CAAT.Point)"+" x:"+String(Math.round(Math.floor(this.x*10))/10)+" y:"+String(Math.round(Math.floor(this.y*10))/10)+" z:"+String(Math.round(Math.floor(this.z*10))/10)}}})();
(function(){CAAT.QuadTree=function(){return this};var QT_MAX_ELEMENTS=1;var QT_MIN_WIDTH=32;CAAT.QuadTree.prototype={bgActors:null,quadData:null,create:function(l,t,r,b,backgroundElements,minWidth,maxElements){if(typeof minWidth==="undefined")minWidth=QT_MIN_WIDTH;if(typeof maxElements==="undefined")maxElements=QT_MAX_ELEMENTS;var cx=(l+r)/2;var cy=(t+b)/2;this.x=l;this.y=t;this.x1=r;this.y1=b;this.width=r-l;this.height=b-t;this.bgActors=this.__getOverlappingActorList(backgroundElements);if(this.bgActors.length<=
maxElements||this.width<=minWidth)return this;this.quadData=new Array(4);this.quadData[0]=(new CAAT.QuadTree).create(l,t,cx,cy,this.bgActors);this.quadData[1]=(new CAAT.QuadTree).create(cx,t,r,cy,this.bgActors);this.quadData[2]=(new CAAT.QuadTree).create(l,cy,cx,b,this.bgActors);this.quadData[3]=(new CAAT.QuadTree).create(cx,cy,r,b,this.bgActors);return this},__getOverlappingActorList:function(actorList){var tmpList=[];for(var i=0,l=actorList.length;i<l;i++){var actor=actorList[i];if(this.intersects(actor.AABB))tmpList.push(actor)}return tmpList},
getOverlappingActors:function(rectangle){var i,j,l;var overlappingActors=[];var qoverlappingActors;var actors=this.bgActors;var actor;if(this.quadData)for(i=0;i<4;i++){if(this.quadData[i].intersects(rectangle)){qoverlappingActors=this.quadData[i].getOverlappingActors(rectangle);for(j=0,l=qoverlappingActors.length;j<l;j++)overlappingActors.push(qoverlappingActors[j])}}else for(i=0,l=actors.length;i<l;i++){actor=actors[i];if(rectangle.intersects(actor.AABB))overlappingActors.push(actor)}return overlappingActors}};
extend(CAAT.QuadTree,CAAT.Rectangle)})();
(function(){CAAT.SpatialHash=function(){return this};CAAT.SpatialHash.prototype={elements:null,width:null,height:null,rows:null,columns:null,xcache:null,ycache:null,xycache:null,rectangle:null,r0:null,r1:null,initialize:function(w,h,rows,columns){var i,j;this.elements=[];for(i=0;i<rows*columns;i++)this.elements.push([]);this.width=w;this.height=h;this.rows=rows;this.columns=columns;this.xcache=[];for(i=0;i<w;i++)this.xcache.push(i/(w/columns)>>0);this.ycache=[];for(i=0;i<h;i++)this.ycache.push(i/
(h/rows)>>0);this.xycache=[];for(i=0;i<this.rows;i++){this.xycache.push([]);for(j=0;j<this.columns;j++)this.xycache[i].push(j+i*columns)}this.rectangle=(new CAAT.Rectangle).setBounds(0,0,w,h);this.r0=new CAAT.Rectangle;this.r1=new CAAT.Rectangle;return this},clearObject:function(){var i;for(i=0;i<this.rows*this.columns;i++)this.elements[i]=[];return this},addObject:function(obj){var x=obj.x|0;var y=obj.y|0;var width=obj.width|0;var height=obj.height|0;var cells=this.__getCells(x,y,width,height);for(var i=
0;i<cells.length;i++)this.elements[cells[i]].push(obj)},__getCells:function(x,y,width,height){var cells=[];var i;if(this.rectangle.contains(x,y))cells.push(this.xycache[this.ycache[y]][this.xcache[x]]);if(this.rectangle.contains(x+width-1,y+height-1)){var c=this.xycache[this.ycache[y+height-1]][this.xcache[x+width-1]];if(c===cells[0])return cells;cells.push(c)}if(this.rectangle.contains(x+width-1,y)){var c=this.xycache[this.ycache[y]][this.xcache[x+width-1]];if(c===cells[0]||c===cells[1])return cells;
cells.push(c)}if(this.rectangle.contains(x+width-1,y+height-1)){var c=this.xycache[this.ycache[y+height-1]][this.xcache[x]];cells.push(c)}return cells},solveCollision:function(callback){var i,j,k;for(i=0;i<this.elements.length;i++){var cell=this.elements[i];if(cell.length>1)this._solveCollisionCell(cell,callback)}},_solveCollisionCell:function(cell,callback){var i,j;for(i=0;i<cell.length;i++){var pivot=cell[i];this.r0.setBounds(pivot.x,pivot.y,pivot.width,pivot.height);for(j=i+1;j<cell.length;j++){var c=
cell[j];if(this.r0.intersects(this.r1.setBounds(c.x,c.y,c.width,c.height)))callback(pivot,c)}}},collide:function(x,y,w,h,oncollide){x|=0;y|=0;w|=0;h|=0;var cells=this.__getCells(x,y,w,h);var i,j,l;var el=this.elements;this.r0.setBounds(x,y,w,h);for(i=0;i<cells.length;i++){var cell=cells[i];var elcell=el[cell];for(j=0,l=elcell.length;j<l;j++){var obj=elcell[j];this.r1.setBounds(obj.x,obj.y,obj.width,obj.height);if(this.r0.intersects(this.r1))if(oncollide(obj))return}}}}})();
(function(){CAAT.Interpolator=function(){this.interpolated=new CAAT.Point(0,0,0);return this};CAAT.Interpolator.prototype={interpolated:null,paintScale:90,createLinearInterpolator:function(bPingPong,bInverse){this.getPosition=function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;if(bInverse!==null&&bInverse)time=1-time;return this.interpolated.set(orgTime,time)};return this},createBackOutInterpolator:function(bPingPong){this.getPosition=function getPosition(time){var orgTime=
time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;time=time-1;var overshoot=1.70158;return this.interpolated.set(orgTime,time*time*((overshoot+1)*time+overshoot)+1)};return this},createExponentialInInterpolator:function(exponent,bPingPong){this.getPosition=function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;return this.interpolated.set(orgTime,Math.pow(time,exponent))};return this},createExponentialOutInterpolator:function(exponent,bPingPong){this.getPosition=
function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;return this.interpolated.set(orgTime,1-Math.pow(1-time,exponent))};return this},createExponentialInOutInterpolator:function(exponent,bPingPong){this.getPosition=function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;if(time*2<1)return this.interpolated.set(orgTime,Math.pow(time*2,exponent)/2);return this.interpolated.set(orgTime,1-Math.abs(Math.pow(time*
2-2,exponent))/2)};return this},createQuadricBezierInterpolator:function(p0,p1,p2,bPingPong){this.getPosition=function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;time=(1-time)*(1-time)*p0.y+2*(1-time)*time*p1.y+time*time*p2.y;return this.interpolated.set(orgTime,time)};return this},createCubicBezierInterpolator:function(p0,p1,p2,p3,bPingPong){this.getPosition=function getPosition(time){var orgTime=time;if(bPingPong)if(time<0.5)time*=2;else time=1-
(time-0.5)*2;var t2=time*time;var t3=time*t2;time=p0.y+time*(-p0.y*3+time*(3*p0.y-p0.y*time))+time*(3*p1.y+time*(-6*p1.y+p1.y*3*time))+t2*(p2.y*3-p2.y*3*time)+p3.y*t3;return this.interpolated.set(orgTime,time)};return this},createElasticOutInterpolator:function(amplitude,p,bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;if(time===0)return{x:0,y:0};if(time===1)return{x:1,y:1};var s=p/(2*Math.PI)*Math.asin(1/amplitude);return this.interpolated.set(time,
amplitude*Math.pow(2,-10*time)*Math.sin((time-s)*2*Math.PI/p)+1)};return this},createElasticInInterpolator:function(amplitude,p,bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;if(time===0)return{x:0,y:0};if(time===1)return{x:1,y:1};var s=p/(2*Math.PI)*Math.asin(1/amplitude);return this.interpolated.set(time,-(amplitude*Math.pow(2,10*(time-=1))*Math.sin((time-s)*2*Math.PI/p)))};return this},createElasticInOutInterpolator:function(amplitude,
p,bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;var s=p/(2*Math.PI)*Math.asin(1/amplitude);time*=2;if(time<=1)return this.interpolated.set(time,-0.5*amplitude*Math.pow(2,10*(time-=1))*Math.sin((time-s)*2*Math.PI/p));return this.interpolated.set(time,1+0.5*amplitude*Math.pow(2,-10*(time-=1))*Math.sin((time-s)*2*Math.PI/p))};return this},bounce:function(time){if((time/=1)<1/2.75)return{x:time,y:7.5625*time*time};else if(time<2/2.75)return{x:time,
y:7.5625*(time-=1.5/2.75)*time+0.75};else if(time<2.5/2.75)return{x:time,y:7.5625*(time-=2.25/2.75)*time+0.9375};else return{x:time,y:7.5625*(time-=2.625/2.75)*time+0.984375}},createBounceOutInterpolator:function(bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;return this.bounce(time)};return this},createBounceInInterpolator:function(bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-
(time-0.5)*2;var r=this.bounce(1-time);r.y=1-r.y;return r};return this},createBounceInOutInterpolator:function(bPingPong){this.getPosition=function getPosition(time){if(bPingPong)if(time<0.5)time*=2;else time=1-(time-0.5)*2;var r;if(time<0.5){r=this.bounce(1-time*2);r.y=(1-r.y)*0.5;return r}r=this.bounce(time*2-1,bPingPong);r.y=r.y*0.5+0.5;return r};return this},paint:function(director,time){var canvas=director.crc;canvas.save();canvas.beginPath();canvas.moveTo(0,this.getPosition(0).y*this.paintScale);
for(var i=0;i<=this.paintScale;i++)canvas.lineTo(i,this.getPosition(i/this.paintScale).y*this.paintScale);canvas.strokeStyle="black";canvas.stroke();canvas.restore()},getContour:function(iSize){var contour=[];for(var i=0;i<=iSize;i++)contour.push({x:i/iSize,y:this.getPosition(i/iSize).y});return contour},enumerateInterpolators:function(){return[(new CAAT.Interpolator).createLinearInterpolator(false,false),"Linear pingpong=false, inverse=false",(new CAAT.Interpolator).createLinearInterpolator(true,
false),"Linear pingpong=true, inverse=false",(new CAAT.Interpolator).createLinearInterpolator(false,true),"Linear pingpong=false, inverse=true",(new CAAT.Interpolator).createLinearInterpolator(true,true),"Linear pingpong=true, inverse=true",(new CAAT.Interpolator).createExponentialInInterpolator(2,false),"ExponentialIn pingpong=false, exponent=2",(new CAAT.Interpolator).createExponentialOutInterpolator(2,false),"ExponentialOut pingpong=false, exponent=2",(new CAAT.Interpolator).createExponentialInOutInterpolator(2,
false),"ExponentialInOut pingpong=false, exponent=2",(new CAAT.Interpolator).createExponentialInInterpolator(2,true),"ExponentialIn pingpong=true, exponent=2",(new CAAT.Interpolator).createExponentialOutInterpolator(2,true),"ExponentialOut pingpong=true, exponent=2",(new CAAT.Interpolator).createExponentialInOutInterpolator(2,true),"ExponentialInOut pingpong=true, exponent=2",(new CAAT.Interpolator).createExponentialInInterpolator(4,false),"ExponentialIn pingpong=false, exponent=4",(new CAAT.Interpolator).createExponentialOutInterpolator(4,
false),"ExponentialOut pingpong=false, exponent=4",(new CAAT.Interpolator).createExponentialInOutInterpolator(4,false),"ExponentialInOut pingpong=false, exponent=4",(new CAAT.Interpolator).createExponentialInInterpolator(4,true),"ExponentialIn pingpong=true, exponent=4",(new CAAT.Interpolator).createExponentialOutInterpolator(4,true),"ExponentialOut pingpong=true, exponent=4",(new CAAT.Interpolator).createExponentialInOutInterpolator(4,true),"ExponentialInOut pingpong=true, exponent=4",(new CAAT.Interpolator).createExponentialInInterpolator(6,
false),"ExponentialIn pingpong=false, exponent=6",(new CAAT.Interpolator).createExponentialOutInterpolator(6,false),"ExponentialOut pingpong=false, exponent=6",(new CAAT.Interpolator).createExponentialInOutInterpolator(6,false),"ExponentialInOut pingpong=false, exponent=6",(new CAAT.Interpolator).createExponentialInInterpolator(6,true),"ExponentialIn pingpong=true, exponent=6",(new CAAT.Interpolator).createExponentialOutInterpolator(6,true),"ExponentialOut pingpong=true, exponent=6",(new CAAT.Interpolator).createExponentialInOutInterpolator(6,
true),"ExponentialInOut pingpong=true, exponent=6",(new CAAT.Interpolator).createBounceInInterpolator(false),"BounceIn pingpong=false",(new CAAT.Interpolator).createBounceOutInterpolator(false),"BounceOut pingpong=false",(new CAAT.Interpolator).createBounceInOutInterpolator(false),"BounceInOut pingpong=false",(new CAAT.Interpolator).createBounceInInterpolator(true),"BounceIn pingpong=true",(new CAAT.Interpolator).createBounceOutInterpolator(true),"BounceOut pingpong=true",(new CAAT.Interpolator).createBounceInOutInterpolator(true),
"BounceInOut pingpong=true",(new CAAT.Interpolator).createElasticInInterpolator(1.1,0.4,false),"ElasticIn pingpong=false, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticOutInterpolator(1.1,0.4,false),"ElasticOut pingpong=false, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticInOutInterpolator(1.1,0.4,false),"ElasticInOut pingpong=false, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticInInterpolator(1.1,0.4,true),"ElasticIn pingpong=true, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticOutInterpolator(1.1,
0.4,true),"ElasticOut pingpong=true, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticInOutInterpolator(1.1,0.4,true),"ElasticInOut pingpong=true, amp=1.1, d=.4",(new CAAT.Interpolator).createElasticInInterpolator(1,0.2,false),"ElasticIn pingpong=false, amp=1.0, d=.2",(new CAAT.Interpolator).createElasticOutInterpolator(1,0.2,false),"ElasticOut pingpong=false, amp=1.0, d=.2",(new CAAT.Interpolator).createElasticInOutInterpolator(1,0.2,false),"ElasticInOut pingpong=false, amp=1.0, d=.2",(new CAAT.Interpolator).createElasticInInterpolator(1,
0.2,true),"ElasticIn pingpong=true, amp=1.0, d=.2",(new CAAT.Interpolator).createElasticOutInterpolator(1,0.2,true),"ElasticOut pingpong=true, amp=1.0, d=.2",(new CAAT.Interpolator).createElasticInOutInterpolator(1,0.2,true),"ElasticInOut pingpong=true, amp=1.0, d=.2"]}}})();
(function(){CAAT.Behavior=function(){this.lifecycleListenerList=[];this.setDefaultInterpolator();return this};CAAT.Behavior.Status={NOT_STARTED:0,STARTED:1,EXPIRED:2};var DefaultInterpolator=(new CAAT.Interpolator).createLinearInterpolator(false);var DefaultPPInterpolator=(new CAAT.Interpolator).createLinearInterpolator(true);CAAT.Behavior.prototype={lifecycleListenerList:null,behaviorStartTime:-1,behaviorDuration:-1,cycleBehavior:false,status:CAAT.Behavior.NOT_STARTED,interpolator:null,actor:null,
id:0,timeOffset:0,doValueApplication:true,solved:true,discardable:false,setValueApplication:function(apply){this.doValueApplication=apply;return this},setTimeOffset:function(offset){this.timeOffset=offset;return this},setId:function(id){this.id=id;return this},setDefaultInterpolator:function(){this.interpolator=DefaultInterpolator;return this},setPingPong:function(){this.interpolator=DefaultPPInterpolator;return this},setStatus:function(status){this.status=status},setFrameTime:function(startTime,
duration){this.behaviorStartTime=startTime;this.behaviorDuration=duration;this.setStatus(CAAT.Behavior.Status.NOT_STARTED);return this},setDelayTime:function(delay,duration){this.behaviorStartTime=delay;this.behaviorDuration=duration;this.setStatus(CAAT.Behavior.Status.NOT_STARTED);this.solved=false;return this},setOutOfFrameTime:function(){this.setStatus(CAAT.Behavior.Status.EXPIRED);this.behaviorStartTime=Number.MAX_VALUE;this.behaviorDuration=0;return this},setInterpolator:function(interpolator){this.interpolator=
interpolator;return this},apply:function(time,actor){if(!this.solved){this.behaviorStartTime+=time;this.solved=true}time+=this.timeOffset*this.behaviorDuration;var orgTime=time;if(this.isBehaviorInTime(time,actor)){time=this.normalizeTime(time);this.fireBehaviorAppliedEvent(actor,orgTime,time,this.setForTime(time,actor))}},setCycle:function(bool){this.cycleBehavior=bool;return this},addListener:function(behaviorListener){this.lifecycleListenerList.push(behaviorListener);return this},emptyListenerList:function(){this.lifecycleListenerList=
[];return this},getStartTime:function(){return this.behaviorStartTime},getDuration:function(){return this.behaviorDuration},isBehaviorInTime:function(time,actor){var S=CAAT.Behavior.Status;if(this.status===S.EXPIRED||this.behaviorStartTime<0)return false;if(this.cycleBehavior)if(time>=this.behaviorStartTime)time=(time-this.behaviorStartTime)%this.behaviorDuration+this.behaviorStartTime;if(time>this.behaviorStartTime+this.behaviorDuration){if(this.status!==S.EXPIRED)this.setExpired(actor,time);return false}if(this.status===
S.NOT_STARTED){this.status=S.STARTED;this.fireBehaviorStartedEvent(actor,time)}return this.behaviorStartTime<=time},fireBehaviorStartedEvent:function(actor,time){for(var i=0,l=this.lifecycleListenerList.length;i<l;i++){var b=this.lifecycleListenerList[i];if(b.behaviorStarted)b.behaviorStarted(this,time,actor)}},fireBehaviorExpiredEvent:function(actor,time){for(var i=0,l=this.lifecycleListenerList.length;i<l;i++){var b=this.lifecycleListenerList[i];if(b.behaviorExpired)b.behaviorExpired(this,time,
actor)}},fireBehaviorAppliedEvent:function(actor,time,normalizedTime,value){for(var i=0,l=this.lifecycleListenerList.length;i<l;i++){var b=this.lifecycleListenerList[i];if(b.behaviorApplied)b.behaviorApplied(this,time,normalizedTime,actor,value)}},normalizeTime:function(time){time=time-this.behaviorStartTime;if(this.cycleBehavior)time%=this.behaviorDuration;return this.interpolator.getPosition(time/this.behaviorDuration).y},setExpired:function(actor,time){this.status=CAAT.Behavior.Status.EXPIRED;
this.setForTime(this.interpolator.getPosition(1).y,actor);this.fireBehaviorExpiredEvent(actor,time);if(this.discardable)this.actor.removeBehavior(this)},setForTime:function(time,actor){},initialize:function(overrides){if(overrides)for(var i in overrides)this[i]=overrides[i];return this},getPropertyName:function(){return""}}})();
(function(){CAAT.ContainerBehavior=function(){CAAT.ContainerBehavior.superclass.constructor.call(this);this.behaviors=[];return this};CAAT.ContainerBehavior.prototype={behaviors:null,conformToDuration:function(duration){this.duration=duration;var f=duration/this.duration;var bh;for(var i=0;i<this.behaviors.length;i++){bh=this.behaviors[i];bh.setFrameTime(bh.getStartTime()*f,bh.getDuration()*f)}return this},addBehavior:function(behavior){this.behaviors.push(behavior);behavior.addListener(this);return this},
apply:function(time,actor){if(!this.solved){this.behaviorStartTime+=time;this.solved=true}time+=this.timeOffset*this.behaviorDuration;if(this.isBehaviorInTime(time,actor)){time-=this.getStartTime();if(this.cycleBehavior)time%=this.getDuration();var bh=this.behaviors;for(var i=0;i<bh.length;i++)bh[i].apply(time,actor)}},behaviorExpired:function(behavior,time,actor){if(this.cycleBehavior)behavior.setStatus(CAAT.Behavior.Status.STARTED)},setForTime:function(time,actor){var bh=this.behaviors;for(var i=
0;i<bh.length;i++)bh[i].setForTime(time,actor);return null},setExpired:function(actor,time){CAAT.ContainerBehavior.superclass.setExpired.call(this,actor,time);var bh=this.behaviors;for(var i=0;i<bh.length;i++){var bb=bh[i];if(bb.status!==CAAT.Behavior.Status.EXPIRED)bb.setExpired(actor,time-this.behaviorStartTime)}return this},setFrameTime:function(start,duration){CAAT.ContainerBehavior.superclass.setFrameTime.call(this,start,duration);var bh=this.behaviors;for(var i=0;i<bh.length;i++)bh[i].setStatus(CAAT.Behavior.Status.NOT_STARTED);
return this},setDelayTime:function(start,duration){CAAT.ContainerBehavior.superclass.setDelayTime.call(this,start,duration);var bh=this.behaviors;for(var i=0;i<bh.length;i++)bh[i].setStatus(CAAT.Behavior.Status.NOT_STARTED);return this},calculateKeyFrameData:function(referenceTime,prefix,prevValues){var i;var bh;var retValue={};var time;var cssRuleValue;var cssProperty;var property;for(i=0;i<this.behaviors.length;i++){bh=this.behaviors[i];if(bh.status!==CAAT.Behavior.Status.EXPIRED&&!(bh instanceof
CAAT.GenericBehavior)){time=referenceTime*this.behaviorDuration;if(bh.behaviorStartTime<=time&&bh.behaviorStartTime+bh.behaviorDuration>=time){time=(time-bh.behaviorStartTime)/bh.behaviorDuration;cssRuleValue=bh.calculateKeyFrameData(time);cssProperty=bh.getPropertyName(prefix);if(typeof retValue[cssProperty]==="undefined")retValue[cssProperty]="";retValue[cssProperty]+=cssRuleValue+" "}}}var tr="";var pv;function xx(pr){if(retValue[pr])tr+=retValue[pr];else if(prevValues){pv=prevValues[pr];if(pv){tr+=
pv;retValue[pr]=pv}}}xx("translate");xx("rotate");xx("scale");var keyFrameRule="";if(tr)keyFrameRule="-"+prefix+"-transform: "+tr+";";tr="";xx("opacity");if(tr)keyFrameRule+=" opacity: "+tr+";";return{rules:keyFrameRule,ret:retValue}},calculateKeyFramesData:function(prefix,name,keyframessize){if(this.duration===Number.MAX_VALUE)return"";if(typeof keyframessize==="undefined")keyframessize=100;var i;var prevValues=null;var kfd="@-"+prefix+"-keyframes "+name+" {";var ret;var time;var kfr;for(i=0;i<=
keyframessize;i++){time=this.interpolator.getPosition(i/keyframessize).y;ret=this.calculateKeyFrameData(time,prefix,prevValues);kfr=""+i/keyframessize*100+"%"+"{"+ret.rules+"}\n";prevValues=ret.ret;kfd+=kfr}kfd+="}";return kfd}};extend(CAAT.ContainerBehavior,CAAT.Behavior,null)})();
(function(){CAAT.RotateBehavior=function(){CAAT.RotateBehavior.superclass.constructor.call(this);this.anchor=CAAT.Actor.prototype.ANCHOR_CENTER;return this};CAAT.RotateBehavior.prototype={startAngle:0,endAngle:0,anchorX:0.5,anchorY:0.5,getPropertyName:function(){return"rotate"},setForTime:function(time,actor){var angle=this.startAngle+time*(this.endAngle-this.startAngle);if(this.doValueApplication)actor.setRotationAnchored(angle,this.anchorX,this.anchorY);return angle},setValues:function(startAngle,
endAngle,anchorx,anchory){this.startAngle=startAngle;this.endAngle=endAngle;if(typeof anchorx!=="undefined"&&typeof anchory!=="undefined"){this.anchorX=anchorx;this.anchorY=anchory}return this},setAngles:function(start,end){return this.setValues(start,end)},setAnchor:function(actor,rx,ry){this.anchorX=rx/actor.width;this.anchorY=ry/actor.height;return this},calculateKeyFrameData:function(time){time=this.interpolator.getPosition(time).y;return"rotate("+(this.startAngle+time*(this.endAngle-this.startAngle))+
"rad)"},calculateKeyFramesData:function(prefix,name,keyframessize){if(typeof keyframessize==="undefined")keyframessize=100;keyframessize>>=0;var i;var kfr;var kfd="@-"+prefix+"-keyframes "+name+" {";for(i=0;i<=keyframessize;i++){kfr=""+i/keyframessize*100+"%"+"{"+"-"+prefix+"-transform:"+this.calculateKeyFrameData(i/keyframessize)+"}\n";kfd+=kfr}kfd+="}";return kfd}};extend(CAAT.RotateBehavior,CAAT.Behavior,null)})();
(function(){CAAT.GenericBehavior=function(){CAAT.GenericBehavior.superclass.constructor.call(this);return this};CAAT.GenericBehavior.prototype={start:0,end:0,target:null,property:null,callback:null,setForTime:function(time,actor){var value=this.start+time*(this.end-this.start);if(this.callback)this.callback(value,this.target,actor);if(this.property)this.target[this.property]=value},setValues:function(start,end,target,property,callback){this.start=start;this.end=end;this.target=target;this.property=
property;this.callback=callback;return this}};extend(CAAT.GenericBehavior,CAAT.Behavior,null)})();
(function(){CAAT.ScaleBehavior=function(){CAAT.ScaleBehavior.superclass.constructor.call(this);this.anchor=CAAT.Actor.prototype.ANCHOR_CENTER;return this};CAAT.ScaleBehavior.prototype={startScaleX:1,endScaleX:1,startScaleY:1,endScaleY:1,anchorX:0.5,anchorY:0.5,getPropertyName:function(){return"scale"},setForTime:function(time,actor){var scaleX=this.startScaleX+time*(this.endScaleX-this.startScaleX);var scaleY=this.startScaleY+time*(this.endScaleY-this.startScaleY);if(0===scaleX)scaleX=0.01;if(0===
scaleY)scaleY=0.01;if(this.doValueApplication)actor.setScaleAnchored(scaleX,scaleY,this.anchorX,this.anchorY);return{scaleX:scaleX,scaleY:scaleY}},setValues:function(startX,endX,startY,endY,anchorx,anchory){this.startScaleX=startX;this.endScaleX=endX;this.startScaleY=startY;this.endScaleY=endY;if(typeof anchorx!=="undefined"&&typeof anchory!=="undefined"){this.anchorX=anchorx;this.anchorY=anchory}return this},setAnchor:function(actor,x,y){this.anchorX=x/actor.width;this.anchorY=y/actor.height;return this},
calculateKeyFrameData:function(time){var scaleX;var scaleY;time=this.interpolator.getPosition(time).y;scaleX=this.startScaleX+time*(this.endScaleX-this.startScaleX);scaleY=this.startScaleY+time*(this.endScaleY-this.startScaleY);return"scaleX("+scaleX+") scaleY("+scaleY+")"},calculateKeyFramesData:function(prefix,name,keyframessize){if(typeof keyframessize==="undefined")keyframessize=100;keyframessize>>=0;var i;var kfr;var kfd="@-"+prefix+"-keyframes "+name+" {";for(i=0;i<=keyframessize;i++){kfr=""+
i/keyframessize*100+"%"+"{"+"-"+prefix+"-transform:"+this.calculateKeyFrameData(i/keyframessize)+"}";kfd+=kfr}kfd+="}";return kfd}};extend(CAAT.ScaleBehavior,CAAT.Behavior,null)})();
(function(){CAAT.AlphaBehavior=function(){CAAT.AlphaBehavior.superclass.constructor.call(this);return this};CAAT.AlphaBehavior.prototype={startAlpha:0,endAlpha:0,getPropertyName:function(){return"opacity"},setForTime:function(time,actor){var alpha=this.startAlpha+time*(this.endAlpha-this.startAlpha);if(this.doValueApplication)actor.setAlpha(alpha);return alpha},setValues:function(start,end){this.startAlpha=start;this.endAlpha=end;return this},calculateKeyFrameData:function(time){time=this.interpolator.getPosition(time).y;
return this.startAlpha+time*(this.endAlpha-this.startAlpha)},calculateKeyFramesData:function(prefix,name,keyframessize){if(typeof keyframessize==="undefined")keyframessize=100;keyframessize>>=0;var i;var kfr;var kfd="@-"+prefix+"-keyframes "+name+" {";for(i=0;i<=keyframessize;i++){kfr=""+i/keyframessize*100+"%"+"{"+"opacity: "+this.calculateKeyFrameData(i/keyframessize)+"}";kfd+=kfr}kfd+="}";return kfd}};extend(CAAT.AlphaBehavior,CAAT.Behavior,null)})();
(function(){CAAT.PathBehavior=function(){CAAT.PathBehavior.superclass.constructor.call(this);return this};CAAT.PathBehavior.autorotate={LEFT_TO_RIGHT:0,RIGHT_TO_LEFT:1,FREE:2};CAAT.PathBehavior.prototype={path:null,autoRotate:false,prevX:-1,prevY:-1,autoRotateOp:CAAT.PathBehavior.autorotate.FREE,getPropertyName:function(){return"translate"},setAutoRotate:function(autorotate,autorotateOp){this.autoRotate=autorotate;if(autorotateOp!==undefined)this.autoRotateOp=autorotateOp;return this},setPath:function(path){this.path=
path;return this},setValues:function(path){return this.setPath(path)},setTranslation:function(tx,ty){return this},calculateKeyFrameData:function(time){time=this.interpolator.getPosition(time).y;var point=this.path.getPosition(time);return"translateX("+point.x+"px) translateY("+point.y+"px)"},calculateKeyFramesData:function(prefix,name,keyframessize){if(typeof keyframessize==="undefined")keyframessize=100;keyframessize>>=0;var i;var kfr;var time;var kfd="@-"+prefix+"-keyframes "+name+" {";for(i=0;i<=
keyframessize;i++){kfr=""+i/keyframessize*100+"%"+"{"+"-"+prefix+"-transform:"+this.calculateKeyFrameData(i/keyframessize)+"}";kfd+=kfr}kfd+="}";return kfd},setForTime:function(time,actor){if(!this.path)return{x:actor.x,y:actor.y};var point=this.path.getPosition(time);if(this.autoRotate){if(-1===this.prevX&&-1===this.prevY){this.prevX=point.x;this.prevY=point.y}var ax=point.x-this.prevX;var ay=point.y-this.prevY;if(ax===0&&ay===0){actor.setLocation(point.x,point.y);return{x:actor.x,y:actor.y}}var angle=
Math.atan2(ay,ax);var si=CAAT.SpriteImage.prototype;var pba=CAAT.PathBehavior.autorotate;if(this.autoRotateOp===pba.LEFT_TO_RIGHT)if(this.prevX<=point.x)actor.setImageTransformation(si.TR_NONE);else{actor.setImageTransformation(si.TR_FLIP_HORIZONTAL);angle+=Math.PI}else if(this.autoRotateOp===pba.RIGHT_TO_LEFT)if(this.prevX<=point.x)actor.setImageTransformation(si.TR_FLIP_HORIZONTAL);else{actor.setImageTransformation(si.TR_NONE);angle-=Math.PI}actor.setRotation(angle);this.prevX=point.x;this.prevY=
point.y;var modulo=Math.sqrt(ax*ax+ay*ay);ax/=modulo;ay/=modulo}if(this.doValueApplication){actor.setLocation(point.x,point.y);return{x:actor.x,y:actor.y}}else return{x:point.x,y:point.y}},positionOnTime:function(time){if(this.isBehaviorInTime(time,null)){time=this.normalizeTime(time);return this.path.getPosition(time)}return{x:-1,y:-1}}};extend(CAAT.PathBehavior,CAAT.Behavior)})();(function(){CAAT.ColorBehavior=function(){return this};CAAT.ColorBehavior.prototype={};extend(CAAT.ColorBehavior,CAAT.Behavior)})();
(function(){CAAT.Scale1Behavior=function(){CAAT.Scale1Behavior.superclass.constructor.call(this);this.anchor=CAAT.Actor.prototype.ANCHOR_CENTER;return this};var AXIS_X=0;var AXIS_Y=1;CAAT.Scale1Behavior.AXIS_X=AXIS_X;CAAT.Scale1Behavior.AXIS_Y=AXIS_Y;CAAT.Scale1Behavior.prototype={startScale:1,endScale:1,anchorX:0.5,anchorY:0.5,sx:1,sy:1,applyOnX:true,applyOnAxis:function(axis){if(axis===AXIS_Y)this.applyOnX=false;else this.applyOnX=true},getPropertyName:function(){return"scale"},setForTime:function(time,
actor){var scale=this.startScale+time*(this.endScale-this.startScale);if(0===scale)scale=0.01;if(this.doValueApplication)if(this.applyOnX)actor.setScaleAnchored(scale,actor.scaleY,this.anchorX,this.anchorY);else actor.setScaleAnchored(actor.scaleX,scale,this.anchorX,this.anchorY);return scale},setValues:function(start,end,applyOnX,anchorx,anchory){this.startScale=start;this.endScale=end;this.applyOnX=!!applyOnX;if(typeof anchorx!=="undefined"&&typeof anchory!=="undefined"){this.anchorX=anchorx;this.anchorY=
anchory}return this},setAnchor:function(actor,x,y){this.anchorX=x/actor.width;this.anchorY=y/actor.height;return this},calculateKeyFrameData:function(time){var scale;time=this.interpolator.getPosition(time).y;scale=this.startScale+time*(this.endScale-this.startScale);return this.applyOnX?"scaleX("+scale+")":"scaleY("+scale+")"},calculateKeyFramesData:function(prefix,name,keyframessize){if(typeof keyframessize==="undefined")keyframessize=100;keyframessize>>=0;var i;var kfr;var kfd="@-"+prefix+"-keyframes "+
name+" {";for(i=0;i<=keyframessize;i++){kfr=""+i/keyframessize*100+"%"+"{"+"-"+prefix+"-transform:"+this.calculateKeyFrameData(i/keyframessize)+"}";kfd+=kfr}kfd+="}";return kfd}};extend(CAAT.Scale1Behavior,CAAT.Behavior)})();
(function(){CAAT.CSS={};CAAT.CSS.PREFIX=function(){var prefix="";var prefixes=["WebKit","Moz","O"];var keyframes="";for(var i=0;i<prefixes.length;i++)if(window[prefixes[i]+"CSSKeyframeRule"]){prefix=prefixes[i].toLowerCase();break}CAAT.CSS.PROP_ANIMATION="-"+prefix+"-animation";return prefix}();CAAT.CSS.applyKeyframe=function(domElement,name,secs,forever){domElement.style[CAAT.CSS.PROP_ANIMATION]=name+" "+secs/1E3+"s linear both "+(forever?"infinite":"")};CAAT.CSS.unregisterKeyframes=function(name){var index=
CAAT.CSS.getCSSKeyframesIndex(name);if(-1!==index)document.styleSheets[0].deleteRule(index)};CAAT.CSS.registerKeyframes=function(kfDescriptor){var name=kfDescriptor.name;var behavior=kfDescriptor.behavior;var size=kfDescriptor.size;var overwrite=kfDescriptor.overwrite;if(typeof name==="undefined"||typeof behavior==="undefined")throw"Keyframes must be defined by a name and a CAAT.Behavior instance.";if(typeof size==="undefined")size=100;if(typeof overwrite==="undefined")overwrite=false;var cssRulesIndex=
CAAT.CSS.getCSSKeyframesIndex(name);if(-1!==cssRulesIndex&&!overwrite)return;var keyframesRule=behavior.calculateKeyframesData(CAAT.CSS.PREFIX,name,size);if(document.styleSheets){if(!document.styleSheets.length){var s=document.createElement("style");s.type="text/css";document.getElementsByTagName("head")[0].appendChild(s)}if(-1!==cssRulesIndex)document.styleSheets[0].deleteRule(cssRulesIndex);document.styleSheets[0].insertRule(keyframesRule,0)}};CAAT.CSS.getCSSKeyframesIndex=function(name){var ss=
document.styleSheets;for(var i=ss.length-1;i>=0;i--)try{var s=ss[i],rs=s.cssRules?s.cssRules:s.rules?s.rules:[];for(var j=rs.length-1;j>=0;j--)if((rs[j].type===window.CSSRule.WEBKIT_KEYFRAMES_RULE||rs[j].type===window.CSSRule.MOZ_KEYFRAMES_RULE)&&rs[j].name===name)return j}catch(e){}return-1};CAAT.CSS.getCSSKeyframes=function(name){var ss=document.styleSheets;for(var i=ss.length-1;i>=0;i--)try{var s=ss[i],rs=s.cssRules?s.cssRules:s.rules?s.rules:[];for(var j=rs.length-1;j>=0;j--)if((rs[j].type===
window.CSSRule.WEBKIT_KEYFRAMES_RULE||rs[j].type===window.CSSRule.MOZ_KEYFRAMES_RULE)&&rs[j].name===name)return rs[j]}catch(e){}return null}})();
(function(){CAAT.BrowserDetect=function(){this.init();return this};CAAT.BrowserDetect.prototype={browser:"",version:0,OS:"",init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;var dataProp=data[i].prop;this.versionSearchString=
data[i].versionSearch||data[i].identity;if(dataString){if(dataString.indexOf(data[i].subString)!==-1)return data[i].identity}else if(dataProp)return data[i].identity}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index===-1)return;return parseFloat(dataString.substring(index+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",
identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",
identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Explorer",identity:"Explorer",versionSearch:"Explorer"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},
{string:navigator.platform,subString:"Linux",identity:"Linux"}]}})();
(function(){CAAT.Debug=function(){return this};CAAT.Debug.prototype={width:0,height:0,canvas:null,ctx:null,statistics:null,framerate:null,textContainer:null,textFPS:null,textEntitiesTotal:null,textEntitiesActive:null,textDraws:null,textDrawTime:null,textRAFTime:null,textDirtyRects:null,frameTimeAcc:0,frameRAFAcc:0,canDebug:false,SCALE:60,debugTpl:'    <style type="text/css">'+"        #caat-debug {"+"            z-index: 10000;"+"            position:fixed;"+"            bottom:0;"+"            left:0;"+
"            width:100%;"+"            background-color: rgba(0,0,0,0.8);"+"        }"+"        #caat-debug.caat_debug_max {"+"            margin-bottom: 0px;"+"        }"+"        .caat_debug_bullet {"+"            display:inline-block;"+"            background-color:#f00;"+"            width:8px;"+"            height:8px;"+"            border-radius: 4px;"+"            margin-left:10px;"+"            margin-right:2px;"+"        }"+"        .caat_debug_description {"+"            font-size:11px;"+
"            font-family: helvetica, arial;"+"            color: #aaa;"+"            display: inline-block;"+"        }"+"        .caat_debug_value {"+"            font-size:11px;"+"            font-family: helvetica, arial;"+"            color: #fff;"+"            width:25px;"+"            text-align: right;"+"            display: inline-block;"+"            margin-right: .3em;"+"        }"+"        .caat_debug_indicator {"+"            float: right;"+"        }"+"        #debug_tabs {"+"            border-top: 1px solid #888;"+
"            height:25px;"+"        }"+"        .tab_max_min {"+"            font-family: helvetica, arial;"+"            font-size: 12px;"+"            font-weight: bold;"+"            color: #888;"+"            border-right: 1px solid #888;"+"            float: left;"+"            cursor: pointer;"+"            padding-left: 5px;"+"            padding-right: 5px;"+"            padding-top: 5px;"+"            height: 20px;"+"        }"+"        .debug_tabs_content_hidden {"+"            display: none;"+
"            width: 100%;"+"        }"+"        .debug_tabs_content_visible {"+"            display: block;"+"            width: 100%;"+"        }"+"        .checkbox_enabled {"+"            display:inline-block;"+"            background-color:#eee;"+"            border: 1px solid #eee;"+"            width:6px;"+"            height:8px;"+"            margin-left:12px;"+"            margin-right:2px;"+"            cursor: pointer;"+"        }"+"        .checkbox_disabled {"+"            display:inline-block;"+
"            width:6px;"+"            height:8px;"+"            background-color: #333;"+"            border: 1px solid #eee;"+"            margin-left:12px;"+"            margin-right:2px;"+"            cursor: pointer;"+"        }"+"        .checkbox_description {"+"            font-size:11px;"+"            font-family: helvetica, arial;"+"            color: #fff;"+"        }"+"        .debug_tab {"+"            font-family: helvetica, arial;"+"            font-size: 12px;"+"            color: #fff;"+
"            border-right: 1px solid #888;"+"            float: left;"+"            padding-left: 5px;"+"            padding-right: 5px;"+"            height: 20px;"+"            padding-top: 5px;"+"            cursor: default;"+"        }"+"        .debug_tab_selected {"+"            background-color: #444;"+"            cursor: default;"+"        }"+"        .debug_tab_not_selected {"+"            background-color: #000;"+"            cursor: pointer;"+"        }"+"    </style>"+'    <div id="caat-debug">'+
'        <div id="debug_tabs">'+"            <span class=\"tab_max_min\" onCLick=\"javascript: var debug = document.getElementById('debug_tabs_content');if (debug.className === 'debug_tabs_content_visible') {debug.className = 'debug_tabs_content_hidden'} else {debug.className = 'debug_tabs_content_visible'}\"> CAAT Debug panel </span>"+'            <span id="caat-debug-tab0" class="debug_tab debug_tab_selected">Performance</span>'+'            <span id="caat-debug-tab1" class="debug_tab debug_tab_not_selected">Controls</span>'+
'            <span class="caat_debug_indicator">'+'                <span class="caat_debug_bullet" style="background-color:#0f0;"></span>'+'                <span class="caat_debug_description">Draw Time: </span>'+'                <span class="caat_debug_value" id="textDrawTime">5.46</span>'+'                <span class="caat_debug_description">ms.</span>'+"            </span>"+'            <span class="caat_debug_indicator">'+'                <span class="caat_debug_bullet" style="background-color:#f00;"></span>'+
'                <span class="caat_debug_description">FPS: </span>'+'                <span class="caat_debug_value" id="textFPS">48</span>'+"            </span>"+"        </div>"+'        <div id="debug_tabs_content" class="debug_tabs_content_hidden">'+'            <div id="caat-debug-tab0-content">'+'                <canvas id="caat-debug-canvas" height="60"></canvas>'+"                <div>"+"                    <span>"+'                        <span class="caat_debug_bullet" style="background-color:#0f0;"></span>'+
'                        <span class="caat_debug_description">RAF Time:</span>'+'                        <span class="caat_debug_value" id="textRAFTime">20.76</span>'+'                        <span class="caat_debug_description">ms.</span>'+"                    </span>"+"                    <span>"+'                        <span class="caat_debug_bullet" style="background-color:#0ff;"></span>'+'                        <span class="caat_debug_description">Entities Total: </span>'+'                        <span class="caat_debug_value" id="textEntitiesTotal">41</span>'+
"                    </span>"+"                    <span>"+'                        <span class="caat_debug_bullet" style="background-color:#0ff;"></span>'+'                        <span class="caat_debug_description">Entities Active: </span>'+'                        <span class="caat_debug_value" id="textEntitiesActive">37</span>'+"                    </span>"+"                    <span>"+'                        <span class="caat_debug_bullet" style="background-color:#00f;"></span>'+'                        <span class="caat_debug_description">Draws: </span>'+
'                        <span class="caat_debug_value" id="textDraws">0</span>'+"                    </span>"+"                    <span>"+'                        <span class="caat_debug_bullet" style="background-color:#00f;"></span>'+'                        <span class="caat_debug_description">DirtyRects: </span>'+'                        <span class="caat_debug_value" id="textDirtyRects">0</span>'+"                    </span>"+"                </div>"+"            </div>"+'            <div id="caat-debug-tab1-content">'+
"                <div>"+"                    <div>"+'                        <span id="control-sound"></span>'+'                        <span class="checkbox_description">Sound</span>'+"                    </div>"+"                    <div>"+'                        <span id="control-music"></span>'+'                        <span class="checkbox_description">Music</span>'+"                    </div>"+"                    <div>"+'                        <span id="control-aabb"></span>'+'                        <span class="checkbox_description">AA Bounding Boxes</span>'+
"                    </div>"+"                    <div>"+'                        <span id="control-bb"></span>'+'                        <span class="checkbox_description">Bounding Boxes</span>'+"                    </div>"+"                    <div>"+'                        <span id="control-dr"></span>'+'                        <span class="checkbox_description">Dirty Rects</span>'+"                    </div>"+"                </div>"+"            </div>"+"        </div>"+"    </div>",setScale:function(s){this.scale=
s;return this},initialize:function(w,h){w=window.innerWidth;this.width=w;this.height=h;this.framerate={refreshInterval:CAAT.FPS_REFRESH||500,frames:0,timeLastRefresh:0,fps:0,prevFps:-1,fpsMin:1E3,fpsMax:0};var debugContainer=document.getElementById("caat-debug");if(!debugContainer){var wrap=document.createElement("div");wrap.innerHTML=this.debugTpl;document.body.appendChild(wrap);eval(""+"        function initCheck( name, bool, callback ) {"+"            var elem= document.getElementById(name);"+
"            if ( elem ) {"+'                elem.className= (bool) ? "checkbox_enabled" : "checkbox_disabled";'+"                if ( callback ) {"+'                    elem.addEventListener( "click", (function(elem, callback) {'+"                        return function(e) {"+"                            elem.__value= !elem.__value;"+'                            elem.className= (elem.__value) ? "checkbox_enabled" : "checkbox_disabled";'+"                            callback(e,elem.__value);"+"                        }"+
"                    })(elem, callback), false );"+"                }"+"                elem.__value= bool;"+"            }"+"        }"+"        function setupTabs() {"+"            var numTabs=0;"+"            var elem;"+"            var elemContent;"+"            do {"+'                elem= document.getElementById("caat-debug-tab"+numTabs);'+"                if ( elem ) {"+'                    elemContent= document.getElementById("caat-debug-tab"+numTabs+"-content");'+"                    if ( elemContent ) {"+
"                        elemContent.style.display= numTabs===0 ? 'block' : 'none';"+'                        elem.className= numTabs===0 ? "debug_tab debug_tab_selected" : "debug_tab debug_tab_not_selected";'+'                        elem.addEventListener( "click", (function(tabIndex) {'+"                            return function(e) {"+"                                for( var i=0; i<numTabs; i++ ) {"+'                                    var _elem= document.getElementById("caat-debug-tab"+i);'+
'                                    var _elemContent= document.getElementById("caat-debug-tab"+i+"-content");'+"                                    _elemContent.style.display= i===tabIndex ? 'block' : 'none';"+'                                    _elem.className= i===tabIndex ? "debug_tab debug_tab_selected" : "debug_tab debug_tab_not_selected";'+"                                }"+"                            }"+"                        })(numTabs), false );"+"                    }"+"                    numTabs++;"+
"                }"+"            } while( elem );"+"        }"+'        initCheck( "control-sound", CAAT.director[0].isSoundEffectsEnabled(), function(e, bool) {'+"            CAAT.director[0].setSoundEffectsEnabled(bool);"+"        } );"+'        initCheck( "control-music", CAAT.director[0].isMusicEnabled(), function(e, bool) {'+"            CAAT.director[0].setMusicEnabled(bool);"+"        } );"+'        initCheck( "control-aabb", CAAT.DEBUGBB, function(e,bool) {'+"            CAAT.DEBUGAABB= bool;"+
"            CAAT.director[0].currentScene.dirty= true;"+"        } );"+'        initCheck( "control-bb", CAAT.DEBUGBB, function(e,bool) {'+"            CAAT.DEBUGBB= bool;"+"            if ( bool ) {"+"                CAAT.DEBUGAABB= true;"+"            }"+"            CAAT.director[0].currentScene.dirty= true;"+"        } );"+'        initCheck( "control-dr", CAAT.DEBUG_DIRTYRECTS , function( e,bool ) {'+"            CAAT.DEBUG_DIRTYRECTS= bool;"+"        });"+"        setupTabs();")}this.canvas=
document.getElementById("caat-debug-canvas");if(null===this.canvas){this.canDebug=false;return}this.canvas.width=w;this.canvas.height=h;this.ctx=this.canvas.getContext("2d");this.ctx.fillStyle="#000";this.ctx.fillRect(0,0,this.width,this.height);this.textFPS=document.getElementById("textFPS");this.textDrawTime=document.getElementById("textDrawTime");this.textRAFTime=document.getElementById("textRAFTime");this.textEntitiesTotal=document.getElementById("textEntitiesTotal");this.textEntitiesActive=document.getElementById("textEntitiesActive");
this.textDraws=document.getElementById("textDraws");this.textDirtyRects=document.getElementById("textDirtyRects");this.canDebug=true;return this},debugInfo:function(statistics){this.statistics=statistics;this.frameTimeAcc+=CAAT.FRAME_TIME;this.frameRAFAcc+=CAAT.REQUEST_ANIMATION_FRAME_TIME;this.framerate.frames++;if(CAAT.RAF>this.framerate.timeLastRefresh+this.framerate.refreshInterval){this.framerate.fps=this.framerate.frames*1E3/(CAAT.RAF-this.framerate.timeLastRefresh)|0;this.framerate.fpsMin=
this.framerate.frames>0?Math.min(this.framerate.fpsMin,this.framerate.fps):this.framerate.fpsMin;this.framerate.fpsMax=Math.max(this.framerate.fpsMax,this.framerate.fps);this.textFPS.innerHTML=this.framerate.fps;var value=(this.frameTimeAcc*100/this.framerate.frames|0)/100;this.frameTimeAcc=0;this.textDrawTime.innerHTML=value;var value2=(this.frameRAFAcc*100/this.framerate.frames|0)/100;this.frameRAFAcc=0;this.textRAFTime.innerHTML=value2;this.framerate.timeLastRefresh=CAAT.RAF;this.framerate.frames=
0;this.paint(value2)}this.textEntitiesTotal.innerHTML=this.statistics.size_total;this.textEntitiesActive.innerHTML=this.statistics.size_active;this.textDirtyRects.innerHTML=this.statistics.size_dirtyRects;this.textDraws.innerHTML=this.statistics.draws},paint:function(rafValue){var ctx=this.ctx;var t=0;ctx.drawImage(this.canvas,1,0,this.width-1,this.height,0,0,this.width-1,this.height);ctx.strokeStyle="black";ctx.beginPath();ctx.moveTo(this.width-0.5,0);ctx.lineTo(this.width-0.5,this.height);ctx.stroke();
ctx.strokeStyle="#a22";ctx.beginPath();t=this.height-(20/this.SCALE*this.height>>0)-0.5;ctx.moveTo(0.5,t);ctx.lineTo(this.width+0.5,t);ctx.stroke();ctx.strokeStyle="#aa2";ctx.beginPath();t=this.height-(30/this.SCALE*this.height>>0)-0.5;ctx.moveTo(0.5,t);ctx.lineTo(this.width+0.5,t);ctx.stroke();var fps=Math.min(this.height-this.framerate.fps/this.SCALE*this.height,59);if(-1===this.framerate.prevFps)this.framerate.prevFps=fps|0;ctx.strokeStyle="#0ff";ctx.beginPath();ctx.moveTo(this.width,(fps|0)-0.5);
ctx.lineTo(this.width,this.framerate.prevFps-0.5);ctx.stroke();this.framerate.prevFps=fps;var t1=(this.height-rafValue/this.SCALE*this.height>>0)-0.5;ctx.strokeStyle="#ff0";ctx.beginPath();ctx.moveTo(this.width,t1);ctx.lineTo(this.width,t1);ctx.stroke()}}})();
(function(){var __index=0;CAAT.Actor=function(){this.behaviorList=[];this.lifecycleListenerList=[];this.AABB=new CAAT.Rectangle;this.viewVertices=[new CAAT.Point(0,0,0),new CAAT.Point(0,0,0),new CAAT.Point(0,0,0),new CAAT.Point(0,0,0)];this.scaleAnchor=this.ANCHOR_CENTER;this.modelViewMatrix=new CAAT.Matrix;this.worldModelViewMatrix=new CAAT.Matrix;this.resetTransform();this.setScale(1,1);this.setRotation(0);this.id=__index++;return this};CAAT.Actor.__reflectionInfo={"x":"property:x, type:number",
"y":"property:y, type:number","scaleX":"property:scaleX, type:number","scaleY":"property:scaleY, type:number","cached":"get:isCached(), type:boolean"};CAAT.Actor.ANCHOR_CENTER=0;CAAT.Actor.ANCHOR_TOP=1;CAAT.Actor.ANCHOR_BOTTOM=2;CAAT.Actor.ANCHOR_LEFT=3;CAAT.Actor.ANCHOR_RIGHT=4;CAAT.Actor.ANCHOR_TOP_LEFT=5;CAAT.Actor.ANCHOR_TOP_RIGHT=6;CAAT.Actor.ANCHOR_BOTTOM_LEFT=7;CAAT.Actor.ANCHOR_BOTTOM_RIGHT=8;CAAT.Actor.ANCHOR_CUSTOM=9;CAAT.Actor.CACHE_SIMPLE=1;CAAT.Actor.CACHE_DEEP=2;CAAT.Actor.prototype=
{lifecycleListenerList:null,behaviorList:null,parent:null,x:0,y:0,width:0,height:0,start_time:0,duration:Number.MAX_VALUE,clip:false,clipPath:null,tAnchorX:0,tAnchorY:0,scaleX:0,scaleY:0,scaleTX:0.5,scaleTY:0.5,scaleAnchor:0,rotationAngle:0,rotationY:0.5,rotationX:0.5,alpha:1,isGlobalAlpha:false,frameAlpha:1,expired:false,discardable:false,pointed:false,mouseEnabled:true,visible:true,ANCHOR_CENTER:0,ANCHOR_TOP:1,ANCHOR_BOTTOM:2,ANCHOR_LEFT:3,ANCHOR_RIGHT:4,ANCHOR_TOP_LEFT:5,ANCHOR_TOP_RIGHT:6,ANCHOR_BOTTOM_LEFT:7,
ANCHOR_BOTTOM_RIGHT:8,ANCHOR_CUSTOM:9,fillStyle:null,strokeStyle:null,time:0,AABB:null,viewVertices:null,inFrame:false,dirty:true,wdirty:true,oldX:-1,oldY:-1,modelViewMatrix:null,worldModelViewMatrix:null,modelViewMatrixI:null,worldModelViewMatrixI:null,glEnabled:false,backgroundImage:null,id:null,size_active:1,size_total:1,__d_ax:-1,__d_ay:-1,gestureEnabled:false,invalid:true,cached:0,collides:false,collidesAsRect:true,isAA:true,create:function(){return this},moveTo:function(x,y,duration,delay,interpolator){var id=
"__moveTo";var b=this.getBehavior(id);if(!b){b=(new CAAT.PathBehavior).setId(id).setValues(new CAAT.LinearPath);this.addBehavior(b)}b.path.setInitialPosition(this.x,this.y).setFinalPosition(x,y);b.setDelayTime(delay?delay:0,duration);if(interpolator)b.setInterpolator(interpolator);return this},rotateTo:function(angle,duration,delay,anchorX,anchorY,interpolator){var id="__rotateTo";var b=this.getBehavior(id);if(!b){b=(new CAAT.RotateBehavior).setId(id).setValues(0,0,0.5,0.5);this.addBehavior(b)}b.setValues(this.rotationAngle,
angle,anchorX,anchorY).setDelayTime(delay?delay:0,duration);if(interpolator)b.setInterpolator(interpolator);return this},scaleTo:function(scaleX,scaleY,duration,delay,anchorX,anchorY,interpolator){var id="__scaleTo";var b=this.getBehavior(id);if(!b){b=(new CAAT.ScaleBehavior).setId(id).setValues(1,1,1,1,0.5,0.5);this.addBehavior(b)}b.setValues(this.scaleX,this.scaleY,scaleX,scaleY,anchorX,anchorY).setDelayTime(delay?delay:0,duration);if(interpolator)b.setInterpolator(interpolator);return this},scaleXTo:function(scaleX,
duration,delay,anchorX,anchorY,interpolator){return this.__scale1To(CAAT.Scale1Behavior.AXIS_X,scaleX,duration,delay,anchorX,anchorY,interpolator)},scaleYTo:function(scaleY,duration,delay,anchorX,anchorY,interpolator){return this.__scale1To(CAAT.Scale1Behavior.AXIS_Y,scaleY,duration,delay,anchorX,anchorY,interpolator)},__scale1To:function(axis,scale,duration,delay,anchorX,anchorY,interpolator){var id="__scaleXTo";var b=this.getBehavior(id);if(!b){b=(new CAAT.Scale1Behavior).setId(id).setValues(1,
1,axis===CAAT.Scale1Behavior.AXIS_X,0.5,0.5);this.addBehavior(b)}b.setValues(axis?this.scaleX:this.scaleY,scale,anchorX,anchorY).setDelayTime(delay?delay:0,duration);if(interpolator)b.setInterpolator(interpolator);return this},touchStart:function(e){},touchMove:function(e){},touchEnd:function(e){},gestureStart:function(rotation,scaleX,scaleY){},gestureChange:function(rotation,scaleX,scaleY){if(this.gestureEnabled){this.setRotation(rotation);this.setScale(scaleX,scaleY)}return this},gestureEnd:function(rotation,
scaleX,scaleY){},isVisible:function(){return this.isVisible},setupCollission:function(collides,isCircular){this.collides=collides;this.collidesAsRect=!isCircular},invalidate:function(){this.invalid=true},setGestureEnabled:function(enable){this.gestureEnabled=!!enable;return this},isGestureEnabled:function(){return this.gestureEnabled},getId:function(){return this.id},setId:function(id){this.id=id;return this},setParent:function(parent){this.parent=parent;return this},setBackgroundImage:function(image,
adjust_size_to_image){if(image){if(!(image instanceof CAAT.SpriteImage))image=(new CAAT.SpriteImage).initialize(image,1,1);image.setOwner(this);this.backgroundImage=image;if(typeof adjust_size_to_image==="undefined"||adjust_size_to_image){this.width=image.getWidth();this.height=image.getHeight()}this.glEnabled=true;this.invalidate()}else this.backgroundImage=null;return this},setSpriteIndex:function(index){if(this.backgroundImage){this.backgroundImage.setSpriteIndex(index);this.invalidate()}return this},
setBackgroundImageOffset:function(ox,oy){if(this.backgroundImage)this.backgroundImage.setOffset(ox,oy);return this},setAnimationImageIndex:function(ii){if(this.backgroundImage){this.backgroundImage.resetAnimationTime();this.backgroundImage.setAnimationImageIndex(ii);this.invalidate()}return this},resetAnimationTime:function(){if(this.backgroundImage){this.backgroundImage.resetAnimationTime();this.invalidate()}return this},setChangeFPS:function(time){if(this.backgroundImage)this.backgroundImage.setChangeFPS(time);
return this},setImageTransformation:function(it){if(this.backgroundImage)this.backgroundImage.setSpriteTransformation(it);return this},centerOn:function(x,y){this.setLocation(x-this.width/2,y-this.height/2);return this},centerAt:function(x,y){return this.centerOn(x,y)},getTextureGLPage:function(){return this.backgroundImage.image.__texturePage},setVisible:function(visible){this.invalidate();if(CAAT.currentDirector&&CAAT.currentDirector.dirtyRectsEnabled&&!visible&&this.visible)CAAT.currentDirector.scheduleDirtyRect(this.AABB);
this.visible=visible;return this},setOutOfFrameTime:function(){this.setFrameTime(-1,0);return this},addListener:function(actorListener){this.lifecycleListenerList.push(actorListener);return this},removeListener:function(actorListener){var n=this.lifecycleListenerList.length;while(n--)if(this.lifecycleListenerList[n]===actorListener){this.lifecycleListenerList.splice(n,1);return}},setGlobalAlpha:function(global){this.isGlobalAlpha=global;return this},fireEvent:function(sEventType,time){for(var i=0;i<
this.lifecycleListenerList.length;i++)this.lifecycleListenerList[i].actorLifeCycleEvent(this,sEventType,time)},setExpired:function(time){this.expired=true;this.fireEvent("expired",time);return this},enableEvents:function(enable){this.mouseEnabled=enable;return this},emptyBehaviorList:function(){this.behaviorList=[];return this},setFillStyle:function(style){this.fillStyle=style;this.invalidate();return this},setStrokeStyle:function(style){this.strokeStyle=style;this.invalidate();return this},setPaint:function(paint){return this.setFillStyle(paint)},
setAlpha:function(alpha){this.alpha=alpha;this.invalidate();return this},resetTransform:function(){this.rotationAngle=0;this.rotationX=0.5;this.rotationY=0.5;this.scaleX=1;this.scaleY=1;this.scaleTX=0.5;this.scaleTY=0.5;this.scaleAnchor=0;this.oldX=-1;this.oldY=-1;this.dirty=true;return this},setFrameTime:function(startTime,duration){this.start_time=startTime;this.duration=duration;this.expired=false;this.dirty=true;return this},paint:function(director,time){if(this.backgroundImage)this.backgroundImage.paint(director,
time,0,0);else if(this.fillStyle){var ctx=director.crc;ctx.fillStyle=this.fillStyle;ctx.fillRect(0,0,this.width,this.height)}},setScale:function(sx,sy){this.scaleX=sx;this.scaleY=sy;this.dirty=true;return this},getAnchorPercent:function(anchor){var anchors=[0.5,0.5,0.5,0,0.5,1,0,0.5,1,0.5,0,0,1,0,0,1,1,1];return{x:anchors[anchor*2],y:anchors[anchor*2+1]}},getAnchor:function(anchor){var tx=0,ty=0;switch(anchor){case this.ANCHOR_CENTER:tx=0.5;ty=0.5;break;case this.ANCHOR_TOP:tx=0.5;ty=0;break;case this.ANCHOR_BOTTOM:tx=
0.5;ty=1;break;case this.ANCHOR_LEFT:tx=0;ty=0.5;break;case this.ANCHOR_RIGHT:tx=1;ty=0.5;break;case this.ANCHOR_TOP_RIGHT:tx=1;ty=0;break;case this.ANCHOR_BOTTOM_LEFT:tx=0;ty=1;break;case this.ANCHOR_BOTTOM_RIGHT:tx=1;ty=1;break;case this.ANCHOR_TOP_LEFT:tx=0;ty=0;break}return{x:tx,y:ty}},setGlobalAnchor:function(ax,ay){this.tAnchorX=ax;this.rotationX=ax;this.scaleTX=ax;this.tAnchorY=ay;this.rotationY=ay;this.scaleTY=ay;this.dirty=true;return this},setScaleAnchor:function(sax,say){this.scaleTX=sax;
this.scaleTY=say;this.dirty=true;return this},setScaleAnchored:function(sx,sy,anchorx,anchory){this.scaleTX=anchorx;this.scaleTY=anchory;this.scaleX=sx;this.scaleY=sy;this.dirty=true;return this},setRotationAnchor:function(rax,ray){this.rotationX=ray;this.rotationY=rax;this.dirty=true;return this},setRotation:function(angle){this.rotationAngle=angle;this.dirty=true;return this},setRotationAnchored:function(angle,rx,ry){this.rotationAngle=angle;this.rotationX=rx;this.rotationY=ry;this.dirty=true;return this},
setSize:function(w,h){this.width=w|0;this.height=h|0;this.dirty=true;return this},setBounds:function(x,y,w,h){this.x=x;this.y=y;this.width=w;this.height=h;this.dirty=true;return this},setLocation:function(x,y){this.x=x;this.y=y;this.oldX=x;this.oldY=y;this.dirty=true;return this},setPosition:function(x,y){return this.setLocation(x,y)},setPositionAnchor:function(pax,pay){this.tAnchorX=pax;this.tAnchorY=pay;return this},setPositionAnchored:function(x,y,pax,pay){this.setLocation(x,y);this.tAnchorX=pax;
this.tAnchorY=pay;return this},isInAnimationFrame:function(time){if(this.expired)return false;if(this.duration===Number.MAX_VALUE)return this.start_time<=time;if(time>=this.start_time+this.duration){if(!this.expired)this.setExpired(time);return false}return this.start_time<=time&&time<this.start_time+this.duration},contains:function(x,y){return x>=0&&y>=0&&x<this.width&&y<this.height},addBehavior:function(behavior){this.behaviorList.push(behavior);return this},removeBehaviour:function(behavior){var c=
this.behaviorList;var n=c.length-1;while(n)if(c[n]===behavior){c.splice(n,1);return this}return this},removeBehaviorById:function(id){var c=this.behaviorList;for(var n=0;n<c.length;n++)if(c[n].id===id)c.splice(n,1);return this},getBehavior:function(id){var c=this.behaviorList;for(var n=0;n<c.length;n++){var cc=c[n];if(cc.id===id)return cc}return null},setDiscardable:function(discardable){this.discardable=discardable;return this},destroy:function(time){if(this.parent)this.parent.removeChild(this);
this.fireEvent("destroyed",time)},modelToView:function(point){var x,y,pt,tm;if(this.dirty)this.setModelViewMatrix();tm=this.worldModelViewMatrix.matrix;if(point instanceof Array)for(var i=0;i<point.length;i++){pt=point[i];x=pt.x;y=pt.y;pt.x=x*tm[0]+y*tm[1]+tm[2];pt.y=x*tm[3]+y*tm[4]+tm[5]}else{x=point.x;y=point.y;point.x=x*tm[0]+y*tm[1]+tm[2];point.y=x*tm[3]+y*tm[4]+tm[5]}return point},modelToModel:function(point,otherActor){if(this.dirty)this.setModelViewMatrix();return otherActor.viewToModel(this.modelToView(point))},
viewToModel:function(point){if(this.dirty)this.setModelViewMatrix();this.worldModelViewMatrixI=this.worldModelViewMatrix.getInverse();this.worldModelViewMatrixI.transformCoord(point);return point},findActorAtPosition:function(point){if(!this.visible||!this.mouseEnabled||!this.isInAnimationFrame(this.time))return null;this.modelViewMatrixI=this.modelViewMatrix.getInverse();this.modelViewMatrixI.transformCoord(point);return this.contains(point.x,point.y)?this:null},enableDrag:function(){this.ax=0;this.ay=
0;this.asx=1;this.asy=1;this.ara=0;this.screenx=0;this.screeny=0;this.mouseEnter=function(mouseEvent){this.__d_ax=-1;this.__d_ay=-1;this.pointed=true;CAAT.setCursor("move")};this.mouseExit=function(mouseEvent){this.__d_ax=-1;this.__d_ay=-1;this.pointed=false;CAAT.setCursor("default")};this.mouseMove=function(mouseEvent){};this.mouseUp=function(mouseEvent){this.__d_ax=-1;this.__d_ay=-1};this.mouseDrag=function(mouseEvent){var pt;pt=this.modelToView(new CAAT.Point(mouseEvent.x,mouseEvent.y));this.parent.viewToModel(pt);
if(this.__d_ax===-1||this.__d_ay===-1){this.__d_ax=pt.x;this.__d_ay=pt.y;this.__d_asx=this.scaleX;this.__d_asy=this.scaleY;this.__d_ara=this.rotationAngle;this.__d_screenx=mouseEvent.screenPoint.x;this.__d_screeny=mouseEvent.screenPoint.y}if(mouseEvent.isShiftDown()){var scx=(mouseEvent.screenPoint.x-this.__d_screenx)/100;var scy=(mouseEvent.screenPoint.y-this.__d_screeny)/100;if(!mouseEvent.isAltDown()){var sc=Math.max(scx,scy);scx=sc;scy=sc}this.setScale(scx+this.__d_asx,scy+this.__d_asy)}else if(mouseEvent.isControlDown()){var vx=
mouseEvent.screenPoint.x-this.__d_screenx;var vy=mouseEvent.screenPoint.y-this.__d_screeny;this.setRotation(-Math.atan2(vx,vy)+this.__d_ara)}else{this.x+=pt.x-this.__d_ax;this.y+=pt.y-this.__d_ay}this.__d_ax=pt.x;this.__d_ay=pt.y};return this},disableDrag:function(){this.mouseEnter=function(mouseEvent){};this.mouseExit=function(mouseEvent){};this.mouseMove=function(mouseEvent){};this.mouseUp=function(mouseEvent){};this.mouseDrag=function(mouseEvent){};return this},mouseClick:function(mouseEvent){},
mouseDblClick:function(mouseEvent){},mouseEnter:function(mouseEvent){this.pointed=true},mouseExit:function(mouseEvent){this.pointed=false},mouseMove:function(mouseEvent){},mouseDown:function(mouseEvent){},mouseUp:function(mouseEvent){},mouseOut:function(mouseEvent){},mouseOver:function(mouseEvent){},mouseDrag:function(mouseEvent){},drawScreenBoundingBox:function(director,time){if(null!==this.AABB&&this.inFrame){var s=this.AABB;var ctx=director.ctx;ctx.strokeStyle=CAAT.DEBUGAABBCOLOR;ctx.strokeRect(0.5+
(s.x|0),0.5+(s.y|0),s.width|0,s.height|0);if(CAAT.DEBUGBB){var vv=this.viewVertices;ctx.beginPath();ctx.lineTo(vv[0].x,vv[0].y);ctx.lineTo(vv[1].x,vv[1].y);ctx.lineTo(vv[2].x,vv[2].y);ctx.lineTo(vv[3].x,vv[3].y);ctx.closePath();ctx.strokeStyle=CAAT.DEBUGBBCOLOR;ctx.stroke()}}},animate:function(director,time){if(!this.visible)return false;var i;if(!this.isInAnimationFrame(time)){this.inFrame=false;this.dirty=true;return false}if(this.x!==this.oldX||this.y!==this.oldY){this.dirty=true;this.oldX=this.x;
this.oldY=this.y}for(i=0;i<this.behaviorList.length;i++)this.behaviorList[i].apply(time,this);if(this.clipPath)this.clipPath.applyBehaviors(time);this.setModelViewMatrix();if(this.dirty||this.wdirty||this.invalid){if(director.dirtyRectsEnabled)director.addDirtyRect(this.AABB);this.setScreenBounds();if(director.dirtyRectsEnabled)director.addDirtyRect(this.AABB)}this.dirty=false;this.invalid=false;this.inFrame=true;return this.AABB.intersects(director.AABB)},setModelViewMatrix:function(){var c,s,_m00,
_m01,_m10,_m11;var mm0,mm1,mm2,mm3,mm4,mm5;var mm;this.wdirty=false;mm=this.modelViewMatrix.matrix;if(this.dirty){mm0=1;mm1=0;mm3=0;mm4=1;mm2=this.x-this.tAnchorX*this.width;mm5=this.y-this.tAnchorY*this.height;if(this.rotationAngle){var rx=this.rotationX*this.width;var ry=this.rotationY*this.height;mm2+=mm0*rx+mm1*ry;mm5+=mm3*rx+mm4*ry;c=Math.cos(this.rotationAngle);s=Math.sin(this.rotationAngle);_m00=mm0;_m01=mm1;_m10=mm3;_m11=mm4;mm0=_m00*c+_m01*s;mm1=-_m00*s+_m01*c;mm3=_m10*c+_m11*s;mm4=-_m10*
s+_m11*c;mm2+=-mm0*rx-mm1*ry;mm5+=-mm3*rx-mm4*ry}if(this.scaleX!=1||this.scaleY!=1){var sx=this.scaleTX*this.width;var sy=this.scaleTY*this.height;mm2+=mm0*sx+mm1*sy;mm5+=mm3*sx+mm4*sy;mm0=mm0*this.scaleX;mm1=mm1*this.scaleY;mm3=mm3*this.scaleX;mm4=mm4*this.scaleY;mm2+=-mm0*sx-mm1*sy;mm5+=-mm3*sx-mm4*sy}mm[0]=mm0;mm[1]=mm1;mm[2]=mm2;mm[3]=mm3;mm[4]=mm4;mm[5]=mm5}if(this.parent){this.isAA=this.rotationAngle===0&&this.scaleX===1&&this.scaleY===1&&this.parent.isAA;if(this.dirty||this.parent.wdirty){this.worldModelViewMatrix.copy(this.parent.worldModelViewMatrix);
if(this.isAA){var mmm=this.worldModelViewMatrix.matrix;mmm[2]+=mm[2];mmm[5]+=mm[5]}else this.worldModelViewMatrix.multiply(this.modelViewMatrix);this.wdirty=true}}else{if(this.dirty)this.wdirty=true;this.worldModelViewMatrix.identity();this.isAA=this.rotationAngle===0&&this.scaleX===1&&this.scaleY===1}},setScreenBounds:function(){var AABB=this.AABB;var vv=this.viewVertices;if(this.isAA){var m=this.worldModelViewMatrix.matrix;var x=m[2];var y=m[5];var w=this.width;var h=this.height;AABB.x=x;AABB.y=
y;AABB.x1=x+w;AABB.y1=y+h;AABB.width=w;AABB.height=h;if(CAAT.GLRENDER){var vvv;vvv=vv[0];vvv.x=x;vvv.y=y;vvv=vv[1];vvv.x=x+w;vvv.y=y;vvv=vv[2];vvv.x=x+w;vvv.y=y+h;vvv=vv[3];vvv.x=x;vvv.y=y+h}return this}var vvv;vvv=vv[0];vvv.x=0;vvv.y=0;vvv=vv[1];vvv.x=this.width;vvv.y=0;vvv=vv[2];vvv.x=this.width;vvv.y=this.height;vvv=vv[3];vvv.x=0;vvv.y=this.height;this.modelToView(this.viewVertices);var xmin=Number.MAX_VALUE,xmax=-Number.MAX_VALUE;var ymin=Number.MAX_VALUE,ymax=-Number.MAX_VALUE;vvv=vv[0];if(vvv.x<
xmin)xmin=vvv.x;if(vvv.x>xmax)xmax=vvv.x;if(vvv.y<ymin)ymin=vvv.y;if(vvv.y>ymax)ymax=vvv.y;var vvv=vv[1];if(vvv.x<xmin)xmin=vvv.x;if(vvv.x>xmax)xmax=vvv.x;if(vvv.y<ymin)ymin=vvv.y;if(vvv.y>ymax)ymax=vvv.y;var vvv=vv[2];if(vvv.x<xmin)xmin=vvv.x;if(vvv.x>xmax)xmax=vvv.x;if(vvv.y<ymin)ymin=vvv.y;if(vvv.y>ymax)ymax=vvv.y;var vvv=vv[3];if(vvv.x<xmin)xmin=vvv.x;if(vvv.x>xmax)xmax=vvv.x;if(vvv.y<ymin)ymin=vvv.y;if(vvv.y>ymax)ymax=vvv.y;AABB.x=xmin;AABB.y=ymin;AABB.x1=xmax;AABB.y1=ymax;AABB.width=xmax-xmin;
AABB.height=ymax-ymin;return this},paintActor:function(director,time){if(!this.visible)return true;var ctx=director.ctx;this.frameAlpha=this.parent?this.parent.frameAlpha*this.alpha:1;ctx.globalAlpha=this.frameAlpha;director.modelViewMatrix.transformRenderingContextSet(ctx);this.worldModelViewMatrix.transformRenderingContext(ctx);if(this.clip){ctx.beginPath();if(!this.clipPath)ctx.rect(0,0,this.width,this.height);else this.clipPath.applyAsPath(director);ctx.clip()}this.paint(director,time);return true},
__paintActor:function(director,time){if(!this.visible)return true;var ctx=director.ctx;this.frameAlpha=this.alpha;var m=this.worldModelViewMatrix.matrix;ctx.setTransform(m[0],m[3],m[1],m[4],m[2],m[5],this.frameAlpha);this.paint(director,time);return true},paintActorGL:function(director,time){this.frameAlpha=this.parent.frameAlpha*this.alpha;if(!this.glEnabled||!this.visible)return;if(this.glNeedsFlush(director)){director.glFlush();this.glSetShader(director);if(!this.__uv)this.__uv=new Float32Array(8);
if(!this.__vv)this.__vv=new Float32Array(12);this.setGLCoords(this.__vv,0);this.setUV(this.__uv,0);director.glRender(this.__vv,12,this.__uv);return}var glCoords=director.coords;var glCoordsIndex=director.coordsIndex;this.setGLCoords(glCoords,glCoordsIndex);director.coordsIndex=glCoordsIndex+12;this.setUV(director.uv,director.uvIndex);director.uvIndex+=8},setGLCoords:function(glCoords,glCoordsIndex){var vv=this.viewVertices;glCoords[glCoordsIndex++]=vv[0].x;glCoords[glCoordsIndex++]=vv[0].y;glCoords[glCoordsIndex++]=
0;glCoords[glCoordsIndex++]=vv[1].x;glCoords[glCoordsIndex++]=vv[1].y;glCoords[glCoordsIndex++]=0;glCoords[glCoordsIndex++]=vv[2].x;glCoords[glCoordsIndex++]=vv[2].y;glCoords[glCoordsIndex++]=0;glCoords[glCoordsIndex++]=vv[3].x;glCoords[glCoordsIndex++]=vv[3].y;glCoords[glCoordsIndex++]=0},setUV:function(uvBuffer,uvIndex){this.backgroundImage.setUV(uvBuffer,uvIndex)},glNeedsFlush:function(director){if(this.getTextureGLPage()!==director.currentTexturePage)return true;if(this.frameAlpha!==director.currentOpacity)return true;
return false},glSetShader:function(director){var tp=this.getTextureGLPage();if(tp!==director.currentTexturePage)director.setGLTexturePage(tp);if(this.frameAlpha!==director.currentOpacity)director.setGLCurrentOpacity(this.frameAlpha)},endAnimate:function(director,time){return this},initialize:function(overrides){if(overrides)for(var i in overrides)this[i]=overrides[i];return this},setClip:function(enable,clipPath){this.clip=enable;this.clipPath=clipPath;return this},cacheAsBitmap:function(time,strategy){time=
time||0;var canvas=document.createElement("canvas");canvas.width=this.width;canvas.height=this.height;var ctx=canvas.getContext("2d");var director={ctx:ctx,crc:ctx,modelViewMatrix:new CAAT.Matrix};this.cached=false;this.paintActor(director,time);this.setBackgroundImage(canvas);this.cached=strategy?strategy:CAAT.Actor.CACHE_SIMPLE;return this},setAsButton:function(buttonImage,iNormal,iOver,iPress,iDisabled,fn){var me=this;this.setBackgroundImage(buttonImage,true);this.iNormal=iNormal||0;this.iOver=
iOver||this.iNormal;this.iPress=iPress||this.iNormal;this.iDisabled=iDisabled||this.iNormal;this.fnOnClick=fn;this.enabled=true;this.setSpriteIndex(iNormal);this.setEnabled=function(enabled){this.enabled=enabled;this.setSpriteIndex(this.enabled?this.iNormal:this.iDisabled);return this};this.actionPerformed=function(event){if(this.enabled&&this.fnOnClick)this.fnOnClick(this)};this.mouseEnter=function(mouseEvent){if(!this.enabled)return;if(this.dragging)this.setSpriteIndex(this.iPress);else this.setSpriteIndex(this.iOver);
CAAT.setCursor("pointer")};this.mouseExit=function(mouseEvent){if(!this.enabled)return;this.setSpriteIndex(this.iNormal);CAAT.setCursor("default")};this.mouseDown=function(mouseEvent){if(!this.enabled)return;this.setSpriteIndex(this.iPress)};this.mouseUp=function(mouseEvent){if(!this.enabled)return;this.setSpriteIndex(this.iNormal);this.dragging=false};this.mouseClick=function(mouseEvent){};this.mouseDrag=function(mouseEvent){if(!this.enabled)return;this.dragging=true};this.setButtonImageIndex=function(_normal,
_over,_press,_disabled){this.iNormal=_normal||0;this.iOver=_over||this.iNormal;this.iPress=_press||this.iNormal;this.iDisabled=_disabled||this.iNormal;this.setSpriteIndex(this.iNormal);return this};return this}}})();
(function(){var __CD=2;CAAT.ActorContainer=function(hint){CAAT.ActorContainer.superclass.constructor.call(this);this.childrenList=[];this.activeChildren=[];this.pendingChildrenList=[];if(typeof hint!=="undefined"){this.addHint=hint;this.boundingBox=new CAAT.Rectangle}return this};CAAT.ActorContainer.AddHint={CONFORM:1};CAAT.ActorContainer.prototype={childrenList:null,activeChildren:null,pendingChildrenList:null,addHint:0,boundingBox:null,runion:new CAAT.Rectangle,drawScreenBoundingBox:function(director,
time){if(!this.inFrame)return;var cl=this.childrenList;for(var i=0;i<cl.length;i++)cl[i].drawScreenBoundingBox(director,time);CAAT.ActorContainer.superclass.drawScreenBoundingBox.call(this,director,time)},emptyChildren:function(){this.childrenList=[];return this},paintActor:function(director,time){if(!this.visible)return true;var ctx=director.ctx;ctx.save();CAAT.ActorContainer.superclass.paintActor.call(this,director,time);if(this.cached===__CD)return;if(!this.isGlobalAlpha)this.frameAlpha=this.parent?
this.parent.frameAlpha:1;for(var i=0,l=this.activeChildren.length;i<l;++i){var actor=this.activeChildren[i];if(actor.visible){ctx.save();actor.paintActor(director,time);ctx.restore()}}ctx.restore();return true},__paintActor:function(director,time){if(!this.visible)return true;var ctx=director.ctx;this.frameAlpha=this.parent?this.parent.frameAlpha*this.alpha:1;var m=this.worldModelViewMatrix.matrix;ctx.setTransform(m[0],m[3],m[1],m[4],m[2],m[5],this.frameAlpha);this.paint(director,time);if(!this.isGlobalAlpha)this.frameAlpha=
this.parent?this.parent.frameAlpha:1;for(var i=0,l=this.activeChildren.length;i<l;++i){var actor=this.activeChildren[i];actor.paintActor(director,time)}return true},paintActorGL:function(director,time){var i,c;if(!this.visible)return true;CAAT.ActorContainer.superclass.paintActorGL.call(this,director,time);if(!this.isGlobalAlpha)this.frameAlpha=this.parent.frameAlpha;for(var i=0,l=this.activeChildren.length;i<l;++i){var c=this.activeChildren[i];c.paintActorGL(director,time)}},animate:function(director,
time){if(!this.visible)return false;this.activeChildren=[];var last=null;if(false===CAAT.ActorContainer.superclass.animate.call(this,director,time))return false;if(this.cached===__CD)return true;var i,l;var pcl=this.pendingChildrenList;for(i=0;i<pcl.length;i++){var child=pcl[i];this.addChildImmediately(child)}this.pendingChildrenList=[];var markDelete=[];var cl=this.childrenList;this.size_active=1;this.size_total=1;for(i=0;i<cl.length;i++){var actor=cl[i];actor.time=time;this.size_total+=actor.size_total;
if(actor.animate(director,time)){this.activeChildren.push(actor);this.size_active+=actor.size_active}else if(actor.expired&&actor.discardable)markDelete.push(actor)}for(i=0,l=markDelete.length;i<l;i++){var md=markDelete[i];md.destroy(time);if(director.dirtyRectsEnabled)director.addDirtyRect(md.AABB)}return true},endAnimate:function(director,time){},addChildImmediately:function(child){return this.addChild(child)},addChild:function(child){if(child.parent!=null)throw"adding to a container an element with parent.";
child.parent=this;this.childrenList.push(child);child.dirty=true;if(this.addHint===CAAT.ActorContainer.AddHint.CONFORM)this.recalcSize();return this},recalcSize:function(){var bb=this.boundingBox;bb.setEmpty();var cl=this.childrenList;var ac;for(var i=0;i<cl.length;i++){ac=cl[i];this.runion.setBounds(ac.x<0?0:ac.x,ac.y<0?0:ac.y,ac.width,ac.height);bb.unionRectangle(this.runion)}this.setSize(bb.x1,bb.y1);return this},addChildDelayed:function(child){this.pendingChildrenList.push(child);return this},
addChildAt:function(child,index){if(index<=0){child.parent=this;child.dirty=true;this.childrenList.splice(0,0,child);return this}else if(index>=this.childrenList.length)index=this.childrenList.length;child.parent=this;child.dirty=true;this.childrenList.splice(index,0,child);return this},findActorById:function(id){var cl=this.childrenList;for(var i=0,l=cl.length;i<l;i++)if(cl[i].id===id)return cl[i];return null},findChild:function(child){var cl=this.childrenList;var i=0;var len=cl.length;for(i=0;i<
len;i++)if(cl[i]===child)return i;return-1},removeChildAt:function(pos){var cl=this.childrenList;var rm;if(-1!==pos){cl[pos].setParent(null);rm=cl.splice(pos,1);if(rm[0].isVisible()&&CAAT.currentDirector.dirtyRectsEnabled)CAAT.currentDirector.scheduleDirtyRect(rm[0].AABB);return rm[0]}return null},removeChild:function(child){var pos=this.findChild(child);return this.removeChildAt(pos)},removeFirstChild:function(){var first=this.childrenList.shift();first.parent=null;if(first.isVisible()&&CAAT.currentDirector.dirtyRectsEnabled)CAAT.currentDirector.scheduleDirtyRect(first.AABB);
return first},removeLastChild:function(){if(this.childrenList.length){var last=this.childrenList.pop();last.parent=null;if(last.isVisible()&&CAAT.currentDirector.dirtyRectsEnabled)CAAT.currentDirector.scheduleDirtyRect(last.AABB);return last}},findActorAtPosition:function(point){if(null===CAAT.ActorContainer.superclass.findActorAtPosition.call(this,point))return null;var cl=this.childrenList;for(var i=cl.length-1;i>=0;i--){var child=this.childrenList[i];var np=new CAAT.Point(point.x,point.y,0);var contained=
child.findActorAtPosition(np);if(null!==contained)return contained}return this},destroy:function(){var cl=this.childrenList;for(var i=cl.length-1;i>=0;i--)cl[i].destroy();CAAT.ActorContainer.superclass.destroy.call(this);return this},getNumChildren:function(){return this.childrenList.length},getNumActiveChildren:function(){return this.activeChildren.length},getChildAt:function(iPosition){return this.childrenList[iPosition]},setZOrder:function(actor,index){var actorPos=this.findChild(actor);if(-1!==
actorPos){var cl=this.childrenList;if(index===actorPos)return;if(index>=cl.length){cl.splice(actorPos,1);cl.push(actor)}else{var nActor=cl.splice(actorPos,1);if(index<0)index=0;else if(index>cl.length)index=cl.length;cl.splice(index,0,nActor[0])}}}};extend(CAAT.ActorContainer,CAAT.Actor,null)})();
(function(){CAAT.TextActor=function(){CAAT.TextActor.superclass.constructor.call(this);this.font="10px sans-serif";this.textAlign="left";this.textBaseline="top";this.outlineColor="black";this.clip=false;return this};CAAT.TextActor.TRAVERSE_PATH_FORWARD=1;CAAT.TextActor.TRAVERSE_PATH_BACKWARD=-1;CAAT.TextActor.prototype={font:null,textAlign:null,textBaseline:null,fill:true,textFillStyle:"#eee",text:null,textWidth:0,textHeight:0,outline:false,outlineColor:null,lineWidth:1,path:null,pathInterpolator:null,
pathDuration:1E4,sign:1,setFill:function(fill){this.fill=fill;return this},setLineWidth:function(lw){this.lineWidth=lw;return this},setTextFillStyle:function(style){this.textFillStyle=style;return this},setOutline:function(outline){this.outline=outline;return this},setPathTraverseDirection:function(direction){this.sign=direction;return this},setOutlineColor:function(color){this.outlineColor=color;return this},setText:function(sText){this.text=sText;if(null===this.text||this.text==="")this.width=this.height=
0;this.calcTextSize(CAAT.director[0]);this.invalidate();return this},setTextAlign:function(align){this.textAlign=align;return this},setAlign:function(align){return this.setTextAlign(align)},setTextBaseline:function(baseline){this.textBaseline=baseline;return this},setBaseline:function(baseline){return this.setTextBaseline(baseline)},setFont:function(font){if(!font)font="10px sans-serif";if(font instanceof CAAT.Font)font=font.setAsSpriteImage();this.font=font;this.calcTextSize(CAAT.director[0]);return this},
calcTextSize:function(director){if(typeof this.text==="undefined"||null===this.text||""===this.text){this.textWidth=0;this.textHeight=0;return this}if(director.glEnabled)return this;if(this.font instanceof CAAT.SpriteImage){this.textWidth=this.font.stringWidth(this.text);this.textHeight=this.font.stringHeight();this.width=this.textWidth;this.height=this.textHeight;return this}var ctx=director.ctx;ctx.save();ctx.font=this.font;this.textWidth=ctx.measureText(this.text).width;if(this.width===0)this.width=
this.textWidth;try{var pos=this.font.indexOf("px");var s=this.font.substring(0,pos);this.textHeight=parseInt(s,10);this.textHeight+=this.textHeight/4>>0}catch(e){this.textHeight=20}if(this.height===0)this.height=this.textHeight;ctx.restore();return this},paint:function(director,time){CAAT.TextActor.superclass.paint.call(this,director,time);if(this.cached)return;if(null===this.text)return;if(this.textWidth===0||this.textHeight===0)this.calcTextSize(director);var ctx=director.ctx;if(this.font instanceof
CAAT.SpriteImage)return this.drawSpriteText(director,time);if(null!==this.font)ctx.font=this.font;if(null!==this.textAlign)ctx.textAlign=this.textAlign;if(null!==this.textBaseline)ctx.textBaseline=this.textBaseline;if(this.fill&&null!==this.textFillStyle)ctx.fillStyle=this.textFillStyle;if(this.outline&&null!==this.outlineColor)ctx.strokeStyle=this.outlineColor;if(null===this.path){var tx=0;if(this.textAlign==="center")tx=this.width/2|0;else if(this.textAlign==="right")tx=this.width;if(this.fill){ctx.fillText(this.text,
tx,0);if(this.outline){ctx.beginPath();ctx.lineWidth=this.lineWidth;ctx.strokeText(this.text,tx,0)}}else{if(null!==this.outlineColor)ctx.strokeStyle=this.outlineColor;ctx.beginPath();ctx.strokeText(this.text,tx,0)}}else this.drawOnPath(director,time)},drawOnPath:function(director,time){var ctx=director.ctx;var textWidth=this.sign*this.pathInterpolator.getPosition(time%this.pathDuration/this.pathDuration).y*this.path.getLength();var p0=new CAAT.Point(0,0,0);var p1=new CAAT.Point(0,0,0);for(var i=0;i<
this.text.length;i++){var caracter=this.text[i].toString();var charWidth=ctx.measureText(caracter).width;var currentCurveLength=textWidth;p0=this.path.getPositionFromLength(currentCurveLength).clone();p1=this.path.getPositionFromLength(currentCurveLength-0.1).clone();var angle=Math.atan2(p0.y-p1.y,p0.x-p1.x);ctx.save();ctx.translate(p0.x>>0,p0.y>>0);ctx.rotate(angle);if(this.fill)ctx.fillText(caracter,0,0);if(this.outline)ctx.strokeText(caracter,0,0);ctx.restore();textWidth+=charWidth}},drawSpriteText:function(director,
time){if(null===this.path)this.font.drawString(director.ctx,this.text,0,0);else this.drawSpriteTextOnPath(director,time)},drawSpriteTextOnPath:function(director,time){var context=director.ctx;var textWidth=this.sign*this.pathInterpolator.getPosition(time%this.pathDuration/this.pathDuration).y*this.path.getLength();var p0=new CAAT.Point(0,0,0);var p1=new CAAT.Point(0,0,0);for(var i=0;i<this.text.length;i++){var character=this.text[i].toString();var charWidth=this.font.stringWidth(character);var pathLength=
this.path.getLength();var currentCurveLength=charWidth/2+textWidth;p0=this.path.getPositionFromLength(currentCurveLength).clone();p1=this.path.getPositionFromLength(currentCurveLength-0.1).clone();var angle=Math.atan2(p0.y-p1.y,p0.x-p1.x);context.save();context.translate(p0.x|0,p0.y|0);context.rotate(angle);var y=this.textBaseline==="bottom"?0-this.font.height:0;this.font.drawString(context,character,0,y);context.restore();textWidth+=charWidth}},setPath:function(path,interpolator,duration){this.path=
path;this.pathInterpolator=interpolator||(new CAAT.Interpolator).createLinearInterpolator();this.pathDuration=duration||1E4;this.mouseEnabled=false;return this}};extend(CAAT.TextActor,CAAT.Actor,null)})();
(function(){CAAT.ShapeActor=function(){CAAT.ShapeActor.superclass.constructor.call(this);this.compositeOp="source-over";this.setShape(this.SHAPE_CIRCLE);return this};CAAT.ShapeActor.prototype={shape:0,compositeOp:null,lineWidth:1,lineCap:null,lineJoin:null,miterLimit:null,SHAPE_CIRCLE:0,SHAPE_RECTANGLE:1,setLineWidth:function(l){this.lineWidth=l;return this},setLineCap:function(lc){this.lineCap=lc;return this},setLineJoin:function(lj){this.lineJoin=lj;return this},setMiterLimit:function(ml){this.miterLimit=
ml;return this},getLineCap:function(){return this.lineCap},getLineJoin:function(){return this.lineJoin},getMiterLimit:function(){return this.miterLimit},getLineWidth:function(){return this.lineWidth},setShape:function(iShape){this.shape=iShape;this.paint=this.shape===this.SHAPE_CIRCLE?this.paintCircle:this.paintRectangle;return this},setCompositeOp:function(compositeOp){this.compositeOp=compositeOp;return this},paint:function(director,time){},paintCircle:function(director,time){var ctx=director.crc;
ctx.lineWidth=this.lineWidth;ctx.globalCompositeOperation=this.compositeOp;if(null!==this.fillStyle){ctx.fillStyle=this.fillStyle;ctx.beginPath();ctx.arc(this.width/2,this.height/2,Math.min(this.width,this.height)/2,0,2*Math.PI,false);ctx.fill()}if(null!==this.strokeStyle){ctx.strokeStyle=this.strokeStyle;ctx.beginPath();ctx.arc(this.width/2,this.height/2,Math.min(this.width,this.height)/2,0,2*Math.PI,false);ctx.stroke()}},paintRectangle:function(director,time){var ctx=director.crc;ctx.lineWidth=
this.lineWidth;if(this.lineCap)ctx.lineCap=this.lineCap;if(this.lineJoin)ctx.lineJoin=this.lineJoin;if(this.miterLimit)ctx.miterLimit=this.miterLimit;ctx.globalCompositeOperation=this.compositeOp;if(null!==this.fillStyle){ctx.fillStyle=this.fillStyle;ctx.beginPath();ctx.fillRect(0,0,this.width,this.height);ctx.fill()}if(null!==this.strokeStyle){ctx.strokeStyle=this.strokeStyle;ctx.beginPath();ctx.strokeRect(0,0,this.width,this.height);ctx.stroke()}}};extend(CAAT.ShapeActor,CAAT.ActorContainer,null)})();
(function(){CAAT.StarActor=function(){CAAT.StarActor.superclass.constructor.call(this);this.compositeOp="source-over";return this};CAAT.StarActor.prototype={nPeaks:0,maxRadius:0,minRadius:0,initialAngle:0,compositeOp:null,lineWidth:1,lineCap:null,lineJoin:null,miterLimit:null,setLineWidth:function(l){this.lineWidth=l;return this},setLineCap:function(lc){this.lineCap=lc;return this},setLineJoin:function(lj){this.lineJoin=lj;return this},setMiterLimit:function(ml){this.miterLimit=ml;return this},getLineCap:function(){return this.lineCap},
getLineJoin:function(){return this.lineJoin},getMiterLimit:function(){return this.miterLimit},getLineWidth:function(){return this.lineWidth},setFilled:function(filled){return this},setOutlined:function(outlined){return this},setCompositeOp:function(compositeOp){this.compositeOp=compositeOp;return this},setInitialAngle:function(angle){this.initialAngle=angle;return this},initialize:function(nPeaks,maxRadius,minRadius){this.setSize(2*maxRadius,2*maxRadius);this.nPeaks=nPeaks;this.maxRadius=maxRadius;
this.minRadius=minRadius;return this},paint:function(director,timer){var ctx=director.ctx;var centerX=this.width/2;var centerY=this.height/2;var r1=this.maxRadius;var r2=this.minRadius;var ix=centerX+r1*Math.cos(this.initialAngle);var iy=centerY+r1*Math.sin(this.initialAngle);ctx.lineWidth=this.lineWidth;if(this.lineCap)ctx.lineCap=this.lineCap;if(this.lineJoin)ctx.lineJoin=this.lineJoin;if(this.miterLimit)ctx.miterLimit=this.miterLimit;ctx.globalCompositeOperation=this.compositeOp;ctx.beginPath();
ctx.moveTo(ix,iy);for(var i=1;i<this.nPeaks*2;i++){var angleStar=Math.PI/this.nPeaks*i+this.initialAngle;var rr=i%2===0?r1:r2;var x=centerX+rr*Math.cos(angleStar);var y=centerY+rr*Math.sin(angleStar);ctx.lineTo(x,y)}ctx.lineTo(centerX+r1*Math.cos(this.initialAngle),centerY+r1*Math.sin(this.initialAngle));ctx.closePath();if(this.fillStyle){ctx.fillStyle=this.fillStyle;ctx.fill()}if(this.strokeStyle){ctx.strokeStyle=this.strokeStyle;ctx.stroke()}}};extend(CAAT.StarActor,CAAT.ActorContainer,null)})();
(function(){CAAT.IMActor=function(){CAAT.IMActor.superclass.constructor.call(this);return this};CAAT.IMActor.prototype={imageProcessor:null,changeTime:100,lastApplicationTime:-1,setImageProcessor:function(im){this.imageProcessor=im;return this},setImageProcessingTime:function(time){this.changeTime=time;return this},paint:function(director,time){if(time-this.lastApplicationTime>this.changeTime){this.imageProcessor.apply(director,time);this.lastApplicationTime=time}var ctx=director.ctx;this.imageProcessor.paint(director,
time)}};extend(CAAT.IMActor,CAAT.ActorContainer,null)})();
(function(){CAAT.AudioManager=function(){this.browserInfo=new CAAT.BrowserDetect;return this};CAAT.AudioManager.prototype={browserInfo:null,musicEnabled:true,fxEnabled:true,audioCache:null,channels:null,workingChannels:null,loopingChannels:[],audioTypes:{"mp3":"audio/mpeg;","ogg":'audio/ogg; codecs="vorbis"',"wav":'audio/wav; codecs="1"',"mp4":'audio/mp4; codecs="mp4a.40.2"'},initialize:function(numChannels){this.audioCache=[];this.channels=[];this.workingChannels=[];for(var i=0;i<numChannels;i++){var channel=
document.createElement("audio");if(null!==channel){channel.finished=-1;this.channels.push(channel);var me=this;channel.addEventListener("ended",function(audioEvent){var target=audioEvent.target;var i;for(i=0;i<me.workingChannels.length;i++)if(me.workingChannels[i]===target){me.workingChannels.splice(i,1);break}if(target.caat_callback)target.caat_callback(target.caat_id);me.channels.push(target)},false)}}return this},addAudioFromURL:function(id,url,endplaying_callback){var extension=null;var audio=
document.createElement("audio");if(null!==audio){if(!audio.canPlayType)return false;extension=url.substr(url.lastIndexOf(".")+1);var canplay=audio.canPlayType(this.audioTypes[extension]);if(canplay!==""&&canplay!=="no"){audio.src=url;audio.preload="auto";audio.load();if(endplaying_callback){audio.caat_callback=endplaying_callback;audio.caat_id=id}this.audioCache.push({id:id,audio:audio});return true}}return false},addAudioFromDomNode:function(id,audio,endplaying_callback){var extension=audio.src.substr(audio.src.lastIndexOf(".")+
1);if(audio.canPlayType(this.audioTypes[extension])){if(endplaying_callback){audio.caat_callback=endplaying_callback;audio.caat_id=id}this.audioCache.push({id:id,audio:audio});return true}return false},addAudioElement:function(id,element,endplaying_callback){if(typeof element==="string")return this.addAudioFromURL(id,element,endplaying_callback);else try{if(element instanceof HTMLAudioElement)return this.addAudioFromDomNode(id,element,endplaying_callback)}catch(e){}return false},addAudio:function(id,
array_of_url_or_domnodes,endplaying_callback){if(array_of_url_or_domnodes instanceof Array)for(var i=0;i<array_of_url_or_domnodes.length;i++){if(this.addAudioElement(id,array_of_url_or_domnodes[i],endplaying_callback))break}else this.addAudioElement(id,array_of_url_or_domnodes,endplaying_callback);return this},getAudio:function(aId){for(var i=0;i<this.audioCache.length;i++)if(this.audioCache[i].id===aId)return this.audioCache[i].audio;return null},setVolume:function(id,volume){var audio=this.getAudio(id);
if(null!=audio)audio.volume=volume;return this},play:function(id){if(!this.fxEnabled)return this;var audio=this.getAudio(id);if(null!==audio&&this.channels.length>0){var channel=this.channels.shift();channel.src=audio.src;channel.load();channel.volume=audio.volume;channel.play();this.workingChannels.push(channel)}return this},loop:function(id){if(!this.musicEnabled)return this;var audio_in_cache=this.getAudio(id);if(null!==audio_in_cache){var audio=document.createElement("audio");if(null!==audio){audio.src=
audio_in_cache.src;audio.preload="auto";if(this.browserInfo.browser==="Firefox")audio.addEventListener("ended",function(audioEvent){var target=audioEvent.target;target.currentTime=0},false);else audio.loop=true;audio.load();audio.play();this.loopingChannels.push(audio);return audio}}return null},endSound:function(){var i;for(i=0;i<this.workingChannels.length;i++){this.workingChannels[i].pause();this.channels.push(this.workingChannels[i])}for(i=0;i<this.loopingChannels.length;i++)this.loopingChannels[i].pause();
return this},setSoundEffectsEnabled:function(enable){this.fxEnabled=enable;return this},isSoundEffectsEnabled:function(){return this.fxEnabled},setMusicEnabled:function(enable){this.musicEnabled=enable;for(var i=0;i<this.loopingChannels.length;i++)if(enable)this.loopingChannels[i].play();else this.loopingChannels[i].pause();return this},isMusicEnabled:function(){return this.musicEnabled}}})();
(function(){CAAT.Dock=function(){CAAT.Dock.superclass.constructor.call(this);return this};CAAT.Dock.prototype={scene:null,ttask:null,minSize:0,maxSize:0,range:2,layoutOp:0,OP_LAYOUT_BOTTOM:0,OP_LAYOUT_TOP:1,OP_LAYOUT_LEFT:2,OP_LAYOUT_RIGHT:3,initialize:function(scene){this.scene=scene;return this},setApplicationRange:function(range){this.range=range;return this},setLayoutOp:function(lo){this.layoutOp=lo;return this},setSizes:function(min,max){this.minSize=min;this.maxSize=max;for(var i=0;i<this.childrenList.length;i++){this.childrenList[i].width=
min;this.childrenList[i].height=min}return this},layout:function(){var i,actor;if(this.layoutOp===this.OP_LAYOUT_BOTTOM||this.layoutOp===this.OP_LAYOUT_TOP){var currentWidth=0,currentX=0;for(i=0;i<this.getNumChildren();i++)currentWidth+=this.getChildAt(i).width;currentX=(this.width-currentWidth)/2;for(i=0;i<this.getNumChildren();i++){actor=this.getChildAt(i);actor.x=currentX;currentX+=actor.width;if(this.layoutOp===this.OP_LAYOUT_BOTTOM)actor.y=this.maxSize-actor.height;else actor.y=0}}else{var currentHeight=
0,currentY=0;for(i=0;i<this.getNumChildren();i++)currentHeight+=this.getChildAt(i).height;currentY=(this.height-currentHeight)/2;for(i=0;i<this.getNumChildren();i++){actor=this.getChildAt(i);actor.y=currentY;currentY+=actor.height;if(this.layoutOp===this.OP_LAYOUT_LEFT)actor.x=0;else actor.x=this.width-actor.width}}},mouseMove:function(mouseEvent){this.actorNotPointed()},mouseExit:function(mouseEvent){this.actorNotPointed()},actorNotPointed:function(){var i;var me=this;for(i=0;i<this.getNumChildren();i++){var actor=
this.getChildAt(i);actor.emptyBehaviorList();actor.addBehavior((new CAAT.GenericBehavior).setValues(actor.width,this.minSize,actor,"width").setFrameTime(this.scene.time,250)).addBehavior((new CAAT.GenericBehavior).setValues(actor.height,this.minSize,actor,"height").setFrameTime(this.scene.time,250));if(i===this.getNumChildren()-1)actor.behaviorList[0].addListener({behaviorApplied:function(behavior,time,normalizedTime,targetActor,value){targetActor.parent.layout()},behaviorExpired:function(behavior,
time,targetActor){for(i=0;i<me.getNumChildren();i++){actor=me.getChildAt(i);actor.width=me.minSize;actor.height=me.minSize}targetActor.parent.layout()}})}},actorPointed:function(x,y,pointedActor){var index=this.findChild(pointedActor);var across=0;if(this.layoutOp===this.OP_LAYOUT_BOTTOM||this.layoutOp===this.OP_LAYOUT_TOP)across=x/pointedActor.width;else across=y/pointedActor.height;var i;for(i=0;i<this.childrenList.length;i++){var actor=this.childrenList[i];actor.emptyBehaviorList();var wwidth=
0;if(i<index-this.range||i>index+this.range)wwidth=this.minSize;else if(i===index)wwidth=this.maxSize;else if(i<index)wwidth=this.minSize+(this.maxSize-this.minSize)*(Math.cos((i-index-across+1)/this.range*Math.PI)+1)/2;else wwidth=this.minSize+(this.maxSize-this.minSize)*(Math.cos((i-index-across)/this.range*Math.PI)+1)/2;actor.height=wwidth;actor.width=wwidth}this.layout()},actorMouseExit:function(mouseEvent){if(null!==this.ttask)this.ttask.cancel();var me=this;this.ttask=this.scene.createTimer(this.scene.time,
100,function timeout(sceneTime,time,timerTask){me.actorNotPointed()},null,null)},actorMouseEnter:function(mouseEvent){if(null!==this.ttask){this.ttask.cancel();this.ttask=null}},addChild:function(actor){var me=this;actor.__Dock_mouseEnter=actor.mouseEnter;actor.__Dock_mouseExit=actor.mouseExit;actor.__Dock_mouseMove=actor.mouseMove;actor.mouseEnter=function(mouseEvent){me.actorMouseEnter(mouseEvent);this.__Dock_mouseEnter(mouseEvent)};actor.mouseExit=function(mouseEvent){me.actorMouseExit(mouseEvent);
this.__Dock_mouseExit(mouseEvent)};actor.mouseMove=function(mouseEvent){me.actorPointed(mouseEvent.point.x,mouseEvent.point.y,mouseEvent.source);this.__Dock_mouseMove(mouseEvent)};actor.width=this.minSize;actor.height=this.minSize;return CAAT.Dock.superclass.addChild.call(this,actor)}};extend(CAAT.Dock,CAAT.ActorContainer,null)})();
(function(){CAAT.Director=function(){CAAT.Director.superclass.constructor.call(this);this.browserInfo=new CAAT.BrowserDetect;this.audioManager=(new CAAT.AudioManager).initialize(8);this.scenes=[];this.mousePoint=new CAAT.Point(0,0,0);this.prevMousePoint=new CAAT.Point(0,0,0);this.screenMousePoint=new CAAT.Point(0,0,0);this.isMouseDown=false;this.lastSelectedActor=null;this.dragging=false;this.cDirtyRects=[];this.sDirtyRects=[];this.dirtyRects=[];for(var i=0;i<64;i++)this.dirtyRects.push(new CAAT.Rectangle);
this.dirtyRectsIndex=0;this.touches={};this.timerManager=new CAAT.TimerManager;return this};CAAT.Director.RENDER_MODE_CONTINUOUS=1;CAAT.Director.RENDER_MODE_DIRTY=2;CAAT.Director.CLEAR_DIRTY_RECTS=1;CAAT.Director.CLEAR_ALL=true;CAAT.Director.CLEAR_NONE=false;CAAT.Director.prototype={debug:false,renderMode:CAAT.Director.RENDER_MODE_CONTINUOUS,onRenderStart:null,onRenderEnd:null,mousePoint:null,prevMousePoint:null,screenMousePoint:null,isMouseDown:false,lastSelectedActor:null,dragging:false,scenes:null,
currentScene:null,canvas:null,crc:null,ctx:null,time:0,timeline:0,imagesCache:null,audioManager:null,clear:true,transitionScene:null,browserInfo:null,gl:null,glEnabled:false,glTextureManager:null,glTtextureProgram:null,glColorProgram:null,pMatrix:null,coords:null,coordsIndex:0,uv:null,uvIndex:0,front_to_back:false,statistics:{size_total:0,size_active:0,size_dirtyRects:0,draws:0},currentTexturePage:0,currentOpacity:1,intervalId:null,frameCounter:0,RESIZE_NONE:1,RESIZE_WIDTH:2,RESIZE_HEIGHT:4,RESIZE_BOTH:8,
RESIZE_PROPORTIONAL:16,resize:1,onResizeCallback:null,__gestureScale:0,__gestureRotation:0,dirtyRects:null,cDirtyRects:null,sDirtyRects:null,dirtyRectsIndex:0,dirtyRectsEnabled:false,nDirtyRects:0,stopped:false,needsRepaint:false,touches:null,timerManager:null,clean:function(){this.scenes=null;this.currentScene=null;this.imagesCache=null;this.audioManager=null;this.isMouseDown=false;this.lastSelectedActor=null;this.dragging=false;this.__gestureScale=0;this.__gestureRotation=0;this.dirty=true;this.dirtyRects=
null;this.cDirtyRects=null;this.dirtyRectsIndex=0;this.dirtyRectsEnabled=false;this.nDirtyRects=0;this.onResizeCallback=null;return this},createTimer:function(startTime,duration,callback_timeout,callback_tick,callback_cancel){this.timerManager.createTimer(startTime,duration,callback_timeout,callback_tick,callback_cancel);return this},requestRepaint:function(){this.needsRepaint=true},getCurrentScene:function(){return this.currentScene},setRenderMode:function(mode){if(mode===CAAT.Director.RENDER_MODE_CONTINUOUS||
mode===CAAT.Director.RENDER_MODE_DIRTY)this.renderMode=mode;return this},checkDebug:function(){if(CAAT.DEBUG){var dd=(new CAAT.Debug).initialize(this.width,60);this.debugInfo=dd.debugInfo.bind(dd)}},getRenderType:function(){return this.glEnabled?"WEBGL":"CANVAS"},windowResized:function(w,h){switch(this.resize){case this.RESIZE_WIDTH:this.setBounds(0,0,w,this.height);break;case this.RESIZE_HEIGHT:this.setBounds(0,0,this.width,h);break;case this.RESIZE_BOTH:this.setBounds(0,0,w,h);break;case this.RESIZE_PROPORTIONAL:this.setScaleProportional(w,
h);break}if(this.glEnabled)this.glReset();if(this.onResizeCallback)this.onResizeCallback(this,w,h)},setScaleProportional:function(w,h){var factor=Math.min(w/this.referenceWidth,h/this.referenceHeight);this.setScaleAnchored(factor,factor,0,0);this.canvas.width=this.referenceWidth*factor;this.canvas.height=this.referenceHeight*factor;this.ctx=this.canvas.getContext(this.glEnabled?"experimental-webgl":"2d");this.crc=this.ctx;if(this.glEnabled)this.glReset()},enableResizeEvents:function(mode,onResizeCallback){if(mode===
this.RESIZE_BOTH||mode===this.RESIZE_WIDTH||mode===this.RESIZE_HEIGHT||mode===this.RESIZE_PROPORTIONAL){this.referenceWidth=this.width;this.referenceHeight=this.height;this.resize=mode;CAAT.registerResizeListener(this);this.onResizeCallback=onResizeCallback;this.windowResized(window.innerWidth,window.innerHeight)}else{CAAT.unregisterResizeListener(this);this.onResizeCallback=null}},setBounds:function(x,y,w,h){CAAT.Director.superclass.setBounds.call(this,x,y,w,h);this.canvas.width=w;this.canvas.height=
h;this.ctx=this.canvas.getContext(this.glEnabled?"experimental-webgl":"2d");this.crc=this.ctx;for(var i=0;i<this.scenes.length;i++)this.scenes[i].setBounds(0,0,w,h);if(this.glEnabled)this.glReset();return this},initialize:function(width,height,canvas,proxy){if(!canvas){canvas=document.createElement("canvas");document.body.appendChild(canvas)}this.canvas=canvas;if(typeof proxy==="undefined")proxy=canvas;this.setBounds(0,0,width,height);this.enableEvents(proxy);this.timeline=(new Date).getTime();this.transitionScene=
(new CAAT.Scene).setBounds(0,0,width,height);var transitionCanvas=document.createElement("canvas");transitionCanvas.width=width;transitionCanvas.height=height;var transitionImageActor=(new CAAT.Actor).setBackgroundImage(transitionCanvas);this.transitionScene.ctx=transitionCanvas.getContext("2d");this.transitionScene.addChildImmediately(transitionImageActor);this.transitionScene.setEaseListener(this);this.checkDebug();return this},glReset:function(){this.pMatrix=makeOrtho(0,this.referenceWidth,this.referenceHeight,
0,-1,1);this.gl.viewport(0,0,this.canvas.width,this.canvas.height);this.glColorProgram.setMatrixUniform(this.pMatrix);this.glTextureProgram.setMatrixUniform(this.pMatrix);this.gl.viewportWidth=this.canvas.width;this.gl.viewportHeight=this.canvas.height},initializeGL:function(width,height,canvas,proxy){if(!canvas){canvas=document.createElement("canvas");document.body.appendChild(canvas)}canvas.width=width;canvas.height=height;if(typeof proxy==="undefined")proxy=canvas;this.referenceWidth=width;this.referenceHeight=
height;var i;try{this.gl=canvas.getContext("experimental-webgl");this.gl.viewportWidth=width;this.gl.viewportHeight=height;CAAT.GLRENDER=true}catch(e){}if(this.gl){this.canvas=canvas;this.setBounds(0,0,width,height);this.crc=this.ctx;this.enableEvents(canvas);this.timeline=(new Date).getTime();this.glColorProgram=(new CAAT.ColorProgram(this.gl)).create().initialize();this.glTextureProgram=(new CAAT.TextureProgram(this.gl)).create().initialize();this.glTextureProgram.useProgram();this.glReset();var maxTris=
512;this.coords=new Float32Array(maxTris*12);this.uv=new Float32Array(maxTris*8);this.gl.clearColor(0,0,0,255);if(this.front_to_back){this.gl.clearDepth(1);this.gl.enable(this.gl.DEPTH_TEST);this.gl.depthFunc(this.gl.LESS)}else this.gl.disable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);this.glEnabled=true;this.checkDebug()}else return this.initialize(width,height,canvas);return this},createScene:function(){var scene=new CAAT.Scene;
this.addScene(scene);return scene},setImagesCache:function(imagesCache,tpW,tpH){var i;if(null!==this.glTextureManager){this.glTextureManager.deletePages();this.glTextureManager=null}if(this.imagesCache){var ids=[];for(i=0;i<this.imagesCache.length;i++)ids.push(this.imagesCache[i].id);for(i=0;i<ids.length;i++)delete this.imagesCache[ids[i]]}this.imagesCache=imagesCache;if(imagesCache)for(i=0;i<imagesCache.length;i++)this.imagesCache[imagesCache[i].id]=imagesCache[i].image;this.tpW=tpW||2048;this.tpH=
tpH||2048;this.updateGLPages();return this},updateGLPages:function(){if(this.glEnabled){this.glTextureManager=new CAAT.GLTexturePageManager;this.glTextureManager.createPages(this.gl,this.tpW,this.tpH,this.imagesCache);this.currentTexturePage=this.glTextureManager.pages[0];this.glTextureProgram.setTexture(this.currentTexturePage.texture)}},setGLTexturePage:function(tp){this.currentTexturePage=tp;this.glTextureProgram.setTexture(tp.texture);return this},addImage:function(id,image,noUpdateGL){if(this.getImage(id)){for(var i=
0;i<this.imagesCache.length;i++)if(this.imagesCache[i].id===id){this.imagesCache[i].image=image;break}this.imagesCache[id]=image}else{this.imagesCache.push({id:id,image:image});this.imagesCache[id]=image}if(!!!noUpdateGL)this.updateGLPages()},deleteImage:function(id,noUpdateGL){for(var i=0;i<this.imagesCache.length;i++)if(this.imagesCache[i].id===id){delete this.imagesCache[id];this.imagesCache.splice(i,1);break}if(!!!noUpdateGL)this.updateGLPages()},setGLCurrentOpacity:function(opacity){this.currentOpacity=
opacity;this.glTextureProgram.setAlpha(opacity)},glRender:function(vertex,coordsIndex,uv){vertex=vertex||this.coords;uv=uv||this.uv;coordsIndex=coordsIndex||this.coordsIndex;var gl=this.gl;var numTris=coordsIndex/12*2;var numVertices=coordsIndex/3;this.glTextureProgram.updateVertexBuffer(vertex);this.glTextureProgram.updateUVBuffer(uv);gl.drawElements(gl.TRIANGLES,3*numTris,gl.UNSIGNED_SHORT,0)},glFlush:function(){if(this.coordsIndex!==0)this.glRender(this.coords,this.coordsIndex,this.uv);this.coordsIndex=
0;this.uvIndex=0;this.statistics.draws++},findActorAtPosition:function(point){var cl=this.childrenList;for(var i=cl.length-1;i>=0;i--){var child=this.childrenList[i];var np=new CAAT.Point(point.x,point.y,0);var contained=child.findActorAtPosition(np);if(null!==contained)return contained}return this},resetStats:function(){this.statistics.size_total=0;this.statistics.size_active=0;this.statistics.draws=0},render:function(time){if(this.currentScene&&this.currentScene.isPaused())return;this.time+=time;
this.animate(this,this.time);if(CAAT.DEBUG)this.resetStats();var ne=this.childrenList.length;var i,tt,c;var ctx=this.ctx;if(this.glEnabled){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.coordsIndex=0;this.uvIndex=0;for(i=0;i<ne;i++){c=this.childrenList[i];if(c.isInAnimationFrame(this.time)){tt=c.time-c.start_time;if(c.onRenderStart)c.onRenderStart(tt);c.paintActorGL(this,tt);if(c.onRenderEnd)c.onRenderEnd(tt);if(!c.isPaused())c.time+=time;if(CAAT.DEBUG){this.statistics.size_total+=
c.size_total;this.statistics.size_active+=c.size_active}}}this.glFlush()}else{ctx.globalAlpha=1;ctx.globalCompositeOperation="source-over";ctx.save();if(this.dirtyRectsEnabled){this.modelViewMatrix.transformRenderingContext(ctx);if(!CAAT.DEBUG_DIRTYRECTS){ctx.beginPath();this.nDirtyRects=0;var dr=this.cDirtyRects;for(i=0;i<dr.length;i++){var drr=dr[i];if(!drr.isEmpty()){ctx.rect(drr.x|0,drr.y|0,1+(drr.width|0),1+(drr.height|0));this.nDirtyRects++}}ctx.clip()}else ctx.clearRect(0,0,this.width,this.height)}else if(this.clear===
true)ctx.clearRect(0,0,this.width,this.height);for(i=0;i<ne;i++){c=this.childrenList[i];if(c.isInAnimationFrame(this.time)){tt=c.time-c.start_time;ctx.save();if(c.onRenderStart)c.onRenderStart(tt);if(!CAAT.DEBUG_DIRTYRECTS&&this.dirtyRectsEnabled){if(this.nDirtyRects)c.paintActor(this,tt)}else c.paintActor(this,tt);if(c.onRenderEnd)c.onRenderEnd(tt);ctx.restore();if(CAAT.DEBUGAABB){ctx.globalAlpha=1;ctx.globalCompositeOperation="source-over";this.modelViewMatrix.transformRenderingContextSet(ctx);
c.drawScreenBoundingBox(this,tt)}if(!c.isPaused())c.time+=time;if(CAAT.DEBUG){this.statistics.size_total+=c.size_total;this.statistics.size_active+=c.size_active;this.statistics.size_dirtyRects=this.nDirtyRects}}}if(this.nDirtyRects>0&&CAAT.DEBUG&&CAAT.DEBUG_DIRTYRECTS){ctx.beginPath();this.nDirtyRects=0;var dr=this.cDirtyRects;for(i=0;i<dr.length;i++){var drr=dr[i];if(!drr.isEmpty()){ctx.rect(drr.x|0,drr.y|0,1+(drr.width|0),1+(drr.height|0));this.nDirtyRects++}}ctx.clip();ctx.fillStyle="rgba(160,255,150,.4)";
ctx.fillRect(0,0,this.width,this.height)}ctx.restore()}this.frameCounter++},animate:function(director,time){this.timerManager.checkTimers(time);this.setModelViewMatrix(this);this.modelViewMatrixI=this.modelViewMatrix.getInverse();this.setScreenBounds();this.dirty=false;this.invalid=false;this.dirtyRectsIndex=-1;this.cDirtyRects=[];var cl=this.childrenList;var cli;var i,l;if(this.dirtyRectsEnabled){var sdr=this.sDirtyRects;if(sdr.length){for(i=0,l=sdr.length;i<l;i++)this.addDirtyRect(sdr[i]);this.sDirtyRects=
[]}}for(i=0;i<cl.length;i++){cli=cl[i];var tt=cli.time-cli.start_time;cli.animate(this,tt)}this.timerManager.removeExpiredTimers();return this},scheduleDirtyRect:function(rectangle){this.sDirtyRects.push(rectangle)},addDirtyRect:function(rectangle){if(rectangle.isEmpty())return;var i,dr,j,drj;var cdr=this.cDirtyRects;for(i=0;i<cdr.length;i++){dr=cdr[i];if(!dr.isEmpty()&&dr.intersects(rectangle)){var intersected=true;while(intersected){dr.unionRectangle(rectangle);for(j=0;j<cdr.length;j++)if(j!==i){drj=
cdr[j];if(!drj.isEmpty()&&drj.intersects(dr)){dr.unionRectangle(drj);drj.setEmpty();break}}if(j==cdr.length)intersected=false}for(j=0;j<cdr.length;j++)if(cdr[j].isEmpty())cdr.splice(j,1);return}}this.dirtyRectsIndex++;if(this.dirtyRectsIndex>=this.dirtyRects.length)for(i=0;i<32;i++)this.dirtyRects.push(new CAAT.Rectangle);var r=this.dirtyRects[this.dirtyRectsIndex];r.x=rectangle.x;r.y=rectangle.y;r.x1=rectangle.x1;r.y1=rectangle.y1;r.width=rectangle.width;r.height=rectangle.height;this.cDirtyRects.push(r)},
renderToContext:function(ctx,scene){if(scene.isInAnimationFrame(this.time)){ctx.setTransform(1,0,0,1,0,0);ctx.globalAlpha=1;ctx.globalCompositeOperation="source-over";ctx.clearRect(0,0,this.width,this.height);var octx=this.ctx;var ocrc=this.crc;this.ctx=ctx;this.crc=ctx;ctx.save();var matmv=this.modelViewMatrix;var matwmv=this.worldModelViewMatrix;this.worldModelViewMatrix=new CAAT.Matrix;this.modelViewMatrix=this.worldModelViewMatrix;this.wdirty=true;scene.animate(this,scene.time);if(scene.onRenderStart)scene.onRenderStart(scene.time);
scene.paintActor(this,scene.time);if(scene.onRenderEnd)scene.onRenderEnd(scene.time);this.worldModelViewMatrix=matwmv;this.modelViewMatrix=matmv;ctx.restore();this.ctx=octx;this.crc=ocrc}},addScene:function(scene){scene.setBounds(0,0,this.width,this.height);this.scenes.push(scene);scene.setEaseListener(this);if(null===this.currentScene)this.setScene(0)},getNumScenes:function(){return this.scenes.length},easeInOut:function(inSceneIndex,typein,anchorin,outSceneIndex,typeout,anchorout,time,alpha,interpolatorIn,
interpolatorOut){if(inSceneIndex===this.getCurrentSceneIndex())return;var ssin=this.scenes[inSceneIndex];var sout=this.scenes[outSceneIndex];if(!CAAT.__CSS__&&!this.glEnabled){this.renderToContext(this.transitionScene.ctx,sout);sout=this.transitionScene}ssin.setExpired(false);sout.setExpired(false);ssin.mouseEnabled=false;sout.mouseEnabled=false;ssin.resetTransform();sout.resetTransform();ssin.setLocation(0,0);sout.setLocation(0,0);ssin.alpha=1;sout.alpha=1;if(typein===CAAT.Scene.prototype.EASE_ROTATION)ssin.easeRotationIn(time,
alpha,anchorin,interpolatorIn);else if(typein===CAAT.Scene.prototype.EASE_SCALE)ssin.easeScaleIn(0,time,alpha,anchorin,interpolatorIn);else ssin.easeTranslationIn(time,alpha,anchorin,interpolatorIn);if(typeout===CAAT.Scene.prototype.EASE_ROTATION)sout.easeRotationOut(time,alpha,anchorout,interpolatorOut);else if(typeout===CAAT.Scene.prototype.EASE_SCALE)sout.easeScaleOut(0,time,alpha,anchorout,interpolatorOut);else sout.easeTranslationOut(time,alpha,anchorout,interpolatorOut);this.childrenList=[];
this.addChild(sout);this.addChild(ssin)},easeInOutRandom:function(inIndex,outIndex,time,alpha){var pin=Math.random();var pout=Math.random();var typeIn;var interpolatorIn;if(pin<0.33){typeIn=CAAT.Scene.prototype.EASE_ROTATION;interpolatorIn=(new CAAT.Interpolator).createExponentialInOutInterpolator(4)}else if(pin<0.66){typeIn=CAAT.Scene.prototype.EASE_SCALE;interpolatorIn=(new CAAT.Interpolator).createElasticOutInterpolator(1.1,0.4)}else{typeIn=CAAT.Scene.prototype.EASE_TRANSLATE;interpolatorIn=(new CAAT.Interpolator).createBounceOutInterpolator()}var typeOut;
var interpolatorOut;if(pout<0.33){typeOut=CAAT.Scene.prototype.EASE_ROTATION;interpolatorOut=(new CAAT.Interpolator).createExponentialInOutInterpolator(4)}else if(pout<0.66){typeOut=CAAT.Scene.prototype.EASE_SCALE;interpolatorOut=(new CAAT.Interpolator).createExponentialOutInterpolator(4)}else{typeOut=CAAT.Scene.prototype.EASE_TRANSLATE;interpolatorOut=(new CAAT.Interpolator).createBounceOutInterpolator()}this.easeInOut(inIndex,typeIn,Math.random()*8.99>>0,outIndex,typeOut,Math.random()*8.99>>0,time,
alpha,interpolatorIn,interpolatorOut)},easeIn:function(inSceneIndex,type,time,alpha,anchor,interpolator){var sin=this.scenes[inSceneIndex];if(type===CAAT.Scene.prototype.EASE_ROTATION)sin.easeRotationIn(time,alpha,anchor,interpolator);else if(type===CAAT.Scene.prototype.EASE_SCALE)sin.easeScaleIn(0,time,alpha,anchor,interpolator);else sin.easeTranslationIn(time,alpha,anchor,interpolator);this.childrenList=[];this.addChild(sin);sin.resetTransform();sin.setLocation(0,0);sin.alpha=1;sin.mouseEnabled=
false;sin.setExpired(false)},setScene:function(sceneIndex){var sin=this.scenes[sceneIndex];this.childrenList=[];this.addChild(sin);this.currentScene=sin;sin.setExpired(false);sin.mouseEnabled=true;sin.resetTransform();sin.setLocation(0,0);sin.alpha=1;sin.activated()},switchToScene:function(iNewSceneIndex,time,alpha,transition){var currentSceneIndex=this.getSceneIndex(this.currentScene);if(!transition)this.setScene(iNewSceneIndex);else this.easeInOutRandom(iNewSceneIndex,currentSceneIndex,time,alpha)},
switchToPrevScene:function(time,alpha,transition){var currentSceneIndex=this.getSceneIndex(this.currentScene);if(this.getNumScenes()<=1||currentSceneIndex===0)return;if(!transition)this.setScene(currentSceneIndex-1);else this.easeInOutRandom(currentSceneIndex-1,currentSceneIndex,time,alpha)},switchToNextScene:function(time,alpha,transition){var currentSceneIndex=this.getSceneIndex(this.currentScene);if(this.getNumScenes()<=1||currentSceneIndex===this.getNumScenes()-1)return;if(!transition)this.setScene(currentSceneIndex+
1);else this.easeInOutRandom(currentSceneIndex+1,currentSceneIndex,time,alpha)},mouseEnter:function(mouseEvent){},mouseExit:function(mouseEvent){},mouseMove:function(mouseEvent){},mouseDown:function(mouseEvent){},mouseUp:function(mouseEvent){},mouseDrag:function(mouseEvent){},easeEnd:function(scene,b_easeIn){if(!b_easeIn)scene.setExpired(true);else{this.currentScene=scene;this.currentScene.activated()}scene.mouseEnabled=true;scene.emptyBehaviorList()},getSceneIndex:function(scene){for(var i=0;i<this.scenes.length;i++)if(this.scenes[i]===
scene)return i;return-1},getScene:function(index){return this.scenes[index]},getCurrentSceneIndex:function(){return this.getSceneIndex(this.currentScene)},getBrowserName:function(){return this.browserInfo.browser},getBrowserVersion:function(){return this.browserInfo.version},getOSName:function(){return this.browserInfo.OS},getImage:function(sId){var ret=this.imagesCache[sId];if(ret)return ret;for(var i=0;i<this.imagesCache.length;i++)if(this.imagesCache[i].id===sId)return this.imagesCache[i].image;
return null},addAudio:function(id,url){this.audioManager.addAudio(id,url);return this},audioPlay:function(id){this.audioManager.play(id)},audioLoop:function(id){return this.audioManager.loop(id)},endSound:function(){return this.audioManager.endSound()},setSoundEffectsEnabled:function(enabled){return this.audioManager.setSoundEffectsEnabled(enabled)},setMusicEnabled:function(enabled){return this.audioManager.setMusicEnabled(enabled)},isMusicEnabled:function(){return this.audioManager.isMusicEnabled()},
isSoundEffectsEnabled:function(){return this.audioManager.isSoundEffectsEnabled()},setVolume:function(id,volume){return this.audioManager.setVolume(id,volume)},emptyScenes:function(){this.scenes=[]},addChild:function(scene){scene.parent=this;this.childrenList.push(scene)},loop:function(fps,callback,callback2){if(callback2){this.onRenderStart=callback;this.onRenderEnd=callback2}else if(callback)this.onRenderEnd=callback;CAAT.loop()},renderFrame:function(){CAAT.currentDirector=this;if(this.stopped)return;
var t=(new Date).getTime(),delta=t-this.timeline;if(delta>500)delta=500;if(this.onRenderStart)this.onRenderStart(delta);this.render(delta);if(this.debugInfo)this.debugInfo(this.statistics);this.timeline=t;if(this.onRenderEnd)this.onRenderEnd(delta);this.needsRepaint=false},resetTimeline:function(){this.timeline=(new Date).getTime()},endLoop:function(){},setClear:function(clear){this.clear=clear;if(this.clear===CAAT.Director.CLEAR_DIRTY_RECTS)this.dirtyRectsEnabled=true;return this},getAudioManager:function(){return this.audioManager},
cumulateOffset:function(node,parent,prop){var left=prop+"Left";var top=prop+"Top";var x=0,y=0,style;while(navigator.browser!=="iOS"&&node&&node.style){if(node.currentStyle)style=node.currentStyle["position"];else{style=(node.ownerDocument.defaultView||node.ownerDocument.parentWindow).getComputedStyle(node,null);style=style?style.getPropertyValue("position"):null}if(!/^(fixed)$/.test(style)){x+=node[left];y+=node[top];node=node[parent]}else break}return{x:x,y:y,style:style}},getOffset:function(node){var res=
this.cumulateOffset(node,"offsetParent","offset");if(res.style==="fixed"){var res2=this.cumulateOffset(node,node.parentNode?"parentNode":"parentElement","scroll");return{x:res.x+res2.x,y:res.y+res2.y}}return{x:res.x,y:res.y}},getCanvasCoord:function(point,e){var pt=new CAAT.Point;var posx=0;var posy=0;if(!e)e=window.event;if(e.pageX||e.pageY){posx=e.pageX;posy=e.pageY}else if(e.clientX||e.clientY){posx=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;posy=e.clientY+document.body.scrollTop+
document.documentElement.scrollTop}var offset=this.getOffset(this.canvas);posx-=offset.x;posy-=offset.y;pt.x=posx;pt.y=posy;if(!this.modelViewMatrixI)this.modelViewMatrixI=this.modelViewMatrix.getInverse();this.modelViewMatrixI.transformCoord(pt);posx=pt.x;posy=pt.y;point.set(posx,posy);this.screenMousePoint.set(posx,posy)},__mouseDownHandler:function(e){if(this.dragging&&this.lastSelectedActor){this.__mouseUpHandler(e);return}this.getCanvasCoord(this.mousePoint,e);this.isMouseDown=true;var lactor=
this.findActorAtPosition(this.mousePoint);if(null!==lactor){var pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));lactor.mouseDown((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y)))}this.lastSelectedActor=lactor},__mouseUpHandler:function(e){this.isMouseDown=false;this.getCanvasCoord(this.mousePoint,e);var pos=null;var lactor=this.lastSelectedActor;if(null!==lactor){pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,
this.screenMousePoint.y,0));if(lactor.actionPerformed&&lactor.contains(pos.x,pos.y))lactor.actionPerformed(e);lactor.mouseUp((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,this.currentScene.time))}if(!this.dragging&&null!==lactor)if(lactor.contains(pos.x,pos.y))lactor.mouseClick((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,this.currentScene.time));this.dragging=false;this.in_=false},__mouseMoveHandler:function(e){var lactor;var pos;var ct=this.currentScene?
this.currentScene.time:0;if(this.isMouseDown&&null!==this.lastSelectedActor){lactor=this.lastSelectedActor;pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));if(!this.dragging)if(Math.abs(this.prevMousePoint.x-pos.x)<CAAT.DRAG_THRESHOLD_X&&Math.abs(this.prevMousePoint.y-pos.y)<CAAT.DRAG_THRESHOLD_Y)return;this.dragging=true;var px=lactor.x;var py=lactor.y;lactor.mouseDrag((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,new CAAT.Point(this.screenMousePoint.x,
this.screenMousePoint.y),ct));this.prevMousePoint.x=pos.x;this.prevMousePoint.y=pos.y;if(px===lactor.x&&py===lactor.y){var contains=lactor.contains(pos.x,pos.y);if(this.in_&&!contains){lactor.mouseExit((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,ct));this.in_=false}if(!this.in_&&contains){lactor.mouseEnter((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,ct));this.in_=true}}return}this.in_=true;lactor=this.findActorAtPosition(this.mousePoint);if(lactor!==
this.lastSelectedActor){if(null!==this.lastSelectedActor){pos=this.lastSelectedActor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));this.lastSelectedActor.mouseExit((new CAAT.MouseEvent).init(pos.x,pos.y,e,this.lastSelectedActor,this.screenMousePoint,ct))}if(null!==lactor){pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));lactor.mouseEnter((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,ct))}}pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,
this.screenMousePoint.y,0));if(null!==lactor)lactor.mouseMove((new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,ct));this.prevMousePoint.x=pos.x;this.prevMousePoint.y=pos.y;this.lastSelectedActor=lactor},__mouseOutHandler:function(e){if(this.dragging)return;if(null!==this.lastSelectedActor){this.getCanvasCoord(this.mousePoint,e);var pos=new CAAT.Point(this.mousePoint.x,this.mousePoint.y,0);this.lastSelectedActor.viewToModel(pos);var ev=(new CAAT.MouseEvent).init(pos.x,pos.y,e,
this.lastSelectedActor,this.screenMousePoint,this.currentScene.time);this.lastSelectedActor.mouseExit(ev);this.lastSelectedActor.mouseOut(ev);if(!this.dragging)this.lastSelectedActor=null}else{this.isMouseDown=false;this.in_=false}},__mouseOverHandler:function(e){if(this.dragging)return;var lactor;var pos,ev;if(null==this.lastSelectedActor){lactor=this.findActorAtPosition(this.mousePoint);if(null!==lactor){pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));ev=
(new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,this.currentScene?this.currentScene.time:0);lactor.mouseOver(ev);lactor.mouseEnter(ev)}this.lastSelectedActor=lactor}else{lactor=this.lastSelectedActor;pos=lactor.viewToModel(new CAAT.Point(this.screenMousePoint.x,this.screenMousePoint.y,0));ev=(new CAAT.MouseEvent).init(pos.x,pos.y,e,lactor,this.screenMousePoint,this.currentScene.time);lactor.mouseOver(ev);lactor.mouseEnter(ev)}},__mouseDBLClickHandler:function(e){this.getCanvasCoord(this.mousePoint,
e);if(null!==this.lastSelectedActor)this.lastSelectedActor.mouseDblClick((new CAAT.MouseEvent).init(this.mousePoint.x,this.mousePoint.y,e,this.lastSelectedActor,this.screenMousePoint,this.currentScene.time))},__touchStartHandler:function(e){if(e.target===this.canvas){e.preventDefault();e=e.targetTouches[0];var mp=this.mousePoint;this.getCanvasCoord(mp,e);if(mp.x<0||mp.y<0||mp.x>=this.width||mp.y>=this.height)return;this.touching=true;this.__mouseDownHandler(e)}},__touchEndHandler:function(e){if(this.touching){e.preventDefault();
e=e.changedTouches[0];var mp=this.mousePoint;this.getCanvasCoord(mp,e);this.touching=false;this.__mouseUpHandler(e)}},__touchMoveHandler:function(e){if(this.touching){e.preventDefault();if(this.gesturing)return;for(var i=0;i<e.targetTouches.length;i++){var ee=e.targetTouches[i];var mp=this.mousePoint;this.getCanvasCoord(mp,ee);this.__mouseMoveHandler(ee)}}},__gestureStart:function(scale,rotation){this.gesturing=true;this.__gestureRotation=this.lastSelectedActor.rotationAngle;this.__gestureSX=this.lastSelectedActor.scaleX-
1;this.__gestureSY=this.lastSelectedActor.scaleY-1},__gestureChange:function(scale,rotation){if(typeof scale==="undefined"||typeof rotation==="undefined")return;if(this.lastSelectedActor!==null&&this.lastSelectedActor.isGestureEnabled()){this.lastSelectedActor.setRotation(rotation*Math.PI/180+this.__gestureRotation);this.lastSelectedActor.setScale(this.__gestureSX+scale,this.__gestureSY+scale)}},__gestureEnd:function(scale,rotation){this.gesturing=false;this.__gestureRotation=0;this.__gestureScale=
0},__touchEndHandlerMT:function(e){e.preventDefault();var i,j;var recent=[];for(i=0;i<e.changedTouches.length;i++){var _touch=e.changedTouches[i];var id=_touch.identifier;recent.push(id)}var actors={};for(i=0;i<recent.length;i++){var touchId=recent[i];if(this.touches[touchId]){var actor=this.touches[touchId].actor;if(!actors[actor.id])actors[actor.id]={actor:actor,touch:(new CAAT.TouchEvent).init(e,actor,this.currentScene.time)};var ev=actors[actor.id].touch;ev.addChangedTouch(this.touches[touchId].touch)}}for(i=
0;i<e.changedTouches.length;i++){var touch=e.changedTouches[i];var id=touch.identifier;delete this.touches[id]}for(var pr in actors){var data=actors[pr];var actor=data.actor;var touch=data.touch;for(var actorId in this.touches){var tt=this.touches[actorId];if(tt.actor.id===actor.id)touch.addTouch(tt.touch)}actor.touchEnd(touch)}},__touchMoveHandlerMT:function(e){e.preventDefault();var i;var recent=[];for(i=0;i<e.changedTouches.length;i++){var touch=e.changedTouches[i];var id=touch.identifier;if(this.touches[id]){var mp=
this.mousePoint;this.getCanvasCoord(mp,touch);var actor=this.touches[id].actor;mp=actor.viewToModel(mp);this.touches[id]={actor:actor,touch:new CAAT.TouchInfo(id,mp.x,mp.y,actor)};recent.push(id)}}var actors={};for(i=0;i<recent.length;i++){var touchId=recent[i];var actor=this.touches[touchId].actor;if(!actors[actor.id])actors[actor.id]={actor:actor,touch:(new CAAT.TouchEvent).init(e,actor,this.currentScene.time)};var ev=actors[actor.id].touch;ev.addTouch(this.touches[touchId].touch);ev.addChangedTouch(this.touches[touchId].touch)}for(var pr in actors){var data=
actors[pr];var actor=data.actor;var touch=data.touch;for(var actorId in this.touches){var tt=this.touches[actorId];if(tt.actor.id===actor.id)touch.addTouch(tt.touch)}actor.touchMove(touch)}},__touchCancelHandleMT:function(e){this.__touchEndHandlerMT(e)},__touchStartHandlerMT:function(e){e.preventDefault();var i;var recent=[];var allInCanvas=true;for(i=0;i<e.changedTouches.length;i++){var touch=e.changedTouches[i];var id=touch.identifier;var mp=this.mousePoint;this.getCanvasCoord(mp,touch);if(mp.x<
0||mp.y<0||mp.x>=this.width||mp.y>=this.height){allInCanvas=false;continue}var actor=this.findActorAtPosition(mp);if(actor!==null){mp=actor.viewToModel(mp);if(!this.touches[id]){this.touches[id]={actor:actor,touch:new CAAT.TouchInfo(id,mp.x,mp.y,actor)};recent.push(id)}}}var actors={};for(i=0;i<recent.length;i++){var touchId=recent[i];var actor=this.touches[touchId].actor;if(!actors[actor.id])actors[actor.id]={actor:actor,touch:(new CAAT.TouchEvent).init(e,actor,this.currentScene.time)};var ev=actors[actor.id].touch;
ev.addTouch(this.touches[touchId].touch);ev.addChangedTouch(this.touches[touchId].touch)}for(var pr in actors){var data=actors[pr];var actor=data.actor;var touch=data.touch;for(var actorId in this.touches){var tt=this.touches[actorId];if(tt.actor.id===actor.id)touch.addTouch(tt.touch)}actor.touchStart(touch)}},__findTouchFirstActor:function(){var t=Number.MAX_VALUE;var actor=null;for(var pr in this.touches){var touch=this.touches[pr];if(touch.touch.time&&touch.touch.time<t&&touch.actor.isGestureEnabled()){actor=
touch.actor;t=touch.touch.time}}return actor},__gesturedActor:null,__touchGestureStartHandleMT:function(e){var actor=this.__findTouchFirstActor();if(actor!==null&&actor.isGestureEnabled()){this.__gesturedActor=actor;this.__gestureRotation=actor.rotationAngle;this.__gestureSX=actor.scaleX-1;this.__gestureSY=actor.scaleY-1;actor.gestureStart(e.rotation*Math.PI/180,e.scale+this.__gestureSX,e.scale+this.__gestureSY)}},__touchGestureEndHandleMT:function(e){if(null!==this.__gesturedActor&&this.__gesturedActor.isGestureEnabled())this.__gesturedActor.gestureEnd(e.rotation*
Math.PI/180,e.scale+this.__gestureSX,e.scale+this.__gestureSY);this.__gestureRotation=0;this.__gestureScale=0},__touchGestureChangeHandleMT:function(e){if(this.__gesturedActor!==null&&this.__gesturedActor.isGestureEnabled())this.__gesturedActor.gestureChange(e.rotation*Math.PI/180,this.__gestureSX+e.scale,this.__gestureSY+e.scale)},addHandlers:function(canvas){var me=this;window.addEventListener("mouseup",function(e){if(me.touching){e.preventDefault();e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();
var mp=me.mousePoint;me.getCanvasCoord(mp,e);me.__mouseUpHandler(e);me.touching=false}},false);window.addEventListener("mousedown",function(e){if(e.target===canvas){e.preventDefault();e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();var mp=me.mousePoint;me.getCanvasCoord(mp,e);if(mp.x<0||mp.y<0||mp.x>=me.width||mp.y>=me.height)return;me.touching=true;me.__mouseDownHandler(e)}},false);window.addEventListener("mouseover",function(e){if(e.target===canvas&&!me.dragging){e.preventDefault();
e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();var mp=me.mousePoint;me.getCanvasCoord(mp,e);if(mp.x<0||mp.y<0||mp.x>=me.width||mp.y>=me.height)return;me.__mouseOverHandler(e)}},false);window.addEventListener("mouseout",function(e){if(e.target===canvas&&!me.dragging){e.preventDefault();e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();var mp=me.mousePoint;me.getCanvasCoord(mp,e);me.__mouseOutHandler(e)}},false);window.addEventListener("mousemove",function(e){e.preventDefault();
e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();var mp=me.mousePoint;me.getCanvasCoord(mp,e);if(!me.dragging&&(mp.x<0||mp.y<0||mp.x>=me.width||mp.y>=me.height))return;me.__mouseMoveHandler(e)},false);window.addEventListener("dblclick",function(e){if(e.target===canvas){e.preventDefault();e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();var mp=me.mousePoint;me.getCanvasCoord(mp,e);if(mp.x<0||mp.y<0||mp.x>=me.width||mp.y>=me.height)return;me.__mouseDBLClickHandler(e)}},false);
if(CAAT.TOUCH_BEHAVIOR===CAAT.TOUCH_AS_MOUSE){canvas.addEventListener("touchstart",this.__touchStartHandler.bind(this),false);canvas.addEventListener("touchmove",this.__touchMoveHandler.bind(this),false);canvas.addEventListener("touchend",this.__touchEndHandler.bind(this),false);canvas.addEventListener("gesturestart",function(e){if(e.target===canvas){e.preventDefault();me.__gestureStart(e.scale,e.rotation)}},false);canvas.addEventListener("gestureend",function(e){if(e.target===canvas){e.preventDefault();
me.__gestureEnd(e.scale,e.rotation)}},false);canvas.addEventListener("gesturechange",function(e){if(e.target===canvas){e.preventDefault();me.__gestureChange(e.scale,e.rotation)}},false)}else if(CAAT.TOUCH_BEHAVIOR===CAAT.TOUCH_AS_MULTITOUCH){canvas.addEventListener("touchstart",this.__touchStartHandlerMT.bind(this),false);canvas.addEventListener("touchmove",this.__touchMoveHandlerMT.bind(this),false);canvas.addEventListener("touchend",this.__touchEndHandlerMT.bind(this),false);canvas.addEventListener("touchcancel",
this.__touchCancelHandleMT.bind(this),false);canvas.addEventListener("gesturestart",this.__touchGestureStartHandleMT.bind(this),false);canvas.addEventListener("gestureend",this.__touchGestureEndHandleMT.bind(this),false);canvas.addEventListener("gesturechange",this.__touchGestureChangeHandleMT.bind(this),false)}},enableEvents:function(onElement){CAAT.RegisterDirector(this);this.in_=false;this.createEventHandler(onElement)},createEventHandler:function(onElement){this.in_=false;this.addHandlers(onElement)}};
if(CAAT.__CSS__){CAAT.Director.prototype.clip=true;CAAT.Director.prototype.glEnabled=false;CAAT.Director.prototype.getRenderType=function(){return"CSS"};CAAT.Director.prototype.setScaleProportional=function(w,h){var factor=Math.min(w/this.referenceWidth,h/this.referenceHeight);this.setScaleAnchored(factor,factor,0,0);this.eventHandler.style.width=""+this.referenceWidth+"px";this.eventHandler.style.height=""+this.referenceHeight+"px"};CAAT.Director.prototype.setBounds=function(x,y,w,h){CAAT.Director.superclass.setBounds.call(this,
x,y,w,h);for(var i=0;i<this.scenes.length;i++)this.scenes[i].setBounds(0,0,w,h);this.eventHandler.style.width=w+"px";this.eventHandler.style.height=h+"px";return this};CAAT.Director.prototype.initialize=function(width,height,domElement,proxy){this.timeline=(new Date).getTime();this.domElement=domElement;this.style("position","absolute");this.style("width",""+width+"px");this.style("height",""+height+"px");this.style("overflow","hidden");this.enableEvents(domElement);this.setBounds(0,0,width,height);
this.checkDebug();return this};CAAT.Director.prototype.render=function(time){this.time+=time;this.animate(this,time);var i,l,tt;if(CAAT.DEBUG)this.resetStats();for(i=0,l=this.childrenList.length;i<l;i++){var c=this.childrenList[i];if(c.isInAnimationFrame(this.time)){tt=c.time-c.start_time;if(c.onRenderStart)c.onRenderStart(tt);c.paintActor(this,tt);if(c.onRenderEnd)c.onRenderEnd(tt);if(!c.isPaused())c.time+=time;if(CAAT.DEBUG){this.statistics.size_total+=c.size_total;this.statistics.size_active+=
c.size_active;this.statistics.size_dirtyRects=this.nDirtyRects}}}this.frameCounter++};CAAT.Director.prototype.addScene=function(scene){scene.setVisible(true);scene.setBounds(0,0,this.width,this.height);this.scenes.push(scene);scene.setEaseListener(this);if(null===this.currentScene)this.setScene(0);this.domElement.appendChild(scene.domElement)};CAAT.Director.prototype.emptyScenes=function(){this.scenes=[];this.domElement.innerHTML="";this.createEventHandler()};CAAT.Director.prototype.setClear=function(clear){return this};
CAAT.Director.prototype.createEventHandler=function(){this.eventHandler=document.createElement("div");this.domElement.appendChild(this.eventHandler);this.eventHandler.style.position="absolute";this.eventHandler.style.left="0";this.eventHandler.style.top="0";this.eventHandler.style.zIndex=999999;this.eventHandler.style.width=""+this.width+"px";this.eventHandler.style.height=""+this.height+"px";this.canvas=this.eventHandler;this.in_=false;this.addHandlers(this.canvas)}}extend(CAAT.Director,CAAT.ActorContainer,
null)})();CAAT.TouchInfo=function(id,x,y,target){this.identifier=id;this.clientX=x;this.pageX=x;this.clientY=y;this.pageY=y;this.target=target;this.time=(new Date).getTime();return this};
(function(){CAAT.TouchEvent=function(){this.touches=[];this.changedTouches=[];return this};CAAT.TouchEvent.prototype={time:0,source:null,sourceEvent:null,shift:false,control:false,alt:false,meta:false,touches:null,changedTouches:null,init:function(sourceEvent,source,time){this.source=source;this.alt=sourceEvent.altKey;this.control=sourceEvent.ctrlKey;this.shift=sourceEvent.shiftKey;this.meta=sourceEvent.metaKey;this.sourceEvent=sourceEvent;this.time=time;return this},addTouch:function(touchInfo){if(-1===
this.touches.indexOf(touchInfo))this.touches.push(touchInfo);return this},addChangedTouch:function(touchInfo){if(-1===this.changedTouches.indexOf(touchInfo))this.changedTouches.push(touchInfo);return this},isAltDown:function(){return this.alt},isControlDown:function(){return this.control},isShiftDown:function(){return this.shift},isMetaDown:function(){return this.meta},getSourceEvent:function(){return this.sourceEvent}}})();
(function(){CAAT.MouseEvent=function(){this.point=new CAAT.Point(0,0,0);this.screenPoint=new CAAT.Point(0,0,0);this.touches=[];return this};CAAT.MouseEvent.prototype={screenPoint:null,point:null,time:0,source:null,shift:false,control:false,alt:false,meta:false,sourceEvent:null,touches:null,init:function(x,y,sourceEvent,source,screenPoint,time){this.point.set(x,y);this.source=source;this.screenPoint=screenPoint;this.alt=sourceEvent.altKey;this.control=sourceEvent.ctrlKey;this.shift=sourceEvent.shiftKey;
this.meta=sourceEvent.metaKey;this.sourceEvent=sourceEvent;this.x=x;this.y=y;this.time=time;return this},isAltDown:function(){return this.alt},isControlDown:function(){return this.control},isShiftDown:function(){return this.shift},isMetaDown:function(){return this.meta},getSourceEvent:function(){return this.sourceEvent}}})();
CAAT.setCoordinateClamping=function(clamp){if(clamp){CAAT.Matrix.prototype.transformRenderingContext=CAAT.Matrix.prototype.transformRenderingContext_Clamp;CAAT.Matrix.prototype.transformRenderingContextSet=CAAT.Matrix.prototype.transformRenderingContextSet_Clamp}else{CAAT.Matrix.prototype.transformRenderingContext=CAAT.Matrix.prototype.transformRenderingContext_NoClamp;CAAT.Matrix.prototype.transformRenderingContextSet=CAAT.Matrix.prototype.transformRenderingContextSet_NoClamp}};
CAAT.TOUCH_AS_MOUSE=1;CAAT.TOUCH_AS_MULTITOUCH=2;CAAT.TOUCH_BEHAVIOR=CAAT.TOUCH_AS_MOUSE;CAAT.PMR=64;CAAT.GLRENDER=false;CAAT.DEBUG=false;CAAT.DEBUGBB=false;CAAT.DEBUGBBBCOLOR="#00f";CAAT.DEBUGAABB=false;CAAT.DEBUGAABBCOLOR="#f00";CAAT.DEBUG_DIRTYRECTS=false;CAAT.log=function(){if(window.console)window.console.log(Array.prototype.slice.call(arguments))};CAAT.FRAME_TIME=0;CAAT.GlobalEventsEnabled=false;CAAT.prevOnDeviceMotion=null;CAAT.onDeviceMotion=null;
CAAT.accelerationIncludingGravity={x:0,y:0,z:0};CAAT.rotationRate={alpha:0,beta:0,gamma:0};CAAT.DRAG_THRESHOLD_X=5;CAAT.DRAG_THRESHOLD_Y=5;CAAT.renderEnabled=false;CAAT.FPS=60;CAAT.windowResizeListeners=[];CAAT.registerResizeListener=function(f){CAAT.windowResizeListeners.push(f)};CAAT.unregisterResizeListener=function(director){for(var i=0;i<CAAT.windowResizeListeners.length;i++)if(director===CAAT.windowResizeListeners[i]){CAAT.windowResizeListeners.splice(i,1);return}};CAAT.keyListeners=[];
CAAT.registerKeyListener=function(f){CAAT.keyListeners.push(f)};
CAAT.Keys={ENTER:13,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPSLOCK:20,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,SELECT:93,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,
SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145,SEMICOLON:186,EQUALSIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARDSLASH:191,GRAVEACCENT:192,OPENBRACKET:219,BACKSLASH:220,CLOSEBRAKET:221,SINGLEQUOTE:222};CAAT.SHIFT_KEY=16;CAAT.CONTROL_KEY=17;CAAT.ALT_KEY=18;CAAT.ENTER_KEY=13;CAAT.KEY_MODIFIERS={alt:false,control:false,shift:false};
CAAT.KeyEvent=function(keyCode,up_or_down,modifiers,originalEvent){this.keyCode=keyCode;this.action=up_or_down;this.modifiers=modifiers;this.sourceEvent=originalEvent;this.preventDefault=function(){this.sourceEvent.preventDefault()};this.getKeyCode=function(){return this.keyCode};this.getAction=function(){return this.action};this.modifiers=function(){return this.modifiers};this.isShiftPressed=function(){return this.modifiers.shift};this.isControlPressed=function(){return this.modifiers.control};this.isAltPressed=
function(){return this.modifiers.alt};this.getSourceEvent=function(){return this.sourceEvent}};
CAAT.GlobalEnableEvents=function __GlobalEnableEvents(){if(CAAT.GlobalEventsEnabled)return;this.GlobalEventsEnabled=true;window.addEventListener("keydown",function(evt){var key=evt.which?evt.which:evt.keyCode;if(key===CAAT.SHIFT_KEY)CAAT.KEY_MODIFIERS.shift=true;else if(key===CAAT.CONTROL_KEY)CAAT.KEY_MODIFIERS.control=true;else if(key===CAAT.ALT_KEY)CAAT.KEY_MODIFIERS.alt=true;else for(var i=0;i<CAAT.keyListeners.length;i++)CAAT.keyListeners[i](new CAAT.KeyEvent(key,"down",{alt:CAAT.KEY_MODIFIERS.alt,
control:CAAT.KEY_MODIFIERS.control,shift:CAAT.KEY_MODIFIERS.shift},evt))},false);window.addEventListener("keyup",function(evt){var key=evt.which?evt.which:evt.keyCode;if(key===CAAT.SHIFT_KEY)CAAT.KEY_MODIFIERS.shift=false;else if(key===CAAT.CONTROL_KEY)CAAT.KEY_MODIFIERS.control=false;else if(key===CAAT.ALT_KEY)CAAT.KEY_MODIFIERS.alt=false;else for(var i=0;i<CAAT.keyListeners.length;i++)CAAT.keyListeners[i](new CAAT.KeyEvent(key,"up",{alt:CAAT.KEY_MODIFIERS.alt,control:CAAT.KEY_MODIFIERS.control,
shift:CAAT.KEY_MODIFIERS.shift},evt))},false);window.addEventListener("resize",function(evt){for(var i=0;i<CAAT.windowResizeListeners.length;i++)CAAT.windowResizeListeners[i].windowResized(window.innerWidth,window.innerHeight)},false)};
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function raf(callback,element){window.setTimeout(callback,1E3/CAAT.FPS)}}();CAAT.SET_INTERVAL=0;CAAT.endLoop=function(){if(CAAT.NO_RAF){if(CAAT.INTERVAL_ID!==null)clearInterval(CAAT.INTERVAL_ID)}else CAAT.ENDRAF=true;CAAT.renderEnabled=false};CAAT.ENDRAF=false;CAAT.INTERVAL_ID=null;
CAAT.loop=function(fps){if(CAAT.renderEnabled)return;for(var i=0,l=CAAT.director.length;i<l;i++)CAAT.director[i].timeline=(new Date).getTime();CAAT.FPS=fps||60;CAAT.renderEnabled=true;if(CAAT.NO_RAF)CAAT.INTERVAL_ID=setInterval(function(){var t=(new Date).getTime();for(var i=0,l=CAAT.director.length;i<l;i++){var dr=CAAT.director[i];if(dr.renderMode===CAAT.Director.RENDER_MODE_CONTINUOUS||dr.needsRepaint)dr.renderFrame()}CAAT.FRAME_TIME=t-CAAT.SET_INTERVAL;if(CAAT.RAF)CAAT.REQUEST_ANIMATION_FRAME_TIME=
(new Date).getTime()-CAAT.RAF;CAAT.RAF=(new Date).getTime();CAAT.SET_INTERVAL=t},1E3/CAAT.FPS);else CAAT.renderFrame()};CAAT.currentDirector=null;CAAT.getCurrentScene=function(){return CAAT.currentDirector.getCurrentScene()};CAAT.FPS_REFRESH=500;CAAT.RAF=0;CAAT.REQUEST_ANIMATION_FRAME_TIME=0;
CAAT.renderFrame=function(){if(CAAT.ENDRAF){CAAT.ENDRAF=false;return}var t=(new Date).getTime();for(var i=0,l=CAAT.director.length;i<l;i++){var dr=CAAT.director[i];if(dr.renderMode===CAAT.Director.RENDER_MODE_CONTINUOUS||dr.needsRepaint)dr.renderFrame()}t=(new Date).getTime()-t;CAAT.FRAME_TIME=t;if(CAAT.RAF)CAAT.REQUEST_ANIMATION_FRAME_TIME=(new Date).getTime()-CAAT.RAF;CAAT.RAF=(new Date).getTime();window.requestAnimFrame(CAAT.renderFrame,0)};
CAAT.setCursor=function(cursor){if(navigator.browser!=="iOS")document.body.style.cursor=cursor};CAAT.RegisterDirector=function __CAATGlobal_RegisterDirector(director){if(!CAAT.director)CAAT.director=[];CAAT.director.push(director);CAAT.GlobalEnableEvents()};
(function(){function tilt(data){CAAT.rotationRate={alpha:0,beta:data[0],gamma:data[1]}}if(window.DeviceOrientationEvent)window.addEventListener("deviceorientation",function(event){tilt([event.beta,event.gamma])},true);else if(window.DeviceMotionEvent)window.addEventListener("devicemotion",function(event){tilt([event.acceleration.x*2,event.acceleration.y*2])},true);else window.addEventListener("MozOrientation",function(event){tilt([-event.y*45,event.x*45])},true)})();
(function(){CAAT.SpriteImageHelper=function(x,y,w,h,iw,ih){this.x=x;this.y=y;this.width=w;this.height=h;this.setGL(x/iw,y/ih,(x+w-1)/iw,(y+h-1)/ih);return this};CAAT.SpriteImageHelper.prototype={x:0,y:0,width:0,height:0,u:0,v:0,u1:0,v1:0,setGL:function(u,v,u1,v1){this.u=u;this.v=v;this.u1=u1;this.v1=v1;return this}}})();
(function(){CAAT.SpriteImage=function(){this.paint=this.paintN;this.setAnimationImageIndex([0]);this.mapInfo={};return this};CAAT.SpriteImage.prototype={animationImageIndex:null,prevAnimationTime:-1,changeFPS:1E3,transformation:0,spriteIndex:0,TR_NONE:0,TR_FLIP_HORIZONTAL:1,TR_FLIP_VERTICAL:2,TR_FLIP_ALL:3,TR_FIXED_TO_SIZE:4,TR_TILE:5,image:null,rows:1,columns:1,width:0,height:0,singleWidth:0,singleHeight:0,scaleX:1,scaleY:1,offsetX:0,offsetY:0,ownerActor:null,mapInfo:null,map:null,setOwner:function(actor){this.ownerActor=
actor;return this},getRows:function(){return this.rows},getColumns:function(){return this.columns},getWidth:function(){var el=this.mapInfo[this.spriteIndex];return el.width},getHeight:function(){var el=this.mapInfo[this.spriteIndex];return el.height},getRef:function(){var ret=new CAAT.SpriteImage;ret.image=this.image;ret.rows=this.rows;ret.columns=this.columns;ret.width=this.width;ret.height=this.height;ret.singleWidth=this.singleWidth;ret.singleHeight=this.singleHeight;ret.mapInfo=this.mapInfo;ret.offsetX=
this.offsetX;ret.offsetY=this.offsetY;ret.scaleX=this.scaleX;ret.scaleY=this.scaleY;return ret},setOffsetX:function(x){this.offsetX=x;return this},setOffsetY:function(y){this.offsetY=y;return this},setOffset:function(x,y){this.offsetX=x;this.offsetY=y;return this},initialize:function(image,rows,columns){this.image=image;this.rows=rows;this.columns=columns;this.width=image.width;this.height=image.height;this.singleWidth=Math.floor(this.width/columns);this.singleHeight=Math.floor(this.height/rows);
this.mapInfo={};var i,sx0,sy0;var helper;if(image.__texturePage){image.__du=this.singleWidth/image.__texturePage.width;image.__dv=this.singleHeight/image.__texturePage.height;var w=this.singleWidth;var h=this.singleHeight;var mod=this.columns;if(image.inverted){var t=w;w=h;h=t;mod=this.rows}var xt=this.image.__tx;var yt=this.image.__ty;var tp=this.image.__texturePage;for(i=0;i<rows*columns;i++){var c=i%mod>>0;var r=i/mod>>0;var u=xt+c*w;var v=yt+r*h;var u1=u+w;var v1=v+h;helper=(new CAAT.SpriteImageHelper(u,
v,u1-u,v1-v,tp.width,tp.height)).setGL(u/tp.width,v/tp.height,u1/tp.width,v1/tp.height);this.mapInfo[i]=helper}}else for(i=0;i<rows*columns;i++){sx0=(i%this.columns|0)*this.singleWidth;sy0=(i/this.columns|0)*this.singleHeight;helper=new CAAT.SpriteImageHelper(sx0,sy0,this.singleWidth,this.singleHeight,image.width,image.height);this.mapInfo[i]=helper}return this},paintTiled:function(director,time,x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];var r=new CAAT.Rectangle;this.ownerActor.AABB.intersect(director.AABB,
r);var w=this.getWidth();var h=this.getHeight();var xoff=(this.offsetX-this.ownerActor.x)%w;if(xoff>0)xoff=xoff-w;var yoff=(this.offsetY-this.ownerActor.y)%h;if(yoff>0)yoff=yoff-h;var nw=((r.width-xoff)/w>>0)+1;var nh=((r.height-yoff)/h>>0)+1;var i,j;var ctx=director.ctx;for(i=0;i<nh;i++)for(j=0;j<nw;j++)ctx.drawImage(this.image,el.x,el.y,el.width,el.height,r.x-this.ownerActor.x+xoff+j*el.width>>0,r.y-this.ownerActor.y+yoff+i*el.height>>0,el.width,el.height)},paintInvertedH:function(director,time,
x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];var ctx=director.ctx;ctx.save();ctx.translate((x|0)+el.width,y|0);ctx.scale(-1,1);ctx.drawImage(this.image,el.x,el.y,el.width,el.height,this.offsetX>>0,this.offsetY>>0,el.width,el.height);ctx.restore();return this},paintInvertedV:function(director,time,x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];var ctx=director.ctx;ctx.save();ctx.translate(x|0,y+el.height|0);ctx.scale(1,-1);ctx.drawImage(this.image,
el.x,el.y,el.width,el.height,this.offsetX>>0,this.offsetY>>0,el.width,el.height);ctx.restore();return this},paintInvertedHV:function(director,time,x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];var ctx=director.ctx;ctx.save();ctx.translate(x|0,y+el.height|0);ctx.scale(1,-1);ctx.translate(el.width,0);ctx.scale(-1,1);ctx.drawImage(this.image,el.x,el.y,el.width,el.height,this.offsetX>>0,this.offsetY>>0,el.width,el.height);ctx.restore();return this},paintN:function(director,
time,x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];director.ctx.drawImage(this.image,el.x,el.y,el.width,el.height,this.offsetX+x>>0,this.offsetY+y>>0,el.width,el.height);return this},paintChunk:function(ctx,dx,dy,x,y,w,h){ctx.drawImage(this.image,x,y,w,h,dx,dy,w,h)},paintTile:function(ctx,index,x,y){var el=this.mapInfo[index];ctx.drawImage(this.image,el.x,el.y,el.width,el.height,this.offsetX+x>>0,this.offsetY+y>>0,el.width,el.height);return this},paintScaled:function(director,
time,x,y){this.setSpriteIndexAtTime(time);var el=this.mapInfo[this.spriteIndex];director.ctx.drawImage(this.image,el.x,el.y,el.width,el.height,this.offsetX+x>>0,this.offsetY+y>>0,this.ownerActor.width,this.ownerActor.height);return this},getCurrentSpriteImageCSSPosition:function(){var el=this.mapInfo[this.spriteIndex];var x=-(el.x-this.offsetX);var y=-(el.y-this.offsetY);return""+x+"px "+y+"px "+(this.ownerActor.transformation===this.TR_TILE?"repeat":"no-repeat")},getNumImages:function(){return this.rows*
this.columns},setUV:function(uvBuffer,uvIndex){var im=this.image;if(!im.__texturePage)return;var index=uvIndex;var sIndex=this.spriteIndex;var el=this.mapInfo[this.spriteIndex];var u=el.u;var v=el.v;var u1=el.u1;var v1=el.v1;if(this.offsetX||this.offsetY){var w=this.ownerActor.width;var h=this.ownerActor.height;var tp=im.__texturePage;var _u=-this.offsetX/tp.width;var _v=-this.offsetY/tp.height;var _u1=(w-this.offsetX)/tp.width;var _v1=(h-this.offsetY)/tp.height;u=_u+im.__u;v=_v+im.__v;u1=_u1+im.__u;
v1=_v1+im.__v}if(im.inverted){uvBuffer[index++]=u1;uvBuffer[index++]=v;uvBuffer[index++]=u1;uvBuffer[index++]=v1;uvBuffer[index++]=u;uvBuffer[index++]=v1;uvBuffer[index++]=u;uvBuffer[index++]=v}else{uvBuffer[index++]=u;uvBuffer[index++]=v;uvBuffer[index++]=u1;uvBuffer[index++]=v;uvBuffer[index++]=u1;uvBuffer[index++]=v1;uvBuffer[index++]=u;uvBuffer[index++]=v1}},setChangeFPS:function(fps){this.changeFPS=fps;return this},setSpriteTransformation:function(transformation){this.transformation=transformation;
switch(transformation){case this.TR_FLIP_HORIZONTAL:this.paint=this.paintInvertedH;break;case this.TR_FLIP_VERTICAL:this.paint=this.paintInvertedV;break;case this.TR_FLIP_ALL:this.paint=this.paintInvertedHV;break;case this.TR_FIXED_TO_SIZE:this.paint=this.paintScaled;break;case this.TR_TILE:this.paint=this.paintTiled;break;default:this.paint=this.paintN}this.ownerActor.invalidate();return this},resetAnimationTime:function(){this.prevAnimationTime=-1;return this},setAnimationImageIndex:function(aAnimationImageIndex){this.animationImageIndex=
aAnimationImageIndex;this.spriteIndex=aAnimationImageIndex[0];this.prevAnimationTime=-1;return this},setSpriteIndex:function(index){this.spriteIndex=index;return this},setSpriteIndexAtTime:function(time){if(this.animationImageIndex.length>1)if(this.prevAnimationTime===-1){this.prevAnimationTime=time;this.spriteIndex=this.animationImageIndex[0];this.ownerActor.invalidate()}else{var ttime=time;ttime-=this.prevAnimationTime;ttime/=this.changeFPS;ttime%=this.animationImageIndex.length;var idx=this.animationImageIndex[Math.floor(ttime)];
this.spriteIndex=idx;this.ownerActor.invalidate()}},getMapInfo:function(index){return this.mapInfo[index]},initializeFromMap:function(image,map){this.initialize(image,1,1);var key;var helper;var count=0;for(key in map){var value=map[key];helper=new CAAT.SpriteImageHelper(value.x,value.y,value.width,value.height,image.width,image.height);this.mapInfo[key]=helper;if(!count)this.setAnimationImageIndex([key]);count++}return this},initializeAsGlyphDesigner:function(image,map){this.initialize(image,1,1);
var key;var helper;var count=0;for(key in map){var value=map[key];helper=new CAAT.SpriteImageHelper(value.x,value.y,value.width,value.height,image.width,image.height);helper.xoffset=typeof value.xoffset==="undefined"?0:value.xoffset;helper.yoffset=typeof value.yoffset==="undefined"?0:value.yoffset;helper.xadvance=typeof value.xadvance==="undefined"?value.width:value.xadvance;this.mapInfo[key]=helper;if(!count)this.setAnimationImageIndex([key]);count++}return this},initializeAsFontMap:function(image,
chars){this.initialize(image,1,1);var helper;var x=0;for(var i=0;i<chars.length;i++){var value=chars[i];helper=new CAAT.SpriteImageHelper(x,0,value.width,image.height,image.width,image.height);helper.xoffset=0;helper.yoffset=0;helper.xadvance=value.width;x+=value.width;this.mapInfo[chars[i].c]=helper;if(!i)this.setAnimationImageIndex([chars[i].c])}return this},initializeAsMonoTypeFontMap:function(image,chars){var map=[];var charArr=chars.split("");var w=image.width/charArr.length>>0;for(var i=0;i<
charArr.length;i++)map.push({c:charArr[i],width:w});return this.initializeAsFontMap(image,map)},stringWidth:function(str){var i,l,w=0,charInfo;for(i=0,l=str.length;i<l;i++){charInfo=this.mapInfo[str.charAt(i)];if(charInfo)w+=charInfo.xadvance}return w},stringHeight:function(){if(this.fontHeight)return this.fontHeight;var y=0;for(var i in this.mapInfo){var mi=this.mapInfo[i];var h=mi.height+mi.yoffset;if(h>y)y=h}this.fontHeight=y;return this.fontHeight},drawString:function(ctx,str,x,y){var i,l,charInfo,
w;var charArr=str.split("");for(i=0;i<charArr.length;i++){charInfo=this.mapInfo[charArr[i]];if(charInfo){w=charInfo.width;ctx.drawImage(this.image,charInfo.x,charInfo.y,w,charInfo.height,x+charInfo.xoffset,y+charInfo.yoffset,w,charInfo.height);x+=charInfo.xadvance}}}}})();
(function(){CAAT.ImagePreloader=function(){this.images=[];return this};CAAT.ImagePreloader.prototype={images:null,notificationCallback:null,imageCounter:0,loadImages:function(aImages,callback_loaded_one_image,callback_error){if(!aImages)if(callback_loaded_one_image)callback_loaded_one_image(0,[]);var me=this,i;this.notificationCallback=callback_loaded_one_image;this.images=[];for(i=0;i<aImages.length;i++)this.images.push({id:aImages[i].id,image:new Image});for(i=0;i<aImages.length;i++){this.images[i].image.onload=
function imageLoaded(){me.imageCounter++;me.notificationCallback(me.imageCounter,me.images)};this.images[i].image.onerror=function(index){return function(e){if(callback_error)callback_error(e,index)}}(i);this.images[i].image.src=aImages[i].url}if(aImages.length===0)callback_loaded_one_image(0,[])}}})();
(function(){CAAT.TimerTask=function(){return this};CAAT.TimerTask.prototype={startTime:0,duration:0,callback_timeout:null,callback_tick:null,callback_cancel:null,scene:null,taskId:0,remove:false,create:function(startTime,duration,callback_timeout,callback_tick,callback_cancel){this.startTime=startTime;this.duration=duration;this.callback_timeout=callback_timeout;this.callback_tick=callback_tick;this.callback_cancel=callback_cancel;return this},checkTask:function(time){var ttime=time;ttime-=this.startTime;
if(ttime>=this.duration){this.remove=true;if(this.callback_timeout)this.callback_timeout(time,ttime,this)}else if(this.callback_tick)this.callback_tick(time,ttime,this);return this},reset:function(time){this.remove=false;this.startTime=time;this.scene.ensureTimerTask(this);return this},cancel:function(){this.remove=true;if(null!=this.callback_cancel)this.callback_cancel(this.scene.time,this.scene.time-this.startTime,this);return this}}})();
(function(){CAAT.TimerManager=function(){this.timerList=[];return this};CAAT.TimerManager.prototype={timerList:null,timerSequence:0,checkTimers:function(time){var tl=this.timerList;var i=tl.length-1;while(i>=0){if(!tl[i].remove)tl[i].checkTask(time);i--}},ensureTimerTask:function(timertask){if(!this.hasTimer(timertask))this.timerList.push(timertask);return this},hasTimer:function(timertask){var tl=this.timerList;var i=tl.length-1;while(i>=0){if(tl[i]===timertask)return true;i--}return false},createTimer:function(startTime,
duration,callback_timeout,callback_tick,callback_cancel){var tt=(new CAAT.TimerTask).create(startTime,duration,callback_timeout,callback_tick,callback_cancel);tt.taskId=this.timerSequence++;tt.sceneTime=this.time;tt.scene=this;this.timerList.push(tt);return tt},removeExpiredTimers:function(){var i;var tl=this.timerList;for(i=0;i<tl.length;i++)if(tl[i].remove)tl.splice(i,1)}}})();
(function(){CAAT.Scene=function(){CAAT.Scene.superclass.constructor.call(this);this.timerManager=new CAAT.TimerManager;this.fillStyle=null;this.isGlobalAlpha=true;return this};CAAT.Scene.prototype={easeContainerBehaviour:null,easeContainerBehaviourListener:null,easeIn:false,EASE_ROTATION:1,EASE_SCALE:2,EASE_TRANSLATE:3,paused:false,timerManager:null,isPaused:function(){return this.paused},setPaused:function(paused){this.paused=paused},createTimer:function(startTime,duration,callback_timeout,callback_tick,
callback_cancel){return this.timerManager.createTimer(startTime,duration,callback_timeout,callback_tick,callback_cancel)},animate:function(director,time){this.timerManager.checkTimers(time);CAAT.Scene.superclass.animate.call(this,director,time);this.timerManager.removeExpiredTimers()},createAlphaBehaviour:function(time,isIn){var ab=new CAAT.AlphaBehavior;ab.setFrameTime(0,time);ab.startAlpha=isIn?0:1;ab.endAlpha=isIn?1:0;this.easeContainerBehaviour.addBehavior(ab)},easeTranslationIn:function(time,
alpha,anchor,interpolator){this.easeTranslation(time,alpha,anchor,true,interpolator)},easeTranslationOut:function(time,alpha,anchor,interpolator){this.easeTranslation(time,alpha,anchor,false,interpolator)},easeTranslation:function(time,alpha,anchor,isIn,interpolator){this.easeContainerBehaviour=new CAAT.ContainerBehavior;this.easeIn=isIn;var pb=new CAAT.PathBehavior;if(interpolator)pb.setInterpolator(interpolator);pb.setFrameTime(0,time);if(anchor<1)anchor=1;else if(anchor>4)anchor=4;switch(anchor){case CAAT.Actor.prototype.ANCHOR_TOP:if(isIn)pb.setPath((new CAAT.Path).setLinear(0,
-this.height,0,0));else pb.setPath((new CAAT.Path).setLinear(0,0,0,-this.height));break;case CAAT.Actor.prototype.ANCHOR_BOTTOM:if(isIn)pb.setPath((new CAAT.Path).setLinear(0,this.height,0,0));else pb.setPath((new CAAT.Path).setLinear(0,0,0,this.height));break;case CAAT.Actor.prototype.ANCHOR_LEFT:if(isIn)pb.setPath((new CAAT.Path).setLinear(-this.width,0,0,0));else pb.setPath((new CAAT.Path).setLinear(0,0,-this.width,0));break;case CAAT.Actor.prototype.ANCHOR_RIGHT:if(isIn)pb.setPath((new CAAT.Path).setLinear(this.width,
0,0,0));else pb.setPath((new CAAT.Path).setLinear(0,0,this.width,0));break}if(alpha)this.createAlphaBehaviour(time,isIn);this.easeContainerBehaviour.addBehavior(pb);this.easeContainerBehaviour.setFrameTime(this.time,time);this.easeContainerBehaviour.addListener(this);this.emptyBehaviorList();CAAT.Scene.superclass.addBehavior.call(this,this.easeContainerBehaviour)},easeScaleIn:function(starttime,time,alpha,anchor,interpolator){this.easeScale(starttime,time,alpha,anchor,true,interpolator);this.easeIn=
true},easeScaleOut:function(starttime,time,alpha,anchor,interpolator){this.easeScale(starttime,time,alpha,anchor,false,interpolator);this.easeIn=false},easeScale:function(starttime,time,alpha,anchor,isIn,interpolator){this.easeContainerBehaviour=new CAAT.ContainerBehavior;var x=0;var y=0;var x2=0;var y2=0;switch(anchor){case CAAT.Actor.prototype.ANCHOR_TOP_LEFT:case CAAT.Actor.prototype.ANCHOR_TOP_RIGHT:case CAAT.Actor.prototype.ANCHOR_BOTTOM_LEFT:case CAAT.Actor.prototype.ANCHOR_BOTTOM_RIGHT:case CAAT.Actor.prototype.ANCHOR_CENTER:x2=
1;y2=1;break;case CAAT.Actor.prototype.ANCHOR_TOP:case CAAT.Actor.prototype.ANCHOR_BOTTOM:x=1;x2=1;y=0;y2=1;break;case CAAT.Actor.prototype.ANCHOR_LEFT:case CAAT.Actor.prototype.ANCHOR_RIGHT:y=1;y2=1;x=0;x2=1;break;default:alert("scale anchor ?? "+anchor)}if(!isIn){var tmp;tmp=x;x=x2;x2=tmp;tmp=y;y=y2;y2=tmp}if(alpha)this.createAlphaBehaviour(time,isIn);var anchorPercent=this.getAnchorPercent(anchor);var sb=(new CAAT.ScaleBehavior).setFrameTime(starttime,time).setValues(x,x2,y,y2,anchorPercent.x,
anchorPercent.y);if(interpolator)sb.setInterpolator(interpolator);this.easeContainerBehaviour.addBehavior(sb);this.easeContainerBehaviour.setFrameTime(this.time,time);this.easeContainerBehaviour.addListener(this);this.emptyBehaviorList();CAAT.Scene.superclass.addBehavior.call(this,this.easeContainerBehaviour)},addBehavior:function(behaviour){return this},easeRotationIn:function(time,alpha,anchor,interpolator){this.easeRotation(time,alpha,anchor,true,interpolator);this.easeIn=true},easeRotationOut:function(time,
alpha,anchor,interpolator){this.easeRotation(time,alpha,anchor,false,interpolator);this.easeIn=false},easeRotation:function(time,alpha,anchor,isIn,interpolator){this.easeContainerBehaviour=new CAAT.ContainerBehavior;var start=0;var end=0;if(anchor==CAAT.Actor.prototype.ANCHOR_CENTER)anchor=CAAT.Actor.prototype.ANCHOR_TOP;switch(anchor){case CAAT.Actor.prototype.ANCHOR_TOP:case CAAT.Actor.prototype.ANCHOR_BOTTOM:case CAAT.Actor.prototype.ANCHOR_LEFT:case CAAT.Actor.prototype.ANCHOR_RIGHT:start=Math.PI*
(Math.random()<0.5?1:-1);break;case CAAT.Actor.prototype.ANCHOR_TOP_LEFT:case CAAT.Actor.prototype.ANCHOR_TOP_RIGHT:case CAAT.Actor.prototype.ANCHOR_BOTTOM_LEFT:case CAAT.Actor.prototype.ANCHOR_BOTTOM_RIGHT:start=Math.PI/2*(Math.random()<0.5?1:-1);break;default:alert("rot anchor ?? "+anchor)}if(false===isIn){var tmp=start;start=end;end=tmp}if(alpha)this.createAlphaBehaviour(time,isIn);var anchorPercent=this.getAnchorPercent(anchor);var rb=(new CAAT.RotateBehavior).setFrameTime(0,time).setValues(start,
end,anchorPercent.x,anchorPercent.y);if(interpolator)rb.setInterpolator(interpolator);this.easeContainerBehaviour.addBehavior(rb);this.easeContainerBehaviour.setFrameTime(this.time,time);this.easeContainerBehaviour.addListener(this);this.emptyBehaviorList();CAAT.Scene.superclass.addBehavior.call(this,this.easeContainerBehaviour)},setEaseListener:function(listener){this.easeContainerBehaviourListener=listener},behaviorExpired:function(actor){this.easeContainerBehaviourListener.easeEnd(this,this.easeIn)},
activated:function(){},setExpired:function(bExpired){this.expired=bExpired},paint:function(director,time){if(this.fillStyle){var ctx=director.crc;ctx.fillStyle=this.fillStyle;ctx.fillRect(0,0,this.width,this.height)}},findActorAtPosition:function(point){var i,j;var p=new CAAT.Point;if(this.inputList){var il=this.inputList;for(i=0;i<il.length;i++){var ill=il[i];for(j=0;j<ill.length;j++){p.set(point.x,point.y);var modelViewMatrixI=ill[j].worldModelViewMatrix.getInverse();modelViewMatrixI.transformCoord(p);
if(ill[j].contains(p.x,p.y))return ill[j]}}}p.set(point.x,point.y);return CAAT.Scene.superclass.findActorAtPosition.call(this,p)},enableInputList:function(size){this.inputList=[];for(var i=0;i<size;i++)this.inputList.push([]);return this},addActorToInputList:function(actor,index,position){if(index<0)index=0;else if(index>=this.inputList.length)index=this.inputList.length-1;var il=this.inputList[index];if(typeof position==="undefined"||position>=il.length)il.push(actor);else if(position<=0)il.unshift(actor);
else il.splice(position,0,actor);return this},emptyInputList:function(index){if(index<0)index=0;else if(index>=this.inputList.length)index=this.inputList.length-1;this.inputList[index]=[];return this},removeActorFromInputList:function(actor,index){if(typeof index==="undefined"){var i,j;for(i=0;i<this.inputList.length;i++){var il=this.inputList[i];for(j=0;j<il.length;j++)if(il[j]==actor)il.splice(j,1)}return this}if(index<0)index=0;else if(index>=this.inputList.length)index=this.inputList.length-1;
var il=this.inputList[index];for(j=0;j<il.length;j++)if(il[j]==actor)il.splice(j,1);return this}};extend(CAAT.Scene,CAAT.ActorContainer)})();CAAT.modules=CAAT.modules||{};CAAT.modules.CircleManager=CAAT.modules.CircleManager||{};
(function(){CAAT.modules.CircleManager.PackedCircle=function(){this.boundsRule=CAAT.modules.CircleManager.PackedCircle.BOUNDS_RULE_IGNORE;this.position=new CAAT.Point(0,0,0);this.offset=new CAAT.Point(0,0,0);this.targetPosition=new CAAT.Point(0,0,0);return this};CAAT.modules.CircleManager.PackedCircle.prototype={id:0,delegate:null,position:new CAAT.Point(0,0,0),offset:new CAAT.Point(0,0,0),targetPosition:null,targetChaseSpeed:0.02,isFixed:false,boundsRule:0,collisionMask:0,collisionGroup:0,BOUNDS_RULE_WRAP:1,
BOUNDS_RULE_CONSTRAINT:2,BOUNDS_RULE_DESTROY:4,BOUNDS_RULE_IGNORE:8,containsPoint:function(aPoint){var distanceSquared=this.position.getDistanceSquared(aPoint);return distanceSquared<this.radiusSquared},getDistanceSquaredFromPosition:function(aPosition){var distanceSquared=this.position.getDistanceSquared(aPosition);return distanceSquared<this.radiusSquared},intersects:function(aCircle){var distanceSquared=this.position.getDistanceSquared(aCircle.position);return distanceSquared<this.radiusSquared||
distanceSquared<aCircle.radiusSquared},setPosition:function(aPosition){this.position=aPosition;return this},setDelegate:function(aDelegate){this.delegate=aDelegate;return this},setOffset:function(aPosition){this.offset=aPosition;return this},setTargetPosition:function(aTargetPosition){this.targetPosition=aTargetPosition;return this},setTargetChaseSpeed:function(aTargetChaseSpeed){this.targetChaseSpeed=aTargetChaseSpeed;return this},setIsFixed:function(value){this.isFixed=value;return this},setCollisionMask:function(aCollisionMask){this.collisionMask=
aCollisionMask;return this},setCollisionGroup:function(aCollisionGroup){this.collisionGroup=aCollisionGroup;return this},setRadius:function(aRadius){this.radius=aRadius;this.radiusSquared=this.radius*this.radius;return this},initialize:function(overrides){if(overrides)for(var i in overrides)this[i]=overrides[i];return this},dealloc:function(){this.position=null;this.offset=null;this.delegate=null;this.targetPosition=null}}})();
(function(){CAAT.modules.CircleManager.PackedCircleManager=function(){return this};CAAT.modules.CircleManager.PackedCircleManager.prototype={allCircles:[],numberOfCollisionPasses:1,numberOfTargetingPasses:0,bounds:new CAAT.Rectangle,addCircle:function(aCircle){aCircle.id=this.allCircles.length;this.allCircles.push(aCircle);return this},removeCircle:function(aCircle){var index=0,found=false,len=this.allCircles.length;if(len===0)throw"Error: (PackedCircleManager) attempting to remove circle, and allCircles.length === 0!!";
while(len--)if(this.allCircles[len]===aCircle){found=true;index=len;break}if(!found)throw"Could not locate circle in allCircles array!";this.allCircles[index].dealloc();this.allCircles[index]=null;return this},forceCirclesToMatchDelegatePositions:function(){var len=this.allCircles.length;for(var n=0;n<len;n++){var aCircle=this.allCircles[n];if(!aCircle||!aCircle.delegate)continue;aCircle.position.set(aCircle.delegate.x+aCircle.offset.x,aCircle.delegate.y+aCircle.offset.y)}},pushAllCirclesTowardTarget:function(aTarget){var v=
new CAAT.Point(0,0,0),circleList=this.allCircles,len=circleList.length;for(var n=0;n<this.numberOfTargetingPasses;n++)for(var i=0;i<len;i++){var c=circleList[i];if(c.isFixed)continue;v.x=c.position.x-(c.targetPosition.x+c.offset.x);v.y=c.position.y-(c.targetPosition.y+c.offset.y);v.multiply(c.targetChaseSpeed);c.position.x-=v.x;c.position.y-=v.y}},handleCollisions:function(){this.removeExpiredElements();var v=new CAAT.Point(0,0,0),circleList=this.allCircles,len=circleList.length;for(var n=0;n<this.numberOfCollisionPasses;n++)for(var i=
0;i<len;i++){var ci=circleList[i];for(var j=i+1;j<len;j++){var cj=circleList[j];if(!this.circlesCanCollide(ci,cj))continue;var dx=cj.position.x-ci.position.x,dy=cj.position.y-ci.position.y;var r=(ci.radius+cj.radius)*1.08,d=ci.position.getDistanceSquared(cj.position);if(d<r*r-0.02){v.x=dx;v.y=dy;v.normalize();var inverseForce=(r-Math.sqrt(d))*0.5;v.multiply(inverseForce);if(!cj.isFixed){if(ci.isFixed)v.multiply(2.2);cj.position.translatePoint(v)}if(!ci.isFixed){if(cj.isFixed)v.multiply(2.2);ci.position.subtract(v)}}}}},
handleBoundaryForCircle:function(aCircle,boundsRule){var xpos=aCircle.position.x;var ypos=aCircle.position.y;var radius=aCircle.radius;var diameter=radius*2;var wrapXMask=1<<0;var wrapYMask=1<<2;var constrainXMask=1<<3;var constrainYMask=1<<4;var emitEvent=1<<5;boundsRule=wrapYMask|constrainXMask;if(boundsRule&wrapXMask&&xpos-diameter>this.bounds.right)aCircle.position.x=this.bounds.left+radius;else if(boundsRule&wrapXMask&&xpos+diameter<this.bounds.left)aCircle.position.x=this.bounds.right-radius;
if(boundsRule&wrapYMask&&ypos-diameter>this.bounds.bottom)aCircle.position.y=this.bounds.top-radius;else if(boundsRule&wrapYMask&&ypos+diameter<this.bounds.top)aCircle.position.y=this.bounds.bottom+radius;if(boundsRule&constrainXMask&&xpos+radius>=this.bounds.right)aCircle.position.x=aCircle.position.x=this.bounds.right-radius;else if(boundsRule&constrainXMask&&xpos-radius<this.bounds.left)aCircle.position.x=this.bounds.left+radius;if(boundsRule&constrainYMask&&ypos+radius>this.bounds.bottom)aCircle.position.y=
this.bounds.bottom-radius;else if(boundsRule&constrainYMask&&ypos-radius<this.bounds.top)aCircle.position.y=this.bounds.top+radius},getCircleAt:function(xpos,ypos,buffer){var circleList=this.allCircles;var len=circleList.length;var grabVector=new CAAT.Point(xpos,ypos,0);var closestCircle=null;var closestDistance=Number.MAX_VALUE;for(var i=0;i<len;i++){var aCircle=circleList[i];if(!aCircle)continue;var distanceSquared=aCircle.position.getDistanceSquared(grabVector);if(distanceSquared<closestDistance&&
distanceSquared<aCircle.radiusSquared+buffer){closestDistance=distanceSquared;closestCircle=aCircle}}return closestCircle},circlesCanCollide:function(circleA,circleB){if(!circleA||!circleB||circleA===circleB)return false;return true},setBounds:function(x,y,w,h){this.bounds.x=x;this.bounds.y=y;this.bounds.width=w;this.bounds.height=h},setNumberOfCollisionPasses:function(value){this.numberOfCollisionPasses=value;return this},setNumberOfTargetingPasses:function(value){this.numberOfTargetingPasses=value;
return this},sortOnDistanceToTarget:function(circleA,circleB){var valueA=circleA.getDistanceSquaredFromPosition(circleA.targetPosition);var valueB=circleB.getDistanceSquaredFromPosition(circleA.targetPosition);var comparisonResult=0;if(valueA>valueB)comparisonResult=-1;else if(valueA<valueB)comparisonResult=1;return comparisonResult},removeExpiredElements:function(){for(var k=this.allCircles.length;k>=0;k--)if(this.allCircles[k]===null)this.allCircles.splice(k,1)},initialize:function(overrides){if(overrides)for(var i in overrides)this[i]=
overrides[i];return this}}})();(function(){CAAT.modules.LocalStorage=function(){return this};CAAT.modules.LocalStorage.prototype={save:function(key,data){try{localStorage.setItem(key,JSON.stringify(data))}catch(e){}return this},load:function(key){try{return JSON.parse(localStorage.getItem(key))}catch(e){return null}},remove:function(key){try{localStorage.removeItem(key)}catch(e){}return this}}})();
(function(){CAAT.modules.ImageUtil={};CAAT.modules.ImageUtil.createAlphaSpriteSheet=function(maxAlpha,minAlpha,sheetSize,image,bg_fill_style){if(maxAlpha<minAlpha){var t=maxAlpha;maxAlpha=minAlpha;minAlpha=t}var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height*sheetSize;var ctx=canvas.getContext("2d");ctx.fillStyle=bg_fill_style?bg_fill_style:"rgba(255,255,255,0)";ctx.fillRect(0,0,image.width,image.height*sheetSize);var i;for(i=0;i<sheetSize;i++){ctx.globalAlpha=
1-(maxAlpha-minAlpha)/sheetSize*(i+1);ctx.drawImage(image,0,i*image.height)}return canvas};CAAT.modules.ImageUtil.rotate=function(image,angle){angle=angle||0;if(!angle)return image;var canvas=document.createElement("canvas");canvas.width=image.height;canvas.height=image.width;var ctx=canvas.getContext("2d");ctx.globalAlpha=1;ctx.fillStyle="rgba(0,0,0,0)";ctx.clearRect(0,0,canvas.width,canvas.height);var m=new CAAT.Matrix;m.multiply((new CAAT.Matrix).setTranslate(canvas.width/2,canvas.width/2));m.multiply((new CAAT.Matrix).setRotation(angle*
Math.PI/180));m.multiply((new CAAT.Matrix).setTranslate(-canvas.width/2,-canvas.width/2));m.transformRenderingContext(ctx);ctx.drawImage(image,0,0);return canvas};CAAT.modules.ImageUtil.optimize=function(image,threshold,areas){threshold>>=0;var atop=true;var abottom=true;var aleft=true;var aright=true;if(typeof areas!=="undefined"){if(typeof areas.top!=="undefined")atop=areas.top;if(typeof areas.bottom!=="undefined")abottom=areas.bottom;if(typeof areas.left!=="undefined")aleft=areas.left;if(typeof areas.right!==
"undefined")aright=areas.right}var canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;var ctx=canvas.getContext("2d");ctx.fillStyle="rgba(0,0,0,0)";ctx.fillRect(0,0,image.width,image.height);ctx.drawImage(image,0,0);var imageData=ctx.getImageData(0,0,image.width,image.height);var data=imageData.data;var i,j;var miny=0,maxy=canvas.height-1;var minx=0,maxx=canvas.width-1;var alpha=false;if(atop){for(i=0;i<canvas.height;i++){for(j=0;j<canvas.width;j++)if(data[i*
canvas.width*4+3+j*4]>threshold){alpha=true;break}if(alpha)break}miny=i}if(abottom){alpha=false;for(i=canvas.height-1;i>=miny;i--){for(j=0;j<canvas.width;j++)if(data[i*canvas.width*4+3+j*4]>threshold){alpha=true;break}if(alpha)break}maxy=i}if(aleft){alpha=false;for(j=0;j<canvas.width;j++){for(i=miny;i<=maxy;i++)if(data[i*canvas.width*4+3+j*4]>threshold){alpha=true;break}if(alpha)break}minx=j}if(aright){alpha=false;for(j=canvas.width-1;j>=minx;j--){for(i=miny;i<=maxy;i++)if(data[i*canvas.width*4+3+
j*4]>threshold){alpha=true;break}if(alpha)break}maxx=j}if(0===minx&&0===miny&&canvas.width-1===maxx&&canvas.height-1===maxy)return canvas;var width=maxx-minx+1;var height=maxy-miny+1;var id2=ctx.getImageData(minx,miny,width,height);canvas.width=width;canvas.height=height;ctx=canvas.getContext("2d");ctx.putImageData(id2,0,0);return canvas};CAAT.modules.ImageUtil.createThumb=function(image,w,h,best_fit){w=w||24;h=h||24;var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;var ctx=
canvas.getContext("2d");if(best_fit){var max=Math.max(image.width,image.height);var ww=image.width/max*w;var hh=image.height/max*h;ctx.drawImage(image,(w-ww)/2,(h-hh)/2,ww,hh)}else ctx.drawImage(image,0,0,w,h);return canvas}})();
(function(){CAAT.modules.LayoutUtils={};CAAT.modules.LayoutUtils.row=function(dst,what_to_layout_array,constraint_object){var width=dst.width;var x=0,y=0,i=0,l=0;var actor_max_h=-Number.MAX_VALUE,actor_max_w=Number.MAX_VALUE;for(i=what_to_layout_array.length-1;i;i-=1){if(actor_max_w<what_to_layout_array[i].width)actor_max_w=what_to_layout_array[i].width;if(actor_max_h<what_to_layout_array[i].height)actor_max_h=what_to_layout_array[i].height}if(constraint_object.padding_left){x=constraint_object.padding_left;
width-=x}if(constraint_object.padding_right)width-=constraint_object.padding_right;if(constraint_object.top){var top=parseInt(constraint_object.top,10);if(!isNaN(top))y=top;else switch(constraint_object.top){case "center":y=(dst.height-actor_max_h)/2;break;case "top":y=0;break;case "bottom":y=dst.height-actor_max_h;break;default:y=0}}var actor_area=width/what_to_layout_array.length;for(i=0,l=what_to_layout_array.length;i<l;i++)what_to_layout_array[i].setLocation(x+i*actor_area+(actor_area-what_to_layout_array[i].width)/
2,y)}})();
(function(){CAAT.Font=function(){return this};var UNKNOWN_CHAR_WIDTH=10;CAAT.Font.prototype={fontSize:10,fontSizeUnit:"px",font:"Sans-Serif",fontStyle:"",fillStyle:"#fff",strokeStyle:null,strokeSize:1,padding:0,image:null,charMap:null,height:0,setPadding:function(padding){this.padding=padding;return this},setFontStyle:function(style){this.fontStyle=style;return this},setStrokeSize:function(size){this.strokeSize=size;return this},setFontSize:function(fontSize){this.fontSize=fontSize;this.fontSizeUnit="px";
return this},setFont:function(font){this.font=font;return this},setFillStyle:function(style){this.fillStyle=style;return this},setStrokeStyle:function(style){this.strokeStyle=style;return this},createDefault:function(padding){var str="";for(var i=32;i<128;i++)str=str+String.fromCharCode(i);return this.create(str,padding)},create:function(chars,padding){padding=padding|0;this.padding=padding;var canvas=document.createElement("canvas");canvas.width=1;canvas.height=1;var ctx=canvas.getContext("2d");
ctx.textBaseline="top";ctx.font=this.fontStyle+" "+this.fontSize+""+this.fontSizeUnit+" "+this.font;var textWidth=0;var charWidth=[];var i;var x;var cchar;for(i=0;i<chars.length;i++){var cw=Math.max(1,(ctx.measureText(chars.charAt(i)).width>>0)+1)+2*padding;charWidth.push(cw);textWidth+=cw}canvas.width=textWidth;canvas.height=this.fontSize*1.5>>0;ctx=canvas.getContext("2d");ctx.textBaseline="top";ctx.font=this.fontStyle+" "+this.fontSize+""+this.fontSizeUnit+" "+this.font;ctx.fillStyle=this.fillStyle;
ctx.strokeStyle=this.strokeStyle;this.charMap={};x=0;for(i=0;i<chars.length;i++){cchar=chars.charAt(i);ctx.fillText(cchar,x+padding,0);if(this.strokeStyle){ctx.beginPath();ctx.lineWidth=this.strokeSize;ctx.strokeText(cchar,x+padding,0)}this.charMap[cchar]={x:x+padding,width:charWidth[i]-2*padding};x+=charWidth[i]}this.image=CAAT.modules.ImageUtil.optimize(canvas,32,{top:true,bottom:true,left:false,right:false});this.height=this.image.height;return this},setAsSpriteImage:function(){var cm=[];var _index=
0;for(var i in this.charMap){var _char=i;var charData=this.charMap[i];cm[i]={id:_index++,height:this.height,xoffset:0,letter:_char,yoffset:0,width:charData.width,xadvance:charData.width,x:charData.x,y:0}}return(new CAAT.SpriteImage).initializeAsGlyphDesigner(this.image,cm)},stringWidth:function(str){var i,l,w=0,c;for(i=0,l=str.length;i<l;i++){c=this.charMap[str.charAt(i)];if(c)w+=c.width;else w+=UNKNOWN_CHAR_WIDTH}return w},drawText:function(str,ctx,x,y){var i,l,charInfo,w;var height=this.image.height;
for(i=0,l=str.length;i<l;i++){charInfo=this.charMap[str.charAt(i)];if(charInfo){w=charInfo.width;ctx.drawImage(this.image,charInfo.x,0,w,height,x,y,w,height);x+=w}else{ctx.strokeStyle="#f00";ctx.strokeRect(x,y,UNKNOWN_CHAR_WIDTH,height);x+=UNKNOWN_CHAR_WIDTH}}},save:function(){var str="image/png";var strData=this.image.toDataURL(str);document.location.href=strData.replace(str,"image/octet-stream")}}})();
(function(){var Inspector=function(){return this};Inspector.prototype={initialize:function(root){if(!root)root=CAAT;CAAT.log("Analyzing "+root.toString()+" for reflection info.");for(var clazz in root)if(root[clazz].__reflectionInfo){CAAT.log("  Extracting reflection info for: "+root[clazz]);this.extractReflectionInfo(root[clazz])}},extractReflectionInfo:function(object){var ri=object.__reflectionInfo;var key;var i;var __removeEmpty=function(el,index,array){array[index]=array[index].trim();if(array[index]===
"")array.splice(index,1)};reflection[object]={};for(key in ri){var metadata=ri[key];CAAT.log("    reflection info for: "+key+"="+metadata);var ks=key.split(",");var data=metadata.split(",");ks.forEach(__removeEmpty);data.forEach(__removeEmpty);if(ks.length===1)data.forEach(function(el,index,array){var operation=el.split(":");operation.forEach(__removeEmpty);if(operation.length!=2)CAAT.log("      ERR. operation: "+el+" wrong format");else if(operation[0]==="set")CAAT.log("set="+operation[1]);else if(operation[0]===
"get")CAAT.log("get="+operation[1]);else if(operation[0]==="type")CAAT.log("type="+operation[1])})}}};var reflection={};var inspector=new Inspector;CAAT.Inspector={extractReflectionInfo:inspector.extractReflectionInfo.bind(inspector)}})();
(function(){CAAT.InterpolatorActor=function(){CAAT.InterpolatorActor.superclass.constructor.call(this);return this};CAAT.InterpolatorActor.prototype={interpolator:null,contour:null,S:50,gap:5,setGap:function(gap){this.gap=gap;return this},setInterpolator:function(interpolator,size){this.interpolator=interpolator;this.contour=interpolator.getContour(size||this.S);return this},paint:function(director,time){CAAT.InterpolatorActor.superclass.paint.call(this,director,time);if(this.backgroundImage)return this;
if(this.interpolator){var canvas=director.crc;var xs=this.width-2*this.gap;var ys=this.height-2*this.gap;canvas.beginPath();canvas.moveTo(this.gap+xs*this.contour[0].x,-this.gap+this.height-ys*this.contour[0].y);for(var i=1;i<this.contour.length;i++)canvas.lineTo(this.gap+xs*this.contour[i].x,-this.gap+this.height-ys*this.contour[i].y);canvas.strokeStyle=this.strokeStyle;canvas.stroke()}},getInterpolator:function(){return this.interpolator}};extend(CAAT.InterpolatorActor,CAAT.ActorContainer,null)})();
(function(){CAAT.PathSegment=function(){this.bbox=new CAAT.Rectangle;return this};CAAT.PathSegment.prototype={color:"#000",length:0,bbox:null,parent:null,setParent:function(parent){this.parent=parent;return this},setColor:function(color){if(color)this.color=color;return this},endCurvePosition:function(){},startCurvePosition:function(){},setPoints:function(points){},setPoint:function(point,index){},getPosition:function(time){},getLength:function(){return this.length},getBoundingBox:function(){return this.bbox},
numControlPoints:function(){},getControlPoint:function(index){},endPath:function(){},getContour:function(iSize){},updatePath:function(point){},applyAsPath:function(director){},transform:function(matrix){},drawHandle:function(ctx,x,y){ctx.beginPath();ctx.arc(x,y,CAAT.Curve.prototype.HANDLE_SIZE/2,0,2*Math.PI,false);ctx.fill()}}})();
(function(){CAAT.LinearPath=function(){CAAT.LinearPath.superclass.constructor.call(this);this.points=[];this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.newPosition=new CAAT.Point(0,0,0);return this};CAAT.LinearPath.prototype={points:null,newPosition:null,applyAsPath:function(director){director.ctx.lineTo(this.points[0].x,this.points[1].y)},setPoint:function(point,index){if(index===0)this.points[0]=point;else if(index===1)this.points[1]=point},updatePath:function(point){var x=
this.points[1].x-this.points[0].x;var y=this.points[1].y-this.points[0].y;this.length=Math.sqrt(x*x+y*y);this.bbox.setEmpty();this.bbox.union(this.points[0].x,this.points[0].y);this.bbox.union(this.points[1].x,this.points[1].y);return this},setPoints:function(points){this.points[0]=points[0];this.points[1]=points[1];this.updatePath();return this},setInitialPosition:function(x,y){this.points[0].x=x;this.points[0].y=y;this.newPosition.set(x,y);return this},setFinalPosition:function(finalX,finalY){this.points[1].x=
finalX;this.points[1].y=finalY;return this},endCurvePosition:function(){return this.points[1]},startCurvePosition:function(){return this.points[0]},getPosition:function(time){if(time>1||time<0)time%=1;if(time<0)time=1+time;this.newPosition.set(this.points[0].x+(this.points[1].x-this.points[0].x)*time,this.points[0].y+(this.points[1].y-this.points[0].y)*time);return this.newPosition},getPositionFromLength:function(len){return this.getPosition(len/this.length)},initialPositionX:function(){return this.points[0].x},
finalPositionX:function(){return this.points[1].x},paint:function(director,bDrawHandles){var ctx=director.ctx;ctx.save();ctx.strokeStyle=this.color;ctx.beginPath();ctx.moveTo(this.points[0].x,this.points[0].y);ctx.lineTo(this.points[1].x,this.points[1].y);ctx.stroke();if(bDrawHandles){ctx.globalAlpha=0.5;ctx.fillStyle="#7f7f00";ctx.beginPath();this.drawHandle(ctx,this.points[0].x,this.points[0].y);this.drawHandle(ctx,this.points[1].x,this.points[1].y)}ctx.restore()},numControlPoints:function(){return 2},
getControlPoint:function(index){if(0===index)return this.points[0];else if(1===index)return this.points[1]},getContour:function(iSize){var contour=[];contour.push(this.getPosition(0).clone());contour.push(this.getPosition(1).clone());return contour}};extend(CAAT.LinearPath,CAAT.PathSegment)})();
(function(){CAAT.CurvePath=function(){CAAT.CurvePath.superclass.constructor.call(this);this.newPosition=new CAAT.Point(0,0,0);return this};CAAT.CurvePath.prototype={curve:null,newPosition:null,applyAsPath:function(director){this.curve.applyAsPath(director);return this},setPoint:function(point,index){if(this.curve)this.curve.setPoint(point,index)},setPoints:function(points){var curve=new CAAT.Bezier;curve.setPoints(points);this.curve=curve;return this},setQuadric:function(p0x,p0y,p1x,p1y,p2x,p2y){var curve=
new CAAT.Bezier;curve.setQuadric(p0x,p0y,p1x,p1y,p2x,p2y);this.curve=curve;this.updatePath();return this},setCubic:function(p0x,p0y,p1x,p1y,p2x,p2y,p3x,p3y){var curve=new CAAT.Bezier;curve.setCubic(p0x,p0y,p1x,p1y,p2x,p2y,p3x,p3y);this.curve=curve;this.updatePath();return this},updatePath:function(point){this.curve.update();this.length=this.curve.getLength();this.curve.getBoundingBox(this.bbox);return this},getPosition:function(time){if(time>1||time<0)time%=1;if(time<0)time=1+time;this.curve.solve(this.newPosition,
time);return this.newPosition},getPositionFromLength:function(iLength){this.curve.solve(this.newPosition,iLength/this.length);return this.newPosition},initialPositionX:function(){return this.curve.coordlist[0].x},finalPositionX:function(){return this.curve.coordlist[this.curve.coordlist.length-1].x},paint:function(director,bDrawHandles){this.curve.drawHandles=bDrawHandles;director.ctx.strokeStyle=this.color;this.curve.paint(director,bDrawHandles)},numControlPoints:function(){return this.curve.coordlist.length},
getControlPoint:function(index){return this.curve.coordlist[index]},endCurvePosition:function(){return this.curve.endCurvePosition()},startCurvePosition:function(){return this.curve.startCurvePosition()},getContour:function(iSize){var contour=[];for(var i=0;i<=iSize;i++)contour.push({x:i/iSize,y:this.getPosition(i/iSize).y});return contour}};extend(CAAT.CurvePath,CAAT.PathSegment,null)})();
(function(){CAAT.ArcPath=function(){CAAT.ArcPath.superclass.constructor.call(this);this.points=[];this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.newPosition=new CAAT.Point;return this};CAAT.ArcPath.prototype={points:null,length:-1,cw:true,bbox:null,newPosition:null,radius:0,startAngle:0,angle:2*Math.PI,arcTo:false,setRadius:function(r){this.radius=r},isArcTo:function(){return this.arcTo},setArcTo:function(b){this.arcTo=b;return this},initialize:function(x,y,r,angle){this.setInitialPosition(x,
y);this.setFinalPosition(x+r,y);this.angle=angle||2*Math.PI;return this},applyAsPath:function(director){var ctx=director.ctx;if(!this.arcTo)ctx.arc(this.points[0].x,this.points[0].y,this.radius,this.startAngle,this.angle+this.startAngle,this.cw);else ctx.arcTo(this.points[0].x,this.points[0].y,this.points[1].x,this.points[1].y,this.radius);return this},setPoint:function(point,index){if(index>=0&&index<this.points.length)this.points[index]=point},setPoints:function(points){this.points=[];this.points[0]=
points[0];this.points[1]=points[1];this.updatePath();return this},setClockWise:function(cw){this.cw=cw!==undefined?cw:true;return this},isClockWise:function(){return this.cw},setInitialPosition:function(x,y){for(var i=0,l=this.points.length;i<l;i++){this.points[0].x=x;this.points[0].y=y}return this},setFinalPosition:function(finalX,finalY){this.points[1].x=finalX;this.points[1].y=finalY;this.updatePath(this.points[1]);return this},endCurvePosition:function(){return this.points[0]},startCurvePosition:function(){return this.points[0]},
getPosition:function(time){if(time>1||time<0)time%=1;if(time<0)time=1+time;if(-1===this.length)this.newPosition.set(this.points[0].x,this.points[0].y);else{var angle=this.angle*time*(this.cw?1:-1)+this.startAngle;this.newPosition.set(this.points[0].x+this.radius*Math.cos(angle),this.points[0].y+this.radius*Math.sin(angle))}return this.newPosition},initialPositionX:function(){return this.points[0].x},finalPositionX:function(){return this.points[1].x},paint:function(director,bDrawHandles){var ctx=director.ctx;
ctx.save();ctx.strokeStyle=this.color;ctx.beginPath();if(!this.arcTo)ctx.arc(this.points[0].x,this.points[0].y,this.radius,this.startAngle,this.startAngle+this.angle,this.cw);else ctx.arcTo(this.points[0].x,this.points[0].y,this.points[1].x,this.points[1].y,this.radius);ctx.stroke();if(bDrawHandles){ctx.globalAlpha=0.5;ctx.fillStyle="#7f7f00";for(var i=0;i<this.points.length;i++)this.drawHandle(ctx,this.points[i].x,this.points[i].y)}ctx.restore()},numControlPoints:function(){return this.points.length},
getControlPoint:function(index){return this.points[index]},getContour:function(iSize){var contour=[];for(var i=0;i<iSize;i++)contour.push({x:this.points[0].x+this.radius*Math.cos(i*Math.PI/(iSize/2)),y:this.points[0].y+this.radius*Math.sin(i*Math.PI/(iSize/2))});return contour},getPositionFromLength:function(iLength){var ratio=iLength/this.length*(this.cw?1:-1);return this.getPosition(ratio)},updatePath:function(point){if(this.points[1]===point){if(!this.arcTo)this.radius=Math.sqrt((this.points[0].x-
this.points[1].x)*(this.points[0].x-this.points[1].x)+(this.points[0].y-this.points[1].y)*(this.points[0].y-this.points[1].y));this.length=this.angle*this.radius;this.startAngle=Math.atan2(this.points[1].y-this.points[0].y,this.points[1].x-this.points[0].x)}else if(this.points[0]===point)this.points[1].set(this.points[0].x+this.radius*Math.cos(this.startAngle),this.points[0].y+this.radius*Math.sin(this.startAngle));this.bbox.setEmpty();this.bbox.x=this.points[0].x-this.radius;this.bbox.y=this.points[0].y-
this.radius;this.bbox.x1=this.points[0].x+this.radius;this.bbox.y1=this.points[0].y+this.radius;this.bbox.width=2*this.radius;this.bbox.height=2*this.radius;return this}};extend(CAAT.ArcPath,CAAT.PathSegment)})();
(function(){CAAT.RectPath=function(){CAAT.RectPath.superclass.constructor.call(this);this.points=[];this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.points.push(new CAAT.Point);this.newPosition=new CAAT.Point;this.lengths=[0,0,0,0];return this};CAAT.RectPath.prototype={points:null,length:-1,cw:true,bbox:null,newPosition:null,applyAsPath:function(director){var ctx=director.ctx;if(this.cw){ctx.lineTo(this.points[0].x,
this.points[0].y);ctx.lineTo(this.points[1].x,this.points[1].y);ctx.lineTo(this.points[2].x,this.points[2].y);ctx.lineTo(this.points[3].x,this.points[3].y);ctx.lineTo(this.points[4].x,this.points[4].y)}else{ctx.lineTo(this.points[4].x,this.points[4].y);ctx.lineTo(this.points[3].x,this.points[3].y);ctx.lineTo(this.points[2].x,this.points[2].y);ctx.lineTo(this.points[1].x,this.points[1].y);ctx.lineTo(this.points[0].x,this.points[0].y)}return this},setPoint:function(point,index){if(index>=0&&index<this.points.length)this.points[index]=
point},setPoints:function(points){this.points=[];this.points.push(points[0]);this.points.push((new CAAT.Point).set(points[1].x,points[0].y));this.points.push(points[1]);this.points.push((new CAAT.Point).set(points[0].x,points[1].y));this.points.push(points[0].clone());this.updatePath();return this},setClockWise:function(cw){this.cw=cw!==undefined?cw:true;return this},isClockWise:function(){return this.cw},setInitialPosition:function(x,y){for(var i=0,l=this.points.length;i<l;i++){this.points[i].x=
x;this.points[i].y=y}return this},setFinalPosition:function(finalX,finalY){this.points[2].x=finalX;this.points[2].y=finalY;this.points[1].x=finalX;this.points[1].y=this.points[0].y;this.points[3].x=this.points[0].x;this.points[3].y=finalY;this.points[4].x=this.points[0].x;this.points[4].y=this.points[0].y;this.updatePath();return this},endCurvePosition:function(){return this.points[4]},startCurvePosition:function(){return this.points[0]},getPosition:function(time){if(time>1||time<0)time%=1;if(time<
0)time=1+time;if(-1===this.length)this.newPosition.set(0,0);else{var w=this.bbox.width/this.length;var h=this.bbox.height/this.length;var accTime=0;var times;var segments;var index=0;if(this.cw){segments=[0,1,2,3,4];times=[w,h,w,h]}else{segments=[4,3,2,1,0];times=[h,w,h,w]}while(index<times.length)if(accTime+times[index]<time){accTime+=times[index];index++}else break;time-=accTime;var p0=segments[index];var p1=segments[index+1];this.newPosition.set(this.points[p0].x+(this.points[p1].x-this.points[p0].x)*
time/times[index],this.points[p0].y+(this.points[p1].y-this.points[p0].y)*time/times[index])}return this.newPosition},initialPositionX:function(){return this.points[0].x},finalPositionX:function(){return this.points[2].x},paint:function(director,bDrawHandles){var ctx=director.ctx;ctx.save();ctx.strokeStyle=this.color;ctx.beginPath();ctx.strokeRect(this.bbox.x,this.bbox.y,this.bbox.width,this.bbox.height);if(bDrawHandles){ctx.globalAlpha=0.5;ctx.fillStyle="#7f7f00";for(var i=0;i<this.points.length;i++)this.drawHandle(ctx,
this.points[i].x,this.points[i].y)}ctx.restore()},numControlPoints:function(){return this.points.length},getControlPoint:function(index){return this.points[index]},getContour:function(iSize){var contour=[];for(var i=0;i<this.points.length;i++)contour.push(this.points[i]);return contour},updatePath:function(point){if(point){if(point===this.points[0]){this.points[1].y=point.y;this.points[3].x=point.x}else if(point===this.points[1]){this.points[0].y=point.y;this.points[2].x=point.x}else if(point===this.points[2]){this.points[3].y=
point.y;this.points[1].x=point.x}else if(point===this.points[3]){this.points[0].x=point.x;this.points[2].y=point.y}this.points[4].x=this.points[0].x;this.points[4].y=this.points[0].y}this.bbox.setEmpty();var minx=Number.MAX_VALUE,miny=Number.MAX_VALUE,maxx=-Number.MAX_VALUE,maxy=-Number.MAX_VALUE;for(var i=0;i<4;i++)this.bbox.union(this.points[i].x,this.points[i].y);this.length=2*this.bbox.width+2*this.bbox.height;this.points[0].x=this.bbox.x;this.points[0].y=this.bbox.y;this.points[1].x=this.bbox.x+
this.bbox.width;this.points[1].y=this.bbox.y;this.points[2].x=this.bbox.x+this.bbox.width;this.points[2].y=this.bbox.y+this.bbox.height;this.points[3].x=this.bbox.x;this.points[3].y=this.bbox.y+this.bbox.height;this.points[4].x=this.bbox.x;this.points[4].y=this.bbox.y;return this},getPositionFromLength:function(iLength){return this.getPosition(iLength/(this.bbox.width*2+this.bbox.height*2))}};extend(CAAT.RectPath,CAAT.PathSegment);CAAT.ShapePath=CAAT.RectPath})();
(function(){CAAT.Path=function(){CAAT.Path.superclass.constructor.call(this);this.newPosition=new CAAT.Point(0,0,0);this.pathSegments=[];this.behaviorList=[];this.matrix=new CAAT.Matrix;this.tmpMatrix=new CAAT.Matrix;return this};CAAT.Path.prototype={pathSegments:null,pathSegmentDurationTime:null,pathSegmentStartTime:null,newPosition:null,pathLength:-1,beginPathX:-1,beginPathY:-1,trackPathX:-1,trackPathY:-1,ax:-1,ay:-1,point:[],interactive:true,behaviorList:null,rb_angle:0,rb_rotateAnchorX:0.5,rb_rotateAnchorY:0.5,
sb_scaleX:1,sb_scaleY:1,sb_scaleAnchorX:0.5,sb_scaleAnchorY:0.5,tAnchorX:0,tAnchorY:0,tb_x:0,tb_y:0,matrix:null,tmpMatrix:null,pathPoints:null,width:0,height:0,clipOffsetX:0,clipOffsetY:0,applyAsPath:function(director){var ctx=director.ctx;director.modelViewMatrix.transformRenderingContext(ctx);ctx.beginPath();ctx.globalCompositeOperation="source-out";ctx.moveTo(this.getFirstPathSegment().startCurvePosition().x,this.getFirstPathSegment().startCurvePosition().y);for(var i=0;i<this.pathSegments.length;i++)this.pathSegments[i].applyAsPath(director);
ctx.globalCompositeOperation="source-over";return this},setInteractive:function(interactive){this.interactive=interactive;return this},getFirstPathSegment:function(){return this.pathSegments.length?this.pathSegments[0]:null},getLastPathSegment:function(){return this.pathSegments.length?this.pathSegments[this.pathSegments.length-1]:null},endCurvePosition:function(){if(this.pathSegments.length)return this.pathSegments[this.pathSegments.length-1].endCurvePosition();else return(new CAAT.Point).set(this.beginPathX,
this.beginPathY)},startCurvePosition:function(){return this.pathSegments[0].startCurvePosition()},getCurrentPathSegment:function(){return this.pathSegments[this.pathSegments.length-1]},setLinear:function(x0,y0,x1,y1){this.beginPath(x0,y0);this.addLineTo(x1,y1);this.endPath();return this},setQuadric:function(x0,y0,x1,y1,x2,y2){this.beginPath(x0,y0);this.addQuadricTo(x1,y1,x2,y2);this.endPath();return this},setCubic:function(x0,y0,x1,y1,x2,y2,x3,y3){this.beginPath(x0,y0);this.addCubicTo(x1,y1,x2,y2,
x3,y3);this.endPath();return this},setRectangle:function(x0,y0,x1,y1){this.beginPath(x0,y0);this.addRectangleTo(x1,y1);this.endPath();return this},setCatmullRom:function(points,closed){if(closed){points=points.slice(0);points.unshift(points[points.length-1]);points.push(points[1]);points.push(points[2])}for(var i=1;i<points.length-2;i++){var segment=(new CAAT.CurvePath).setColor("#000").setParent(this);var cm=(new CAAT.CatmullRom).setCurve(points[i-1],points[i],points[i+1],points[i+2]);segment.curve=
cm;this.pathSegments.push(segment)}return this},addSegment:function(pathSegment){pathSegment.setParent(this);this.pathSegments.push(pathSegment);return this},addArcTo:function(x1,y1,x2,y2,radius,cw,color){var r=new CAAT.ArcPath;r.setArcTo(true);r.setRadius(radius);r.setInitialPosition(x1,y1).setFinalPosition(x2,y2);r.setParent(this);r.setColor(color);this.pathSegments.push(r);return this},addRectangleTo:function(x1,y1,cw,color){var r=new CAAT.RectPath;r.setPoints([this.endCurvePosition(),(new CAAT.Point).set(x1,
y1)]);r.setClockWise(cw);r.setColor(color);r.setParent(this);this.pathSegments.push(r);return this},addQuadricTo:function(px1,py1,px2,py2,color){var bezier=new CAAT.Bezier;bezier.setPoints([this.endCurvePosition(),(new CAAT.Point).set(px1,py1),(new CAAT.Point).set(px2,py2)]);this.trackPathX=px2;this.trackPathY=py2;var segment=(new CAAT.CurvePath).setColor(color).setParent(this);segment.curve=bezier;this.pathSegments.push(segment);return this},addCubicTo:function(px1,py1,px2,py2,px3,py3,color){var bezier=
new CAAT.Bezier;bezier.setPoints([this.endCurvePosition(),(new CAAT.Point).set(px1,py1),(new CAAT.Point).set(px2,py2),(new CAAT.Point).set(px3,py3)]);this.trackPathX=px3;this.trackPathY=py3;var segment=(new CAAT.CurvePath).setColor(color).setParent(this);segment.curve=bezier;this.pathSegments.push(segment);return this},addCatmullTo:function(px1,py1,px2,py2,px3,py3,color){var curve=(new CAAT.CatmullRom).setColor(color);curve.setCurve(this.trackPathX,this.trackPathY,px1,py1,px2,py2,px3,py3);this.trackPathX=
px3;this.trackPathY=py3;var segment=(new CAAT.CurvePath).setParent(this);segment.curve=curve;this.pathSegments.push(segment);return this},addLineTo:function(px1,py1,color){var segment=(new CAAT.LinearPath).setColor(color);segment.setPoints([this.endCurvePosition(),(new CAAT.Point).set(px1,py1)]);segment.setParent(this);this.trackPathX=px1;this.trackPathY=py1;this.pathSegments.push(segment);return this},beginPath:function(px0,py0){this.trackPathX=px0;this.trackPathY=py0;this.beginPathX=px0;this.beginPathY=
py0;return this},closePath:function(){this.getLastPathSegment().setPoint(this.getFirstPathSegment().startCurvePosition(),this.getLastPathSegment().numControlPoints()-1);this.trackPathX=this.beginPathX;this.trackPathY=this.beginPathY;this.endPath();return this},endPath:function(){this.pathSegmentStartTime=[];this.pathSegmentDurationTime=[];this.updatePath();return this},getPosition:function(time){if(time>1||time<0)time%=1;if(time<0)time=1+time;var ps=this.pathSegments;var psst=this.pathSegmentStartTime;
var psdt=this.pathSegmentDurationTime;var l=0;var r=ps.length;var m;var np=this.newPosition;var psstv;while(l!==r){m=(r+l)/2|0;psstv=psst[m];if(psstv<=time&&time<=psstv+psdt[m]){time=psdt[m]?(time-psstv)/psdt[m]:0;var pointInPath=ps[m].getPosition(time);np.x=pointInPath.x;np.y=pointInPath.y;return np}else if(time<psstv)r=m;else l=m+1}return this.endCurvePosition()},getPositionFromLength:function(iLength){iLength%=this.getLength();if(iLength<0)iLength+=this.getLength();var accLength=0;for(var i=0;i<
this.pathSegments.length;i++){if(accLength<=iLength&&iLength<=this.pathSegments[i].getLength()+accLength){iLength-=accLength;var pointInPath=this.pathSegments[i].getPositionFromLength(iLength);this.newPosition.x=pointInPath.x;this.newPosition.y=pointInPath.y;break}accLength+=this.pathSegments[i].getLength()}return this.newPosition},paint:function(director){for(var i=0;i<this.pathSegments.length;i++)this.pathSegments[i].paint(director,this.interactive)},release:function(){this.ax=-1;this.ay=-1},getNumSegments:function(){return this.pathSegments.length},
getSegment:function(index){return this.pathSegments[index]},numControlPoints:function(){return this.points.length},getControlPoint:function(index){return this.points[index]},updatePath:function(point,callback){var i,j;this.length=0;this.bbox.setEmpty();this.points=[];var xmin=Number.MAX_VALUE,ymin=Number.MAX_VALUE;for(i=0;i<this.pathSegments.length;i++){this.pathSegments[i].updatePath(point);this.length+=this.pathSegments[i].getLength();this.bbox.unionRectangle(this.pathSegments[i].bbox);for(j=0;j<
this.pathSegments[i].numControlPoints();j++){var pt=this.pathSegments[i].getControlPoint(j);this.points.push(pt);if(pt.x<xmin)xmin=pt.x;if(pt.y<ymin)ymin=pt.y}}this.clipOffsetX=-xmin;this.clipOffsetY=-ymin;this.width=this.bbox.width;this.height=this.bbox.height;this.setLocation(this.bbox.x,this.bbox.y);this.pathSegmentStartTime=[];this.pathSegmentDurationTime=[];var i;for(i=0;i<this.pathSegments.length;i++){this.pathSegmentStartTime.push(0);this.pathSegmentDurationTime.push(0)}for(i=0;i<this.pathSegments.length;i++){this.pathSegmentDurationTime[i]=
this.getLength()?this.pathSegments[i].getLength()/this.getLength():0;if(i>0)this.pathSegmentStartTime[i]=this.pathSegmentStartTime[i-1]+this.pathSegmentDurationTime[i-1];else this.pathSegmentStartTime[0]=0;this.pathSegments[i].endPath()}this.extractPathPoints();if(callback)callback(this);return this},press:function(x,y){if(!this.interactive)return;var HS=CAAT.Curve.prototype.HANDLE_SIZE/2;for(var i=0;i<this.pathSegments.length;i++)for(var j=0;j<this.pathSegments[i].numControlPoints();j++){var point=
this.pathSegments[i].getControlPoint(j);if(x>=point.x-HS&&y>=point.y-HS&&x<point.x+HS&&y<point.y+HS){this.point=point;return}}this.point=null},drag:function(x,y,callback){if(!this.interactive)return;if(null===this.point)return;if(-1===this.ax||-1===this.ay){this.ax=x;this.ay=y}this.point.x+=x-this.ax;this.point.y+=y-this.ay;this.ax=x;this.ay=y;this.updatePath(this.point,callback)},getContour:function(iSize){var contour=[];for(var i=0;i<=iSize;i++)contour.push((new CAAT.Point).set(i/iSize,this.getPosition(i/
iSize).y,0));return contour},setPoints:function(points){if(this.points.length===points.length)for(var i=0;i<points.length;i++){this.points[i].x=points[i].x;this.points[i].y=points[i].y}return this},setPoint:function(point,index){if(index>=0&&index<this.points.length){this.points[index].x=point.x;this.points[index].y=point.y}return this},emptyBehaviorList:function(){this.behaviorList=[];return this},extractPathPoints:function(){if(!this.pathPoints){var i;this.pathPoints=[];for(i=0;i<this.numControlPoints();i++)this.pathPoints.push(this.getControlPoint(i).clone())}return this},
addBehavior:function(behavior){this.behaviorList.push(behavior);return this},removeBehaviour:function(behavior){var n=this.behaviorList.length-1;while(n)if(this.behaviorList[n]===behavior){this.behaviorList.splice(n,1);return this}return this},removeBehaviorById:function(id){for(var n=0;n<this.behaviorList.length;n++)if(this.behaviorList[n].id===id)this.behaviorList.splice(n,1);return this},applyBehaviors:function(time){for(var i=0;i<this.behaviorList.length;i++)this.behaviorList[i].apply(time,this);
this.setATMatrix();for(i=0;i<this.numControlPoints();i++)this.setPoint(this.matrix.transformCoord(this.pathPoints[i].clone().translate(this.clipOffsetX,this.clipOffsetY)),i);return this},setATMatrix:function(){this.matrix.identity();var m=this.tmpMatrix.identity();var mm=this.matrix.matrix;var c,s,_m00,_m01,_m10,_m11;var mm0,mm1,mm2,mm3,mm4,mm5;var bbox=this.bbox;var bbw=bbox.width;var bbh=bbox.height;var bbx=bbox.x;var bby=bbox.y;mm0=1;mm1=0;mm3=0;mm4=1;mm2=this.tb_x-bbx-this.tAnchorX*bbw;mm5=this.tb_y-
bby-this.tAnchorY*bbh;if(this.rb_angle){var rbx=this.rb_rotateAnchorX*bbw+bbx;var rby=this.rb_rotateAnchorY*bbh+bby;mm2+=mm0*rbx+mm1*rby;mm5+=mm3*rbx+mm4*rby;c=Math.cos(this.rb_angle);s=Math.sin(this.rb_angle);_m00=mm0;_m01=mm1;_m10=mm3;_m11=mm4;mm0=_m00*c+_m01*s;mm1=-_m00*s+_m01*c;mm3=_m10*c+_m11*s;mm4=-_m10*s+_m11*c;mm2+=-mm0*rbx-mm1*rby;mm5+=-mm3*rbx-mm4*rby}if(this.sb_scaleX!=1||this.sb_scaleY!=1){var sbx=this.sb_scaleAnchorX*bbw+bbx;var sby=this.sb_scaleAnchorY*bbh+bby;mm2+=mm0*sbx+mm1*sby;mm5+=
mm3*sbx+mm4*sby;mm0=mm0*this.sb_scaleX;mm1=mm1*this.sb_scaleY;mm3=mm3*this.sb_scaleX;mm4=mm4*this.sb_scaleY;mm2+=-mm0*sbx-mm1*sby;mm5+=-mm3*sbx-mm4*sby}mm[0]=mm0;mm[1]=mm1;mm[2]=mm2;mm[3]=mm3;mm[4]=mm4;mm[5]=mm5;return this},setRotationAnchored:function(angle,rx,ry){this.rb_angle=angle;this.rb_rotateAnchorX=rx;this.rb_rotateAnchorY=ry;return this},setRotationAnchor:function(ax,ay){this.rb_rotateAnchorX=ax;this.rb_rotateAnchorY=ay},setRotation:function(angle){this.rb_angle=angle},setScaleAnchored:function(scaleX,
scaleY,sx,sy){this.sb_scaleX=scaleX;this.sb_scaleAnchorX=sx;this.sb_scaleY=scaleY;this.sb_scaleAnchorY=sy;return this},setScale:function(sx,sy){this.sb_scaleX=sx;this.sb_scaleY=sy;return this},setScaleAnchor:function(ax,ay){this.sb_scaleAnchorX=ax;this.sb_scaleAnchorY=ay;return this},setPositionAnchor:function(ax,ay){this.tAnchorX=ax;this.tAnchorY=ay;return this},setPositionAnchored:function(x,y,ax,ay){this.tb_x=x;this.tb_y=y;this.tAnchorX=ax;this.tAnchorY=ay;return this},setPosition:function(x,y){this.tb_x=
x;this.tb_y=y;return this},setLocation:function(x,y){this.tb_x=x;this.tb_y=y;return this},flatten:function(npatches,closed){var point=this.getPositionFromLength(0);var path=(new CAAT.Path).beginPath(point.x,point.y);for(var i=0;i<npatches;i++){point=this.getPositionFromLength(i/npatches*this.length);path.addLineTo(point.x,point.y)}if(closed)path.closePath();else path.endPath();return path}};extend(CAAT.Path,CAAT.PathSegment,null)})();
(function(){CAAT.PathActor=function(){CAAT.PathActor.superclass.constructor.call(this);return this};CAAT.PathActor.prototype={path:null,pathBoundingRectangle:null,bOutline:false,outlineColor:"black",onUpdateCallback:null,interactive:false,showBBox:false,getPath:function(){return this.path},setPath:function(path){this.path=path;if(path!=null){this.pathBoundingRectangle=path.getBoundingBox();this.setInteractive(this.interactive)}return this},paint:function(director,time){CAAT.PathActor.superclass.paint.call(this,
director,time);if(!this.path)return;var ctx=director.ctx;ctx.strokeStyle="#000";this.path.paint(director,this.interactive);if(this.bOutline){ctx.strokeStyle=this.outlineColor;ctx.strokeRect(this.pathBoundingRectangle.x,this.pathBoundingRectangle.y,this.pathBoundingRectangle.width,this.pathBoundingRectangle.height)}},showBoundingBox:function(show,color){this.bOutline=show;if(show&&color)this.outlineColor=color;return this},setInteractive:function(interactive){this.interactive=interactive;if(this.path)this.path.setInteractive(interactive);
return this},setOnUpdateCallback:function(fn){this.onUpdateCallback=fn;return this},mouseDrag:function(mouseEvent){this.path.drag(mouseEvent.point.x,mouseEvent.point.y,this.onUpdateCallback)},mouseDown:function(mouseEvent){this.path.press(mouseEvent.point.x,mouseEvent.point.y)},mouseUp:function(mouseEvent){this.path.release()}};extend(CAAT.PathActor,CAAT.ActorContainer,null)})();
(function(){CAAT.ImageProcessor=function(){return this};CAAT.ImageProcessor.prototype={canvas:null,ctx:null,width:0,height:0,imageData:null,bufferImage:null,grabPixels:function(image){var canvas=document.createElement("canvas");if(canvas!==null){canvas.width=image.width;canvas.height=image.height;var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0);try{var imageData=ctx.getImageData(0,0,canvas.width,canvas.height);return imageData}catch(e){CAAT.log("error pixelgrabbing.",image);return null}}return null},
makeArray:function(size,initValue){var a=[];for(var i=0;i<size;i++)a.push(initValue);return a},makeArray2D:function(size,size2,initvalue){var a=[];for(var i=0;i<size;i++)a.push(this.makeArray(size2,initvalue));return a},initialize:function(width,height){this.width=width;this.height=height;this.canvas=document.createElement("canvas");if(this.canvas!==null){this.canvas.width=width;this.canvas.height=height;this.ctx=this.canvas.getContext("2d");this.imageData=this.ctx.getImageData(0,0,width,height);
this.bufferImage=this.imageData.data}return this},clear:function(r,g,b,a){if(null===this.imageData)return this;var data=this.imageData.data;for(var i=0;i<this.width*this.height;i++){data[i*4+0]=r;data[i*4+1]=g;data[i*4+2]=b;data[i*4+3]=a}this.imageData.data=data;return this},getImageData:function(){return this.ctx.getImageData(0,0,this.width,this.height)},apply:function(director,time){if(null!==this.imageData){this.imageData.data=this.bufferImage;this.ctx.putImageData(this.imageData,0,0)}return this},
getCanvas:function(){return this.canvas},createPattern:function(type){return this.ctx.createPattern(this.canvas,type?type:"repeat")},paint:function(director,time){if(null!==this.canvas){var ctx=director.ctx;ctx.drawImage(this.getCanvas(),0,0)}}}})();
(function(){CAAT.IMPlasma=function(){CAAT.IMPlasma.superclass.constructor.call(this);return this};CAAT.IMPlasma.prototype={wavetable:null,m_colorMap:null,spd1:1,spd2:2,spd3:3,spd4:4,pos1:0,pos2:0,pos3:0,pos4:0,tpos1:0,tpos2:0,tpos3:0,tpos4:0,m_colorMapSize:256,i1:0,i2:0,i3:0,i4:0,b1:false,b2:false,b3:false,b4:false,color:[4294967295,4294902015,4294967040,4278255360,4294901760,4278190335,4278190080],initialize:function(width,height,colors){CAAT.IMPlasma.superclass.initialize.call(this,width,height);
this.wavetable=[];for(var x=0;x<256;x++)this.wavetable.push(Math.floor(32*(1+Math.cos(x*2*Math.PI/256))));this.pos1=Math.floor(255*Math.random());this.pos2=Math.floor(255*Math.random());this.pos3=Math.floor(255*Math.random());this.pos4=Math.floor(255*Math.random());this.m_colorMap=CAAT.Color.prototype.makeRGBColorRamp(colors!==null?colors:this.color,256,CAAT.Color.prototype.RampEnumeration.RAMP_CHANNEL_RGBA_ARRAY);this.setB();return this},setB:function(){this.b1=Math.random()>0.5;this.b2=Math.random()>
0.5;this.b3=Math.random()>0.5;this.b4=Math.random()>0.5;this.spd1=Math.floor((Math.random()*3+1)*(Math.random()<0.5?1:-1));this.spd2=Math.floor((Math.random()*3+1)*(Math.random()<0.5?1:-1));this.spd3=Math.floor((Math.random()*3+1)*(Math.random()<0.5?1:-1));this.spd4=Math.floor((Math.random()*3+1)*(Math.random()<0.5?1:-1));this.i1=Math.floor((Math.random()*2.4+1)*(Math.random()<0.5?1:-1));this.i2=Math.floor((Math.random()*2.4+1)*(Math.random()<0.5?1:-1));this.i3=Math.floor((Math.random()*2.4+1)*(Math.random()<
0.5?1:-1));this.i4=Math.floor((Math.random()*2.4+1)*(Math.random()<0.5?1:-1))},apply:function(director,time){var v=0;this.tpos1=this.pos1;this.tpos2=this.pos2;var bi=this.bufferImage;var cm=this.m_colorMap;var wt=this.wavetable;var z;var cmz;for(var x=0;x<this.height;x++){this.tpos3=this.pos3;this.tpos4=this.pos4;for(var y=0;y<this.width;y++){var o1=this.tpos1+this.tpos2+this.tpos3;var o2=this.tpos2+this.tpos3-this.tpos1;var o3=this.tpos3+this.tpos4-this.tpos2;var o4=this.tpos4+this.tpos1-this.tpos2;
if(this.b1)o1=-o1;if(this.b2)o2=-o2;if(this.b3)o3=-o3;if(this.b4)o4=-o4;z=Math.floor(wt[o1&255]+wt[o2&255]+wt[o3&255]+wt[o4&255]);cmz=cm[z];bi[v++]=cmz[0];bi[v++]=cmz[1];bi[v++]=cmz[2];bi[v++]=cmz[3];this.tpos3+=this.i1;this.tpos3&=255;this.tpos4+=this.i2;this.tpos4&=255}this.tpos1+=this.i3;this.tpos1&=255;this.tpos2+=this.i4;this.tpos2&=255}this.pos1+=this.spd1;this.pos2-=this.spd2;this.pos3+=this.spd3;this.pos4-=this.spd4;this.pos1&=255;this.pos3&=255;this.pos2&=255;this.pos4&=255;return CAAT.IMPlasma.superclass.apply.call(this,
director,time)}};extend(CAAT.IMPlasma,CAAT.ImageProcessor,null)})();
(function(){CAAT.IMBump=function(){CAAT.IMBump.superclass.constructor.call(this);return this};CAAT.IMBump.prototype={m_avgX:null,m_avgY:null,m_tt:null,phong:null,m_radius:75,m_lightcolor:null,bcolor:false,lightPosition:[],prepareBump:function(image,radius){var i,j;this.m_radius=radius?radius:75;var imageData=this.grabPixels(image);this.m_tt=this.makeArray(this.height,0);for(i=0;i<this.height;i++)this.m_tt[i]=this.width*i;this.m_avgX=this.makeArray2D(this.height,this.width,0);this.m_avgY=this.makeArray2D(this.height,
this.width,0);var bump=this.makeArray2D(this.height,this.width,0);if(null===imageData)return;var sourceImagePixels=imageData.data;for(i=0;i<this.height;i++)for(j=0;j<this.width;j++){var pos=(i*this.width+j)*4;bump[i][j]=sourceImagePixels[pos]+sourceImagePixels[pos+1]+sourceImagePixels[pos+2]}bump=this.soften(bump);for(var x=1;x<this.width-1;x++)for(var y=1;y<this.height-1;y++){this.m_avgX[y][x]=Math.floor(bump[y][x+1]-bump[y][x-1]);this.m_avgY[y][x]=Math.floor(bump[y+1][x]-bump[y-1][x])}bump=null},
soften:function(bump){var temp;var sbump=this.makeArray2D(this.height,this.width,0);for(var j=0;j<this.width;j++)for(var i=0;i<this.height;i++){temp=bump[i][j];temp+=bump[(i+1)%this.height][j];temp+=bump[(i+this.height-1)%this.height][j];temp+=bump[i][(j+1)%this.width];temp+=bump[i][(j+this.width-1)%this.width];temp+=bump[(i+1)%this.height][(j+1)%this.width];temp+=bump[(i+this.height-1)%this.height][(j+this.width-1)%this.width];temp+=bump[(i+this.height-1)%this.height][(j+1)%this.width];temp+=bump[(i+
1)%this.height][(j+this.width-1)%this.width];temp/=9;sbump[i][j]=temp/3}return sbump},calculatePhong:function(){this.phong=this.makeArray2D(this.m_radius,this.m_radius,0);var i,j,z;for(i=0;i<this.m_radius;i++)for(j=0;j<this.m_radius;j++){var x=j/this.m_radius;var y=i/this.m_radius;z=(1-Math.sqrt(x*x+y*y))*0.8;if(z<0)z=0;this.phong[i][j]=Math.floor(z*255)}},drawColored:function(dstPixels){var i,j,k;for(i=0;i<this.height;i++)for(j=0;j<this.width;j++){var rrr=0;var ggg=0;var bbb=0;for(k=0;k<this.m_lightcolor.length;k++){var lx=
this.lightPosition[k].x;var ly=this.lightPosition[k].y;var dx=Math.floor(Math.abs(this.m_avgX[i][j]-j+lx));var dy=Math.floor(Math.abs(this.m_avgY[i][j]-i+ly));if(dx>=this.m_radius)dx=this.m_radius-1;if(dy>=this.m_radius)dy=this.m_radius-1;var c=this.phong[dx][dy];var r=0;var g=0;var b=0;if(c>=0){r=this.m_lightcolor[k][0]*c/128;g=this.m_lightcolor[k][1]*c/128;b=this.m_lightcolor[k][2]*c/128}else{c=128+c;var rr=this.m_lightcolor[k][0];var gg=this.m_lightcolor[k][1];var bb=this.m_lightcolor[k][2];r=
Math.floor(rr+(255-rr)*c/128);g=Math.floor(gg+(255-gg)*c/128);b=Math.floor(bb+(255-bb)*c/128)}rrr+=r;ggg+=g;bbb+=b}if(rrr>255)rrr=255;if(ggg>255)ggg=255;if(bbb>255)bbb=255;var pos=(j+this.m_tt[i])*4;dstPixels[pos]=rrr;dstPixels[pos+1]=ggg;dstPixels[pos+2]=bbb;dstPixels[pos+3]=255}},setLightColors:function(colors_rgb_array){this.m_lightcolor=colors_rgb_array;this.lightPosition=[];for(var i=0;i<this.m_lightcolor.length;i++){var x=this.width*Math.random();var y=this.height*Math.random();this.lightPosition.push((new CAAT.Point).set(x,
y))}return this},initialize:function(image,radius){CAAT.IMBump.superclass.initialize.call(this,image.width,image.height);this.setLightColors([[255,128,0],[0,0,255]]);this.prepareBump(image,radius);this.calculatePhong();return this},setLightPosition:function(lightIndex,x,y){this.lightPosition[lightIndex].set(x,y);return this},apply:function(director,time){this.drawColored(this.bufferImage);return CAAT.IMBump.superclass.apply.call(this,director,time)}};extend(CAAT.IMBump,CAAT.ImageProcessor,null)})();
(function(){CAAT.IMRotoZoom=function(){CAAT.IMRotoZoom.superclass.constructor.call(this);return this};CAAT.IMRotoZoom.prototype={m_alignv:1,m_alignh:1,distortion:2,mask:0,shift:0,sourceImageData:null,initialize:function(width,height,patternImage){CAAT.IMRotoZoom.superclass.initialize.call(this,width,height);this.clear(255,128,0,255);this.sourceImageData=this.grabPixels(patternImage);if(null!==this.sourceImageData)switch(this.sourceImageData.width){case 1024:this.mask=1023;this.shift=10;break;case 512:this.mask=
511;this.shift=9;break;case 256:this.mask=255;this.shift=8;break;case 128:this.mask=127;this.shift=7;break;case 64:this.mask=63;this.shift=6;break;case 32:this.mask=31;this.shift=5;break;case 16:this.mask=15;this.shift=4;break;case 8:this.mask=7;this.shift=3;break}this.setCenter();return this},rotoZoom:function(director,time){var timer=(new Date).getTime();var angle=Math.PI*2*Math.cos(timer*1.0E-4);var distance=600+550*Math.sin(timer*2.0E-4);var dist=this.distortion;var off=0;var ddx=Math.floor(Math.cos(angle)*
distance);var ddy=Math.floor(Math.sin(angle)*distance);var hh=0,ww=0;switch(this.m_alignh){case 0:hh=0;break;case 1:hh=this.height>>1;break;case 2:hh=this.height-1;break}switch(this.m_alignv){case 0:ww=0;break;case 1:ww=this.width>>1;break;case 2:ww=this.width-1;break}var i=(this.width>>1<<8)-ddx*ww+ddy*hh&65535;var j=(this.height>>1<<8)-ddy*ww-ddx*hh&65535;var srcwidth=this.sourceImageData.width;var srcheight=this.sourceImageData.height;var srcdata=this.sourceImageData.data;var bi=this.bufferImage;
var dstoff;var addx;var addy;while(off<this.width*this.height*4){addx=i;addy=j;for(var m=0;m<this.width;m++){dstoff=(addy>>this.shift&this.mask)*srcwidth+(addx>>this.shift&this.mask);dstoff<<=2;bi[off++]=srcdata[dstoff++];bi[off++]=srcdata[dstoff++];bi[off++]=srcdata[dstoff++];bi[off++]=srcdata[dstoff++];addx+=ddx;addy+=ddy}dist+=this.distortion;i-=ddy;j+=ddx-dist}},apply:function(director,time){if(null!==this.sourceImageData)this.rotoZoom(director,time);return CAAT.IMRotoZoom.superclass.apply.call(this,
director,time)},setCenter:function(){var d=Math.random();if(d<0.33)this.m_alignv=0;else if(d<0.66)this.m_alignv=1;else this.m_alignv=2;d=Math.random();if(d<0.33)this.m_alignh=0;else if(d<0.66)this.m_alignh=1;else this.m_alignh=2}};extend(CAAT.IMRotoZoom,CAAT.ImageProcessor,null)})();
(function(){CAAT.Program=function(gl){this.gl=gl;return this};CAAT.Program.prototype={shaderProgram:null,gl:null,setAlpha:function(alpha){},getShader:function(gl,type,str){var shader;if(type==="x-shader/x-fragment")shader=gl.createShader(gl.FRAGMENT_SHADER);else if(type==="x-shader/x-vertex")shader=gl.createShader(gl.VERTEX_SHADER);else return null;gl.shaderSource(shader,str);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert(gl.getShaderInfoLog(shader));return null}return shader},
getDomShader:function(gl,id){var shaderScript=document.getElementById(id);if(!shaderScript)return null;var str="";var k=shaderScript.firstChild;while(k){if(k.nodeType===3)str+=k.textContent;k=k.nextSibling}var shader;if(shaderScript.type==="x-shader/x-fragment")shader=gl.createShader(gl.FRAGMENT_SHADER);else if(shaderScript.type==="x-shader/x-vertex")shader=gl.createShader(gl.VERTEX_SHADER);else return null;gl.shaderSource(shader,str);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert(gl.getShaderInfoLog(shader));
return null}return shader},initialize:function(){return this},getFragmentShader:function(){return null},getVertexShader:function(){return null},create:function(){var gl=this.gl;this.shaderProgram=gl.createProgram();gl.attachShader(this.shaderProgram,this.getVertexShader());gl.attachShader(this.shaderProgram,this.getFragmentShader());gl.linkProgram(this.shaderProgram);gl.useProgram(this.shaderProgram);return this},setMatrixUniform:function(caatMatrix4){this.gl.uniformMatrix4fv(this.shaderProgram.pMatrixUniform,
false,new Float32Array(caatMatrix4.flatten()))},useProgram:function(){this.gl.useProgram(this.shaderProgram);return this}}})();
(function(){CAAT.ColorProgram=function(gl){CAAT.ColorProgram.superclass.constructor.call(this,gl);return this};CAAT.ColorProgram.prototype={colorBuffer:null,vertexPositionBuffer:null,vertexPositionArray:null,getFragmentShader:function(){return this.getShader(this.gl,"x-shader/x-fragment","#ifdef GL_ES \n"+"precision highp float; \n"+"#endif \n"+"varying vec4 color; \n"+"void main(void) { \n"+"  gl_FragColor = color;\n"+"}\n")},getVertexShader:function(){return this.getShader(this.gl,"x-shader/x-vertex",
"attribute vec3 aVertexPosition; \n"+"attribute vec4 aColor; \n"+"uniform mat4 uPMatrix; \n"+"varying vec4 color; \n"+"void main(void) { \n"+"gl_Position = uPMatrix * vec4(aVertexPosition, 1.0); \n"+"color= aColor; \n"+"}\n")},initialize:function(){this.shaderProgram.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute);this.shaderProgram.vertexColorAttribute=this.gl.getAttribLocation(this.shaderProgram,
"aColor");this.gl.enableVertexAttribArray(this.shaderProgram.vertexColorAttribute);this.shaderProgram.pMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");this.useProgram();this.colorBuffer=this.gl.createBuffer();this.setColor([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);var maxTris=512,i;this.vertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);this.vertexPositionArray=new Float32Array(maxTris*12);this.gl.bufferData(this.gl.ARRAY_BUFFER,
this.vertexPositionArray,this.gl.DYNAMIC_DRAW);this.gl.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,3,this.gl.FLOAT,false,0,0);return CAAT.ColorProgram.superclass.initialize.call(this)},setColor:function(colorArray){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(colorArray),this.gl.STATIC_DRAW);this.gl.vertexAttribPointer(this.shaderProgram.vertexColorAttribute,this.colorBuffer,this.gl.FLOAT,false,0,0)}};extend(CAAT.ColorProgram,
CAAT.Program,null)})();
(function(){CAAT.TextureProgram=function(gl){CAAT.TextureProgram.superclass.constructor.call(this,gl);return this};CAAT.TextureProgram.prototype={vertexPositionBuffer:null,vertexPositionArray:null,vertexUVBuffer:null,vertexUVArray:null,vertexIndexBuffer:null,linesBuffer:null,prevAlpha:-1,prevR:-1,prevG:-1,prevB:-1,prevA:-1,prevTexture:null,getFragmentShader:function(){return this.getShader(this.gl,"x-shader/x-fragment","#ifdef GL_ES \n"+"precision highp float; \n"+"#endif \n"+"varying vec2 vTextureCoord; \n"+
"uniform sampler2D uSampler; \n"+"uniform float alpha; \n"+"uniform bool uUseColor;\n"+"uniform vec4 uColor;\n"+"void main(void) { \n"+"if ( uUseColor ) {\n"+"  gl_FragColor= vec4(uColor.r*alpha, uColor.g*alpha, uColor.b*alpha, uColor.a*alpha);\n"+"} else { \n"+"  vec4 textureColor= texture2D(uSampler, vec2(vTextureCoord)); \n"+"  gl_FragColor = vec4(textureColor.r*alpha, textureColor.g*alpha, textureColor.b*alpha, textureColor.a * alpha ); \n"+"}\n"+"}\n")},getVertexShader:function(){return this.getShader(this.gl,
"x-shader/x-vertex","attribute vec3 aVertexPosition; \n"+"attribute vec2 aTextureCoord; \n"+"uniform mat4 uPMatrix; \n"+"varying vec2 vTextureCoord; \n"+"void main(void) { \n"+"gl_Position = uPMatrix * vec4(aVertexPosition, 1.0); \n"+"vTextureCoord = aTextureCoord;\n"+"}\n")},useProgram:function(){CAAT.TextureProgram.superclass.useProgram.call(this);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexUVBuffer);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,
this.vertexIndexBuffer)},initialize:function(){var i;this.linesBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.linesBuffer);var arr=[];for(i=0;i<1024;i++)arr[i]=i;this.linesBufferArray=new Uint16Array(arr);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.linesBufferArray,this.gl.DYNAMIC_DRAW);this.shaderProgram.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute);
this.shaderProgram.textureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord");this.gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute);this.shaderProgram.pMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");this.shaderProgram.samplerUniform=this.gl.getUniformLocation(this.shaderProgram,"uSampler");this.shaderProgram.alphaUniform=this.gl.getUniformLocation(this.shaderProgram,"alpha");this.shaderProgram.useColor=this.gl.getUniformLocation(this.shaderProgram,
"uUseColor");this.shaderProgram.color=this.gl.getUniformLocation(this.shaderProgram,"uColor");this.setAlpha(1);this.setUseColor(false);var maxTris=4096;this.vertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexPositionBuffer);this.vertexPositionArray=new Float32Array(maxTris*12);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertexPositionArray,this.gl.DYNAMIC_DRAW);this.gl.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,3,this.gl.FLOAT,false,
0,0);this.vertexUVBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexUVBuffer);this.vertexUVArray=new Float32Array(maxTris*8);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertexUVArray,this.gl.DYNAMIC_DRAW);this.gl.vertexAttribPointer(this.shaderProgram.textureCoordAttribute,2,this.gl.FLOAT,false,0,0);this.vertexIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.vertexIndexBuffer);var vertexIndex=[];for(i=0;i<maxTris;i++){vertexIndex.push(0+
i*4);vertexIndex.push(1+i*4);vertexIndex.push(2+i*4);vertexIndex.push(0+i*4);vertexIndex.push(2+i*4);vertexIndex.push(3+i*4)}this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(vertexIndex),this.gl.DYNAMIC_DRAW);return CAAT.TextureProgram.superclass.initialize.call(this)},setUseColor:function(use,r,g,b,a){this.gl.uniform1i(this.shaderProgram.useColor,use?1:0);if(use)if(this.prevA!==a||this.prevR!==r||this.prevG!==g||this.prevB!==b){this.gl.uniform4f(this.shaderProgram.color,r,g,b,a);this.prevA=
a;this.prevR=r;this.prevG=g;this.prevB=b}},setTexture:function(glTexture){if(this.prevTexture!==glTexture){var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,glTexture);gl.uniform1i(this.shaderProgram.samplerUniform,0);this.prevTexture=glTexture}return this},updateVertexBuffer:function(vertexArray){var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,vertexArray);return this},updateUVBuffer:function(uvArray){var gl=this.gl;
gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexUVBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,uvArray);return this},setAlpha:function(alpha){if(this.prevAlpha!==alpha){this.gl.uniform1f(this.shaderProgram.alphaUniform,alpha);this.prevAlpha=alpha}return this},drawLines:function(lines_data,size,r,g,b,a,lineWidth){var gl=this.gl;this.setAlpha(a);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.linesBuffer);gl.lineWidth(lineWidth);this.updateVertexBuffer(lines_data);this.setUseColor(true,r,g,b,1);gl.drawElements(gl.LINES,
size,gl.UNSIGNED_SHORT,0);this.setAlpha(1);this.setUseColor(false);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.vertexIndexBuffer)},drawPolylines:function(polyline_data,size,r,g,b,a,lineWidth){var gl=this.gl;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.linesBuffer);gl.lineWidth(lineWidth);this.setAlpha(a);this.updateVertexBuffer(polyline_data);this.setUseColor(true,r,g,b,1);gl.drawElements(gl.LINE_STRIP,size,gl.UNSIGNED_SHORT,0);this.setAlpha(1);this.setUseColor(false);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,
this.vertexIndexBuffer)}};extend(CAAT.TextureProgram,CAAT.Program,null)})();function makePerspective(fovy,aspect,znear,zfar,viewportHeight){var ymax=znear*Math.tan(fovy*Math.PI/360);var ymin=-ymax;var xmin=ymin*aspect;var xmax=ymax*aspect;return makeFrustum(xmin,xmax,ymin,ymax,znear,zfar,viewportHeight)}
function makeFrustum(left,right,bottom,top,znear,zfar,viewportHeight){var X=2*znear/(right-left);var Y=2*znear/(top-bottom);var A=(right+left)/(right-left);var B=(top+bottom)/(top-bottom);var C=-(zfar+znear)/(zfar-znear);var D=-2*zfar*znear/(zfar-znear);return(new CAAT.Matrix3).initWithMatrix([[X,0,A,-viewportHeight/2],[0,-Y,B,viewportHeight/2],[0,0,C,D],[0,0,-1,0]])}
function makeOrtho(left,right,bottom,top,znear,zfar){var tx=-(right+left)/(right-left);var ty=-(top+bottom)/(top-bottom);var tz=-(zfar+znear)/(zfar-znear);return(new CAAT.Matrix3).initWithMatrix([[2/(right-left),0,0,tx],[0,2/(top-bottom),0,ty],[0,0,-2/(zfar-znear),tz],[0,0,0,1]])}(function(){CAAT.GLTextureElement=function(){return this};CAAT.GLTextureElement.prototype={inverted:false,image:null,u:0,v:0,glTexture:null}})();
(function(){CAAT.GLTextureScan=function(w){this.freeChunks=[{position:0,size:w||1024}];return this};CAAT.GLTextureScan.prototype={freeChunks:null,findWhereFits:function(width){if(this.freeChunks.length===0)return[];var fitsOnPosition=[];var i;for(i=0;i<this.freeChunks.length;i++){var pos=0;while(pos+width<=this.freeChunks[i].size){fitsOnPosition.push(pos+this.freeChunks[i].position);pos+=width}}return fitsOnPosition},fits:function(position,size){var i=0;for(i=0;i<this.freeChunks.length;i++){var fc=
this.freeChunks[i];if(fc.position<=position&&position+size<=fc.position+fc.size)return true}return false},substract:function(position,size){var i=0;for(i=0;i<this.freeChunks.length;i++){var fc=this.freeChunks[i];if(fc.position<=position&&position+size<=fc.position+fc.size){var lp=0;var ls=0;var rp=0;var rs=0;lp=fc.position;ls=position-fc.position;rp=position+size;rs=fc.position+fc.size-rp;this.freeChunks.splice(i,1);if(ls>0)this.freeChunks.splice(i++,0,{position:lp,size:ls});if(rs>0)this.freeChunks.splice(i,
0,{position:rp,size:rs});return true}}return false},log:function(index){if(0===this.freeChunks.length)CAAT.log("index "+index+" empty");else{var str="index "+index;for(var i=0;i<this.freeChunks.length;i++){var fc=this.freeChunks[i];str+="["+fc.position+","+fc.size+"]"}CAAT.log(str)}}}})();
(function(){CAAT.GLTextureScanMap=function(w,h){this.scanMapHeight=h;this.scanMapWidth=w;this.scanMap=[];for(var i=0;i<this.scanMapHeight;i++)this.scanMap.push(new CAAT.GLTextureScan(this.scanMapWidth));return this};CAAT.GLTextureScanMap.prototype={scanMap:null,scanMapWidth:0,scanMapHeight:0,whereFitsChunk:function(width,height){if(width>this.width||height>this.height)return null;var i,j,initialPosition=0;while(initialPosition<=this.scanMapHeight-height){var fitHorizontalPositions=null;var foundPositionOnScan=
false;for(;initialPosition<=this.scanMapHeight-height;initialPosition++){fitHorizontalPositions=this.scanMap[initialPosition].findWhereFits(width);if(null!==fitHorizontalPositions&&fitHorizontalPositions.length>0){foundPositionOnScan=true;break}}if(foundPositionOnScan){var minInitialPosition=Number.MAX_VALUE;for(j=0;j<fitHorizontalPositions.length;j++){var fits=true;for(i=initialPosition;i<initialPosition+height;i++)if(!this.scanMap[i].fits(fitHorizontalPositions[j],width)){fits=false;break}if(fits)return{x:fitHorizontalPositions[j],
y:initialPosition}}initialPosition++}else return null}return null},substract:function(x,y,width,height){for(var i=0;i<height;i++)if(!this.scanMap[i+y].substract(x,width))CAAT.log("Error: removing chunk ",width,height," at ",x,y)},log:function(){for(var i=0;i<this.scanMapHeight;i++)this.scanMap[i].log(i)}}})();
(function(){CAAT.GLTexturePage=function(w,h){this.width=w||1024;this.height=h||1024;this.images=[];return this};CAAT.GLTexturePage.prototype={width:1024,height:1024,gl:null,texture:null,allowImagesInvertion:false,padding:4,scan:null,images:null,criteria:"area",initialize:function(gl){this.gl=gl;gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);this.texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA);var uarr=new Uint8Array(this.width*
this.height*4);for(var jj=0;jj<4*this.width*this.height;){uarr[jj++]=0;uarr[jj++]=0;uarr[jj++]=0;uarr[jj++]=0}gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,uarr);gl.enable(gl.BLEND);for(var i=0;i<this.images.length;i++){var img=this.images[i];if(img.inverted)img=CAAT.modules.ImageUtil.prototype.rotate(img,-90);gl.texSubImage2D(gl.TEXTURE_2D,0,this.images[i].__tx,this.images[i].__ty,gl.RGBA,gl.UNSIGNED_BYTE,img)}},create:function(imagesCache){var images=[];
for(var i=0;i<imagesCache.length;i++){var img=imagesCache[i].image;if(!img.__texturePage)images.push(img)}this.createFromImages(images)},clear:function(){this.createFromImages([])},update:function(invert,padding,width,height){this.allowImagesInvertion=invert;this.padding=padding;if(width<100)width=100;if(height<100)height=100;this.width=width;this.height=height;this.createFromImages(this.images)},createFromImages:function(images){var i;this.scan=new CAAT.GLTextureScanMap(this.width,this.height);this.images=
[];if(this.allowImagesInvertion)for(i=0;i<images.length;i++)images[i].inverted=this.allowImagesInvertion&&images[i].height<images[i].width;var me=this;images.sort(function(a,b){var aarea=a.width*a.height;var barea=b.width*b.height;if(me.criteria==="width")return a.width<b.width?1:a.width>b.width?-1:0;else if(me.criteria==="height")return a.height<b.height?1:a.height>b.height?-1:0;return aarea<barea?1:aarea>barea?-1:0});for(i=0;i<images.length;i++){var img=images[i];this.packImage(img)}},addImage:function(image,
invert,padding){this.allowImagesInvertion=invert;this.padding=padding;this.images.push(image);this.createFromImages(Array.prototype.slice.call(this.images))},endCreation:function(){var gl=this.gl;gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D)},deletePage:function(){for(var i=0;i<this.images.length;i++){delete this.images[i].__texturePage;delete this.images[i].__u;delete this.images[i].__v}this.gl.deleteTexture(this.texture)},
toCanvas:function(canvass,outline){canvass=canvass||document.createElement("canvas");canvass.width=this.width;canvass.height=this.height;var ctxx=canvass.getContext("2d");ctxx.fillStyle="rgba(0,0,0,0)";ctxx.fillRect(0,0,this.width,this.height);for(var i=0;i<this.images.length;i++){ctxx.drawImage(!this.images[i].inverted?this.images[i]:CAAT.modules.ImageUtil.prototype.rotate(this.images[i],90),this.images[i].__tx,this.images[i].__ty);if(outline){ctxx.strokeStyle="red";ctxx.strokeRect(this.images[i].__tx,
this.images[i].__ty,this.images[i].__w,this.images[i].__h)}}if(outline){ctxx.strokeStyle="red";ctxx.strokeRect(0,0,this.width,this.height)}return canvass},packImage:function(img){var newWidth,newHeight;if(img.inverted){newWidth=img.height;newHeight=img.width}else{newWidth=img.width;newHeight=img.height}var w=newWidth;var h=newHeight;var mod;if(w&&this.padding){mod=this.padding;if(w+mod<=this.width)w+=mod}if(h&&this.padding){mod=this.padding;if(h+mod<=this.height)h+=mod}var where=this.scan.whereFitsChunk(w,
h);if(null!==where){this.images.push(img);img.__tx=where.x;img.__ty=where.y;img.__u=where.x/this.width;img.__v=where.y/this.height;img.__u1=(where.x+newWidth)/this.width;img.__v1=(where.y+newHeight)/this.height;img.__texturePage=this;img.__w=newWidth;img.__h=newHeight;this.scan.substract(where.x,where.y,w,h)}else CAAT.log("Imagen ",img.src," de tamano ",img.width,img.height," no cabe.")},changeHeuristic:function(criteria){this.criteria=criteria}}})();
(function(){CAAT.GLTexturePageManager=function(){this.pages=[];return this};CAAT.GLTexturePageManager.prototype={pages:null,createPages:function(gl,width,height,imagesCache){var end=false;while(!end){var page=new CAAT.GLTexturePage(width,height);page.create(imagesCache);page.initialize(gl);page.endCreation();this.pages.push(page);end=true;for(var i=0;i<imagesCache.length;i++)if(!imagesCache[i].image.__texturePage){if(imagesCache[i].image.width<=width&&imagesCache[i].image.height<=height)end=false;
break}}},deletePages:function(){for(var i=0;i<this.pages.length;i++)this.pages[i].deletePage();this.pages=null}}})();(function(){var _director=null;var _scene=null;var _modelActor=null;var _model=null;var _timer=null;function __CAAT__loadingScene(director){var scene=director.createScene();var TIME=1E3;var time=(new Date).getTime();var background=(new CAAT.ActorContainer).setBackgroundImage(director.getImage("splash"),false).setSize(director.width,director.height).setImageTransformation(CAAT.SpriteImage.prototype.TR_FIXED_TO_SIZE);scene.addChild(background);var lading=(new CAAT.Actor).setBackgroundImage(director.getImage("lading"),
true);lading.setLocation(director.width-lading.width-10,director.height-lading.height-30);scene.addChild(lading);var rueda=(new CAAT.Actor).setBackgroundImage(director.getImage("rueda"),true).setLocation(lading.x+20,lading.y+10);scene.addChild(rueda);rueda.addBehavior((new CAAT.RotateBehavior).setValues(0,2*Math.PI).setFrameTime(0,1E3).setCycle(true));var starsImage=null;starsImage=(new CAAT.SpriteImage).initialize(director.getImage("stars"),24,6);var T=600;var mouseStars=function(mouseEvent){for(var i=
0;i<3;i++){var offset0=Math.random()*10*(Math.random()<0.5?1:-1);var offset1=Math.random()*10*(Math.random()<0.5?1:-1);var iindex=Math.random()*6>>0;var actorStar=new CAAT.Actor;actorStar.__imageIndex=iindex;actorStar.setBackgroundImage(starsImage.getRef().setAnimationImageIndex([Math.random()*6>>0]),true).setLocation(offset0+mouseEvent.point.x,offset1+mouseEvent.point.y).setDiscardable(true).enableEvents(false).setFrameTime(scene.time,T).addBehavior((new CAAT.ScaleBehavior).setFrameTime(scene.time,
T).setValues(1,5,1,5).setInterpolator((new CAAT.Interpolator).createExponentialInInterpolator(3,false))).addBehavior((new CAAT.GenericBehavior).setFrameTime(scene.time,T).setValues(1,0.1,null,null,function(value,target,actor){actor.setSpriteIndex(actor.__imageIndex+(23-(23*value>>0))*actor.backgroundImage.getColumns())}).setInterpolator((new CAAT.Interpolator).createExponentialInInterpolator(3,false)));background.addChild(actorStar)}};background.mouseMove=mouseStars;background.mouseDrag=mouseStars;
scene.loadedImage=function(count,images){if(count===images.length){var difftime=(new Date).getTime()-time;if(difftime<TIME){difftime=Math.abs(TIME-difftime);if(difftime>TIME)difftime=TIME;scene.createTimer(scene.time,difftime,function(){__end_loading(director,images)})}else __end_loading(director,images)}};return scene}function __end_loading(director,images){director.emptyScenes();director.setImagesCache(images);createMenuScene(director);createSolitaireScene(director);director.setScene(0)}function createMenuScene(director){var games=
SU.GamesRegistry.getGames();var div=document.createElement("div");div.style.cssText="position: fixed; right: 0; top: 0; width: 150px; height: 100%;";for(var i=0;i<games.length;i++){var d=document.createElement("div");d.style.cssText="width:100%;";(function(game,d){var a=document.createElement("a");a.innerHTML=games[i];a.href="#";a.style.cssText="font-size: .9em; color: #fff;";a.onclick=function(e){changeGame(game)};d.appendChild(a)})(games[i],d);div.appendChild(d)}document.body.appendChild(div)}function changeGame(gameName){var model=
(new SU.Model).create(SU.GamesRegistry.createGame(gameName)).shuffle();if(_modelActor!==null)_scene.removeChild(_modelActor);_model=model;_modelActor=(new SU.ModelActor).initialize(_director,_scene,model);_scene.addChild(_modelActor);if(_timer!==null)_timer.cancel;_timer=_scene.createTimer(0,100,function(){_model.dealInit()})}function createSolitaireScene(director){var scene=director.createScene();_scene=scene;(new SU.FishPond).initialize(director,scene);changeGame("Klondike_Klondike3");scene.activated=
function(){}}function ss(){var director=(new CAAT.Director).initialize(960,640).setClear(false);_director=director;CAAT.browser=navigator.browser;(new CAAT.ImagePreloader).loadImages([{id:"stars",url:"game/res/stars.png"},{id:"splash",url:"game/splash/splash.png"},{id:"lading",url:"game/splash/lading.png"},{id:"rueda",url:"game/splash/rueda.png"}],function(counter,images){if(counter===images.length){director.setImagesCache(images);var scene_loading=__CAAT__loadingScene(director);(new CAAT.ImagePreloader).loadImages([{id:"cards",
url:"game/res/cartas.png"},{id:"dorso",url:"game/res/dorso.png"},{id:"start",url:"game/res/stars.png"},{id:"K",url:"game/res/rey.png"},{id:"A",url:"game/res/as.png"},{id:"P",url:"game/res/palos.png"},{id:"game-canfield",url:"game/res/games/canfield.png"},{id:"game-klondike",url:"game/res/games/klondike.png"},{id:"game-scorpion",url:"game/res/games/scorpion.png"},{id:"game-whitecard",url:"game/res/games/whitecard.png"},{id:"game-whitehead",url:"game/res/games/whitehead.png"}],function(counter,images){scene_loading.loadedImage(counter,
images)})}});CAAT.loop(60)}window.addEventListener("load",ss,false)})();(function(pool,math,width,chunks,significance,overflow,startdenom){math["seedrandom"]=function seedrandom(seed,use_entropy){var key=[];var arc4;seed=mixkey(flatten(use_entropy?[seed,pool]:arguments.length?seed:[(new Date).getTime(),pool,window],3),key);arc4=new ARC4(key);mixkey(arc4.S,pool);math["random"]=function random(){var n=arc4.g(chunks);var d=startdenom;var x=0;while(n<significance){n=(n+x)*width;d*=width;x=arc4.g(1)}while(n>=overflow){n/=2;d/=2;x>>>=1}return(n+x)/d};return seed};function ARC4(key){var t,
u,me=this,keylen=key.length;var i=0,j=me.i=me.j=me.m=0;me.S=[];me.c=[];if(!keylen)key=[keylen++];while(i<width)me.S[i]=i++;for(i=0;i<width;i++){t=me.S[i];j=lowbits(j+t+key[i%keylen]);u=me.S[j];me.S[i]=u;me.S[j]=t}me.g=function getnext(count){var s=me.S;var i=lowbits(me.i+1);var t=s[i];var j=lowbits(me.j+t);var u=s[j];s[i]=u;s[j]=t;var r=s[lowbits(t+u)];while(--count){i=lowbits(i+1);t=s[i];j=lowbits(j+t);u=s[j];s[i]=u;s[j]=t;r=r*width+s[lowbits(t+u)]}me.i=i;me.j=j;return r};me.g(width)}function flatten(obj,
depth,result,prop,typ){result=[];typ=typeof obj;if(depth&&typ=="object")for(prop in obj)if(prop.indexOf("S")<5)try{result.push(flatten(obj[prop],depth-1))}catch(e){}return result.length?result:obj+(typ!="string"?"\x00":"")}function mixkey(seed,key,smear,j){seed+="";smear=0;for(j=0;j<seed.length;j++)key[lowbits(j)]=lowbits((smear^=key[lowbits(j)]*19)+seed.charCodeAt(j));seed="";for(j in key)seed+=String.fromCharCode(key[j]);return seed}function lowbits(n){return n&width-1}startdenom=math.pow(width,
chunks);significance=math.pow(2,significance);overflow=significance*2;mixkey(math.random(),pool)})([],Math,256,6,52);SU={};SU.Game={};function assert(condition,description){if(!condition)throw"Assertion error:"+description;};(function(){SU.Action=function(){this.actions=[];return this};SU.Action.Types={DONE:0,UNDONE:1};SU.Action.prototype={actions:null,status:SU.Action.Types.DONE,addAction:function(action){this.actions.push(action);return this},undo:function(){if(this.status===SU.Action.Types.UNDONE)throw"Undoing already undone action.";for(var i=this.actions.length-1;i>=0;i--)this.actions[i].undo();this.status=SU.Action.Types.UNDONE;return this},canUndo:function(){return this.status===SU.Action.Types.DONE},canRedo:function(){return this.status===
SU.Action.Types.UNDONE},redo:function(){if(status===SU.Action.Types.DONE)throw"Doing already done action.";for(var i=0,l=this.actions.length;i<l;i++)this.actions[i].redo();this.status=SU.Action.Types.DONE;return this}}})();(function(){SU.ActionCardVisible=function(){return this};SU.ActionCardVisible.prototype={card:null,init:function(card){return this.setCard(card)},setCard:function(card){this.card=card;return this},getCard:function(){return this.card},undo:function(){this.card.setVisible(!this.card.isVisible())},redo:function(){this.card.setVisible(!this.card.isVisible())}}})();(function(){SU.ActionTransfer=function(model){this.model=model;return this};SU.ActionTransfer.prototype={fromPile:null,toPile:null,cards:null,status:null,model:null,setStatus:function(status){this.status=status;return this},getStatus:function(){return this.status},undo:function(){this.model.transfer.startTransfer(this.cards[0]);this.model.transferCards(this.fromPile,true)},redo:function(){this.model.transfer.startTransfer(this.cards[0]);try{this.model.transferCards(this.toPile,true)}catch(e){console.log("su santa madonna")}},
setSourcePile:function(pile){this.fromPile=pile;return this},setDestinationPile:function(pile){this.toPile=pile;return this},setTransferredCards:function(cards){this.cards=cards;return this},init:function(sp,dp,cards){this.fromPile=sp;this.toPile=dp;this.cards=cards;return this}}})();(function(){SU.ActionRedealCount=function(model){this.model=model;return this};SU.ActionRedealCount.prototype={model:null,undo:function(){this.model.numDeals--;return this},redo:function(){this.model.numDeals++;return this}}})();(function(){SU.Condition=function(){return this};SU.Condition.prototype={check:function(params){return false}}})();(function(){SU.ConditionAnd=function(){this.conditionList=[];return this};SU.ConditionAnd.prototype={conditionList:null,addCondition:function(condition){this.conditionList.push(condition);return this},check:function(params){for(var i=0,l=this.conditionList.length;i<l;i++)if(!this.conditionList[i].check(params))return false;return true}}})();(function(){SU.ConditionOr=function(){this.conditionList=[];return this};SU.ConditionOr.prototype={conditionList:null,addCondition:function(condition){this.conditionList.push(condition);return this},check:function(params){for(var i=0,l=this.conditionList.length;i<l;i++)if(this.conditionList[i].check(params))return true;return false}}})();(function(){SU.ConditionOperator=function(){return this};SU.ConditionOperator.Types={EQ:0,NEQ:1,GT:2,LT:3,GTE:4,LTE:5};SU.ConditionOperator.prototype={operator:null,value:null,setOperator:function(operator,value){this.operator=operator;this.value=value;return this},check:function(op2){var t=SU.ConditionOperator.Types;switch(this.operator){case t.EQ:return this.value===op2;case t.NEQ:return this.value!==op2;case t.GT:return this.value>op2;case t.LT:return this.value<op2;case t.GTE:return this.value>=
op2;case t.LTE:return this.value<=op2}return false}}})();(function(){SU.ConditionCardIndex=function(){return this};SU.ConditionCardIndex.prototype={index:null,setIndex:function(index){this.index=index;return this},check:function(params){return params.sourcePile.getFirstCard().getIndex()===this.index}}})();(function(){SU.ConditionCardIsVisible=function(){return this};SU.ConditionCardIsVisible.prototype={visible:true,setCondition:function(visible){this.visible=visible;return this},check:function(params){return params.card.isVisible()===this.visible}}})();(function(){SU.ConditionCardPositionInPile=function(){return this};SU.ConditionCardPositionInPile.Types={LAST_IN_PILE:0,FIRST_IN_PILE:1,POSITION:2};SU.ConditionCardPositionInPile.prototype={type:null,position:-1,setType:function(type,position){this.type=type;if(type===SU.ConditionCardPositionInPile.Types.POSITION)this.position=position;return this},check:function(params){var t=SU.ConditionCardPositionInPile.Types;switch(this.type){case t.LAST_IN_PILE:return params.card.isLastInPile();case t.FIRST_IN_PILE:return params.card.isFirstInPile();
case t.POSITION:return params.card.getPositionInPile()===this.position>0?this.position:params.card.getPile().getSize()+this.position}return false}}})();(function(){SU.ConditionCardSuitColor=function(){return this};SU.ConditionCardSuitColor.prototype={operator:null,suitcolor:null,setTypes:function(suitcolor,operator){this.suitcolor=suitcolor;this.operator=(new SU.ConditionOperator).setOperator(operator);return this},check:function(params){return this.operator.check(params.card.getSuitColor(),this.suitcolor)}}})();(function(){SU.ConditionCardSequence=function(){return this};SU.ConditionCardSequence.SequenceType={TOP_DOWN:0,BOTTOM_UP:1};SU.ConditionCardSequence.SuitType={EQUAL:0,SAME_COLOR:1,ALTERNATE_COLOR:2};var SQ=SU.ConditionCardSequence.SequenceType;var ST=SU.ConditionCardSequence.SuitType;SU.ConditionCardSequence.prototype={sequenceType:SQ.TOP_DOWN,suitType:ST.ALTERNATE_COLOR,increment:1,setType:function(seqType,suitType,increment){this.sequenceType=seqType;this.suitType=suitType;if(typeof increment!==
"undefined")this.increment=increment;return this},check:function(params){var card=params.card;var suit=card.getSuit();var scolor=card.getSuitColor();var pile=card.getPile();var index=card.getPositionInPile()+1;var sign=1;if(this.sequenceType===SQ.TOP_DOWN)sign=-1;while(index!=pile.getSize()){var ncard=pile.getCard(index);var nsuit=ncard.getSuit();var nscolor=ncard.getSuitColor();if(ncard.getIndex()!=card.getIndex()+sign*this.increment)return false;if(this.suitType===ST.EQUAL){if(suit!==nsuit)return false}else if(this.suitType===
ST.SAME_COLOR){if(nscolor!==scolor)return false}else if(this.suitType===ST.ALTERNATE_COLOR)if(nscolor===scolor)return false;suit=nsuit;scolor=nscolor;card=ncard;index++}return true}}})();(function(){SU.ConditionPileInSequence=function(){this.sequenceType=SU.ConditionPileInSequence.Type.TOP_DOWN;return this};SU.ConditionPileInSequence.Type={FULL_TOP_DOWN:5,FULL_BOTTOM_UP:6,TOP_DOWN:0,BOTTOM_UP:1,WRAPPED_TOP_DOWN:2,WRAPPED_BOTTOM_UP:3,WRAPPED:4};SU.ConditionPileInSequence.prototype={sequenceType:null,setSequenceType:function(type){this.sequenceType=type;return this},check:function(params){var SequenceType=SU.ConditionPileInSequence.Type;var Card=SU.Card;var card_first=params.pile.getFirstCard();
var i;var index;var card;var pile=params.pile;if(this.sequenceType===SequenceType.TOP_DOWN||this.sequenceType===SequenceType.FULL_TOP_DOWN){if(card_first.getIndex()!=Card.KING)return false}else if(this.sequenceType===SequenceType.BOTTOM_UP||this.sequenceType===SequenceType.FULL_BOTTOM_UP)if(card_first.getIndex()!=Card.ACE)return false;if(this.sequenceType===SequenceType.FULL_BOTTOM_UP||this.sequenceType===SequenceType.FULL_TOP_DOWN)if(pile.getSize()!=13)return false;for(i=1;i<pile.getSize();i++){card=
pile.getCard(i);if(card.getSuit()!=card_first.getSuit())return false;if(this.sequenceType==SequenceType.TOP_DOWN){if(card_first.getIndex()!=card.getIndex()+1)return false}else if(this.sequenceType==SequenceType.BOTTOM_UP)if(card_first.getIndex()!=card.getIndex()-1)return false;if(this.sequenceType==SequenceType.WRAPPED_TOP_DOWN){index=card_first.getIndex();if(index==Card.ACE)if(card.getIndex()!=Card.KING)return false;if(index!=card.getIndex()+1)return false}else if(this.sequenceType==SequenceType.WRAPPED_BOTTOM_UP){index=
card_first.getIndex();if(index==Card.KING)if(card.getIndex()!=Card.ACE)return false;if(index!=card.getIndex()-1)return false}else if(this.sequenceType==SequenceType.WRAPPED){index=card_first.getIndex();if(index==Card.ACE){if(card.getIndex()!=Card.KING&&card.getIndex()!=2)return false}else if(index==Card.KING){if(card.getIndex()!=Card.QUEEN&&card.getIndex()!=Card.ACE)return false}else if(card_first.getIndex()!=card.getIndex()-1&&card_first.getIndex()!=card.getIndex()+1)return false}card_first=card}return true}}})();(function(){SU.ConditionPileSize=function(){return this};SU.ConditionPileSize.Types={DESTINATION_PILE:0,SOURCE_PILE:1};SU.ConditionPileSize.prototype={operator:null,type:null,setType:function(operator,type){this.operator=operator;this.type=type;return this},check:function(params){var pile=this.type===SU.ConditionPileSize.Types.SOURCE_PILE?params.sourcePile:params.destinationPile;return this.operator.check(pile.getSize())}}})();(function(){SU.ConditionPileMakeSequence=function(){return this};SU.ConditionPileMakeSequence.SequenceType={TOP_DOWN:0,BOTTOM_UP:1,TOP_DOWN_ANY:2,BOTTOM_UP_ANY:3};SU.ConditionPileMakeSequence.SuitType={EQUAL:0,SAME_COLOR:1,ALTERNATE_COLOR:2,ANY:3};var SQ=SU.ConditionPileMakeSequence.SequenceType;var ST=SU.ConditionPileMakeSequence.SuitType;SU.ConditionPileMakeSequence.prototype={sequenceType:SQ.TOP_DOWN,suitType:ST.ALTERNATE_COLOR,increment:1,allowIfEmpty:true,setType:function(seqType,suitType,increment){this.sequenceType=
seqType;this.suitType=suitType;if(typeof increment!=="undefined")this.increment=increment;return this},allowDropIfEmpty:function(allow){this.allowIfEmpty=allow;return this},check:function(params){if(params.destinationPile.getSize()===0){if(!this.allowIfEmpty)return false;if(this.sequenceType===SQ.TOP_DOWN||this.sequenceType===SQ.BOTTOM_UP){var compareValue=this.sequenceType===SQ.TOP_DOWN?SU.Card.KING:SU.Card.ACE;var index=params.sourcePile.getFirstCard().getIndex();return index===compareValue}else return true}var card=
params.sourcePile.getFirstCard();var suit=card.getSuit();var scolor=card.getSuitColor();var sign=-1;if(this.sequenceType===SQ.TOP_DOWN||this.sequenceType===SQ.TOP_DOWN_ANY)sign=1;var ncard=params.destinationPile.getLastCard();var nsuit=ncard.getSuit();var nscolor=ncard.getSuitColor();if(ncard.getIndex()!=card.getIndex()+sign*this.increment)return false;if(this.suitType===ST.ANY)return true;else if(this.suitType===ST.EQUAL){if(suit!==nsuit)return false}else if(this.suitType===ST.SAME_COLOR){if(nscolor!==
scolor)return false}else if(this.suitType===ST.ALTERNATE_COLOR)if(nscolor===scolor)return false;return true}}})();(function(){SU.ConditionPileType=function(){return this};SU.ConditionPileType.prototype={type:null,setType:function(type){this.type=[].concat(type);return this},check:function(params){var t=params.pile.getType();var i;if(this.type)for(i=0;i<this.type.length;i++)if(this.type[i]===t)return true;return false}}})();(function(){SU.ConditionWin=function(){this.conditionInSequence=(new SU.ConditionPileInSequence).setSequenceType(SU.ConditionPileInSequence.Type.FULL_BOTTOM_UP);return this};SU.ConditionWin.prototype={conditionInSequence:null,check:function(params){var model=params;var foundation=model.getFoundationPiles();for(var i=0;i<foundation.length;i++)if(foundation[i].isEmpty()||!this.conditionInSequence.check({pile:foundation[i]}))return false;return true}}})();(function(){SU.ConditionWinScorpion=function(){this.conditionInSequence=(new SU.ConditionPileInSequence).setSequenceType(SU.ConditionPileInSequence.Type.FULL_TOP_DOWN);return this};SU.ConditionWinScorpion.prototype={conditionInSequence:null,check:function(params){var model=params;var nPiles=model.getNumDecks()*4;var tableau=model.getTableauPiles();for(var i=0;i<tableau.length;i++)if(!tableau[i].isEmpty())if(this.conditionInSequence.check({pile:tableau[i]}))nPiles--;return!nPiles}}})();(function(){SU.ConditionWinPyramid=function(){return this};SU.ConditionWinPyramid.prototype={conditionInSequence:null,check:function(params){var model=params;var tableau=model.getTableauPiles();for(var i=0;i<tableau.length;i++)if(!tableau[i].isEmpty())return false;return true}}})();(function(){SU.Suit=function(id,name,color){this.id=id;this.name=name;this.color=color;return this};SU.Suit.prototype={id:null,name:null,color:null,toString:function(){return this.name}};SU.Suit.Color={RED:"red",BLACK:"black"};SU.Suit.Name={HEARTS:"H",DIAMONDS:"D",SPADES:"S",CLUBS:"C"};SU.Suits=[new SU.Suit(0,SU.Suit.Name.HEARTS,SU.Suit.Color.RED),new SU.Suit(1,SU.Suit.Name.DIAMONDS,SU.Suit.Color.RED),new SU.Suit(2,SU.Suit.Name.SPADES,SU.Suit.Color.BLACK),new SU.Suit(3,SU.Suit.Name.CLUBS,SU.Suit.Color.BLACK)]})();(function(){SU.Card=function(index,suit){this.index=index;this.suit=suit;this.listenerList=[];this.setName();return this};SU.Card.KING=13;SU.Card.QUEEN=12;SU.Card.JACK=11;SU.Card.ACE=1;SU.Card.prototype={index:-1,suit:null,visible:false,name:null,pile:null,listenerList:null,isDraggable:false,visitedFoundation:false,reInit:function(){this.visitedFoundation=false;this.visible=false},setVisitedFoundation:function(b){this.visitedFoundation=b},hasVisitedFoundation:function(){return this.visitedFoundation},
getIndex:function(){return this.index},getSuit:function(){return this.suit},getSuitColor:function(){return this.suit.color},getSuitId:function(){return this.suit.id},getSuitName:function(){return this.suit.name},setVisible:function(visible){this.visible=visible;this.fire("visibilityChange",visible);return this},isVisible:function(){return this.visible},toString:function(){return(this.visible?"":"*")+this.name},setName:function(){var str="";switch(this.index){case 1:str+="A";break;case 2:str+="2";
break;case 3:str+="3";break;case 4:str+="4";break;case 5:str+="5";break;case 6:str+="6";break;case 7:str+="7";break;case 8:str+="8";break;case 9:str+="9";break;case 10:str+="10";break;case 11:str+="J";break;case 12:str+="Q";break;case 13:str+="K";break}str+=this.suit.toString();this.name=str},getName:function(){return this.name},setPile:function(pile){var fromPile=this.pile;this.pile=pile;this.fire("pileChange",fromPile);return this},getPile:function(){return this.pile},getPositionInPile:function(){return this.pile.indexOf(this)},
drag:function(){if(this.pile.canDrag(this));},canDrag:function(){return this.pile.canDrag(this)},isLastInPile:function(){return this.pile.getLastCard()===this},isFirstInPile:function(){return this.pile.getFirstCard()===this},extract:function(){return this.pile.extract(this.pile.getSize()-this.pile.indexOf(this))},extractDealInit:function(){return this.pile.extractDealInit()},removeFromPile:function(){this.pile.removeCard(this);return this},fire:function(type,data){for(var i=0,l=this.listenerList.length;i<
l;i++)this.listenerList[i](this,type,data)},addListener:function(listener){this.listenerList.push(listener)},setDragable:function(canDrag){this.isDraggable=canDrag;this.fire("dragInfo",canDrag)},isDraggable:function(){return this.isDraggable},dealInit:function(){this.fire("dealInit",null)}}})();(function(){SU.Pile=function(){this.cards=[];this.listenerList=[];return this};SU.Pile.Type={TABLEAU:0,FOUNDATION:1,WASTE:2,STOCK:3,TRANSFER:4};SU.Pile.Layout={NONE:0,VERTICAL:1,HORIZONTAL:2};SU.Pile.prototype={cards:null,dragCondition:null,dropCondition:null,name:null,type:null,visualHint:{x:0,y:0},listenerList:null,model:null,id:null,getId:function(){return this.id},setId:function(id){this.id=id;return this},setModel:function(model){this.model=model;return this},getModel:function(){return this.model},
getType:function(){return this.type},setDragCondition:function(condition){this.dragCondition=condition;return this},setDropCondition:function(condition){this.dropCondition=condition;return this},setName:function(name){this.name=name;return this},getName:function(){return this.name},addCard:function(card){var fromPile=card.getPile();card.setPile(this);this.cards.push(card);this.fire("card-added",{fromPile:fromPile,cards:card});return this},removeCard:function(card){var index=this.indexOf(card);this.cards.splice(index,
1);return this},addCards:function(cards){if(cards&&cards.length){var fromPile=cards[0].getPile();this.fire("cards-to-be-added",{fromPile:fromPile,cards:cards});for(var i=0;i<cards.length;i++)this.addCard(cards[i]);this.fire("cards-added",{fromPile:fromPile,cards:cards})}return this},isEmpty:function(){return this.cards.length===0},getSize:function(){return this.cards.length},getCard:function(index){return index>=0?this.cards[index]:this.cards[this.cards.length+index>=0?this.cards.length+index:0]},
getFirstCard:function(){return this.cards[0]},getLastCard:function(){return this.cards[this.cards.length-1]},indexOf:function(card){if(card.getPile()!==this)throw"indexOf called on pile with a not owned card.";for(var i=0;i<this.cards.length;i++)if(this.cards[i]===card)return i;throw"A card thinks to belong to this pile and indexOf says it does not.";},canDrag:function(card){if(card.getPile()!==this)throw"Trying to drag a card not in this Pile";if(!this.dragCondition)return false;return this.dragCondition.check({card:card})},
canDrop:function(transferPile){if(transferPile.getSize()===0)throw"Can not drop an empty pile";if(!this.dropCondition)return false;return this.dropCondition.check({sourcePile:transferPile,destinationPile:this})},extract:function(numCards){numCards=Math.min(numCards,this.cards.length);var cards=this.cards.splice(this.cards.length-numCards,numCards);this.fire("removed",{fromPile:this,cards:cards});return cards},extractDealInit:function(){var cards=this.cards.splice(0,1);this.fire("removed",{fromPile:this,
cards:cards});return cards},toString:function(){var str=this.name+" ("+this.cards.length+")\n";for(var i=this.cards.length-1;i>=0;i--)str+=this.cards[i].toString()+" ";return str},findCard:function(card){var i;var cardDesc;for(i=0;i<this.cards.length;i++){cardDesc=this.cards[i].toString();if(cardDesc==card||cardDesc=="*"+card)return this.cards[i]}return null},setReady:function(undoAction){return this},setVisualHint:function(vh){this.visualHint=vh;if(typeof vh.x==="undefined")vh.x=0;if(typeof vh.y===
"undefined")vh.y=0;if(typeof vh.cardsDistance==="undefined")vh.cardsDistance=30;return this},fire:function(event,data){for(var i=0,l=this.listenerList.length;i<l;i++)this.listenerList[i](this,event,data)},addListener:function(listener){this.listenerList.push(listener);return this},setDragInfo:function(){for(var i=this.cards.length-1;i>=0;i--){var card=this.cards[i];card.setDragable(this.canDrag(card))}},isTableau:function(){return this.type===SU.Pile.Type.TABLEAU},isFoundation:function(){return this.type===
SU.Pile.Type.FOUNDATION},isWaste:function(){return this.type===SU.Pile.Type.WASTE},isStock:function(){return this.type===SU.Pile.Type.STOCK}}})();(function(){SU.Deck=function(){var i,j;this.cards=[];for(i=0;i<SU.Suits.length;i++)for(j=1;j<14;j++)this.cards.push(new SU.Card(j,SU.Suits[i]));return this};SU.Deck.prototype={cards:null,getCards:function(pileStock){for(var i=0;i<this.cards.length;i++)pileStock.addCard(this.cards[i])}}})();(function(){SU.Model=function(){this.undoList=[];this.listenerList=[];return this};SU.Model.Status={DEALING:0,TESTING:1,USER:2,AUTOMATIC:3,ANIMATION:4,LOST:5,WIN:6};SU.Model.prototype={listenerList:null,undoList:null,undoIndex:-1,winConditionList:null,validDropTargets:null,maxRedeals:3,numDeals:0,cardsToDeal:3,transfer:null,stock:null,waste:null,tableau:null,foundation:null,piles:null,actionCount:0,moves:0,startTime:0,suggestedMoves:null,dealToWaste:true,trivialMovements:true,restart:function(){this.create(this.game);
this.fire("restart",null)},setPyramid:function(){this.transferCards=this.transferCardsPyramid;this.solveTrivialMovements=this.solveTrivialMovementsPyramid;this.createTableau=this.createTableauPyramid},create:function(game){this.game=game;if(game.family==="Pyramid")this.setPyramid();this.maxRedeals=game.maxRedeals;this.cardsToDeal=game.cardsToDeal;if(typeof game.trivialMovements!=="undefined")this.trivialMovements=game.trivialMovements;if(typeof game.dealToWaste!=="undefined")this.dealToWaste=game.dealToWaste;
this.piles=[];this.numDecks=game.numDecks;this.stock=(new SU.PileStock).initialize(game.numDecks,this.cardEvent.bind(this)).setVisualHint(game.stock).setDropCondition({check:function(){return false}}).setDragCondition({check:function(params){return params.card.isVisible()}});if(typeof game.waste!=="undefined"){this.waste=(new SU.PileWaste).setVisualHint(game.waste.visualHints).setDragCondition(game.waste.dragCondition).setDropCondition(game.waste.dropCondition);this.piles.push(this.waste)}this.transfer=
(new SU.PileTransfer).setVisualHint(game.transfer.visualHints);this.createTableau(game);if(typeof game.foundation!=="undefined"){this.createFoundation(game);for(i=0;i<this.foundation.length;i++)this.piles.push(this.foundation[i])}this.piles.push(this.stock);var i;for(i=0;i<this.tableau.length;i++)this.piles.push(this.tableau[i]);for(i=0;i<this.piles.length;i++)this.piles[i].setModel(this);this.winConditionList=game.winCondition;return this},reInit:function(){var i;for(i=0;i<this.piles.length;i++)if(!this.piles[i].isStock()){var pile=
this.piles[i];for(var j=0;j<pile.cards.length;j++){var card=pile.cards[j];this.stock.cards.push(card);card.pile=this.stock}pile.cards=[]}for(i=0;i<this.stock.cards.length;i++)this.stock.cards[i].reInit();this.undoList=[];this.undoIndex=-1;this.validDropTargets=[];this.actionCount=0;this.moves=0;this.startTime=(new Date).getTime();this.suggestedMoves=[];this.fire("reinit",null);this.stock.shuffle();this.dealInit()},getNumDecks:function(){return this.numDecks},addListener:function(f){this.listenerList.push(f)},
fire:function(event,data){for(var i=0;i<this.listenerList.length;i++)this.listenerList[i](event,data)},createFoundation:function(game){var index=0;var foundationInfo;var pile;this.foundation=[];for(var i=0;i<game.foundation.length;i++){foundationInfo=game.foundation[index];pile=(new SU.PileFoundation).setName("Foundation-"+(1+index)).setDragCondition(game.foundation.dragCondition).setDropCondition(game.foundation.dropCondition).setVisualHint(foundationInfo);this.foundation.push(pile);index++}},createTableauPyramid:function(game){SU.Model.prototype.createTableau.call(this,
game);var me=this,i,j;var _count=0;for(i=0;i<7;i++)for(j=0;j<i+1;j++){(function(count,row,cards_by_row){me.tableau[count].dragCondition=(new SU.ConditionAnd).addCondition({check:function(){return row===6||me.tableau[count+cards_by_row].getSize()===0&&me.tableau[count+cards_by_row+1].getSize()===0}});me.tableau[count].dropCondition={check:function(params){if(params.destinationPile.getSize()===0)return false;var data=params.destinationPile.id;var t=me.tableau[data.count+data.cbr]===params.sourcePile.sourcePile||
me.tableau[data.count+data.cbr+1]===params.sourcePile.sourcePile;if(t)return false;if(row===6||me.tableau[data.count+data.cbr].getSize()===0&&me.tableau[data.count+data.cbr+1].getSize()===0){var i0=params.sourcePile.getCard(0).getIndex();var i1=params.destinationPile.getCard(0).getIndex();return i0==13||i0+i1===13}return false}};me.tableau[count].setId({count:count,row:row,cbr:cards_by_row})})(_count,i,i+1);_count++}},createTableau:function(game){var i;this.tableau=[];function addTableauObject(tableauSource,
tableauModel){var index=0;var tableauInfo;var pile;while(tableauSource[index]){tableauInfo=tableauSource[index];pile=(new SU.PileTableau).setCardsOnStart(tableauInfo.dealSize).setName("Tableau-"+(1+index)).setDragCondition(tableauInfo.dragCondition?tableauInfo.dragCondition:tableauSource.dragCondition).setDropCondition(tableauInfo.dropCondition?tableauInfo.dropCondition:tableauSource.dropCondition).setVisualHint(tableauInfo).setId(tableauInfo.id);tableauModel.push(pile);index++}}if(Object.prototype.toString.call(game.tableau)==
"[object Array]"){for(i=0;i<game.tableau.length;i++)addTableauObject(game.tableau[i],this.tableau);for(i=0;i<this.tableau.length;i++)this.tableau[i].setName("Tableau-"+(1+i))}else addTableauObject(game.tableau,this.tableau)},shuffle:function(){this.stock.shuffle();return this},setStatus:function(status){this.status=status;this.fire("status",status);return this},getStatus:function(){return this.status},dealInit:function(){this.startTime=(new Date).getTime();this.setStatus(SU.Model.Status.DEALING);
var i,j;for(i=0;i<this.tableau.length;i++){var visible=this.tableau[i].visualHint.visible;var size=this.tableau[i].getCardsOnStart();for(j=0;j<size;j++){var card=this.stock.getLastCard();if(visible)if(size-(visible|0)<=j)card.setVisible(true);this.transfer.startTransfer(card);var cards=this.transfer.extract();this.tableau[i].addCards(cards);this.actionCount++}}for(i=0;i<this.tableau.length;i++){this.tableau[i].setReady();this.actionCount++}this.stock.setReady();this.fire("dealInit",{actions:this.actionCount});
this.actionCount=0;this.setDragInfo();return this},afterDealInit:function(){this.ready()},checkWin:function(){return this.winConditionList.check(this)},ready:function(){this.setStatus(SU.Model.Status.TESTING);if(this.checkWin())this.setStatus(SU.Model.Status.WIN);else{this.suggestedMoves=this.findAvailableMovements();if(this.suggestedMoves.length===0&&!this.canRedeal())this.setStatus(SU.Model.Status.LOST);else{this.setDragInfo();if(!this.solveTrivialMovements())this.setStatus(SU.Model.Status.USER)}}},
canRedeal:function(){return this.maxRedeals===-1||!this.stock.isEmpty()||this.waste&&!this.waste.isEmpty()&&this.numDeals<this.maxRedeals},deal:function(){this.actionCount=0;this.incrementMoves();if(!this.stock.getSize()){if(!this.canRedeal())return this;if(!this.waste.getSize())return this;this.transfer.startTransfer(this.waste.getFirstCard());this.transferCards(this.stock);this.numDeals++;this.addAction(new SU.ActionRedealCount(this))}else if(this.dealToWaste){this.transfer.startTransfer(this.stock.getCard(-this.cardsToDeal));
this.transferCards(this.waste,true)}else{var max=Math.min(this.tableau.length,this.stock.getSize());this.dealToMulti(max)}this.setDragInfo();return this},createUndo:function(){var action=new SU.Action;if(this.undoIndex!==-1)this.undoList=this.undoList.slice(0,this.undoIndex+1);else this.undoList=[];this.undoList.push(action);this.undoIndex=this.undoList.length-1;return action},addAction:function(action){this.undoList[this.undoIndex].addAction(action);return this},dealToMulti:function(numCards){var tindex=
0;var action=this.createUndo();while(numCards){var tbl=this.tableau[tindex];this.transfer.startTransfer(this.stock.getCard(-1));var cards=this.transfer.extract();action.addAction((new SU.ActionTransfer(this)).init(this.transfer.getSourcePile(),tbl,cards));tbl.addCards(cards);tbl.setReady(action);tindex++;numCards--}this.actionCount+=numCards;this.setDragInfo()},transferCardsPyramid:function(destinationPile,cards_from_deal){if(cards_from_deal){SU.Model.prototype.transferCards.call(this,destinationPile,
cards_from_deal);return}var cards=this.transfer.extract();var action=null;var _cc;var i;var dstCards=null;if(!this.inUndo){action=this.createUndo();action.addAction((new SU.ActionTransfer(this)).init(this.transfer.getSourcePile(),this.foundation[0],cards))}if(cards[0].getIndex()!==SU.Card.KING){dstCards=destinationPile.extract(1);if(!this.inUndo)action.addAction((new SU.ActionTransfer(this)).init(destinationPile,this.foundation[0],dstCards));dstCards[0].pile=this.transfer;SU.CardActors[dstCards[0].name].parent.removeChild(SU.CardActors[dstCards[0].name]);
SU.CardActors[dstCards[0].name].parent=null;_cc=[];for(i=0;i<cards.length;i++)_cc.push(cards[i]);for(i=0;i<dstCards.length;i++)_cc.push(dstCards[i]);this.foundation[0].addCards(_cc);this.actionCount+=2}else{_cc=[];for(i=0;i<cards.length;i++){SU.CardActors[cards[i].name].parent=null;_cc.push(cards[i])}this.foundation[0].addCards(_cc);this.actionCount++}this.transfer.setReady(action);destinationPile.setReady(action);this.setDragInfo()},transferCards:function(destinationPile){var cards=this.transfer.extract();
var action=null;if(!this.inUndo){action=this.createUndo();action.addAction((new SU.ActionTransfer(this)).init(this.transfer.getSourcePile(),destinationPile,cards))}destinationPile.addCards(cards);if(!this.inUndo){this.transfer.setReady(action);destinationPile.setReady(action)}this.actionCount+=cards.length;this.setDragInfo()},setDragInfo:function(){for(var i=0;i<this.piles.length;i++)this.piles[i].setDragInfo();return this},incrementMoves:function(){this.moves++;this.fire("moves",this.moves)},dump:function(){var i;
console.log(this.stock.toString());console.log(this.waste.toString());console.log(this.transfer.toString());for(i=0;i<this.tableau.length;i++)console.log(this.tableau[i].toString());for(i=0;i<this.foundation.length;i++)console.log(this.foundation[i].toString())},findCard:function(card_to_find){var card=null;var i;for(i=0;i<this.piles.length;i++){card=this.piles[i].findCard(card_to_find);if(null!==card)return card}return null},findAvailableMovements:function(){var i,j,k;var pairs=[];for(i=0;i<this.piles.length;i++){var tableau=
this.piles[i];if(tableau.isTableau()||tableau.isWaste())for(j=0;j<tableau.getSize();j++){var card=tableau.getCard(j);if(card.canDrag()){var pp=new SU.Pile;pp.cards.push(card);for(k=0;k<this.piles.length;k++){var pile=this.piles[k];if(pile!=tableau&&(pile.isTableau()||pile.isFoundation())&&pile.canDrop(pp))if(pile.getSize()===0&&j===0&&card.getIndex()===13);else pairs.push({card:card,pile:pile})}}}}return pairs},suggestMove:function(){if(!this.suggestedMoves||!this.suggestedMoves.length){if(!this.stock.isEmpty()||
this.waste&&!this.waste.isEmpty())this.deal();return}var move=this.suggestedMoves[Math.random()*this.suggestedMoves.length>>0];if(this.drag(move.card))this.drop(move.pile)},drag:function(card){if(card.canDrag()){this.actionCount=0;this.transfer.startTransfer(card);this.findValidDropTargetList();return true}return false},getCurrentTransferSource:function(){return this.transfer.sourcePile},findValidDropTargetList:function(){var i;var fromPile=this.transfer.getSourcePile();this.validDropTargets=[];for(i=
0;i<this.piles.length;i++){var dropOnPileTest=this.piles[i];if(dropOnPileTest!=fromPile&&this.isDropTarget(dropOnPileTest))this.validDropTargets.push(dropOnPileTest)}},isDropTarget:function(pile){return(pile.isFoundation()||pile.isTableau()||pile.isWaste())&&pile.canDrop(this.transfer)},isValidDropTarget:function(testPile){for(var i=0;i<this.validDropTargets.length;i++){var pile=this.validDropTargets[i];if(pile===testPile)return true}return false},solveTrivialMovementsPyramid:function(){if(!this.trivialMovements)return;
this.setStatus(SU.Model.Status.AUTOMATIC);var t=this.tableau;var f=this.foundation;for(var i=0;i<t.length;i++)if(t[i].getSize()>0&&t[i].canDrag(t[i].getCard(0))){var card=t[i].getCard(0);if(!card.hasVisitedFoundation()&&card.getIndex()===SU.Card.KING){this.drag(card);this.drop(f[0]);return true}}SU.Model.prototype.solveTrivialMovements.call(this);return false},solveTrivialMovements:function(){if(!this.trivialMovements||!this.foundation||this.foundation.length===0)return;this.setStatus(SU.Model.Status.AUTOMATIC);
var t=this.tableau;var f=this.foundation;function trivialDD(pile,me){var tt=pile;var lastCard=tt.getLastCard();if(!lastCard)return false;var pp=new SU.Pile;pp.cards.push(lastCard);if(!lastCard.hasVisitedFoundation()&&tt.canDrag(lastCard))for(var j=0;j<f.length;j++)if(f[j].canDrop(pp)){me.drag(lastCard);me.drop(f[j]);return true}return false}for(var i=0;i<t.length;i++)if(trivialDD(t[i],this))return true;if(this.waste)return trivialDD(this.waste,this);return false},autoFoundation:function(card){var f=
this.foundation;for(var i=0;i<f.length;i++){this.drag(card);if(this.drop(f[i]))return}},drop:function(onPile){if(null!==onPile&&this.isValidDropTarget(onPile)){this.incrementMoves();this.transferCards(onPile);return true}else{this.transfer.undo();return false}},undo:function(){if(this.undoIndex!==-1){this.inUndo=true;this.incrementMoves();this.actionCount=0;this.undoList[this.undoIndex].undo();this.undoIndex--;this.inUndo=false}else throw"Undo underflow";},redo:function(){if(this.undoList.length)if(this.undoList[this.undoIndex].canRedo()){this.undoList[this.undoIndex].redo();
if(this.undoIndex<this.undoList.length-1)this.undoIndex++}else throw"Redoing already done";else throw"Undo Overflow";},getSize:function(){return this.stock.getSize()},getCard:function(i){return this.stock.getCard(i)},cardEvent:function(card,type){if(type==="visibilityChange"||type==="pileChanged")this.actionCount++},getActionCount:function(){return this.actionCount},getPilesSize:function(){return this.piles.length},getPile:function(i){return this.piles[i]},getStockPile:function(){return this.stock},
getWastePile:function(){return this.waste},getTransferPile:function(){return this.transfer},getFoundationPiles:function(){return this.foundation},getTableauPiles:function(){return this.tableau}}})();(function(){SU.PileFoundation=function(){SU.PileFoundation.superclass.constructor.call(this);this.type=SU.Pile.Type.FOUNDATION;return this};SU.PileFoundation.prototype={addCard:function(card){SU.PileFoundation.superclass.addCard.call(this,card);card.setVisitedFoundation(true);return this},addCards:function(cards){SU.PileFoundation.superclass.addCards.call(this,cards);for(var i=0;i<cards.length;i++)cards[i].setVisitedFoundation(true);return this}};extend(SU.PileFoundation,SU.Pile)})();(function(){SU.PileTableau=function(){SU.PileTableau.superclass.constructor.call(this);this.type=SU.Pile.Type.TABLEAU;return this};SU.PileTableau.prototype={cardsOnStart:0,setCardsOnStart:function(n){this.cardsOnStart=n;return this},getCardsOnStart:function(){return this.cardsOnStart},setReady:function(undoAction){var card;if(this.getSize()){card=this.getLastCard();if(!card.isVisible()){card.setVisible(true);if(undoAction)undoAction.addAction((new SU.ActionCardVisible).init(card))}}return this}};
extend(SU.PileTableau,SU.Pile)})();(function(){SU.PileStock=function(){SU.PileStock.superclass.constructor.call(this);this.type=SU.Pile.Type.STOCK;this.setName("Stock");return this};SU.PileStock.prototype={addCards:function(cards){return SU.PileStock.superclass.addCards.call(this,cards.reverse())},initialize:function(numDecks,listener){for(var i=0;i<numDecks;i++)(new SU.Deck).getCards(this);for(var i=0;i<this.getSize();i++)this.getCard(i).addListener(listener);return this},shuffle:function(){var i,c0,c1;for(var i=0;i<this.cards.length*
5;i++){c0=Math.random()*this.cards.length>>0;do c1=Math.random()*this.cards.length>>0;while(c1===c0);var tmp=this.cards[c0];this.cards[c0]=this.cards[c1];this.cards[c1]=tmp}return this},dealInit:function(pile,numCards){for(var i=0;i<numCards;i++)pile.addCard(this.cards.shift());return this},canDrop:function(pile){return false},setReady:function(undoAction){if(!this.getSize())return this;var card;var i;for(i=0;i<this.getSize()-this.visualHint.cardsShown;i++){card=this.getCard(i);if(card.isVisible()){card.setVisible(false);
if(undoAction)undoAction.addAction((new SU.ActionCardVisible).init(card))}}for(i=this.getSize()-this.visualHint.cardsShown;i<this.getSize();i+=1){card=this.getCard(i);if(!card.isVisible()){card.setVisible(true);if(undoAction)undoAction.addAction((new SU.ActionCardVisible).init(card))}}return this}};extend(SU.PileStock,SU.Pile)})();(function(){SU.PileWaste=function(){SU.PileWaste.superclass.constructor.call(this);this.type=SU.Pile.Type.WASTE;this.setName("Waste");this.dragCondition=(new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE);return this};SU.PileWaste.prototype={addCards:function(cards){return SU.PileStock.superclass.addCards.call(this,cards.reverse())},setReady:function(undoAction){if(this.inUndo)return;var card;var i;for(i=0;i<this.getSize();i++){card=this.getCard(i);if(!card.isVisible()){card.setVisible(true);
undoAction.addAction((new SU.ActionCardVisible).init(card))}}return this}};extend(SU.PileWaste,SU.Pile)})();(function(){SU.PileTransfer=function(){SU.PileTransfer.superclass.constructor.call(this);this.type=SU.Pile.Type.TRANSFER;this.setName("Transfer");return this};SU.PileTransfer.prototype={sourcePile:null,setSourcePile:function(pile){this.sourcePile=pile;return this},getSourcePile:function(){return this.sourcePile},undo:function(){this.sourcePile.addCards(this.cards);this.cards=[]},setReady:function(undoAction){return this.sourcePile.setReady(undoAction)},startTransfer:function(card){this.setSourcePile(card.getPile());
this.addCards(card.extract());return this},startTransferDealInit:function(card){this.setSourcePile(card.getPile());this.addCards(card.extractDealInit());return this},extract:function(){return SU.PileTransfer.superclass.extract.call(this,this.getSize())},getType:function(){return this.sourcePile.getType()}};extend(SU.PileTransfer,SU.Pile)})();(function(){var GamesRegistry=function(){this.families={};this.games={};return this};GamesRegistry.prototype={families:null,games:null,registerGame:function(gameRegistry){if(!gameRegistry)throw"Empty game";if(typeof this.games[gameRegistry.id]!=="undefined")throw"Game already registered: "+gameRegistry.id;var family=this.families[gameRegistry.family];if(typeof family==="undefined"){family={};this.families[gameRegistry.family]=family}if(typeof family[gameRegistry.game]!=="undefined")throw"Already registered game. "+
gameRegistry.game;family[gameRegistry.game]={id:gameRegistry.id,clazz:gameRegistry.clazz,constructorParams:gameRegistry.params,instructions:gameRegistry.instructions,family:gameRegistry.family,game:gameRegistry.game};this.games[gameRegistry.id]=family[gameRegistry.game];return SU.GamesRegistry},createGame:function(id){if(typeof this.games[id]==="undefined")throw"Game "+id+" does not exist.";var gameD=this.games[id];var objs=gameD.clazz.split(".");var obj=window;while(objs.length)obj=obj[objs.shift()];
var game=obj.apply(window,gameD.constructorParams);game.family=this.games[id].family;game.name=this.games[id].game;return game},enumerate:function(){console.log("By family: ");for(var family in this.families){console.log("  Family: "+family);for(var game in this.families[family])console.log("    "+this.families[family][game].id)}console.log("");console.log("By Game:");for(var game in this.games)console.log("  "+this.games[game].id)},getGames:function(){var games=[];for(var game in this.games)games.push(this.games[game].id);
return games}};var registry=new GamesRegistry;SU.GamesRegistry={register:registry.registerGame.bind(registry),createGame:registry.createGame.bind(registry),enumerate:registry.enumerate.bind(registry),getGames:registry.getGames.bind(registry)}})();(function(){SU.Game.VisualHint=function(){return this};SU.Game.VisualHint.CardImage={A:"A",K:"K",NONE:""};SU.Game.VisualHint.prototype={dealSize:0,visible:0,x:0,y:0,layout:SU.Pile.Layout.NONE,maxSize:500,cardsDistance:30,image:"K",cardsShown:0,id:null,dragCondition:null,dropCondition:null,setCardsShown:function(cs){this.cardsShown=cs;return this},setLocation:function(x,y){this.x=x;this.y=y;return this},setLayout:function(layout){this.layout=layout;return this},setMaxSize:function(size){this.maxSize=
size;return this},setCardsDistance:function(d){this.cardsDistance=d;return this},setImage:function(i){this.image=i;return this}}})();SU.Helper={};
SU.Helper.createTableau=function(numTableau,dealSize,visible,layout,condition){var tableaus={};for(var i=0;i<numTableau;i++){var tableau=new SU.Game.VisualHint;tableau.dealSize=dealSize[i];tableau.visible=visible[i];tableau.x=layout.x+layout.xoffset*i;tableau.y=layout.y+layout.yoffset*i;if(typeof layout.layout!=="undefined")tableau.layout=layout.layout;if(typeof layout.maxSize!=="undefined")tableau.maxSize=layout.maxSize;if(typeof layout.cardsDistance!=="undefined")tableau.cardsDistance=layout.cardsDistance;
if(typeof layout.image!=="undefined")tableau.image=layout.image;tableaus[i]=tableau}tableaus.dragCondition=condition.drag;tableaus.dropCondition=condition.drop;return tableaus};
SU.Helper.createWaste=function(params){if(typeof params==="undefined")params={};var cardsShown,x,y,layout,cardsDistance,dropCondition;cardsShown=typeof params.cardsShown==="undefined"?3:params.cardsShown;x=typeof params.x==="undefined"?150:params.x;y=typeof params.y==="undefined"?50:params.y;layout=typeof params.layout==="undefined"?SU.Pile.Layout.HORIZONTAL:params.layout;cardsDistance=typeof params.cardsDistance==="undefined"?30:params.cardsDistance;dropCondition=typeof params.dropCondition==="undefined"?
undefined:params.dropCondition;return{visualHints:(new SU.Game.VisualHint).setLocation(x,y).setLayout(layout).setCardsDistance(cardsDistance).setImage(SU.Game.VisualHint.CardImage.P).setCardsShown(cardsShown),dragCondition:(new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE),dropCondition:dropCondition}};
SU.Helper.createStock=function(image,cs){if(typeof image==="undefined")image=SU.Game.VisualHint.CardImage.A;if(typeof cs==="undefined")cs=0;return(new SU.Game.VisualHint).setLocation(50,50).setLayout(SU.Pile.Layout.NONE).setCardsDistance(30).setImage(image).setCardsShown(cs)};
SU.Helper.createFoundation=function(x,xoffset,numDecks,y,yoffset,suitType){if(typeof suitType==="undefined")suitType=SU.ConditionPileMakeSequence.SuitType.EQUAL;if(typeof numDecks==="undefined")numDecks=1;if(typeof y==="undefined"){y=50;yoffset=0}if(typeof x==="undefined")x=350;if(typeof xoffset==="undefined")xoffset=100;var obj={dropCondition:(new SU.ConditionAnd).addCondition(SU.Helper.createDestionationPileSizeEquals(1,SU.ConditionOperator.Types.EQ,SU.ConditionPileSize.Types.SOURCE_PILE)).addCondition((new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.BOTTOM_UP,
suitType,1)),dragCondition:(new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE)};for(var i=0;i<4*numDecks;i++)obj[i]={x:x+xoffset*i,y:y+yoffset*i,image:"A",layout:SU.Pile.Layout.NONE};obj.length=4*numDecks;return obj};SU.Helper.createTransfer=function(){return{visualHints:{x:0,y:0,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30}}};SU.Helper.createWinConditionKlondike=function(){return new SU.ConditionWin};SU.Helper.createWinConditionScorpion=function(){return new SU.ConditionWinScorpion};
SU.Helper.createDestionationPileIsEmptyCondition=function(){return SU.Helper.createDestionationPileSizeEquals(0,SU.ConditionOperator.Types.EQ,SU.ConditionPileSize.Types.DESTINATION_PILE)};SU.Helper.createDestionationPileSizeEquals=function(size,operator,pile){return(new SU.ConditionPileSize).setType((new SU.ConditionOperator).setOperator(operator,size),pile)};
SU.Helper.createFoundationPyramid=function(x,y){if(typeof y==="undefined")y=50;if(typeof x==="undefined")x=680;var obj={dropCondition:(new SU.ConditionCardIndex).setIndex(SU.Card.KING),dragCondition:null};obj[0]={x:x,y:y,image:"A",layout:SU.Pile.Layout.HORIZONTAL,cardsShown:3};obj.length=1;return obj};(function(){SU.GamesRegistry.register({id:"Klondike_Klondike",family:"Klondike",game:"Klondike",clazz:"SU.Game.Klondike",params:[1,1,-1],instructions:""}).register({id:"Klondike_Klondike3",family:"Klondike",game:"Klondike Deal 3",clazz:"SU.Game.Klondike",params:[3,1,-1],instructions:""}).register({id:"Klondike_Whitehead",family:"Klondike",game:"Klondike WhiteHead",clazz:"SU.Game.Klondike_Whitehead",params:[],instructions:""}).register({id:"Klondike_Yukon",family:"Klondike",game:"Klondike Yukon",clazz:"SU.Game.Klondike_Yukon",
params:[],instructions:""});SU.Game.Klondike=function(cardsToDeal,numDecks,maxRedeals){return{canRedeal:true,numDecks:numDecks,maxRedeals:maxRedeals,cardsToDeal:cardsToDeal,waste:SU.Helper.createWaste(),stock:SU.Helper.createStock(),tableau:SU.Helper.createTableau(7,[1,2,3,4,5,6,7],[0,0,0,0,0,0,0],{x:50,y:200,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:270,image:"K",xoffset:100,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardSequence).setType(SU.ConditionCardSequence.SequenceType.TOP_DOWN,
SU.ConditionCardSequence.SuitType.ALTERNATE_COLOR,1)),drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.ALTERNATE_COLOR,1)}),foundation:SU.Helper.createFoundation(),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()}};SU.Game.Klondike_Yukon=function(){return{canRedeal:false,numDecks:1,maxRedeals:-1,
cardsToDeal:0,waste:SU.Helper.createWaste(),stock:SU.Helper.createStock(),tableau:SU.Helper.createTableau(7,[1,6,7,8,9,10,11],[1,5,5,5,5,5,5],{x:50,y:200,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:270,image:"K",xoffset:100,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible),drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.ALTERNATE_COLOR,1)}),foundation:SU.Helper.createFoundation(),
transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()}};SU.Game.Klondike_Whitehead=function(){return{canRedeal:false,numDecks:1,maxRedeals:0,cardsToDeal:1,waste:SU.Helper.createWaste(),stock:SU.Helper.createStock(),tableau:SU.Helper.createTableau(7,[1,2,3,4,5,6,7],[1,2,3,4,5,6,7],{x:50,y:200,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,image:"P",xoffset:100,yoffset:0,maxSize:270},
{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardSequence).setType(SU.ConditionCardSequence.SequenceType.TOP_DOWN,SU.ConditionCardSequence.SuitType.EQUAL,1)),drop:(new SU.ConditionOr).addCondition((new SU.ConditionPileSize).setType((new SU.ConditionOperator).setOperator(SU.ConditionOperator.Types.EQ,0),SU.ConditionPileSize.Types.DESTINATION_PILE)).addCondition((new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,
SU.ConditionPileMakeSequence.SuitType.SAME_COLOR,1))}),foundation:SU.Helper.createFoundation(),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()}}})();(function(){SU.GamesRegistry.register({id:"Scorpion_Scorpion",family:"Scorpion",game:"Scorpion",clazz:"SU.Game.Scorpion",params:[1,0],instructions:""});SU.Game.Scorpion=function(numDecks,maxRedeals){return{numDecks:numDecks,maxRedeals:maxRedeals,cardsToDeal:1,dealToWaste:false,trivialMovements:false,stock:SU.Helper.createStock().setLocation(700,50),tableau:SU.Helper.createTableau(7,[7,7,7,7,7,7,7],[5,5,5,7,7,7,7],{x:30,y:50,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:470,image:"K",xoffset:90,
yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible),drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.EQUAL,1)}),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionScorpion()}}})();(function(){SU.GamesRegistry.register({id:"Whitecard_Whitecard",family:"Whitecard",game:"Whitecard",clazz:"SU.Game.WhiteCard",params:[1],instructions:""});function tableau(){var t0=SU.Helper.createTableau(8,[7,7,7,7,6,6,6,6],[7,7,7,7,6,6,6,6],{x:25,y:200,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:270,image:"P",xoffset:75,yoffset:0},{drag:(new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE),drop:(new SU.ConditionOr).addCondition((new SU.ConditionPileSize).setType((new SU.ConditionOperator).setOperator(SU.ConditionOperator.Types.EQ,
0),SU.ConditionPileSize.Types.DESTINATION_PILE)).addCondition((new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.ALTERNATE_COLOR,1))});var t1=SU.Helper.createTableau(4,[0,0,0,0],[0,0,0,0],{x:25,y:50,layout:SU.Pile.Layout.VERTICAL,cardsDistance:0,maxSize:270,image:"P",xoffset:75,yoffset:0},{drag:{check:function(){return true}},drop:SU.Helper.createDestionationPileIsEmptyCondition()});return[t0,t1]}SU.Game.WhiteCard=function(numDecks){return{canRedeal:false,
numDecks:numDecks,maxRedeals:-1,cardsToDeal:0,dealToWaste:false,trivialMovements:false,stock:SU.Helper.createStock("").setLocation(400,500),tableau:tableau(),foundation:SU.Helper.createFoundation(400,75),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()}}})();(function(){SU.GamesRegistry.register({id:"Canfield_Canfield",family:"Canfielf",game:"Canfield",clazz:"SU.Game.Canfield",params:[1,1],instructions:""});SU.Game.Canfield=function(cardsToDeal,numDecks){return{canRedeal:true,numDecks:numDecks,maxRedeals:-1,cardsToDeal:cardsToDeal,waste:SU.Helper.createWaste({cardsShwon:5,x:700,y:200,layout:SU.Pile.Layout.VERTICAL}),stock:SU.Helper.createStock().setLocation(700,50),tableau:[SU.Helper.createTableau(4,[1,1,1,1],[1,1,1,1],{x:50,y:200,layout:SU.Pile.Layout.VERTICAL,
cardsDistance:30,maxSize:270,image:"K",xoffset:100,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardSequence).setType(SU.ConditionCardSequence.SequenceType.TOP_DOWN,SU.ConditionCardSequence.SuitType.ALTERNATE_COLOR,1)),drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN_ANY,SU.ConditionPileMakeSequence.SuitType.ALTERNATE_COLOR,1)}),SU.Helper.createTableau(1,[14],[1],{x:450,y:200,layout:SU.Pile.Layout.VERTICAL,
cardsDistance:15,maxSize:250,image:"K",xoffset:100,yoffset:0},{drag:(new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE)})],foundation:SU.Helper.createFoundation(50,100),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()}}})();(function(){SU.GamesRegistry.register({id:"Bakers_BakersDozen",family:"Bakers",game:"Bakers dozen",clazz:"SU.Game.Bakers",params:[1,false,false],instructions:""}).register({id:"Bakers_BakersDozen2",family:"Bakers",game:"Bakers dozen II",clazz:"SU.Game.Bakers",params:[1,true,false],instructions:""}).register({id:"Bakers_SpanishPatience",family:"Bakers",game:"Spanish patience",clazz:"SU.Game.Bakers",params:[1,false,true],instructions:""}).register({id:"Bakers_SpanishPatience2",family:"Bakers",game:"Spanish patience II",
clazz:"SU.Game.Bakers",params:[1,true,true],instructions:""});SU.Game.Bakers=function(numDecks,help,spanish){var obj={canRedeal:false,numDecks:numDecks,maxRedeals:-1,cardsToDeal:1,stock:SU.Helper.createStock(SU.Game.VisualHint.CardImage.NONE).setLocation(600,500),tableau:[SU.Helper.createTableau(7,[4,4,4,4,4,4,4],[4,4,4,4,4,4,4],{x:25,y:60,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:170,image:"",xoffset:90,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE)),
drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.ANY,1).allowDropIfEmpty(false)}),SU.Helper.createTableau(6,[4,4,4,4,4,4],[4,4,4,4,4,4],{x:25,y:310,layout:SU.Pile.Layout.VERTICAL,cardsDistance:30,maxSize:170,image:"",xoffset:90,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE)),
drop:(new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,SU.ConditionPileMakeSequence.SuitType.ANY,1).allowDropIfEmpty(false)})],foundation:SU.Helper.createFoundation(700,0,1,help?40:60,100,!spanish?SU.ConditionPileMakeSequence.SuitType.EQUAL:SU.ConditionPileMakeSequence.SuitType.ANY),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:SU.Helper.createWinConditionKlondike()};
if(help)obj.tableau.push(SU.Helper.createTableau(1,[0],[0],{x:700,y:440,layout:SU.Pile.Layout.NONE,cardsDistance:0,maxSize:0,image:"K",xoffset:0,yoffset:0},{drag:(new SU.ConditionAnd).addCondition(new SU.ConditionCardIsVisible).addCondition((new SU.ConditionCardPositionInPile).setType(SU.ConditionCardPositionInPile.Types.LAST_IN_PILE)),drop:!spanish?(new SU.ConditionAnd).addCondition(SU.Helper.createDestionationPileIsEmptyCondition()).addCondition((new SU.ConditionPileMakeSequence).setType(SU.ConditionPileMakeSequence.SequenceType.TOP_DOWN,
SU.ConditionPileMakeSequence.SuitType.ANY,1)):(new SU.ConditionAnd).addCondition(SU.Helper.createDestionationPileIsEmptyCondition())}));return obj}})();(function(){SU.GamesRegistry.register({id:"Pyramid_Pyramid",family:"Pyramid",game:"Pyramid",clazz:"SU.Game.Pyramid",params:[1,1,0,0],instructions:""}).register({id:"Pyramid_Pyramid_II",family:"Pyramid",game:"Pyramid_II",clazz:"SU.Game.Pyramid",params:[1,1,0,1],instructions:""});function createPyramid(rows,layout){var tableaus={};var _count=0;var i,j;for(i=0;i<rows;i++)for(j=0;j<i+1;j++){var tableau=new SU.Game.VisualHint;tableau.dealSize=1;tableau.visible=true;tableau.x=layout.x+(j-i/2)*layout.cardWidth;
tableau.y=layout.y+layout.cardHeight*i;tableau.maxSize=1;tableau.id=_count;tableau.image=layout.image;tableaus[_count]=tableau;_count++}return tableaus}SU.Game.Pyramid=function(cardsToDeal,numDecks,maxRedeals,showOnStock){return{canRedeal:false,numDecks:numDecks,maxRedeals:maxRedeals,cardsToDeal:cardsToDeal,waste:SU.Helper.createWaste({cardsShown:3,dropCondition:{check:function(params){if(params.sourcePile.getType()!==SU.Pile.Type.STOCK)return false;var cs=params.sourcePile.getLastCard();if(params.destinationPile.getSize()){var cd=
params.destinationPile.getLastCard();return cs.getIndex()===SU.Card.KING||cs.getIndex()+cd.getIndex()===SU.Card.KING}return false}},layout:SU.Pile.Layout.HORIZONTAL}),stock:SU.Helper.createStock(SU.Game.VisualHint.CardImage.A,showOnStock).setLocation(20,50),tableau:createPyramid(7,{x:380,y:50,cardWidth:80,cardHeight:70,image:""}),foundation:SU.Helper.createFoundationPyramid(),transfer:SU.Helper.createTransfer(),autoplay:"tableau-foundation waste-foundation tableau-tableau waste-foundation deal",winCondition:new SU.ConditionWinPyramid}}})();(function(){SU.PileActor=function(){SU.PileActor.superclass.constructor.call(this);return this};SU.PileActors=null;SU.PileActor.prototype={pile:null,dorsoImage:null,model:null,horizontalLayout:false,pileImages:null,initialize:function(model,pile,images){var t=SU.Pile.Type;this.dorsoImage=images.dorso;this.model=model;this.pile=pile;this.pileImages=images;this.setPileBackgroundImage();this.pile.addListener(this.pileEvent.bind(this));var p=this.getPileOnScreenPosition();this.setLocation(p.x,p.y);this.setSize(this.dorsoImage.width,
this.dorsoImage.height);return this},setPileBackgroundImage:function(){switch(this.pile.visualHint.image){case "A":this.setBackgroundImage(this.pileImages.A);break;case "K":this.setBackgroundImage(this.pileImages.K);break;case "P":this.setBackgroundImage(this.pileImages.P)}},pileEvent:function(pile,action,data){if(action==="card-added")this.cardAdded(data.cards,data.fromPile);else if(action==="cards-to-be-added")this.cardsToBeAdded(data.cards,data.fromPile);else if(action==="cards-added")this.cardsAdded(data.cards,
data.fromPile);else if(action==="removed")this.cardsRemoved(data.cards,data.fromPile)},cardsToBeAdded:function(cards,fromPile){},cardsAdded:function(cards,fromPile){for(var i=0;i<cards.length;i++){var cardActor=SU.CardActors[cards[i].getName()];var pile=SU.PileActors[this.pile.getName()];var pt=pile.modelToModel(new CAAT.Point(cardActor.x,cardActor.y,0),this);cardActor.x=pt.x;cardActor.y=pt.y}this.parent.setZOrder(this,Number.MAX_VALUE)},cardsRemoved:function(cards,fromPile){},cardAdded:function(card,
fromPile){},calcPileSize:function(){var rw=this.dorsoImage.width;var rh=this.dorsoImage.height;var pt=this.getNextCardPosition();this.setSize(rw+pt.x,rh+pt.y)},getPileOnScreenPosition:function(){var vh=this.pile.visualHint;var x=0,y=0;if(vh){x=vh.x;y=vh.y}return{x:x,y:y}},layout:function(start,end){var pile=this.pile;if(typeof start==="undefined")start=0;if(typeof end==="undefined")end=pile.cards.length;var vh=this.pile.visualHint;var l=SU.Pile.Layout;var x=0;var y=0;var c;var nCards=pile.cards.length;
var offset=vh.cardsDistance;if(nCards*offset>vh.maxSize)offset=vh.maxSize/nCards>>0;switch(vh.layout){case l.VERTICAL:y=offset*start;break;case l.HORIZONTAL:x=offset*start;break}for(var i=start;i<end;i++){c=SU.CardActors[pile.cards[i].getName()];c.__moveTo({x:c.x,y:c.y},{x:x,y:y},0);switch(vh.layout){case l.VERTICAL:y+=offset;break;case l.HORIZONTAL:x+=offset;break}}},unlayoutHorizontal:function(){this.setAlpha(1);this.setPileBackgroundImage();this.horizontalLayout=false;var pos=this.getPileOnScreenPosition();
this.setLocation(pos.x,pos.y).calcPileSize();this.setModelViewMatrix(false);var ca;var ps_src_local;var pile=this.pile;for(var i=0;i<pile.cards.length;i++){ca=SU.CardActors[pile.cards[i].getName()];ps_src_local=this.parent.modelToModel(new CAAT.Point(ca.x,ca.y,0),this);ca.setLocation(ps_src_local.x,ps_src_local.y)}this.layout()},layoutHorizontal:function(){var pile=this.pile;if(this.pile.cards.length<=1)return;this.parent.setZOrder(this,Number.MAX_VALUE);if(this.horizontalLayout)this.unlayoutHorizontal();
else{var offset=10;var w=SU.BackgroundImage.width+offset;var y=(this.parent.height-SU.BackgroundImage.height)/2;var x=(this.parent.width-(pile.cards.length-1)*w)/2-w/2;if(x<10){x=10;w=(this.parent.width-20)/pile.cards.length}var ca;var ps_src_local;for(var i=0;i<pile.cards.length;i++){ca=SU.CardActors[pile.cards[i].getName()];ps_src_local=ca.modelToModel(new CAAT.Point(0,0,0),this.parent);ca.moveTo({x:ps_src_local.x,y:ps_src_local.y},{x:x+w*i,y:y},0,this.pile)}this.setAlpha(0.5);this.setBackgroundImage(null);
this.setFillStyle("#000");this.setBounds(0,0,this.parent.width,this.parent.height);this.horizontalLayout=true;this.emptyBehaviorList();this.addBehavior((new CAAT.AlphaBehavior).setValues(0,0.75).setDelayTime(0,500))}},getNextCardPosition:function(){var vh=this.pile.visualHint;var l=SU.Pile.Layout;var x=0;var y=0;switch(vh.layout){case l.VERTICAL:y+=(this.pile.getSize()-1)*vh.cardsDistance;break;case l.HORIZONTAL:x+=(this.pile.getSize()-1)*vh.cardsDistance;break}return{x:x,y:y}},mouseClick:function(e){if(this.layoutHorizontal)this.unlayoutHorizontal()}};
extend(SU.PileActor,CAAT.ActorContainer)})();
(function(){SU.PileActorTableau=function(){SU.PileActorTableau.superclass.constructor.call(this);return this};SU.PileActorTableau.prototype={pile:null,dorsoImage:null,model:null,cardsAdded:function(addedCards,fromPile){SU.PileActorTableau.superclass.cardsAdded.call(this,addedCards,fromPile);var vh=this.pile.visualHint;var i;var pileFrom=SU.PileActors[fromPile.getName()];var ps_src_local;var cardActor=null;var index;SU.modelActor.readyIn(this.model.getActionCount()+addedCards.length);if(this.model.getStatus()!==
SU.Model.Status.DEALING)this.layout(0,this.pile.cards.length-addedCards.length);var offset=vh.cardsDistance;if(offset*this.pile.cards.length>vh.maxSize)offset=vh.maxSize/this.pile.cards.length>>0;for(i=0;i<addedCards.length;i++){cardActor=SU.CardActors[addedCards[i].getName()];ps_src_local=pileFrom.modelToModel(new CAAT.Point(cardActor.x,cardActor.y,0),this);cardActor.setLocation(ps_src_local.x,ps_src_local.y);pileFrom.removeChild(cardActor);this.addChildImmediately(cardActor);index=this.findChild(cardActor);
cardActor.moveTo({x:cardActor.x,y:cardActor.y},{x:vh.layout===SU.Pile.Layout.VERTICAL?0:index*offset,y:vh.layout===SU.Pile.Layout.VERTICAL?index*offset:0},(this.model.getActionCount()+i)*SU.CardActor.NEXT_ANIMATION_DELAY,this.pile,this.model.getStatus()===SU.Model.Status.DEALING)}this.calcPileSize()},cardsRemoved:function(cards,fromPile){if(!this.horizontalLayout)this.layout(0,this.pile.cards.length)},cardAdded:function(cards,fromPile){}};extend(SU.PileActorTableau,SU.PileActor)})();
(function(){SU.PileActorTransfer=function(){SU.PileActorTransfer.superclass.constructor.call(this);this.visualHint={layout:SU.Pile.Layout.NONE};return this};SU.PileActorTransfer.prototype={setPositionAtCard:function(card){var cardActor=SU.CardActors[card.getName()];var pt=new CAAT.Point(0,0);cardActor.modelToView(pt);this.setPosition(pt.x,pt.y);this.setModelViewMatrix()},cardsToBeAdded:function(cards,fromPile){this.setPositionAtCard(cards[0])},cardsAdded:function(addedCards,fromPile){SU.PileActorTransfer.superclass.cardsAdded.call(this,
addedCards,fromPile);this.visualHint.layout=fromPile.visualHint.layout;this.visualHint.cardsDistance=fromPile.visualHint.cardsDistance;var i;var pileFrom=SU.PileActors[fromPile.getName()];var ps_src_local;var cardActor=null;for(i=0;i<addedCards.length;i++){cardActor=SU.CardActors[addedCards[i].getName()];ps_src_local=pileFrom.modelToModel(new CAAT.Point(cardActor.x,cardActor.y,0),this);cardActor.setLocation(ps_src_local.x,ps_src_local.y);pileFrom.removeChild(cardActor);this.addChildImmediately(cardActor)}this.calcPileSize()},
calcPileSize:function(){}};extend(SU.PileActorTransfer,SU.PileActor)})();
(function(){SU.PileActorWaste=function(){SU.PileActorWaste.superclass.constructor.call(this);return this};SU.PileActorWaste.prototype={doLayout:function(add){var i;var pile=this.pile;var pileSize=this.pile.getSize();var card;var cardActor;if(add)SU.modelActor.readyIn(1);var vh=this.pile.visualHint;var nCards=vh.cardsShown;for(i=0;i<pileSize-nCards&&add;i++){card=pile.getCard(i);cardActor=SU.CardActors[card.getName()];if(i<pileSize-2*nCards){cardActor.visible=false;cardActor.setPosition(0,0)}else{cardActor.visible=
true;cardActor.moveTo({x:cardActor.x,y:cardActor.y},{x:0,y:0},0,this.pile);cardActor.BL_HideCard()}}var index=Math.min(nCards,pileSize);for(i=0;i<index;i++){card=pile.getCard(pileSize-index+i);cardActor=SU.CardActors[card.getName()];cardActor.visible=true;cardActor.moveTo({x:cardActor.x,y:cardActor.y},{x:vh.layout===SU.Pile.Layout.HORIZONTAL?i*vh.cardsDistance:0,y:vh.layout===SU.Pile.Layout.HORIZONTAL?0:i*vh.cardsDistance},0,this.pile);cardActor.BL_Nothing()}},cardsAdded:function(addedCards,fromPile){SU.PileActorWaste.superclass.cardsAdded.call(this,
addedCards,fromPile);var i;var pileFrom=SU.PileActors[fromPile.getName()];var ps_src_local=pileFrom.modelToModel(new CAAT.Point(0,0,0),this);var cardActor=null;for(i=0;i<addedCards.length;i++){cardActor=SU.CardActors[addedCards[i].getName()];cardActor.setLocation(ps_src_local.x+(this.pile.visualHint.layout!==SU.Pile.Layout.VERTICAL?SU.PileActorStock.LayoutOffset*i:0),ps_src_local.y+(this.pile.visualHint.layout===SU.Pile.Layout.VERTICAL?SU.PileActorStock.LayoutOffset*i:0));var ret=pileFrom.removeChild(cardActor);
if(null===ret)console.log("remove cardActor not present");this.addChildImmediately(cardActor)}this.doLayout(true);this.calcPileSize()},cardsRemoved:function(removedCards){this.doLayout(false);this.calcPileSize()},calcPileSize:function(){var rw=this.dorsoImage.width;var rh=this.dorsoImage.height;var vh=this.pile.visualHint;var s=Math.min(vh.cardsShown,this.pile.getSize());if(vh.layout===SU.Pile.Layout.VERTICAL)rh+=s*(vh.cardsDistance?vh.cardsDistance:30);else rw+=s*(vh.cardsDistance?vh.cardsDistance:
30);this.setSize(rw,rh)},cardAdded:function(cards,fromPile){},getNextCardPosition:function(){var vh=this.pile.visualHint;var x=0;var y=0;var s=Math.min(vh.cardsShown,this.pile.getSize());if(vh.verticalLayout)y+=s*(vh.cardsDistance?vh.cardsDistance:30);else x+=s*(vh.cardsDistance?vh.cardsDistance:30);return{x:x,y:y}}};extend(SU.PileActorWaste,SU.PileActor)})();
(function(){SU.PileActorStock=function(){SU.PileActorStock.superclass.constructor.call(this);return this};var NC=3;var CARD_OFFSET=5;SU.PileActorStock.LayoutOffset=CARD_OFFSET;SU.PileActorStock.prototype={NC:3,CARD_OFFSET:5,mouseEnter:function(){if(this.pile.model.canRedeal())CAAT.setCursor("pointer")},mouseExit:function(){CAAT.setCursor("default")},mouseDown:function(){this.model.deal()},mouseClick:function(){},doLayout:function(num){},cardsAdded:function(addedCards,fromPile){SU.PileActorStock.superclass.cardsAdded.call(this,
addedCards,fromPile);var i;var pileFromActor=SU.PileActors[fromPile.getName()];var pt_src_local;var cardActor=null;var offset=0;var pileSize=this.pile.getSize();var card;SU.modelActor.readyIn(addedCards.length);var cartas_a_mover=Math.min(addedCards.length,this.NC-1);var rem=Math.min(pileSize,this.NC)-addedCards.length;for(i=0;i<rem;i++){card=this.pile.getCard(-i-addedCards.length-1);cardActor=SU.CardActors[card.getName()];cardActor.visible=true;cardActor.moveTo({x:cardActor.x,y:cardActor.y},{x:i+
cartas_a_mover>=this.NC-1?-rem*this.CARD_OFFSET:-this.CARD_OFFSET*(1+i),y:0},0,this.pile)}for(i=0;i<addedCards.length;i++){cardActor=SU.CardActors[addedCards[i].getName()];offset=i<addedCards.length-this.NC?0:1-addedCards.length+i;pt_src_local=pileFromActor.modelToModel(new CAAT.Point(cardActor.x,cardActor.y,0),this);cardActor.moveTo(pt_src_local,{x:offset*this.CARD_OFFSET,y:0},i*SU.CardActor.NEXT_ANIMATION_DELAY,this.pile);if(i<addedCards.length-this.NC)cardActor.BL_HideCard();else cardActor.BL_Nothing();
var ret=pileFromActor.removeChild(cardActor);if(null===ret)console.log("remove cardActor not present");this.addChild(cardActor)}},cardAdded:function(cards,fromPile){},cardsRemoved:function(removedCards){var i;var pile=this.pile;var pileSize=this.pile.getSize();var card;var cardActor;var index=Math.max(0,pileSize-this.NC);for(i=0;i<index;i++){card=pile.getCard(i);cardActor=SU.CardActors[card.getName()];if(i===index-1){cardActor.visible=true;cardActor.setLocation(-(this.NC-1)*this.CARD_OFFSET,0)}else cardActor.visible=
false}var rem=Math.min(this.NC,pileSize);for(i=0;i<rem;i++){card=pile.getCard(-i-1);cardActor=SU.CardActors[card.getName()];cardActor.visible=true;var offset=i;cardActor.setLocation(-(rem-1)*this.CARD_OFFSET,0);var pt_src_local=new CAAT.Point(cardActor.x,cardActor.y,0);cardActor.moveTo(pt_src_local,{x:-offset*this.CARD_OFFSET,y:0},0,this.pile);cardActor.BL_Nothing()}}};extend(SU.PileActorStock,SU.PileActor)})();
(function(){SU.PileActorFoundation=function(){SU.PileActorFoundation.superclass.constructor.call(this);return this};SU.PileActorFoundation.prototype={doLayout:function(b_addedcards){var i;var pile=this.pile;var pileSize=this.pile.getSize();var card;var cardActor;var cs=this.pile.visualHint.cardsShown?this.pile.visualHint.cardsShown:2;for(i=0;i<pileSize-cs;i++){card=pile.getCard(i);cardActor=SU.CardActors[card.getName()];cardActor.visible=false}var index=Math.min(cs,pileSize);if(b_addedcards)SU.modelActor.readyIn(1);
for(i=0;i<index;i++){card=pile.getCard(pileSize-index+i);cardActor=SU.CardActors[card.getName()];cardActor.visible=true;cardActor.moveTo({x:cardActor.x,y:cardActor.y},{x:0,y:0},0,this.pile,false)}},cardsAdded:function(addedCards,fromPile){SU.PileActorFoundation.superclass.cardsAdded.call(this,addedCards,fromPile);var i;var pileFrom=SU.PileActors[fromPile.getName()];var ps_src_local=pileFrom.modelToModel(new CAAT.Point(0,0,0),this);var cardActor=null;for(i=0;i<addedCards.length;i++){cardActor=SU.CardActors[addedCards[i].getName()];
cardActor.setLocation(ps_src_local.x,ps_src_local.y);pileFrom.removeChild(cardActor);this.addChildImmediately(cardActor)}this.doLayout(true);this.calcPileSize()},cardsRemoved:function(removedCards){this.doLayout(false);this.calcPileSize()},calcPileSize:function(){var rw=this.dorsoImage.width;var rh=this.dorsoImage.height;this.setSize(rw,rh)},cardAdded:function(cards,fromPile){}};extend(SU.PileActorFoundation,SU.PileActor)})();
(function(){SU.CardActor=function(){SU.CardActor.superclass.constructor.call(this);this.setId(512);return this};SU.CardActor.BEHAVIOR_TIME=400;SU.CardActor.BEHAVIOR_VISIBILITY_TIME=200;SU.CardActor.NEXT_ANIMATION_DELAY=30;SU.CardActor.prototype={card:null,imageIndex:0,cardImage:null,dorsoImage:null,scene:null,model:null,bshow:null,bhide:null,canDrag:false,dragPrevX:-1,dragPrevY:-1,pile2Actor:null,inAnimation:false,initialize:function(scene,model,card,cardImage,dorsoImage,pile2Actor){this.card=card;
this.cardImage=cardImage;this.scene=scene;this.model=model;this.dorsoImage=dorsoImage;this.pile2Actor=pile2Actor;this.imageIndex=(card.getIndex()-1)*4+card.getSuitId();if(card.visible){this.setBackgroundImage(this.cardImage);this.setSpriteIndex(this.imageIndex)}else this.setBackgroundImage(dorsoImage,true);card.addListener(this.cardListener.bind(this));return this},mouseClick:function(e){if(this.parent.pile.getType()===SU.Pile.Type.TABLEAU)this.parent.layoutHorizontal()},mouseDblClick:function(e){if(this.card.isLastInPile())this.model.autoFoundation(this.card)},
mouseEnter:function(e){if(this.canDrag||this.card.pile.getType()===SU.Pile.Type.STOCK)CAAT.setCursor("pointer")},mouseExit:function(e){CAAT.setCursor("default")},mouseDown:function(e){if(this.parent.pile.getType()===SU.Pile.Type.STOCK)this.model.deal();else if(this.canDrag){this.model.drag(this.card);this.dragPrevX=e.screenPoint.x;this.dragPrevY=e.screenPoint.y}},mouseUp:function(e){this.dragPrevX=-1;this.dragPrevY=-1;if(this.canDrag){var dropTarget=this.checkPositionWithDropTargets();this.model.drop(dropTarget?
dropTarget.pile:null)}},mouseDrag:function(e){if(this.canDrag){var currentTR=this.model.getCurrentTransferSource();if(currentTR.getType()===SU.Pile.Type.TABLEAU){var pa=SU.PileActors[currentTR.getName()];if(pa.horizontalLayout){pa.unlayoutHorizontal();SU.PileActors[this.parent.pile.getName()].layout()}}var sp=e.screenPoint;var parent=this.parent;var x=parent.x+sp.x-this.dragPrevX;var y=parent.y+sp.y-this.dragPrevY;parent.setLocation(x,y);this.dragPrevX=sp.x;this.dragPrevY=sp.y}},checkPositionWithDropTargets:function(){var i;
var pile;var pileActor;var dropTargets=this.model.validDropTargets;var pileActorTransfer=this.parent;var x,y;for(i=0;i<dropTargets.length;i++){pile=dropTargets[i];pileActor=SU.PileActors[pile.getName()];x=pileActorTransfer.x-pileActor.x;y=pileActorTransfer.y-pileActor.y;x/=pileActor.width;y/=pileActor.height;if(x>=0&&x<=1&&y>=0&&y<=1)return pileActor}return null},cardListener:function(card,eventType,data){if(eventType==="visibilityChange")this.setVisibility(data);else if(eventType==="dragInfo")this.canDrag=
data;else if(eventType==="selected")this.alpha=0.5;else if(eventType==="unselected")this.alpha=1},reInit:function(){this.setBackgroundImage(this.dorsoImage);this.setLocation(0,0);this.visible=false;this.emptyBehaviorList()},setVisibility:function(show){var pb=this.getBehavior(101);var me=this;if(!pb){pb=(new CAAT.ContainerBehavior).setId(101);this.bshow=(new CAAT.ScaleBehavior).setValues(0,1,1.1,1).setFrameTime(SU.CardActor.BEHAVIOR_VISIBILITY_TIME/2,SU.CardActor.BEHAVIOR_VISIBILITY_TIME/2);this.bhide=
(new CAAT.ScaleBehavior).setValues(1,0,1,1.1).setFrameTime(0,SU.CardActor.BEHAVIOR_VISIBILITY_TIME/2);pb.addBehavior(this.bhide);pb.addBehavior(this.bshow);this.addBehavior(pb)}if(show){me.setBackgroundImage(me.dorsoImage);this.bhide.emptyListenerList();this.bhide.addListener({behaviorExpired:function(behavior,time,actor){actor.setBackgroundImage(me.cardImage);actor.setSpriteIndex(me.imageIndex);actor.inAnimation=false}})}else{me.setBackgroundImage(me.cardImage);me.setSpriteIndex(me.imageIndex);this.bhide.emptyListenerList();
this.bhide.addListener({behaviorExpired:function(behavior,time,actor){actor.setBackgroundImage(me.dorsoImage);actor.inAnimation=false}})}this.inAnimation=true;pb.setDelayTime((this.model.getActionCount()-1)*SU.CardActor.NEXT_ANIMATION_DELAY+(show?SU.CardActor.BEHAVIOR_TIME-SU.CardActor.BEHAVIOR_VISIBILITY_TIME:0),SU.CardActor.BEHAVIOR_VISIBILITY_TIME)},BL_Nothing:function(){var b0=this.getBehavior(100);if(b0)b0.emptyListenerList();this.inAnimation=false},BL_HideCard:function(callback){var me=this;
var b0=this.getBehavior(100);b0.emptyListenerList();b0.addListener({behaviorExpired:function(behavior,time,actor){actor.visible=false;actor.getBehavior(100).emptyListenerList();actor.inAnimation=false;if(callback)callback()}})},moveTo:function(pt_src_local,pt_dst_local,start_time,toPile,rotate){this.setLocation(pt_src_local.x,pt_src_local.y);if(toPile.getType()!==SU.Pile.Type.TRANSFER){var b1=this.getBehavior(102);this.visible=true;if(rotate&&toPile.getType()!==SU.Pile.Type.WASTE&&toPile.getType()!==
SU.Pile.Type.STOCK){if(null===b1){b1=(new CAAT.RotateBehavior).setValues(0,2*(Math.random()<0.5?1:2)*Math.PI).setId(102).setInterpolator((new CAAT.Interpolator).createExponentialOutInterpolator(3,false));this.addBehavior(b1)}b1.setDelayTime(start_time,SU.CardActor.BEHAVIOR_TIME)}this.__moveTo(pt_src_local,pt_dst_local,start_time)}else this.setLocation(pt_dst_local.x,pt_dst_local.y)},__moveTo:function(pt_src_local,pt_dst_local,start_time){var b0=this.getBehavior(100);if(!b0){b0=(new CAAT.PathBehavior).setValues((new CAAT.Path).setLinear(0,
0,0,0)).setId(100).setInterpolator((new CAAT.Interpolator).createExponentialOutInterpolator(3,false));b0.addListener({behaviorExpired:function(behavior,time,actor){actor.inAnimation=false}});this.addBehavior(b0)}if(pt_src_local.x!=pt_dst_local.x||pt_src_local.y!=pt_dst_local.y){this.inAnimation=true;b0.setValues((new CAAT.Path).setLinear(pt_src_local.x,pt_src_local.y,pt_dst_local.x,pt_dst_local.y)).setDelayTime(start_time,SU.CardActor.BEHAVIOR_TIME)}}};extend(SU.CardActor,CAAT.Actor)})();
(function(){SU.ModelActor=function(){SU.ModelActor.superclass.constructor.call(this);return this};SU.ModelActor.prototype={model:null,stockActor:null,wasteActor:null,transferActor:null,foundationActors:null,tableauActors:null,pile2Actor:null,scene:null,initGame:function(model,director,scene,images){this.emptyChildren();this.pile2Actor={};var cardsImage=(new CAAT.SpriteImage).initialize(director.getImage("cards"),13,4);var i;var tp;var fp;this.stockActor=(new SU.PileActorStock).initialize(model,model.getStockPile(),
images);this.addChild(this.stockActor);this.pile2Actor[model.getStockPile().getName()]=this.stockActor;if(model.getWastePile()){this.wasteActor=(new SU.PileActorWaste).initialize(model,model.getWastePile(),images);this.addChild(this.wasteActor);this.pile2Actor[model.getWastePile().getName()]=this.wasteActor}tp=model.getTableauPiles();this.tableauActors=[];for(i=0;i<tp.length;i++){this.tableauActors.push((new SU.PileActorTableau).initialize(model,tp[i],images));this.pile2Actor[tp[i].getName()]=this.tableauActors[i]}for(i=
tp.length-1;i>=0;i--)this.addChild(this.tableauActors[i]);fp=model.getFoundationPiles();if(fp&&fp.length>0){this.foundationActors=[];for(i=0;i<fp.length;i++){this.foundationActors.push((new SU.PileActorFoundation).initialize(model,fp[i],images));this.addChild(this.foundationActors[i]);this.pile2Actor[fp[i].getName()]=this.foundationActors[i]}}this.transferActor=(new SU.PileActorTransfer).initialize(model,model.getTransferPile(),images).enableEvents(false);this.addChild(this.transferActor);this.pile2Actor[model.getTransferPile().getName()]=
this.transferActor;SU.PileActors=this.pile2Actor;SU.PileActor.prototype.scene=scene;var card2Actor={};for(i=0;i<model.getSize();i++){var card=model.getCard(i);var cardActor=(new SU.CardActor).initialize(scene,model,card,cardsImage.getRef(),images.dorso,this.pile2Actor);this.stockActor.addChild(cardActor);card2Actor[card.getName()]=cardActor}SU.CardActors=card2Actor},initialize:function(director,scene,model){var images={dorso:director.getImage("dorso"),A:director.getImage("A"),K:director.getImage("K"),
P:director.getImage("P")};var me=this;SU.BackgroundImage=images.dorso;this.model=model;this.model.addListener(this.modelEvent.bind(this));this.scene=scene;this.setSize(director.width,director.height);SU.modelActor=this;this.initGame(model,director,scene,images);var undo=(new CAAT.Actor).setFillStyle("green").setAsButton(images.dorso,0,0,0,0,function(button){model.undo()}).setBounds(director.width-30,director.height-40,30,30).setImageTransformation(CAAT.SpriteImage.prototype.TR_FIXED_TO_SIZE);this.addChild(undo);
var suggest=(new CAAT.Actor).setFillStyle("green").setAsButton(images.dorso,0,0,0,0,function(button){model.suggestMove()}).setBounds(director.width-70,director.height-40,30,30).setImageTransformation(CAAT.SpriteImage.prototype.TR_FIXED_TO_SIZE);this.addChild(suggest);var newgame=(new CAAT.Actor).setFillStyle("green").setAsButton(images.dorso,0,0,0,0,function(button){me.model.reInit()}).setBounds(30,director.height-40,30,30).setImageTransformation(CAAT.SpriteImage.prototype.TR_FIXED_TO_SIZE);this.addChild(newgame);
var font=(new CAAT.Font).setFont("'Baumans'").setFontSize(30,"px").setFontStyle("bold").setFillStyle("#aaf").setStrokeStyle("#bbb").setStrokeSize(0.5).createDefault(2);var aa=(new CAAT.TextActor).setFont(font).setLocation(10,10);aa.moves=function(event,data){if(event==="moves")this.setText(data+(data>1?" moves":" move"))};this.addChild(aa);this.model.addListener(aa.moves.bind(aa));var fam=(new CAAT.TextActor).setFont(font).setLocation(500,10).setText(model.game.name);this.addChild(fam);var bb=(new CAAT.TextActor).setFont(font).setLocation(250,
10);scene.onRenderStart=function(){var t=(new Date).getTime()-model.startTime;t=t/1E3>>0;var secs=""+t%60;if(secs<10)secs="0"+secs;t=t/60>>0;var mins=""+t;if(mins<10)mins="0"+mins;var time="Time: "+mins+":"+secs;bb.setText(time)};this.addChild(bb);return this},modelEvent:function(event,data){var i;if(event==="reinit"){for(i in SU.PileActors)SU.PileActors[i].emptyChildren();for(i in SU.CardActors){var card=SU.CardActors[i];card.setLocation(0,0);card.reInit();card.resetTransform();card.setModelViewMatrix();
card.setParent(null);card.visible=false;card.BL_Nothing();this.stockActor.addChildImmediately(card)}}else if(event==="dealInit"){this.stockActor.emptyChildren();for(i=0;i<this.model.getSize();i++){var c=SU.CardActors[this.model.getCard(i).name];c.parent=null;this.stockActor.addChildImmediately(c)}var me=this;var t=SU.CardActor.BEHAVIOR_TIME+SU.CardActor.NEXT_ANIMATION_DELAY*(data.actions-1);this.scene.createTimer(this.scene.time,t,function(){me.model.afterDealInit();for(i=0;i<me.tableauActors.length;i++)if(!me.tableauActors[i].horizontalLayout)me.tableauActors[i].layout(0,
me.tableauActors[i].pile.cards.length)})}else if(event==="status"){this.scene.enableEvents(data===SU.Model.Status.USER);if(data===SU.Model.Status.WIN)this.gameWin();else if(data===SU.Model.Status.LOST)this.gameEnded()}},readyIn:function(actions){if(!actions)return;var me=this;if(this.model.getStatus()===SU.Model.Status.USER||this.model.getStatus()===SU.Model.Status.AUTOMATIC){this.model.setStatus(SU.Model.Status.ANIMATION);var t=SU.CardActor.BEHAVIOR_TIME+actions*SU.CardActor.NEXT_ANIMATION_DELAY;
this.scene.createTimer(this.scene.time,t,function(){me.model.ready()})}},gameWin:function(){console.log("win")},gameEnded:function(){console.log("end")}};extend(SU.ModelActor,CAAT.ActorContainer)})();(function(){SU.Menu=function(){return this};SU.Menu.prototype={create:function(director){var img=[];img.push(director.getImage("game-canfield"));img.push(director.getImage("game-klondike"));img.push(director.getImage("game-scorpion"));img.push(director.getImage("game-whitecard"));img.push(director.getImage("game-whitehead"));var scene=director.createScene();var inset_left=40;var min=img[0].height*0.3;var max=img[0].height;var dock=(new CAAT.Dock).initialize(scene).setBounds(inset_left,20,director.width-
2*inset_left,img[0].height).setSizes(min,max).setApplicationRange(2).setLayoutOp(CAAT.Dock.prototype.OP_LAYOUT_TOP);for(var i=0;i<img.length;i++)dock.addChild((new CAAT.Actor).setBackgroundImage(img[i]).setImageTransformation(CAAT.SpriteImage.prototype.TR_FIXED_TO_SIZE));dock.layout();scene.addChild(dock);scene.activated=function(){director.setClear(true)};return scene}}})();/*


 The MIT License
 Copyright (c) 2010-2011 Ibon Tolosana, Hyperandroid || http://labs.hyperandroid.com/

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){CAAT.Fish=function(){CAAT.Fish.superclass.constructor.call(this);this.tail=[];this.tail1=[];this.tail2=[];this.head1=[];this.head2=[];return this};CAAT.Fish.prototype={tail:null,tail1:null,tail2:null,head1:null,head2:null,maxAngle:45,bodyColor:"red",f1:0,f2:0,f3:0,f4:0,tailSize:0,timeOffset:0,headProportion:0,antihead:false,headStart:0,setBodyColor:function(color){this.bodyColor=color;return this},born:function(){this.f1=(Math.random()*2>>0)/1E3+0.0020;this.f2=(Math.random()*2>>0)/1E3+
0.0020;this.f3=(Math.random()*5>>0)/1E3;this.f4=(Math.random()*5>>0)/1E3;this.tailSize=Math.random()*3+2>>0;this.timeOffset=Math.random()*1E4;this.antihead=Math.random()<0.25;if(this.antihead){this.headProportion=Math.random()*0.25+0.65;if(this.headProportion<0.8)this.headProportion=0.8}else this.headProportion=Math.random()*0.25+0.6;this.maxAngle=40+25*Math.random();var w=this.width;var h=this.height;var w2=w/2;var h2=h/2;this.headStart=this.antihead?w:w*this.headProportion;this.tail[0]=0;this.tail[1]=
h2;this.tail1[0]=w2;this.tail1[1]=h2;this.tail1[2]=w2;this.tail1[3]=0;this.tail1[4]=this.headStart;this.tail1[5]=0;this.headpos=w;if(this.antihead)this.headpos=w*this.headProportion;this.head1[0]=this.headpos;this.head1[1]=0;this.head1[2]=this.headpos;this.head1[3]=h2;this.head2[0]=this.headpos;this.head2[1]=h;this.head2[2]=this.headStart;this.head2[3]=h;this.tail2[0]=w2;this.tail2[1]=h;this.tail2[2]=w2;this.tail2[3]=h2;return this},paint:function(director,time){var ctx=director.ctx;time+=this.timeOffset;
var w=this.width;var h=this.height;var w2=w/2;var w4=w2/2;var h2=h/2;var ang=Math.cos(time*this.f1)*this.maxAngle*Math.sin(time*this.f2)*Math.PI/180;var px=w4-w4*Math.cos(ang);var py=w4*Math.sin(ang);this.tail[0]=px;this.tail[1]=h2+py;var inc=-3*(Math.sin(time*0.0050)+Math.cos(time*0.0010))/2;this.tail1[0]=w4;this.tail1[1]=h2+inc;this.tail1[2]=w2;this.tail1[3]=inc;this.tail2[0]=w2;this.tail2[1]=h+inc;this.tail2[2]=w4;this.tail2[3]=h2+inc;ctx.beginPath();ctx.fillStyle="orange";var aletaSize=h2;var aletaHeight=
7;var aletaWidth=5;var aletaPos=w*2/3+aletaWidth;ctx.beginPath();ctx.moveTo(aletaPos,2);ctx.quadraticCurveTo(aletaPos,-aletaHeight,aletaPos-aletaSize,-aletaHeight-3*Math.sin(time*0.0020));ctx.lineTo(aletaPos-aletaWidth,2);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(aletaPos,h-2);ctx.quadraticCurveTo(aletaPos,h+aletaHeight,aletaPos-aletaSize,h+aletaHeight-3*Math.cos(time*0.0020));ctx.lineTo(aletaPos-aletaWidth,h-2);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(this.tail[0],this.tail[1]+
this.tailSize);ctx.bezierCurveTo(this.tail1[0],this.tail1[1],this.tail1[2],this.tail1[3],this.tail1[4],this.tail1[5]);ctx.quadraticCurveTo(this.head1[0],this.head1[1],this.head1[2],this.head1[3]);ctx.quadraticCurveTo(this.head2[0],this.head2[1],this.head2[2],this.head2[3]);ctx.bezierCurveTo(this.tail2[0],this.tail2[1],this.tail2[2],this.tail2[3],this.tail[0],this.tail[1]-this.tailSize);ctx.closePath();ctx.fillStyle=this.bodyColor;ctx.fill();ctx.strokeStyle=this.bodyColor;ctx.stroke();ctx.beginPath();
ctx.fillStyle="black";var eyeradius=h2/6;if(this.antihead){ctx.arc(this.headpos-eyeradius*2,h2-h2/3,eyeradius,0,2*Math.PI,false);ctx.arc(this.headpos-eyeradius*2,h2+h2/3,eyeradius,0,2*Math.PI,false)}else{ctx.arc(w-w2/4,h2-h2/3,eyeradius,0,2*Math.PI,false);ctx.arc(w-w2/4,h2+h2/3,eyeradius,0,2*Math.PI,false)}ctx.fill()}};extend(CAAT.Fish,CAAT.Actor)})();
(function(){SU.FishPond=function(){return this};SU.FishPond.prototype={initialize:function(director,scene){var NP=10;var colors=["red","blue","white","rgb(0,255,255)","yellow"];var gradient=director.ctx.createLinearGradient(0,0,director.width,director.height);gradient.addColorStop(0,"#000000");gradient.addColorStop(1,"#00007f");var gr=(new CAAT.ActorContainer).setBounds(0,0,director.width,director.height).setFillStyle(gradient).enableEvents(false).cacheAsBitmap();for(var i=0;i<NP;i++){var fw=100+
Math.random()*40*(Math.random()<0.5?1:-1)>>0;var fh=20+Math.random()*5*(Math.random()<0.5?1:-1)>>0;var inTime=i*1E3;var pb=(new CAAT.PathBehavior).setPath((new CAAT.Path).setCubic(-fw-Math.random()*300,Math.random()*director.height,director.width*Math.random(),Math.random()*director.height,director.width*Math.random(),Math.random()*director.height,Math.random()<0.5?director.width+fw+Math.random()*150:Math.random()*director.width,Math.random()<0.5?-director.height*Math.random()-300:director.height+
Math.random()*director.height)).setFrameTime(scene.time+inTime,2E4+5E3*Math.random()>>0).setCycle(true).setAutoRotate(true).addListener({behaviorExpired:function(behavior,time,actor){behavior.path.setCubic(-fw-Math.random()*300,Math.random()*director.height,director.width*Math.random(),-Math.random()*director.height/2+Math.random()*director.height,director.width*Math.random(),-Math.random()*director.height/2+Math.random()*director.height,Math.random()<0.5?director.width+fw+Math.random()*150:Math.random()*
director.width,Math.random()<0.5?-director.height*Math.random()-300:director.height+Math.random()*director.height);behavior.setFrameTime(scene.time,2E4+5E3*Math.random()>>0);actor.born()},behaviorApplied:function(actor,time,normalizedTime,value){}});var f=(new CAAT.Fish).setBounds(300,400,fw,fh).born().setFrameTime(scene.time+inTime,Number.MAX_VALUE).setBodyColor(colors[i%colors.length]).enableEvents(false);f.addBehavior(pb);gr.addChild(f)}scene.addChild(gr)}}})();(function(){CAAT.Grass=function(){return this};CAAT.Grass.prototype={alto_hierba:0,maxAngle:0,angle:0,coords:null,color:null,offset_control_point:3,initialize:function(canvasWidth,canvasHeight,minHeight,maxHeight,angleMax,initialMaxAngle){var sx=Math.floor(Math.random()*canvasWidth);var sy=canvasHeight;var offset_control_x=2;this.alto_hierba=minHeight+Math.random()*maxHeight;this.maxAngle=10+Math.random()*angleMax;this.angle=Math.random()*initialMaxAngle*(Math.random()<0.5?1:-1)*Math.PI/180;var csx=
sx-offset_control_x;var csy=sy-this.alto_hierba/2;var psx=csx;var psy=csy;this.offset_control_point=10;var dx=sx+this.offset_control_point;var dy=sy;this.coords=[sx,sy,csx,csy,psx,psy,dx,dy];this.color=[16+Math.floor(Math.random()*32),100+Math.floor(Math.random()*155),16+Math.floor(Math.random()*32)]},paint:function(ctx,time,ambient){var inc_punta_hierba=Math.sin(time*5.0E-4);var ang=this.angle+Math.PI/2+inc_punta_hierba*Math.PI/180*this.maxAngle*Math.cos(time*2.0E-4);var px=this.coords[0]+this.offset_control_point+
this.alto_hierba*Math.cos(ang);var py=this.coords[1]-this.alto_hierba*Math.sin(ang);ctx.beginPath();ctx.moveTo(this.coords[0],this.coords[1]);ctx.quadraticCurveTo(this.coords[2],this.coords[3],px,py);ctx.quadraticCurveTo(this.coords[4],this.coords[5],this.coords[6],this.coords[7]);ctx.closePath();ctx.fillStyle="rgb("+Math.floor(this.color[0]*ambient)+","+Math.floor(this.color[1]*ambient)+","+Math.floor(this.color[2]*ambient)+")";ctx.fill()}}})();
(function(){CAAT.Garden=function(){CAAT.Garden.superclass.constructor.call(this);this.lerpindex=Math.random()*this.colors.length>>0;return this};CAAT.Garden.prototype={grass:null,ambient:1,stars:null,firefly_radius:10,num_fireflyes:40,num_stars:512,fireflyColor:["#ffff00","#7fff00","#c0c000"],backgroundEnabled:true,rotate:true,initialize:function(ctx,size,maxGrassHeight,rotate){this.grass=[];if(typeof rotate!=="undefined")this.rotate=!!rotate;for(var i=0;i<size;i++){var g=new CAAT.Grass;g.initialize(this.width,
this.height,50,maxGrassHeight,20,40);this.grass.push(g)}this.stars=[];for(i=0;i<this.num_stars;i++){this.stars.push(Math.floor(Math.random()*(this.width-10)+5));this.stars.push(Math.floor(Math.random()*(this.height-10)+5))}if(this.backgroundEnabled)this.lerp(ctx,0,5E3);return this},paint:function(director,time){var ctx=director.ctx;if(this.backgroundEnabled){ctx.fillStyle=this.gradient;ctx.fillRect(0,0,this.width,this.height);if(this.ambient<0.3){ctx.globalAlpha=1-(this.ambient-0.05)/0.25;var intensity=
1-(this.ambient/2-0.05)/0.25;var c=Math.floor(192*intensity);var strc="rgb("+c+","+c+","+c+")";ctx.strokeStyle=strc;for(var j=this.num_fireflyes*2;j<this.stars.length;j+=2){var inc=1;if(j%3==0)inc=1.5;else if(j%11==0)inc=2.5;this.stars[j]=(this.stars[j]+0.1*inc)%this.width;var y=this.stars[j+1];ctx.strokeRect(this.stars[j],this.stars[j+1],1,1)}}ctx.globalAlpha=1}for(var i=0;i<this.num_fireflyes*2;i+=2){ctx.fillStyle=this.fireflyColor[i%3];var angle=Math.PI*2*Math.sin(time*3.0E-4)+i*Math.PI/50;var radius=
this.firefly_radius*Math.cos(time*3.0E-4);var fy=this.height-this.height*0.3+0.5*this.stars[i+1]+20*Math.sin(time*3.0E-4)+radius*Math.sin(angle);if(fy<director.height){ctx.beginPath();ctx.arc(this.width/2+0.5*this.stars[i]+150*Math.cos(time*3.0E-4)+(radius+20*Math.cos(i%5*Math.PI/3600))*Math.cos(angle),fy,2,0,Math.PI*2,false);ctx.fill()}}for(var i=0;i<this.grass.length;i++)this.grass[i].paint(ctx,time,this.ambient);if(this.backgroundEnabled&&this.rotate)if(time>this.nextLerpTime){this.lerpindex=Math.floor((time-
this.nextLerpTime)/this.nextLerpTime);if((time-this.nextLerpTime)%this.nextLerpTime<this.lerpTime)this.lerp(ctx,(time-this.nextLerpTime)%this.nextLerpTime,this.lerpTime)}},gradient:null,lerpTime:1E4,nextLerpTime:15E3,colors:[[0,63,127,0,63,127,31,95,192,63,160,255],[0,63,127,160,95,127,255,144,224,255,144,0],[0,63,127,0,47,127,0,40,80,0,31,63],[0,63,127,63,47,160,160,31,31,255,127,0]],ambients:[1,0.35,0.05,0.5],lerpindex:0,lerp:function(ctx,time,last){this.gradient=ctx.createLinearGradient(0,0,0,
this.height);var i0=this.lerpindex%this.colors.length;var i1=(this.lerpindex+1)%this.colors.length;for(var i=0;i<4;i++){var rgb="rgb(";for(var j=0;j<3;j++){rgb+=Math.floor((this.colors[i1][i*3+j]-this.colors[i0][i*3+j])*time/last+this.colors[i0][i*3+j]);if(j<2)rgb+=","}rgb+=")";this.gradient.addColorStop(i/3,rgb)}this.ambient=(this.ambients[i1]-this.ambients[i0])*time/last+this.ambients[i0]}};extend(CAAT.Garden,CAAT.Actor)})();(function(){CAAT.Starfield=function(){CAAT.Starfield.superclass.constructor.call(this);this.m_starData=[];this.m_matrix=[];this.createStars();return this};CAAT.Starfield.prototype={nStars:1E3,m_starData:null,speed:0.2,dist:256,m_matrix:null,xy:0,xz:0,yz:0,paint:function(director,time){var ctx=director.ctx;ctx.fillStyle=this.fillStyle;ctx.fillRect(0,0,this.width,this.height);this.drawStars(ctx);for(var i=0;i<this.nStars;i++){this.m_starData[i*4+2]-=this.speed;if(this.m_starData[i*4+2]<-this.dist){this.m_starData[i*
4+2]=this.dist;this.m_starData[i*4+0]=(Math.random()>0.5?1:-1)*Math.random()*this.dist>>0;this.m_starData[i*4+1]=(Math.random()>0.5?1:-1)*Math.random()*this.dist>>0}}this.xz=time%2E5/2E5*2*Math.PI;this.yz=time%79E3/79E3*2*Math.PI;this.rotate()},createStars:function(){this.rotate();var i;for(i=0;i<this.nStars*4;i++)this.m_starData.push(0);for(i=0;i<this.nStars;i++){this.m_starData[i*4+0]=(Math.random()>0.5?1:-1)*Math.random()*this.dist>>0;this.m_starData[i*4+1]=(Math.random()>0.5?1:-1)*Math.random()*
this.dist>>0;this.m_starData[i*4+2]=(Math.random()>0.5?1:-1)*Math.random()*this.dist>>0;var d=Math.random();if(d<0.25)this.m_starData[i*4+3]="#444";else if(d<0.5)this.m_starData[i*4+3]="#888";else if(d<0.75)this.m_starData[i*4+3]="#bbb";else this.m_starData[i*4+3]="#fff"}},drawStars:function(ctx){var i,l;for(i=0,l=this.nStars;i<l;i++){var xx=this.m_starData[i*4+0];var yy=this.m_starData[i*4+1];var zz=this.m_starData[i*4+2];var m_matrix=this.m_matrix;var x=xx*m_matrix[0]+yy*m_matrix[1]+zz*m_matrix[2]+
m_matrix[3];var y=xx*m_matrix[4]+yy*m_matrix[5]+zz*m_matrix[6]+m_matrix[7];var z=xx*m_matrix[8]+yy*m_matrix[9]+zz*m_matrix[10]+m_matrix[11];if(z>0){var xp=(this.width>>1)+x*256/z;var yp=(this.height>>1)+y*256/z;var s=0;if(z<128)s=4;else if(z<256)s=2;else s=1;ctx.fillStyle=this.m_starData[i*4+3];ctx.fillRect(xp,yp,s,s)}}},rotate:function(){var sxy=Math.sin(this.xy);var sxz=Math.sin(this.xz);var syz=Math.sin(this.yz);var cxy=Math.cos(this.xy);var cxz=Math.cos(this.xz);var cyz=Math.cos(this.yz);var m_matrix=
this.m_matrix;m_matrix[0]=cxz*cxy;m_matrix[1]=-cxz*sxy;m_matrix[2]=sxz;m_matrix[3]=0;m_matrix[4]=syz*sxz*cxy+sxy*cyz;m_matrix[5]=cyz*cxy-syz*sxz*sxy;m_matrix[6]=-syz*cxz;m_matrix[7]=0;m_matrix[8]=syz*sxy-cyz*sxz*cxy;m_matrix[9]=cyz*sxz*sxy+syz*cxy;m_matrix[10]=cyz*cxz;m_matrix[11]=this.dist;m_matrix[12]=0;m_matrix[13]=0;m_matrix[14]=0;m_matrix[15]=1}};extend(CAAT.Starfield,CAAT.Actor)})();
